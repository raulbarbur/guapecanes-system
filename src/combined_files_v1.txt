--- File: category-actions.ts (in subfolder: actions) ---

// src/actions/category-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createCategory(formData: FormData) {
  const name = formData.get("name") as string

  if (!name) return

  try {
    await prisma.category.create({
      data: { name }
    })
    
    revalidatePath("/categories")
    return { success: true }
  
  } catch (error) {
    // Si el error es porque ya existe (c√≥digo P2002 de Prisma), no hacemos nada
    console.error("Error creando categor√≠a:", error)
    return { success: false, error: "Error al crear (¬øQuiz√°s ya existe?)" }
  }
}

--- File: inventory-actions.ts (in subfolder: actions) ---

// src/actions/inventory-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function registerStockEntry(formData: FormData) {
  const variantId = formData.get("variantId") as string
  const quantity = parseInt(formData.get("quantity") as string)
  const reason = formData.get("reason") as string

  if (!variantId || quantity <= 0) {
    throw new Error("Datos inv√°lidos")
  }

  try {
    // TRANSACCI√ìN: Auditor√≠a + Actualizaci√≥n
    await prisma.$transaction([
      // 1. Crear el movimiento (La historia)
      prisma.stockMovement.create({
        data: {
          variantId,
          quantity: quantity, // Positivo porque entra
          type: "ENTRY",      // Usamos el ENUM del esquema
          reason: reason || "Ingreso manual de mercader√≠a",
          userId: "sistema",  // Por ahora hardcodeado hasta tener login real
        }
      }),

      // 2. Actualizar el contador (El saldo actual)
      prisma.productVariant.update({
        where: { id: variantId },
        data: {
          stock: { increment: quantity } // üëà LA MAGIA: Suma at√≥mica
        }
      })
    ])

    revalidatePath("/products")
    
  } catch (error) {
    console.error("Error cargando stock:", error)
    return { error: "Fall√≥ la carga de stock" }
  }

  redirect("/products")
}

--- File: owner-actions.ts (in subfolder: actions) ---

// src/actions/owner-actions.ts
"use server"; // Esto le dice a Next.js: "Ejecutame en el servidor, no en el navegador"

import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

export async function createOwner(formData: FormData) {
  // 1. Extraer datos del formulario HTML
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const phone = formData.get("phone") as string;

  // 2. Validaci√≥n b√°sica (nunca conf√≠es en el usuario)
  if (!name) return;

  // 3. Guardar en Base de Datos
  await prisma.owner.create({
    data: {
      name,
      email,
      phone,
      isActive: true,
    },
  });

  // 4. Actualizar la pantalla para mostrar el nuevo dato
  revalidatePath("/owners");
}


--- File: product-actions.ts (in subfolder: actions) ---

// src/actions/product-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createProduct(formData: FormData) {
  // 1. Obtener datos simples
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const ownerId = formData.get("ownerId") as string
  const categoryId = formData.get("categoryId") as string
  const imageUrl = formData.get("imageUrl") as string // URL de Cloudinary
  
  // 2. Obtener y convertir n√∫meros (Prisma usa Strings para Decimals, pero validamos aqu√≠)
  const costPrice = parseFloat(formData.get("costPrice") as string)
  const salePrice = parseFloat(formData.get("salePrice") as string)

  // Validaciones b√°sicas
  if (!name || !ownerId || !categoryId || !costPrice || !salePrice) {
    throw new Error("Faltan datos obligatorios")
  }

  try {
    // 3. LA TRANSACCI√ìN (Todo o Nada)
    await prisma.$transaction(async (tx) => {
      
      // A. Crear el "Padre" (Producto gen√©rico)
      const newProduct = await tx.product.create({
        data: {
          name,
          description,
          ownerId,
          categoryId,
          isActive: true
        }
      })

      // B. Crear el "Hijo" (Variante inicial)
      // Usamos el ID del padre que acabamos de crear (newProduct.id)
      await tx.productVariant.create({
        data: {
          productId: newProduct.id,
          name: "Est√°ndar", // Por ahora, variante √∫nica por defecto
          imageUrl: imageUrl || null,
          costPrice: costPrice,
          salePrice: salePrice,
          stock: 0 // Regla de oro: Nace con stock 0. Se carga despu√©s.
        }
      })
    })

    // 4. Si todo sali√≥ bien
    revalidatePath("/products")

  } catch (error) {
    console.error("Error creando producto:", error)
    return { error: "Error al guardar el producto" }
  }
  
  // Redirigir al listado (fuera del try/catch)
  redirect("/products")
}

--- File: sale-actions.ts (in subfolder: actions) ---

// src/actions/sale-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

// Definimos la estructura de lo que esperamos recibir desde el carrito
type CartItem = {
  variantId: string
  quantity: number
}

export async function processSale(cart: CartItem[], totalEstimado: number) {
  if (cart.length === 0) return { error: "El carrito est√° vac√≠o" }

  try {
    await prisma.$transaction(async (tx) => {
      // 1. Calcular el total REAL en el servidor (No confiamos en el frontend)
      let totalReal = 0
      
      // Preparamos los items para guardar
      const saleItemsData = []

      for (const item of cart) {
        // Buscamos el producto en la DB para tener el precio y stock ACTUAL
        const variant = await tx.productVariant.findUnique({
          where: { id: item.variantId },
          include: { product: true }
        })

        if (!variant) throw new Error(`Producto ${item.variantId} no encontrado`)
        
        // Validaci√≥n de Stock Cr√≠tica
        if (variant.stock < item.quantity) {
          throw new Error(`Stock insuficiente para ${variant.product.name}`)
        }

        // Sumamos al total (usando el precio de la DB)
        const subtotal = Number(variant.salePrice) * item.quantity
        totalReal += subtotal

        // Preparamos el item de venta (Snapshot de precios)
        saleItemsData.push({
          variantId: variant.id,
          description: variant.product.name, // Guardamos el nombre por si despu√©s cambia
          quantity: item.quantity,
          costAtSale: variant.costPrice,     // Guardamos el costo hist√≥rico
          priceAtSale: variant.salePrice     // Guardamos el precio hist√≥rico
        })

        // 2. Descontar Stock
        await tx.productVariant.update({
          where: { id: variant.id },
          data: { stock: { decrement: item.quantity } }
        })

        // 3. Auditor√≠a de Movimiento
        await tx.stockMovement.create({
          data: {
            variantId: variant.id,
            quantity: -item.quantity, // Negativo porque sale
            type: "SALE",
            reason: "Venta Mostrador",
            userId: "sistema"
          }
        })
      }

      // 4. Crear la Venta Cabecera
      await tx.sale.create({
        data: {
          total: totalReal,
          paymentMethod: "CASH", // Por ahora fijo efectivo
          status: "COMPLETED",
          items: {
            create: saleItemsData
          }
        }
      })
    })

    revalidatePath("/products")
    revalidatePath("/pos")
    return { success: true }

  } catch (error: any) {
    console.error("Error en venta:", error)
    return { error: error.message || "Error al procesar venta" }
  }
}

// --- AGREGAR ESTO AL FINAL DE: src/actions/sale-actions.ts ---

export async function cancelSale(saleId: string) {
  try {
    await prisma.$transaction(async (tx) => {
      // 1. Buscar la venta y sus items
      const sale = await tx.sale.findUnique({
        where: { id: saleId },
        include: { items: true }
      })

      if (!sale) throw new Error("Venta no encontrada")
      if (sale.status === 'CANCELLED') throw new Error("Ya est√° anulada")

      // 2. Marcar como ANULADA
      await tx.sale.update({
        where: { id: saleId },
        data: { status: 'CANCELLED' }
      })

      // 3. Devolver el stock de cada producto
      for (const item of sale.items) {
        if (item.variantId) {
          // Devolver stock
          await tx.productVariant.update({
            where: { id: item.variantId },
            data: { stock: { increment: item.quantity } }
          })

          // Auditar el movimiento
          await tx.stockMovement.create({
            data: {
              variantId: item.variantId,
              quantity: item.quantity, // Positivo (Entra de nuevo)
              type: 'SALE_CANCELLED',
              reason: `Anulaci√≥n Venta #${sale.id.slice(0, 8)}`,
              userId: 'sistema'
            }
          })
        }
      }
    })

    revalidatePath("/sales")
    revalidatePath("/products") // Para que se vea el stock actualizado
    return { success: true }

  } catch (error: any) {
    return { error: error.message }
  }
}

--- File: layout.tsx (in subfolder: app) ---

import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}


--- File: page.tsx (in subfolder: app) ---

import Image from "next/image";

export default function Home() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
        <Image
          className="dark:invert"
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-zinc-50">
            To get started, edit the page.tsx file.
          </h1>
          <p className="max-w-md text-lg leading-8 text-zinc-600 dark:text-zinc-400">
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
          <a
            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className="dark:invert"
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}


--- File: page.tsx (in subfolder: app\categories) ---

// src/app/categories/page.tsx
import { createCategory } from "@/actions/category-actions"
import { prisma } from "@/lib/prisma"

export default async function CategoriesPage() {
  const categories = await prisma.category.findMany({
    orderBy: { name: 'asc' } // Orden alfab√©tico
  })

  return (
    <div className="p-10 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Categor√≠as de Productos</h1>

      {/* FORMULARIO */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-10 border">
        <form action={createCategory} className="flex gap-4">
          <input 
            name="name" 
            type="text" 
            required 
            className="border p-2 rounded flex-1" 
            placeholder="Ej: Alimentos, Accesorios..."
          />
          <button 
            type="submit" 
            className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          >
            Agregar
          </button>
        </form>
      </div>

      {/* LISTADO */}
      <div className="grid grid-cols-2 gap-4">
        {categories.map((cat) => (
          <div key={cat.id} className="border p-4 rounded bg-gray-50 flex justify-between items-center">
            <span className="font-semibold">{cat.name}</span>
            <span className="text-xs text-gray-400">ID: {cat.id.slice(0, 8)}...</span>
          </div>
        ))}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\inventory) ---

// src/app/inventory/page.tsx
import { prisma } from "@/lib/prisma"
import { registerStockEntry } from "@/actions/inventory-actions"

export default async function InventoryPage() {
  // Buscamos productos para llenar el select
  // Incluimos variants para saber su stock actual y el nombre del due√±o
  const products = await prisma.product.findMany({
    include: {
      variants: true,
      owner: true
    },
    orderBy: { name: 'asc' }
  })

  return (
    <div className="p-8 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Ingreso de Mercader√≠a (Remito)</h1>

      <div className="bg-white p-6 rounded-lg shadow-md border border-green-200">
        <form action={registerStockEntry} className="space-y-6">
          
          {/* SELECCI√ìN DE PRODUCTO */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Producto</label>
            <select name="variantId" required className="w-full border p-3 rounded bg-white">
              <option value="">Seleccionar producto...</option>
              {products.map(p => {
                const v = p.variants[0] // Asumimos variante √∫nica
                return (
                  <option key={v.id} value={v.id}>
                    {p.name} (Stock actual: {v.stock}) - De: {p.owner.name}
                  </option>
                )
              })}
            </select>
          </div>

          {/* CANTIDAD */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Cantidad a Ingresar</label>
            <input 
              name="quantity" 
              type="number" 
              min="1" 
              required 
              className="w-full border p-3 rounded text-lg font-bold" 
              placeholder="Ej: 10"
            />
          </div>

          {/* MOTIVO (Opcional) */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Motivo / Nro Remito</label>
            <input 
              name="reason" 
              type="text" 
              className="w-full border p-3 rounded" 
              placeholder="Ej: Remito #0042 de Juan"
            />
          </div>

          <button 
            type="submit" 
            className="w-full bg-green-600 text-white py-3 rounded hover:bg-green-700 font-bold text-lg"
          >
            Confirmar Ingreso
          </button>

        </form>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners) ---

// src/app/owners/page.tsx
import { createOwner } from "@/actions/owner-actions"
import { prisma } from "@/lib/prisma"

export default async function OwnersPage() {
  // Consultamos los due√±os existentes para mostrarlos abajo
  const owners = await prisma.owner.findMany({
    orderBy: { createdAt: 'desc' }
  })

  return (
    <div className="p-10 max-w-4xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Gesti√≥n de Due√±os</h1>

      {/* FORMULARIO DE ALTA */}
      <div className="bg-gray-100 p-6 rounded-lg shadow-md mb-10">
        <h2 className="text-xl font-semibold mb-4">Nuevo Due√±o</h2>
        {/* Al enviar, ejecutamos la Server Action createOwner */}
        <form action={createOwner} className="flex gap-4 items-end">
          
          <div className="flex flex-col gap-1">
            <label className="text-sm text-gray-600">Nombre *</label>
            <input 
              name="name" 
              type="text" 
              required 
              className="border p-2 rounded" 
              placeholder="Juan P√©rez"
            />
          </div>

          <div className="flex flex-col gap-1">
            <label className="text-sm text-gray-600">Email</label>
            <input 
              name="email" 
              type="email" 
              className="border p-2 rounded" 
              placeholder="juan@mail.com"
            />
          </div>

          <div className="flex flex-col gap-1">
            <label className="text-sm text-gray-600">Tel√©fono</label>
            <input 
              name="phone" 
              type="text" 
              className="border p-2 rounded" 
              placeholder="11 1234 5678"
            />
          </div>

          <button 
            type="submit" 
            className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition"
          >
            Guardar
          </button>
        </form>
      </div>

      {/* LISTADO DE DUE√ëOS */}
      <div className="grid gap-4">
        {owners.map((owner) => (
          <div key={owner.id} className="border p-4 rounded flex justify-between bg-white shadow-sm">
            <div>
              <p className="font-bold text-lg">{owner.name}</p>
              <p className="text-gray-500 text-sm">{owner.email || "Sin email"} | {owner.phone || "Sin tel√©fono"}</p>
            </div>
            <span className="text-green-600 text-sm bg-green-100 px-2 py-1 rounded h-fit">
              Activo
            </span>
          </div>
        ))}
        
        {owners.length === 0 && (
          <p className="text-gray-500 text-center py-10">No hay due√±os registrados a√∫n.</p>
        )}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pos) ---

// src/app/pos/page.tsx
import { prisma } from "@/lib/prisma"
import PosSystem from "@/components/PosSystem"

export default async function PosPage() {
  // Buscamos productos con stock > 0 (o todos, para mostrar agotados visualmente)
  const products = await prisma.product.findMany({
    where: { isActive: true },
    include: { variants: true, owner: true }
  })

  // Transformamos los datos complejos de Prisma a una estructura simple para el Frontend
  const simpleProducts = products.map(p => {
    const v = p.variants[0] // Asumimos variante √∫nica
    return {
      id: v.id,
      name: p.name,
      price: Number(v.salePrice), // Convertimos Decimal a Number para JS
      stock: v.stock,
      imageUrl: v.imageUrl,
      ownerName: p.owner.name
    }
  })

  return (
    <div className="h-screen flex flex-col p-4 bg-gray-50">
      <header className="mb-4 flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">Punto de Venta</h1>
        <div className="text-sm text-gray-500">Caja Principal</div>
      </header>
      
      {/* Cargamos el sistema interactivo */}
      <PosSystem products={simpleProducts} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products) ---

// src/app/products/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import Link from "next/link"

export default async function ProductsPage() {
  // 1. Buscamos datos necesarios para los selectores
  const owners = await prisma.owner.findMany({ select: { id: true, name: true } })
  const categories = await prisma.category.findMany({ select: { id: true, name: true } })

  // 2. Buscamos productos ya creados para listar (opcional por ahora, para verificar)
  const products = await prisma.product.findMany({
    include: { 
      variants: true, 
      category: true,
      owner: true 
    },
    orderBy: { name: 'asc' }
  })

  return (
    <div className="p-8 max-w-6xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">Inventario de Productos</h1>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Columna Izquierda: Formulario de Alta */}
        <div className="lg:col-span-1">
          <ProductForm owners={owners} categories={categories} />
        </div>

        {/* Columna Derecha: Listado Simple */}
        <div className="lg:col-span-2">
          <div className="bg-white rounded shadow overflow-hidden">
            <table className="w-full text-sm text-left">
              <thead className="bg-gray-100 text-gray-700 uppercase font-bold">
                <tr>
                  <th className="px-4 py-3">Producto</th>
                  <th className="px-4 py-3">Categor√≠a</th>
                  <th className="px-4 py-3">Precio</th>
                  <th className="px-4 py-3">Stock</th>
                </tr>
              </thead>
              <tbody>
                {products.map(p => {
                  const variant = p.variants[0] // Tomamos la variante principal
                  return (
                    <tr key={p.id} className="border-b hover:bg-gray-50">
                      <td className="px-4 py-3 flex items-center gap-3">
                        {variant?.imageUrl && (
                          <img src={variant.imageUrl} className="w-10 h-10 object-cover rounded" />
                        )}
                        <div>
                          <p className="font-semibold">{p.name}</p>
                          <p className="text-xs text-gray-500">{p.owner.name}</p>
                        </div>
                      </td>
                      <td className="px-4 py-3">{p.category.name}</td>
                      <td className="px-4 py-3 font-bold text-green-600">
                        ${variant?.salePrice.toString()}
                      </td>
                      <td className="px-4 py-3">
                        {variant?.stock === 0 ? (
                          <span className="text-red-500 bg-red-50 px-2 py-1 rounded text-xs">Sin Stock</span>
                        ) : variant?.stock}
                      </td>
                    </tr>
                  )
                })}
                {products.length === 0 && (
                  <tr>
                    <td colSpan={4} className="text-center py-10 text-gray-500">
                      No hay productos. ¬°Crea el primero a la izquierda!
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\sales) ---

// src/app/sales/page.tsx
import { prisma } from "@/lib/prisma"
import { cancelSale } from "@/actions/sale-actions"
import { revalidatePath } from "next/cache"

export default async function SalesHistoryPage() {
  // Buscamos las ventas, incluyendo los items para mostrar detalles
  const sales = await prisma.sale.findMany({
    include: {
      items: true
    },
    orderBy: { createdAt: 'desc' } // Las m√°s nuevas primero
  })

  // Esta funci√≥n act√∫a como puente entre el bot√≥n y la Server Action
  async function handleCancel(formData: FormData) {
    'use server'
    const saleId = formData.get("saleId") as string
    await cancelSale(saleId)
  }

  return (
    <div className="p-8 max-w-5xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Historial de Ventas</h1>

      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-gray-100 text-gray-700 uppercase text-sm">
            <tr>
              <th className="p-4">Fecha / ID</th>
              <th className="p-4">Items</th>
              <th className="p-4">Total</th>
              <th className="p-4">Estado</th>
              <th className="p-4">Acci√≥n</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {sales.map((sale) => (
              <tr key={sale.id} className={sale.status === 'CANCELLED' ? 'bg-red-50' : 'hover:bg-gray-50'}>
                <td className="p-4">
                  <p className="font-bold">{sale.createdAt.toLocaleDateString()}</p>
                  <p className="text-xs text-gray-500 font-mono">{sale.id.slice(0, 8)}...</p>
                </td>
                
                <td className="p-4">
                  <ul className="text-sm list-disc pl-4">
                    {sale.items.map(item => (
                      <li key={item.id}>
                        {item.quantity} x {item.description}
                      </li>
                    ))}
                  </ul>
                </td>

                <td className="p-4 font-bold text-lg">
                  ${sale.total.toString()}
                </td>

                <td className="p-4">
                  <span className={`px-2 py-1 rounded text-xs font-bold
                    ${sale.status === 'COMPLETED' ? 'bg-green-100 text-green-700' : 'bg-red-200 text-red-800'}
                  `}>
                    {sale.status === 'COMPLETED' ? 'COBRADO' : 'ANULADO'}
                  </span>
                </td>

                <td className="p-4">
                  {sale.status === 'COMPLETED' && (
                    <form action={handleCancel}>
                      <input type="hidden" name="saleId" value={sale.id} />
                      <button 
                        type="submit"
                        className="text-red-600 hover:text-red-800 text-sm font-semibold border border-red-200 px-3 py-1 rounded hover:bg-red-50"
                      >
                        Anular
                      </button>
                    </form>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {sales.length === 0 && (
          <div className="p-10 text-center text-gray-500">
            No hay ventas registradas a√∫n.
          </div>
        )}
      </div>
    </div>
  )
}

--- File: ImageUpload.tsx (in subfolder: components) ---

// src/components/ImageUpload.tsx
'use client' // Necesario para interactuar con el usuario

import { useState } from "react"

export default function ImageUpload({ onImageUpload }: { onImageUpload: (url: string) => void }) {
  const [uploading, setUploading] = useState(false)
  const [preview, setPreview] = useState<string | null>(null)

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setUploading(true)

    // 1. Preparar los datos para Cloudinary
    const formData = new FormData()
    formData.append("file", file)
    formData.append("upload_preset", process.env.NEXT_PUBLIC_CLOUDINARY_PRESET!)

    try {
      // 2. Enviar a Cloudinary (Petici√≥n directa desde el navegador)
      const cloudName = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData,
      })

      const data = await response.json()

      if (data.secure_url) {
        // 3. √âxito: Guardamos la URL y avisamos al componente padre
        setPreview(data.secure_url)
        onImageUpload(data.secure_url) // üëà Esta funci√≥n viene de afuera
      } else {
        alert("Error al subir imagen")
      }
    } catch (error) {
      console.error(error)
      alert("Error de conexi√≥n al subir imagen")
    } finally {
      setUploading(false)
    }
  }

  return (
    <div className="flex flex-col gap-2">
      <label className="text-sm font-medium text-gray-700">Imagen del Producto</label>
      
      <div className="flex items-center gap-4">
        {/* Input de archivo */}
        <input 
          type="file" 
          accept="image/*"
          onChange={handleFileChange}
          disabled={uploading}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
        
        {/* Indicador de carga */}
        {uploading && <span className="text-sm text-blue-600">Subiendo...</span>}
      </div>

      {/* Previsualizaci√≥n */}
      {preview && (
        <div className="mt-2">
          <img src={preview} alt="Vista previa" className="h-32 w-32 object-cover rounded-md border" />
        </div>
      )}
    </div>
  )
}

--- File: PosSystem.tsx (in subfolder: components) ---

// src/components/PosSystem.tsx
'use client'

import { useState } from "react"
import { processSale } from "@/actions/sale-actions"

type ProductType = {
  id: string
  name: string
  price: number
  stock: number
  imageUrl: string | null
  ownerName: string
}

export default function PosSystem({ products }: { products: ProductType[] }) {
  const [cart, setCart] = useState<{ product: ProductType; quantity: number }[]>([])
  const [loading, setLoading] = useState(false)

  const addToCart = (product: ProductType) => {
    if (product.stock <= 0) return alert("Sin stock")

    setCart(currentCart => {
      const existing = currentCart.find(item => item.product.id === product.id)
      if (existing) {
        if (existing.quantity >= product.stock) {
          alert("No hay m√°s stock disponible")
          return currentCart
        }
        return currentCart.map(item => 
          item.product.id === product.id 
            ? { ...item, quantity: item.quantity + 1 } 
            : item
        )
      }
      return [...currentCart, { product, quantity: 1 }]
    })
  }

  const total = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0)

  const handleCheckout = async () => {
    if (!confirm(`¬øConfirmar venta por $${total}?`)) return
    
    setLoading(true)
    
    const payload = cart.map(item => ({
      variantId: item.product.id,
      quantity: item.quantity
    }))

    const result = await processSale(payload, total)
    
    setLoading(false)

    if (result.success) {
      alert("¬°Venta Exitosa!")
      setCart([]) 
    } else {
      alert("Error: " + result.error)
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pb-20"> {/* pb-20 da espacio abajo */}
      
      {/* IZQUIERDA: GRILLA DE PRODUCTOS */}
      <div className="md:col-span-2">
        <div className="grid grid-cols-2 lg:grid-cols-3 gap-4">
          {products.map(p => (
            <button 
              key={p.id}
              onClick={() => addToCart(p)}
              disabled={p.stock === 0}
              className={`p-4 border rounded-lg text-left transition shadow-sm flex flex-col gap-2 min-h-[200px]
                ${p.stock === 0 ? 'bg-gray-100 opacity-50 cursor-not-allowed' : 'bg-white hover:border-blue-500 hover:shadow-md'}
              `}
            >
              {p.imageUrl ? (
                <img src={p.imageUrl} alt={p.name} className="w-full h-32 object-cover rounded mb-2" />
              ) : (
                <div className="w-full h-32 bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-400">Sin foto</div>
              )}
              <h3 className="font-bold text-gray-800 leading-tight">{p.name}</h3>
              <div className="flex justify-between items-center w-full mt-auto">
                <span className="text-blue-600 font-bold">${p.price}</span>
                <span className="text-xs text-gray-500">Stock: {p.stock}</span>
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* DERECHA: TICKET / CARRITO (Sticky para que baje contigo) */}
      <div className="md:col-span-1">
        <div className="bg-white border rounded-lg shadow-lg sticky top-4">
          <div className="p-4 border-b bg-gray-50">
            <h2 className="font-bold text-xl">Ticket Actual</h2>
          </div>
          
          <div className="p-4 space-y-4 max-h-[400px] overflow-y-auto">
            {cart.length === 0 && (
              <p className="text-gray-400 text-center py-10">El carrito est√° vac√≠o.<br/>Seleccion√° productos de la izquierda.</p>
            )}
            {cart.map((item, index) => (
              <div key={index} className="flex justify-between items-center border-b pb-2">
                <div>
                  <p className="font-medium">{item.product.name}</p>
                  <p className="text-sm text-gray-500">{item.quantity} x ${item.product.price}</p>
                </div>
                <span className="font-bold">${item.quantity * item.product.price}</span>
              </div>
            ))}
          </div>

          {/* ZONA DE COBRO */}
          <div className="p-6 bg-gray-900 text-white rounded-b-lg">
            <div className="flex justify-between text-2xl font-bold mb-4">
              <span>Total</span>
              <span>${total}</span>
            </div>
            <button 
              onClick={handleCheckout}
              disabled={cart.length === 0 || loading}
              className={`w-full py-4 rounded font-bold text-xl transition
                ${cart.length === 0 ? 'bg-gray-600 cursor-not-allowed text-gray-400' : 'bg-green-500 hover:bg-green-600 text-white'}
              `}
            >
              {loading ? "Procesando..." : "COBRAR"}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

--- File: ProductForm.tsx (in subfolder: components) ---

// src/components/ProductForm.tsx
'use client'

import { useState } from "react"
import { createProduct } from "@/actions/product-actions"
import ImageUpload from "./ImageUpload"

// Definimos qu√© datos esperamos recibir (props)
type Props = {
  owners: { id: string; name: string }[]
  categories: { id: string; name: string }[]
}

export default function ProductForm({ owners, categories }: Props) {
  const [imageUrl, setImageUrl] = useState("")

  return (
    <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto border">
      <h2 className="text-xl font-bold mb-6">Nuevo Producto</h2>
      
      <form action={createProduct} className="space-y-4">
        
        {/* Nombre */}
        <div>
          <label className="block text-sm font-medium text-gray-700">Nombre del Producto *</label>
          <input name="name" type="text" required className="w-full border p-2 rounded" placeholder="Ej: Correa Extensible" />
        </div>

        {/* Descripci√≥n */}
        <div>
          <label className="block text-sm font-medium text-gray-700">Descripci√≥n</label>
          <textarea name="description" className="w-full border p-2 rounded" rows={2} />
        </div>

        {/* Selectores (Relaciones) */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">Due√±o (Consignante) *</label>
            <select name="ownerId" required className="w-full border p-2 rounded bg-white">
              <option value="">Seleccionar...</option>
              {owners.map(o => (
                <option key={o.id} value={o.id}>{o.name}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Categor√≠a *</label>
            <select name="categoryId" required className="w-full border p-2 rounded bg-white">
              <option value="">Seleccionar...</option>
              {categories.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          </div>
        </div>

        {/* Precios */}
        <div className="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded">
          <div>
            <label className="block text-sm font-medium text-gray-700">Costo (Lo que pagamos) *</label>
            <input name="costPrice" type="number" step="0.01" required className="w-full border p-2 rounded" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Precio Venta (P√∫blico) *</label>
            <input name="salePrice" type="number" step="0.01" required className="w-full border p-2 rounded" />
          </div>
        </div>

        {/* Imagen (Componente Especial) */}
        <div className="border-t pt-4">
          <ImageUpload onImageUpload={(url) => setImageUrl(url)} />
          {/* TRUCO: Input oculto para enviar la URL al servidor */}
          <input type="hidden" name="imageUrl" value={imageUrl} />
        </div>

        <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 font-bold">
          Guardar Producto
        </button>

      </form>
    </div>
  )
}

--- File: prisma.ts (in subfolder: lib) ---

// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

