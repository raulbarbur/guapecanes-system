--- File: appointment-actions.ts (in subfolder: actions) ---

// src/actions/appointment-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { buildArgentinaDate } from "@/lib/utils"

type ApptStatus = 'PENDING' | 'CONFIRMED' | 'COMPLETED' | 'BILLED' | 'CANCELLED'

export async function createAppointment(formData: FormData) {
  const petId = formData.get("petId") as string
  const dateStr = formData.get("date") as string // "2024-01-20"
  const timeStr = formData.get("time") as string // "14:30"
  const duration = parseInt(formData.get("duration") as string) || 60 

  if (!petId || !dateStr || !timeStr) {
    return { error: "Faltan datos (Mascota, Fecha u Hora)" }
  }

  try {
    // 1. CONSTRUIR FECHAS (Usando utilidad centralizada)
    const startTime = buildArgentinaDate(dateStr, timeStr)
    
    // Calculamos el final
    const endTime = new Date(startTime.getTime() + duration * 60000)

    if (isNaN(startTime.getTime())) {
      return { error: "Fecha u hora inv√°lida" }
    }

    // 2. VALIDAR COLISIONES
    const collision = await prisma.appointment.findFirst({
      where: {
        status: { not: 'CANCELLED' }, 
        AND: [
          { startTime: { lt: endTime } }, 
          { endTime: { gt: startTime } }  
        ]
      },
      include: { pet: true }
    })

    if (collision) {
        // Formateamos para el mensaje de error
        const collisionStart = collision.startTime.toLocaleTimeString('es-AR', {
            hour: '2-digit', minute:'2-digit', timeZone: 'America/Argentina/Buenos_Aires'
        })
        const collisionEnd = collision.endTime.toLocaleTimeString('es-AR', {
            hour: '2-digit', minute:'2-digit', timeZone: 'America/Argentina/Buenos_Aires'
        })

      return { 
        error: `Horario ocupado por ${collision.pet.name} (${collisionStart} - ${collisionEnd})` 
      }
    }

    // 3. GUARDAR TURNO
    await prisma.appointment.create({
      data: {
        petId,
        startTime,
        endTime,
        status: 'PENDING'
      }
    })

    revalidatePath("/agenda")
    revalidatePath("/dashboard")
    revalidatePath(`/pets/${petId}`) // Refrescamos tambi√©n la ficha de la mascota
    return { success: true }

  } catch (error) {
    console.error("Error agendando:", error)
    return { error: "Error interno al crear turno" }
  }
}

export async function cancelAppointment(formData: FormData) {
    const id = formData.get("id") as string

    if (!id) return { error: "ID no provisto" }

    try {
        // 1. LEER ANTES DE ESCRIBIR (Validaci√≥n de Estado)
        const appointment = await prisma.appointment.findUnique({
            where: { id },
            select: { status: true }
        })

        if (!appointment) return { error: "Turno no encontrado" }

        // 2. REGLA DE ORO: No cancelar lo cobrado ni lo completado
        if (appointment.status === 'BILLED') {
            console.warn(`Intento de cancelar turno cobrado: ${id}`)
            return { error: "‚õî No se puede cancelar: El turno ya fue COBRADO. Deb√©s anular la venta en la secci√≥n Ventas." }
        }
        
        if (appointment.status === 'COMPLETED') {
             return { error: "‚ö†Ô∏è El turno ya fue realizado (COMPLETADO). No se puede cancelar." }
        }

        // 3. EJECUTAR CANCELACI√ìN
        await prisma.appointment.update({
            where: { id },
            data: { status: 'CANCELLED' }
        })

        revalidatePath("/agenda")
        revalidatePath("/dashboard")
        return { success: true }

    } catch (error) {
        console.error("Error cancelando:", error)
        return { error: "Error interno al cancelar" }
    }
}

export async function updateAppointmentStatus(id: string, newStatus: ApptStatus) {
    try {
        // 1. LEER ESTADO ACTUAL
        const currentAppt = await prisma.appointment.findUnique({
            where: { id },
            select: { status: true }
        })

        if (!currentAppt) return { error: "Turno inexistente" }

        // 2. VALIDACIONES DE TRANSICI√ìN

        // A. Si ya est√° cobrado, es INMUTABLE desde la agenda
        if (currentAppt.status === 'BILLED') {
            return { error: "‚õî Turno cerrado/cobrado. No admite cambios de estado." }
        }

        // B. No permitir pasar a 'BILLED' manualmente (eso lo hace la Caja)
        if (newStatus === 'BILLED') {
            return { error: "‚õî Acci√≥n denegada. El estado 'COBRADO' solo lo asigna el sistema de Caja." }
        }

        // 3. ACTUALIZAR
        await prisma.appointment.update({
            where: { id },
            data: { status: newStatus }
        })

        revalidatePath("/agenda")
        revalidatePath("/dashboard")
        return { success: true }

    } catch (error) {
        console.error("Error cambiando estado:", error)
        return { error: "No se pudo actualizar el estado" }
    }
}

--- File: bulk-actions.ts (in subfolder: actions) ---

// src/actions/bulk-actions.ts
'use server'

import { prisma } from "@/lib/prisma"

// Definimos la nueva estructura esperada (incluye variantName)
type ImportRow = {
  name: string
  variantName?: string // üëà Campo nuevo opcional
  categoryName: string
  ownerName: string
  cost: number
  price: number
}

// Helper simple para convertir a Title Case
function toTitleCase(str: string) {
  return str.replace(
    /\w\S*/g,
    (txt) => txt.charAt(0).toUpperCase() + txt.substring(1).toLowerCase()
  )
}

export async function importSingleProduct(data: ImportRow) {
  try {
    // 1. SANITIZACI√ìN Y VALIDACI√ìN (Fail Fast)
    if (!data.name || !data.categoryName || !data.ownerName) {
      return { success: false, error: "Datos incompletos: Faltan Nombre, Categor√≠a o Due√±o." }
    }

    const cost = Number(data.cost)
    const price = Number(data.price)

    if (isNaN(cost) || isNaN(price)) {
      return { success: false, error: "Formato inv√°lido: Costo y Precio deben ser n√∫meros." }
    }

    // 2. REGLAS FINANCIERAS (Guard Clauses)
    if (cost < 0 || price < 0) {
      return { success: false, error: "Error financiero: Importes negativos no permitidos." }
    }

    if (price < cost) {
      return { success: false, error: `Rentabilidad negativa: Costo ($${cost}) > Venta ($${price}).` }
    }

    // 3. NORMALIZAR DATOS
    const productName = data.name.trim()
    // Si no ponen variante, asumimos "Est√°ndar"
    const variantName = data.variantName && data.variantName.trim() !== "" 
        ? data.variantName.trim() 
        : "Est√°ndar"
    
    // 4. BUSCAR O CREAR ENTIDADES RELACIONADAS (Due√±o y Categor√≠a)
    
    // A. Due√±o
    const owner = await prisma.owner.findFirst({
      where: { name: { equals: data.ownerName, mode: 'insensitive' } }
    })

    if (!owner) {
      return { success: false, error: `Due√±o desconocido: "${data.ownerName}". Crealo en el sistema primero.` }
    }

    // B. Categor√≠a (Upsert manual)
    const normalizedCategory = toTitleCase(data.categoryName.trim())
    let category = await prisma.category.findFirst({
      where: { name: { equals: normalizedCategory, mode: 'insensitive' } }
    })

    if (!category) {
      category = await prisma.category.create({
        data: { name: normalizedCategory } 
      })
    }

    // 5. L√ìGICA CORE: PADRE E HIJO
    
    // Buscamos si el Producto Padre ya existe para este due√±o
    const existingProduct = await prisma.product.findFirst({
        where: {
            name: { equals: productName, mode: 'insensitive' },
            ownerId: owner.id
        }
    })

    if (existingProduct) {
        // CASO A: EL PRODUCTO EXISTE -> Intentamos agregar la VARIANTE
        
        // Verificamos si YA existe esa variante espec√≠fica
        const existingVariant = await prisma.productVariant.findFirst({
            where: {
                productId: existingProduct.id,
                name: { equals: variantName, mode: 'insensitive' }
            }
        })

        if (existingVariant) {
            return { success: false, error: `Omitido: Ya existe la variante "${variantName}" en "${productName}".` }
        }

        // Crear la variante nueva en el producto existente
        await prisma.productVariant.create({
            data: {
                productId: existingProduct.id,
                name: variantName,
                costPrice: cost,
                salePrice: price,
                stock: 0, // Siempre nace en 0
                imageUrl: null
            }
        })

    } else {
        // CASO B: EL PRODUCTO NO EXISTE -> Creamos PADRE + HIJO
        
        await prisma.product.create({
            data: {
                name: productName,
                categoryId: category.id,
                ownerId: owner.id,
                isActive: true,
                variants: {
                    create: {
                        name: variantName,
                        costPrice: cost,
                        salePrice: price,
                        stock: 0,
                        imageUrl: null
                    }
                }
            }
        })
    }

    return { success: true }

  } catch (error: any) {
    console.error("Error importando:", error)
    return { success: false, error: error.message || "Error interno del servidor" }
  }
}

--- File: category-actions.ts (in subfolder: actions) ---

// src/actions/category-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createCategory(formData: FormData) {
  const name = formData.get("name") as string

  if (!name) return

  try {
    await prisma.category.create({
      data: { name }
    })
    
    revalidatePath("/categories")
    return { success: true }
  
  } catch (error) {
    // Si el error es porque ya existe (c√≥digo P2002 de Prisma), no hacemos nada
    console.error("Error creando categor√≠a:", error)
    return { success: false, error: "Error al crear (¬øQuiz√°s ya existe?)" }
  }
}

--- File: export-actions.ts (in subfolder: actions) ---

// src/actions/export-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import ExcelJS from "exceljs"

export async function exportProducts(mode: 'TEMPLATE' | 'FULL') {
  try {
    // 1. Crear Libro y Hoja
    const workbook = new ExcelJS.Workbook()
    const worksheet = workbook.addWorksheet("Productos")

    // 2. Definir Columnas (Mismo orden que el Importador)
    worksheet.columns = [
      { header: "Nombre Producto", key: "name", width: 30 },
      { header: "Variante", key: "variant", width: 20 },
      { header: "Categor√≠a", key: "category", width: 20 },
      { header: "Nombre Due√±o", key: "owner", width: 20 },
      { header: "Costo", key: "cost", width: 15 },
      { header: "Precio Venta", key: "price", width: 15 },
    ]

    // Estilar la cabecera (Negrita y fondo gris)
    const headerRow = worksheet.getRow(1)
    headerRow.font = { bold: true }
    headerRow.fill = {
      type: "pattern",
      pattern: "solid",
      fgColor: { argb: "FFE0E0E0" }
    }

    // 3. Si es FULL, llenamos con datos
    if (mode === 'FULL') {
      const products = await prisma.product.findMany({
        where: { isActive: true }, // Solo activos
        include: {
          category: true,
          owner: true,
          variants: true
        },
        orderBy: { name: 'asc' }
      })

      // APLANAMOS LA DATA (Flatten)
      for (const p of products) {
        for (const v of p.variants) {
          worksheet.addRow({
            name: p.name,
            variant: v.name === "Est√°ndar" ? "" : v.name, // Dejamos vac√≠o si es est√°ndar para limpieza visual
            category: p.category.name,
            owner: p.owner.name,
            cost: Number(v.costPrice),
            price: Number(v.salePrice)
          })
        }
      }
    }

    // 4. Generar Buffer y convertir a Base64
    // (Server Actions no pueden retornar Streams directamente al cliente f√°cilmente todav√≠a)
    const buffer = await workbook.xlsx.writeBuffer()
    const base64 = Buffer.from(buffer).toString("base64")
    
    const filename = mode === 'FULL' 
        ? `Inventario_Guapecanes_${new Date().toISOString().split('T')[0]}.xlsx`
        : `Plantilla_Carga_Productos.xlsx`

    return { success: true, base64, filename }

  } catch (error) {
    console.error("Error exportando:", error)
    return { success: false, error: "Error al generar el archivo Excel." }
  }
}

--- File: inventory-actions.ts (in subfolder: actions) ---

// src/actions/inventory-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { getVariantStockHistory, translateMovementType } from "@/services/inventory-service" // üëà Importamos el servicio

// Definimos los tipos permitidos seg√∫n el Schema y la UI
type MovementType = "ENTRY" | "OWNER_WITHDRAWAL" | "ADJUSTMENT"

export async function registerStockMovement(formData: FormData) {
  const variantId = formData.get("variantId") as string
  const reason = formData.get("reason") as string
  const type = formData.get("type") as MovementType
  
  // Convertimos y validamos n√∫mero
  const rawQuantity = parseInt(formData.get("quantity") as string)

  // 1. VALIDACI√ìN PREVIA (Fail Fast)
  if (!variantId || !type) {
    return { error: "Faltan datos obligatorios." }
  }
  
  if (isNaN(rawQuantity) || rawQuantity <= 0) {
    return { error: "La cantidad debe ser un n√∫mero positivo mayor a 0." }
  }

  try {
    // 2. DETERMINAR EL SIGNO DEL MOVIMIENTO
    // ENTRY: Suma (+)
    // OWNER_WITHDRAWAL: Resta (-)
    // ADJUSTMENT: Seg√∫n UI actual es "Baja/Rotura", as√≠ que Resta (-)
    let finalQuantity = rawQuantity
    
    if (type === "OWNER_WITHDRAWAL" || type === "ADJUSTMENT") {
        finalQuantity = -rawQuantity
    }

    // 3. OBTENER VARIANTE ACTUAL (Para validar stock)
    const currentVariant = await prisma.productVariant.findUnique({
        where: { id: variantId },
        include: { product: true }
    })

    if (!currentVariant) return { error: "Producto no encontrado." }

    // 4. VALIDAR STOCK PARA SALIDAS (Regla de Oro)
    // Si el movimiento es negativo, verificamos que no rompa el stock (negativo prohibido)
    if (finalQuantity < 0) {
      const quantityNeeded = Math.abs(finalQuantity)
      if (currentVariant.stock < quantityNeeded) {
        return { 
            error: `Stock insuficiente en "${currentVariant.product.name}". Ten√©s ${currentVariant.stock}, intent√°s sacar ${quantityNeeded}.` 
        }
      }
    }

    // 5. TRANSACCI√ìN AT√ìMICA
    await prisma.$transaction([
      // A. Crear el movimiento hist√≥rico (Auditor√≠a)
      prisma.stockMovement.create({
        data: {
          variantId,
          quantity: finalQuantity, // Guardamos con signo (+ o -)
          type: type, 
          reason: reason || getDefaultReason(type),
          userId: "sistema", 
        }
      }),

      // B. Actualizar el stock actual (Contador)
      prisma.productVariant.update({
        where: { id: variantId },
        data: {
          stock: { increment: finalQuantity } // increment maneja restas si el n√∫mero es negativo
        }
      })
    ])

    // Revalidamos cach√©
    revalidatePath("/products")
    revalidatePath("/inventory")
    revalidatePath("/dashboard")

    return { success: true }

  } catch (error) {
    console.error("Error gestionando stock:", error)
    return { error: "Fall√≥ el movimiento de stock. Intente nuevamente." }
  }
}

// Funci√≥n auxiliar para textos por defecto
function getDefaultReason(type: MovementType): string {
    switch (type) {
        case "ENTRY": return "Ingreso de mercader√≠a"
        case "OWNER_WITHDRAWAL": return "Retiro de due√±o"
        case "ADJUSTMENT": return "Baja por rotura/p√©rdida"
        default: return "Movimiento de stock"
    }
}

// üëá NUEVA ACCI√ìN DE LECTURA (Para consumir desde el nuevo Frontend)
export async function getHistory(variantId: string) {
    if (!variantId) return { error: "ID requerido" }
    
    try {
        const rawHistory = await getVariantStockHistory(variantId)
        
        // Enriquecemos los datos para la UI (Traducci√≥n)
        const history = rawHistory.map(h => ({
            ...h,
            typeLabel: translateMovementType(h.type)
        }))
        
        return { success: true, data: history }
    } catch (error) {
        console.error("Error leyendo historial:", error)
        return { error: "Error al obtener datos" }
    }
}

--- File: inventory-bulk-actions.ts (in subfolder: actions) ---

// src/actions/inventory-bulk-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

type StockImportRow = {
  variantId: string
  quantity: number
  reason: string
}

export async function bulkUpdateStock(rows: StockImportRow[]) {
  let successCount = 0
  let errorCount = 0
  const errors: string[] = []

  try {
    // Usamos transaction para asegurar integridad, pero dado que puede ser mucha data,
    // procesaremos en lote. Si falla uno, no queremos que fallen todos en este caso de uso masivo,
    // as√≠ que iteramos.
    
    for (const row of rows) {
      // 1. Validaciones b√°sicas
      if (!row.variantId) continue;
      if (row.quantity === 0 || isNaN(row.quantity)) continue; // Ignoramos filas vac√≠as o 0

      // 2. Ejecutar Movimiento
      try {
        await prisma.$transaction([
            // A. Registrar Historial
            prisma.stockMovement.create({
                data: {
                    variantId: row.variantId,
                    quantity: row.quantity, // Puede ser positivo (entrada) o negativo (ajuste)
                    type: row.quantity > 0 ? "ENTRY" : "ADJUSTMENT",
                    reason: row.reason || "Carga Masiva Excel",
                    userId: "sistema"
                }
            }),
            // B. Actualizar Contador
            prisma.productVariant.update({
                where: { id: row.variantId },
                data: { stock: { increment: row.quantity } }
            })
        ])
        successCount++
      } catch (err) {
        errorCount++
        errors.push(`ID ${row.variantId}: Fall√≥ actualizaci√≥n.`)
      }
    }

    revalidatePath("/inventory")
    revalidatePath("/products")

    return { success: true, count: successCount, errors }

  } catch (error) {
    console.error("Error bulk stock:", error)
    return { success: false, error: "Error cr√≠tico en el servidor." }
  }
}

--- File: inventory-export-actions.ts (in subfolder: actions) ---

// src/actions/inventory-export-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import ExcelJS from "exceljs"

export async function exportInventorySheet() {
  try {
    const workbook = new ExcelJS.Workbook()
    const worksheet = workbook.addWorksheet("Carga de Stock")

    // Columnas
    worksheet.columns = [
      { header: "ID_VARIANTE (NO TOCAR)", key: "id", width: 32 }, // Columna t√©cnica
      { header: "Producto", key: "productName", width: 25 },
      { header: "Variante", key: "variantName", width: 15 },
      { header: "Due√±o", key: "ownerName", width: 20 },
      { header: "Stock Actual", key: "currentStock", width: 12 },
      { header: "CANTIDAD A SUMAR", key: "quantity", width: 20 }, // Aqu√≠ escribe el usuario
      { header: "MOTIVO (Opcional)", key: "reason", width: 25 },
    ]

    // Estilo Cabecera
    worksheet.getRow(1).font = { bold: true }
    worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0E0E0' } }

    // Obtenemos datos
    const variants = await prisma.productVariant.findMany({
      where: { product: { isActive: true } },
      include: { product: { include: { owner: true } } },
      orderBy: { product: { name: 'asc' } }
    })

    // Llenamos filas
    for (const v of variants) {
      worksheet.addRow({
        id: v.id,
        productName: v.product.name,
        variantName: v.name === 'Est√°ndar' ? '-' : v.name,
        ownerName: v.product.owner.name,
        currentStock: v.stock,
        quantity: "", // Vac√≠o para que el usuario complete
        reason: "Ingreso Masivo"
      })
    }

    // Protegemos las columnas informativas para evitar errores (opcional, pero buena pr√°ctica)
    // worksheet.getColumn('A').hidden = true; // Podr√≠amos ocultar el ID, pero mejor dejarlo visible por transparencia

    const buffer = await workbook.xlsx.writeBuffer()
    const base64 = Buffer.from(buffer).toString("base64")
    
    return { 
        success: true, 
        base64, 
        filename: `Planilla_Stock_${new Date().toISOString().split('T')[0]}.xlsx` 
    }

  } catch (error) {
    console.error("Error exportando stock:", error)
    return { success: false, error: "Error generando planilla." }
  }
}

--- File: note-actions.ts (in subfolder: actions) ---

// src/actions/note-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createNote(formData: FormData) {
  const petId = formData.get("petId") as string
  const content = formData.get("content") as string

  if (!petId || !content) return

  try {
    await prisma.groomingNote.create({
      data: {
        petId,
        content
      }
    })

    // Revalidamos la ruta din√°mica espec√≠fica de esa mascota
    revalidatePath(`/pets/${petId}`)
    return { success: true }

  } catch (error) {
    console.error("Error creando nota:", error)
    return { error: "Error al guardar la nota" }
  }
}

export async function deleteNote(formData: FormData) {
    const id = formData.get("id") as string
    const petId = formData.get("petId") as string
    
    try {
        await prisma.groomingNote.delete({ where: { id } })
        revalidatePath(`/pets/${petId}`)
    } catch (e) {
        console.error(e)
    }
}

--- File: owner-actions.ts (in subfolder: actions) ---

// src/actions/owner-actions.ts
"use server";

import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";

export async function createOwner(formData: FormData) {
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const phone = formData.get("phone") as string;

  if (!name) return { error: "El nombre es obligatorio" };

  try {
    await prisma.owner.create({
      data: { name, email, phone, isActive: true },
    });
    revalidatePath("/owners");
    return { success: true };
  } catch (error) {
    return { error: "Error creando due√±o" };
  }
}

// üëá NUEVA FUNCI√ìN
export async function updateOwner(formData: FormData) {
  const id = formData.get("id") as string;
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const phone = formData.get("phone") as string;

  if (!id || !name) return { error: "Faltan datos" };

  try {
    await prisma.owner.update({
      where: { id },
      data: { name, email, phone },
    });
    
    revalidatePath("/owners");
    return { success: true };
  } catch (error) {
    console.error(error);
    return { error: "Error actualizando due√±o" };
  }
}

--- File: pet-actions.ts (in subfolder: actions) ---

// src/actions/pet-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createPet(formData: FormData) {
  const name = formData.get("name") as string
  const breed = formData.get("breed") as string
  const ownerName = formData.get("ownerName") as string
  const ownerPhone = formData.get("ownerPhone") as string
  const notes = formData.get("notes") as string

  // Validaci√≥n b√°sica
  if (!name || !ownerName || !ownerPhone) {
    return { error: "Faltan datos obligatorios (Nombre, Due√±o, Tel√©fono)" }
  }

  try {
    await prisma.pet.create({
      data: {
        name,
        breed: breed || "Mestizo",
        ownerName,
        ownerPhone,
        notes
      }
    })

    revalidatePath("/pets")
    return { success: true }

  } catch (error) {
    console.error("Error creando mascota:", error)
    return { error: "Error al guardar la ficha." }
  }
}

export async function deletePet(id: string) {
    try {
        await prisma.pet.delete({ where: { id } })
        revalidatePath("/pets")
        return { success: true }
    } catch (error) {
        return { error: "No se puede eliminar (¬øTiene turnos asignados?)" }
    }
}

--- File: product-actions.ts (in subfolder: actions) ---

// src/actions/product-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

// --- TIPOS INTERNOS ---
type VariantInput = {
    id?: string
    name: string
    costPrice: number
    salePrice: number
}

// --- HELPERS DE VALIDACI√ìN ---

// 1. Resolver Categor√≠a (Existente o Nueva)
async function resolveCategoryId(formData: FormData): Promise<string | null> {
    const isNewCategory = formData.get("isNewCategory") === "true"
    if (isNewCategory) {
        const newName = formData.get("categoryName") as string
        if (!newName || newName.trim() === "") return null
        
        // Buscamos case-insensitive para no duplicar "Juguetes" y "juguetes"
        const existing = await prisma.category.findFirst({
            where: { name: { equals: newName, mode: 'insensitive' } }
        })
        if (existing) return existing.id
        
        const created = await prisma.category.create({ data: { name: newName.trim() } })
        return created.id
    }
    return formData.get("categoryId") as string
}

// 2. Validar Reglas de Negocio Financieras
function validateVariants(variants: VariantInput[]): string | null {
    if (!Array.isArray(variants) || variants.length === 0) {
        return "Debe haber al menos una variante."
    }

    for (const v of variants) {
        const cost = Number(v.costPrice)
        const price = Number(v.salePrice)

        // A. Validaci√≥n de Tipo
        if (isNaN(cost) || isNaN(price)) {
            return `Error en variante "${v.name}": Precios inv√°lidos.`
        }

        // B. Validaci√≥n de Signo (No negativos)
        if (cost < 0 || price < 0) {
            return `Error en variante "${v.name}": Los importes no pueden ser negativos.`
        }

        // C. Regla de Oro: Rentabilidad (Precio >= Costo)
        if (price < cost) {
            return `Rentabilidad negativa en "${v.name}". Costo ($${cost}) es mayor a Venta ($${price}).`
        }

        // D. Validaci√≥n de Nombre
        if (!v.name || v.name.trim() === "") {
            return "Todas las variantes deben tener un nombre."
        }
    }

    return null // null significa que pas√≥ todas las validaciones
}


// --- ACTIONS P√öBLICAS ---

export async function createProduct(formData: FormData) {
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const ownerId = formData.get("ownerId") as string
  const imageUrl = formData.get("imageUrl") as string 
  const variantsJson = formData.get("variantsJson") as string

  // 1. Validaciones de Estructura
  const categoryId = await resolveCategoryId(formData)
  if (!name || !ownerId || !categoryId) return { error: "Faltan datos obligatorios." }

  let variants: VariantInput[] = []
  try {
    variants = JSON.parse(variantsJson || "[]")
  } catch (e) {
    return { error: "Error procesando variantes (JSON inv√°lido)." }
  }

  // 2. Validaciones de Negocio (Fail Fast)
  const validationError = validateVariants(variants)
  if (validationError) {
      return { error: validationError }
  }

  try {
    await prisma.$transaction(async (tx) => {
      // 3. Crear Producto Cabecera
      const newProduct = await tx.product.create({
        data: {
          name,
          description,
          ownerId,
          categoryId,
          isActive: true
        }
      })

      // 4. Crear Variantes
      for (const v of variants) {
        await tx.productVariant.create({
            data: {
                productId: newProduct.id,
                name: v.name,
                imageUrl: imageUrl || null, // Comparten imagen por ahora
                costPrice: v.costPrice,
                salePrice: v.salePrice,
                stock: 0 // Regla: Siempre nace en 0. Se carga por Inventario.
            }
        })
      }
    })

    revalidatePath("/products")
  } catch (error) {
    console.error("Error creando:", error)
    return { error: "Error interno al guardar producto." }
  }
  
  redirect("/products")
}

export async function updateProduct(formData: FormData) {
  const id = formData.get("id") as string
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const ownerId = formData.get("ownerId") as string
  const imageUrl = formData.get("imageUrl") as string
  const variantsJson = formData.get("variantsJson") as string
  
  const categoryId = await resolveCategoryId(formData)
  if (!id || !name || !categoryId) return { error: "Datos faltantes" }

  let variants: VariantInput[] = []
  try {
    variants = JSON.parse(variantsJson || "[]")
  } catch (e) {
    return { error: "Error en variantes." }
  }

  // 1. Validaciones de Negocio (Fail Fast)
  const validationError = validateVariants(variants)
  if (validationError) {
      return { error: validationError }
  }

  try {
    await prisma.$transaction(async (tx) => {
      // 2. Actualizar Cabecera
      await tx.product.update({
        where: { id },
        data: { name, description, categoryId, ownerId }
      })

      // 3. Upsert Manual de Variantes
      for (const v of variants) {
        if (v.id) {
            // A. Si tiene ID, actualizamos
            await tx.productVariant.update({
                where: { id: v.id },
                data: {
                    name: v.name,
                    costPrice: v.costPrice,
                    salePrice: v.salePrice,
                    imageUrl: imageUrl || undefined // Actualiza si hay nueva imagen
                }
            })
        } else {
            // B. Si NO tiene ID, creamos
            await tx.productVariant.create({
                data: {
                    productId: id,
                    name: v.name,
                    costPrice: v.costPrice,
                    salePrice: v.salePrice,
                    stock: 0, // Las nuevas variantes nacen sin stock
                    imageUrl: imageUrl || null
                }
            })
        }
      }
    })

    revalidatePath("/products")
    revalidatePath("/pos") 
    return { success: true }

  } catch (error: any) {
    console.error("Error actualizando:", error)
    
    // Manejo de Error de Unicidad (Nombre de variante duplicado en mismo producto)
    if (error.code === 'P2002') {
        return { error: "No pueden haber dos variantes con el mismo nombre." }
    }
    return { error: "No se pudo actualizar el producto." }
  }
}

export async function toggleProductStatus(productId: string, currentStatus: boolean) {
  try {
    // Regla: No archivar si hay stock f√≠sico real
    if (currentStatus === true) { 
      const variantWithStock = await prisma.productVariant.findFirst({ 
        where: { productId, stock: { gt: 0 } }
      })
      if (variantWithStock) {
        return { error: "No se puede archivar: Hay variantes con stock." }
      }
    }
    await prisma.product.update({
      where: { id: productId },
      data: { isActive: !currentStatus }
    })
    revalidatePath("/products")
    revalidatePath("/pos")
    return { success: true }
  } catch (error) {
    return { error: "Error cambiando estado" }
  }
}

--- File: sale-actions.ts (in subfolder: actions) ---

// src/actions/sale-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string
  description: string
  price: number
  quantity: number
}

type PaymentMethod = "CASH" | "TRANSFER"

export async function processSale(
    cart: CartItem[], 
    totalEstimado: number, 
    paymentMethod: PaymentMethod 
) {
  if (cart.length === 0) return { error: "El carrito est√° vac√≠o" }

  try {
    let createdSaleId = ""
    let createdDate = new Date()

    // --- 1. PREPARACI√ìN FUERA DE LA TRANSACCI√ìN ---
    // Buscamos todos los datos necesarios ANTES de bloquear la base de datos.
    // Esto ahorra tiempo de red dentro del t√∫nel de la transacci√≥n.
    const productIds = cart.filter(i => i.type === 'PRODUCT').map(i => i.id)
    
    const dbVariants = await prisma.productVariant.findMany({
      where: { id: { in: productIds } },
      include: { product: true }
    })

    // --- 2. TRANSACCI√ìN CON TIMEOUT EXTENDIDO ---
    await prisma.$transaction(async (tx) => {
      let totalReal = 0
      const saleItemsData = []
      const appointmentIdsToBill: string[] = []

      for (const item of cart) {
        if (item.type === 'PRODUCT') {
            const variant = dbVariants.find(v => v.id === item.id)
            if (!variant) throw new Error(`Producto no encontrado: ${item.description}`)
            
            // ACTUALIZACI√ìN AT√ìMICA DE STOCK
            // Seguimos usando updateMany para el check de stock gte cantidad (Concurrency Safe)
            const updateResult = await tx.productVariant.updateMany({
                where: { 
                    id: item.id,
                    stock: { gte: item.quantity } 
                },
                data: { 
                    stock: { decrement: item.quantity } 
                }
            })

            if (updateResult.count === 0) {
                throw new Error(`Stock insuficiente para: ${variant.product.name}`)
            }

            const subtotal = Number(variant.salePrice) * item.quantity
            totalReal += subtotal

            saleItemsData.push({
                variantId: variant.id,
                description: variant.product.name,
                quantity: item.quantity,
                costAtSale: variant.costPrice,
                priceAtSale: variant.salePrice
            })

            await tx.stockMovement.create({
                data: {
                    variantId: variant.id,
                    quantity: -item.quantity,
                    type: "SALE",
                    reason: "Venta Mostrador",
                    userId: "sistema"
                }
            })
        } 
        else if (item.type === 'SERVICE') {
            const subtotal = item.price * item.quantity
            totalReal += subtotal

            saleItemsData.push({
                variantId: null,
                description: item.description,
                quantity: item.quantity,
                costAtSale: 0,
                priceAtSale: item.price
            })

            appointmentIdsToBill.push(item.id)
        }
      }

      const sale = await tx.sale.create({
        data: {
          total: totalReal,
          paymentMethod: paymentMethod, 
          status: "COMPLETED",
          items: {
            create: saleItemsData
          }
        }
      })
      
      createdSaleId = sale.id
      createdDate = sale.createdAt

      if (appointmentIdsToBill.length > 0) {
        await tx.appointment.updateMany({
            where: { id: { in: appointmentIdsToBill } },
            data: { status: 'BILLED' }
        })
      }
    }, {
      // CONFIGURACI√ìN DE TIMEOUT (Soluci√≥n al error de expiraci√≥n)
      maxWait: 10000, // Tiempo m√°ximo para esperar a obtener una conexi√≥n (10s)
      timeout: 20000  // Tiempo m√°ximo de ejecuci√≥n de la transacci√≥n (20s)
    })

    revalidatePath("/products")
    revalidatePath("/pos")
    revalidatePath("/agenda")
    revalidatePath("/dashboard")
    
    return { success: true, saleId: createdSaleId, date: createdDate }

  } catch (error: any) {
    console.error("Error en venta:", error)
    return { error: error.message || "Error al procesar venta" }
  }
}

export async function cancelSale(saleId: string) {
  try {
    await prisma.$transaction(async (tx) => {
      const sale = await tx.sale.findUnique({
        where: { id: saleId },
        include: { items: { include: { variant: { include: { product: true } } } } } 
      })

      if (!sale) throw new Error("Venta no encontrada")
      if (sale.status === 'CANCELLED') throw new Error("Esta venta ya est√° anulada")

      await tx.sale.update({
        where: { id: saleId },
        data: { status: 'CANCELLED' }
      })

      for (const item of sale.items) {
        if (item.variantId && item.variant) {
          await tx.productVariant.update({
            where: { id: item.variantId },
            data: { stock: { increment: item.quantity } }
          })

          await tx.stockMovement.create({
            data: {
              variantId: item.variantId,
              quantity: item.quantity,
              type: 'SALE_CANCELLED',
              reason: `Anulaci√≥n Venta #${sale.id.slice(0, 8)}`,
              userId: 'sistema'
            }
          })

          if (item.isSettled) {
            const amountOwedBack = Number(item.costAtSale) * item.quantity
            await tx.balanceAdjustment.create({
              data: {
                ownerId: item.variant.product.ownerId,
                amount: -amountOwedBack,
                description: `Devoluci√≥n Liq. - Prod: ${item.description}`,
                isApplied: false
              }
            })
          }
        }
      }
    }, {
      maxWait: 10000,
      timeout: 20000
    })

    revalidatePath("/sales")
    revalidatePath("/products") 
    revalidatePath("/owners/balance")
    revalidatePath("/dashboard")
    return { success: true }

  } catch (error: any) {
    console.error("Error anulando venta:", error)
    return { error: error.message || "Error al anular venta" }
  }
}

--- File: settlement-actions.ts (in subfolder: actions) ---

// src/actions/settlement-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createSettlement(formData: FormData) {
  const ownerId = formData.get("ownerId") as string
  
  if (!ownerId) return { error: "ID de due√±o requerido" }

  try {
    // 1. BUSCAR CANDIDATOS (Snapshot)
    // No usamos el servicio gen√©rico getOwnerBalance aqu√≠ porque necesitamos los IDs espec√≠ficos
    // para "congelar" la liquidaci√≥n y evitar race conditions.

    const pendingSaleItems = await prisma.saleItem.findMany({
      where: {
        isSettled: false,
        variant: { product: { ownerId: ownerId } }
      },
      select: { id: true, costAtSale: true, quantity: true }
    })

    const pendingAdjustments = await prisma.balanceAdjustment.findMany({
      where: {
        ownerId: ownerId,
        isApplied: false
      },
      select: { id: true, amount: true }
    })

    // 2. CALCULAR TOTAL A PAGAR (En memoria)
    const debtFromSales = pendingSaleItems.reduce((sum, item) => {
        return sum + (Number(item.costAtSale) * item.quantity)
    }, 0)

    const debtFromAdjustments = pendingAdjustments.reduce((sum, adj) => {
        return sum + Number(adj.amount)
    }, 0)

    const totalToPay = debtFromSales + debtFromAdjustments

    // 3. VALIDACI√ìN FINANCIERA
    // Solo permitimos liquidar si el saldo es positivo (A favor del due√±o).
    // Si es negativo (El due√±o nos debe), esperamos a que venda m√°s cosas para compensar.
    if (totalToPay <= 0) {
        return { 
            error: `No se puede liquidar. El saldo es $${totalToPay.toLocaleString()}. Solo se registran pagos cuando hay deuda a favor del due√±o.` 
        }
    }

    // 4. TRANSACCI√ìN DE ESCRITURA (Atomicidad Estricta)
    await prisma.$transaction(async (tx) => {
      
      // A. Crear Recibo (Settlement)
      const newSettlement = await tx.settlement.create({
        data: {
          ownerId,
          totalAmount: totalToPay,
        }
      })

      // B. Marcar items espec√≠ficos como pagados
      // Usamos los IDs capturados en el paso 1. Si entr√≥ una venta nueva hace 1ms, 
      // no est√° en esta lista y quedar√° para la pr√≥xima. Seguro.
      if (pendingSaleItems.length > 0) {
          await tx.saleItem.updateMany({
            where: {
              id: { in: pendingSaleItems.map(i => i.id) }
            },
            data: { isSettled: true, settlementId: newSettlement.id }
          })
      }

      // C. Marcar ajustes espec√≠ficos como aplicados
      if (pendingAdjustments.length > 0) {
          await tx.balanceAdjustment.updateMany({
              where: { 
                  id: { in: pendingAdjustments.map(a => a.id) }
              },
              data: { isApplied: true, settlementId: newSettlement.id }
          })
      }
    })

    revalidatePath("/owners/balance")
    revalidatePath(`/owners/settlement/${ownerId}`)
    revalidatePath(`/owners/${ownerId}`)
    
  } catch (error) {
    console.error("Error en liquidaci√≥n:", error)
    return { error: "Error interno al procesar el pago." }
  }

  // √âxito: Redirigir al balance general
  redirect("/owners/balance")
}

--- File: layout.tsx (in subfolder: app) ---

import type { Metadata } from "next";
import { Inter, Nunito } from "next/font/google";
import "./globals.css";
import MainNav from "@/components/MainNav";
import { Toaster } from "@/components/ui/Toast";
import { ThemeProvider } from "@/components/ThemeProvider"; // üëà Importar

const inter = Inter({ subsets: ["latin"], variable: '--font-inter' });
const nunito = Nunito({ subsets: ["latin"], variable: '--font-nunito' });

export const metadata: Metadata = {
  title: "Guapecanes",
  description: "Gesti√≥n v3.0",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body className={`${inter.variable} ${nunito.variable} antialiased min-h-screen bg-background text-foreground font-sans`}>
        
        {/* Envolvemos todo con el ThemeProvider */}
        <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
        >
            <div className="flex flex-col md:flex-row min-h-screen">
              <MainNav />
              <main className="flex-1 pb-24 md:pb-0 relative overflow-y-auto h-screen custom-scrollbar">
                {children}
              </main>
            </div>
            
            <Toaster />
        </ThemeProvider>

      </body>
    </html>
  );
}

--- File: page.tsx (in subfolder: app) ---

import Image from "next/image";

export default function Home() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
        <Image
          className="dark:invert"
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-zinc-50">
            To get started, edit the page.tsx file.
          </h1>
          <p className="max-w-md text-lg leading-8 text-zinc-600 dark:text-zinc-400">
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
          <a
            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className="dark:invert"
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}


--- File: page.tsx (in subfolder: app\agenda) ---

// src/app/agenda/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import AppointmentForm from "@/components/AppointmentForm"
import AppointmentCard from "@/components/AppointmentCard" // üëà Importamos

interface Props {
  searchParams: Promise<{ date?: string }>
}

export default async function AgendaPage({ searchParams }: Props) {
  const { date } = await searchParams
  
  // L√≥gica de fechas
  const todayStr = new Date().toISOString().split('T')[0]
  const selectedDateStr = date || todayStr

  // Rangos de b√∫squeda (Local Day)
  const startOfDay = new Date(`${selectedDateStr}T00:00:00`)
  const endOfDay = new Date(`${selectedDateStr}T23:59:59`)

  // 1. Datos para el Formulario
  const pets = await prisma.pet.findMany({ 
    orderBy: { name: 'asc' },
    select: { id: true, name: true, breed: true }
  })

  // 2. Datos de Turnos
  const appointments = await prisma.appointment.findMany({
    where: {
      startTime: { gte: startOfDay, lte: endOfDay },
      status: { not: 'CANCELLED' }
    },
    include: { pet: true },
    orderBy: { startTime: 'asc' }
  })

  return (
    <div className="p-6 max-w-7xl mx-auto">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 className="text-3xl font-bold text-gray-800">Agenda de Turnos</h1>
            <p className="text-gray-500 text-sm">Organiza el flujo de trabajo diario.</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {/* COLUMNA IZQUIERDA: LISTADO (2/3 de ancho) */}
        <div className="lg:col-span-2 space-y-4">
            
            {/* Barra de Fecha */}
            <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-wrap items-center gap-4 justify-between">
                <div className="flex items-center gap-2">
                    <span className="text-xl">üìÖ</span>
                    <form className="flex gap-2 items-center">
                        <input 
                            type="date" 
                            name="date" 
                            defaultValue={selectedDateStr} 
                            className="border p-2 rounded text-gray-700 font-medium focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-blue-700">
                            Ir
                        </button>
                    </form>
                </div>
                
                {selectedDateStr !== todayStr && (
                     <Link href="/agenda" className="text-sm font-bold text-blue-600 hover:underline">
                        Volver a Hoy
                     </Link>
                )}
            </div>

            {/* Grilla de Turnos */}
            <div className="space-y-3 min-h-[300px]">
                {appointments.length === 0 ? (
                    <div className="flex flex-col items-center justify-center text-gray-400 py-20 bg-gray-50 rounded-lg border border-dashed">
                        <span className="text-4xl mb-2 opacity-50">üò¥</span>
                        <p>No hay turnos para esta fecha.</p>
                    </div>
                ) : (
                    // Renderizamos cada turno usando el componente nuevo
                    appointments.map(appt => (
                        <AppointmentCard key={appt.id} appt={appt} />
                    ))
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: FORMULARIO (1/3 de ancho) */}
        <div className="lg:col-span-1">
            <div className="sticky top-6">
                <AppointmentForm pets={pets} selectedDate={selectedDateStr} />
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\categories) ---

// src/app/categories/page.tsx
import { createCategory } from "@/actions/category-actions"
import { prisma } from "@/lib/prisma"

export default async function CategoriesPage() {
  const categories = await prisma.category.findMany({
    orderBy: { name: 'asc' } // Orden alfab√©tico
  })

  return (
    <div className="p-10 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Categor√≠as de Productos</h1>

      {/* FORMULARIO */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-10 border">
        <form action={createCategory} className="flex gap-4">
          <input 
            name="name" 
            type="text" 
            required 
            className="border p-2 rounded flex-1" 
            placeholder="Ej: Alimentos, Accesorios..."
          />
          <button 
            type="submit" 
            className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          >
            Agregar
          </button>
        </form>
      </div>

      {/* LISTADO */}
      <div className="grid grid-cols-2 gap-4">
        {categories.map((cat) => (
          <div key={cat.id} className="border p-4 rounded bg-gray-50 flex justify-between items-center">
            <span className="font-semibold">{cat.name}</span>
            <span className="text-xs text-gray-400">ID: {cat.id.slice(0, 8)}...</span>
          </div>
        ))}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\dashboard) ---

// src/app/dashboard/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { getLocalDateISO } from "@/lib/utils"

export default async function DashboardPage() {
  const now = new Date()
  const todayStr = getLocalDateISO() 
  const startOfToday = new Date(`${todayStr}T00:00:00`)
  const endOfToday = new Date(`${todayStr}T23:59:59`)

  // Consultas Paralelas (Mantenemos esta buena pr√°ctica)
  const [todaySales, todayAppointments, lowStockVariants] = await Promise.all([
    // Ventas Hoy
    prisma.sale.findMany({
      where: {
        status: "COMPLETED",
        createdAt: { gte: startOfToday, lte: endOfToday }
      }
    }),
    // Turnos Hoy
    prisma.appointment.findMany({
      where: {
        startTime: { gte: startOfToday, lte: endOfToday },
        status: { not: 'CANCELLED' }
      },
      include: { pet: true },
      orderBy: { startTime: 'asc' }
    }),
    // Stock Bajo (Aumentamos l√≠mite para que sea √∫til)
    prisma.productVariant.findMany({
      where: { stock: { lte: 3 } },
      include: { product: true },
      orderBy: { stock: 'asc' },
      take: 5
    })
  ])

  // C√°lculos r√°pidos
  const stats = todaySales.reduce((acc, sale) => {
    const amount = Number(sale.total)
    acc.total += amount
    if (sale.paymentMethod === 'CASH') acc.cash += amount
    else acc.digital += amount
    return acc
  }, { total: 0, cash: 0, digital: 0 })

  return (
    <div className="p-6 md:p-10 max-w-[1600px] mx-auto space-y-8">
      
      {/* HERO SECTION */}
      <div className="flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
          <h1 className="text-4xl font-black text-slate-800 font-nunito tracking-tight">
            Hola, Equipo üëã
          </h1>
          <p className="text-slate-500 font-medium mt-1">
            Resumen de hoy, {new Date().toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' })}.
          </p>
        </div>
        <Link href="/pos" className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-indigo-200 transition active:scale-95 flex items-center gap-2">
            üõí Abrir Caja
        </Link>
      </div>

      {/* KPI GRID */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* Total Card */}
        <div className="bg-slate-900 text-white p-8 rounded-3xl shadow-xl relative overflow-hidden group">
            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-[60px] opacity-20 group-hover:opacity-40 transition"></div>
            <p className="text-slate-400 font-bold uppercase tracking-widest text-xs mb-2">Ventas Netas</p>
            <p className="text-5xl font-black font-nunito">${stats.total.toLocaleString()}</p>
            <div className="mt-6 flex gap-6">
                <div>
                    <span className="block text-green-400 font-bold text-lg">${stats.cash.toLocaleString()}</span>
                    <span className="text-slate-500 text-xs font-bold uppercase">Efectivo</span>
                </div>
                <div className="w-px bg-slate-700"></div>
                <div>
                    <span className="block text-blue-400 font-bold text-lg">${stats.digital.toLocaleString()}</span>
                    <span className="text-slate-500 text-xs font-bold uppercase">Digital</span>
                </div>
            </div>
        </div>

        {/* Appointments Summary */}
        <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition">
            <div>
                <p className="text-slate-400 font-bold uppercase tracking-widest text-xs mb-2">Turnos Hoy</p>
                <p className="text-4xl font-black text-slate-800 font-nunito">{todayAppointments.length}</p>
            </div>
            <div className="mt-4">
                <div className="flex -space-x-2 overflow-hidden">
                    {/* Avatares falsos para efecto visual UI */}
                    {todayAppointments.slice(0, 4).map(appt => (
                        <div key={appt.id} className="inline-block h-10 w-10 rounded-full ring-2 ring-white bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs" title={appt.pet.name}>
                            {appt.pet.name.slice(0,2)}
                        </div>
                    ))}
                    {todayAppointments.length > 4 && (
                        <div className="inline-block h-10 w-10 rounded-full ring-2 ring-white bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                            +{todayAppointments.length - 4}
                        </div>
                    )}
                </div>
                <Link href="/agenda" className="text-indigo-600 text-sm font-bold mt-2 block hover:underline">Ver agenda completa ‚Üí</Link>
            </div>
        </div>

        {/* Stock Alert */}
        <div className="bg-orange-50 p-8 rounded-3xl border border-orange-100 flex flex-col justify-between">
            <div>
                 <div className="flex justify-between items-start">
                    <p className="text-orange-800/60 font-bold uppercase tracking-widest text-xs mb-2">Atenci√≥n Requerida</p>
                    <span className="bg-orange-200 text-orange-800 text-xs font-bold px-2 py-1 rounded-lg">Stock</span>
                 </div>
                <p className="text-4xl font-black text-orange-900 font-nunito">{lowStockVariants.length}</p>
                <p className="text-orange-800/80 text-sm font-medium mt-1">Productos por agotarse</p>
            </div>
            <Link href="/inventory" className="text-orange-700 text-sm font-bold mt-2 hover:text-orange-900">Reponer inventario ‚Üí</Link>
        </div>
      </div>

      {/* DETAILED SECTIONS */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* Pr√≥ximos Turnos */}
        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
            <h3 className="font-bold text-xl text-slate-800 mb-6 font-nunito">üìÖ Pr√≥ximos Clientes</h3>
            {todayAppointments.length === 0 ? (
                <div className="p-8 text-center text-slate-400 bg-slate-50 rounded-2xl border border-dashed">
                    Todo tranquilo por hoy üò¥
                </div>
            ) : (
                <div className="space-y-4">
                    {todayAppointments.slice(0, 5).map(appt => (
                        <div key={appt.id} className="flex items-center gap-4 p-3 hover:bg-slate-50 rounded-2xl transition group">
                            <div className="bg-indigo-50 text-indigo-700 font-bold text-xs px-3 py-2 rounded-xl border border-indigo-100">
                                {appt.startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                            </div>
                            <div className="flex-1">
                                <p className="font-bold text-slate-800 group-hover:text-indigo-600 transition">{appt.pet.name}</p>
                                <p className="text-xs text-slate-500">{appt.pet.breed} ‚Ä¢ {appt.pet.ownerName}</p>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase
                                ${appt.status === 'PENDING' ? 'bg-yellow-100 text-yellow-700' : ''}
                                ${appt.status === 'CONFIRMED' ? 'bg-blue-100 text-blue-700' : ''}
                                ${appt.status === 'COMPLETED' ? 'bg-green-100 text-green-700' : ''}
                                ${appt.status === 'BILLED' ? 'bg-slate-100 text-slate-500' : ''}
                            `}>
                                {appt.status === 'BILLED' ? 'COBRADO' : appt.status}
                            </span>
                        </div>
                    ))}
                </div>
            )}
        </div>

        {/* Alertas de Inventario */}
        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
            <h3 className="font-bold text-xl text-slate-800 mb-6 font-nunito">‚ö†Ô∏è Stock Cr√≠tico</h3>
            <div className="space-y-3">
                {lowStockVariants.map(v => (
                    <div key={v.id} className="flex items-center justify-between p-3 border border-slate-100 rounded-2xl hover:border-red-200 hover:bg-red-50/50 transition">
                        <div className="flex items-center gap-3">
                            <div className={`w-2 h-12 rounded-full ${v.stock === 0 ? 'bg-red-500' : 'bg-orange-400'}`}></div>
                            <div>
                                <p className="font-bold text-slate-700 text-sm">{v.product.name}</p>
                                <p className="text-xs text-slate-500">{v.name}</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <p className={`font-black text-lg ${v.stock === 0 ? 'text-red-600' : 'text-orange-500'}`}>
                                {v.stock}
                            </p>
                            <p className="text-[10px] font-bold text-slate-400 uppercase">Unid.</p>
                        </div>
                    </div>
                ))}
                {lowStockVariants.length === 0 && (
                    <div className="p-8 text-center text-green-600 bg-green-50 rounded-2xl border border-green-100">
                        ‚úÖ Inventario saludable
                    </div>
                )}
            </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\inventory) ---

// src/app/inventory/page.tsx
import { prisma } from "@/lib/prisma"
import StockMovementForm from "@/components/StockMovementForm"
import InventoryImporter from "@/components/InventoryImporter"
import SearchInput from "@/components/SearchInput" // üëà Reutilizamos tu buscador
import Link from "next/link"

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function InventoryPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  // OPTIMIZACI√ìN: Solo traemos datos si hay b√∫squeda o limitamos a los primeros 20
  // Esto evita cargar 1000 productos en el <select> de golpe.
  const products = await prisma.product.findMany({
    where: { 
        isActive: true,
        OR: query ? [
            { name: { contains: query, mode: 'insensitive' } },
            { variants: { some: { name: { contains: query, mode: 'insensitive' } } } }
        ] : undefined
    },
    include: { variants: true, owner: true },
    orderBy: { name: 'asc' },
    take: query ? 100 : 20 // Si busca, damos m√°s margen. Si no, solo los top 20.
  })

  // Aplanamos la lista
  const productOptions = products.flatMap(p => 
    p.variants.map(v => ({
        variantId: v.id,
        productName: v.name === 'Est√°ndar' ? p.name : `${p.name} - ${v.name}`,
        ownerName: p.owner.name,
        stock: v.stock
    }))
  )
  productOptions.sort((a, b) => a.productName.localeCompare(b.productName))

  return (
    <div className="p-8 max-w-4xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-gray-800">Control de Stock</h1>
        <Link href="/products" className="text-blue-600 hover:underline text-sm font-bold">
            ‚Üê Volver a Lista
        </Link>
      </div>

      <InventoryImporter />

      <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <h2 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Movimiento Manual</h2>
        
        {/* BUSCADOR PARA FILTRAR EL SELECT */}
        <div className="mb-6">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">
                1. Busc√° el producto para habilitarlo en la lista:
            </label>
            <SearchInput placeholder="Escrib√≠ para buscar (Ej: Buzo, Collar)..." />
        </div>

        {productOptions.length > 0 ? (
            <StockMovementForm products={productOptions} />
        ) : (
            <div className="text-center p-4 bg-gray-50 rounded text-gray-500 text-sm">
                {query ? "No se encontraron productos." : "Us√° el buscador para encontrar el producto a ajustar."}
            </div>
        )}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners) ---

// src/app/owners/page.tsx
import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm" 
import SearchInput from "@/components/SearchInput" 
import Link from "next/link"

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function OwnersPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  const owners = await prisma.owner.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { email: { contains: query, mode: 'insensitive' } },
            { phone: { contains: query, mode: 'insensitive' } }
        ]
    } : undefined,
    orderBy: { createdAt: 'desc' }
  })

  return (
    <div className="p-10 max-w-6xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-gray-800">Gesti√≥n de Due√±os</h1>
      </div>

      <div className="mb-8 max-w-md">
        <SearchInput placeholder="Buscar por nombre, mail o tel√©fono..." />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO ALTA */}
        <div className="md:col-span-1">
            <div className="sticky top-6">
                <OwnerForm /> 
            </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="md:col-span-2 grid gap-4">
            {owners.map((owner) => (
            <div key={owner.id} className="border p-4 rounded-lg bg-white shadow-sm hover:shadow-md transition flex justify-between items-center group">
                {/* Click en toda el √°rea (excepto botones) lleva al perfil */}
                <Link href={`/owners/${owner.id}`} className="flex-1 cursor-pointer">
                    <div className="flex items-center gap-2">
                        <p className="font-bold text-lg text-gray-800 group-hover:text-blue-600 transition">
                            {owner.name}
                        </p>
                        {owner.isActive ? (
                            <span className="w-2 h-2 rounded-full bg-green-500" title="Activo"></span>
                        ) : (
                            <span className="w-2 h-2 rounded-full bg-red-500" title="Inactivo"></span>
                        )}
                    </div>
                    <p className="text-gray-500 text-sm mt-1">
                        üìß {owner.email || "Sin email"}
                    </p>
                    <p className="text-gray-500 text-sm">
                        üìû {owner.phone || "Sin tel√©fono"}
                    </p>
                </Link>
                
                {/* BOT√ìN PERFIL */}
                <div className="flex gap-2">
                    <Link 
                        href={`/owners/${owner.id}`}
                        className="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-black transition"
                    >
                        PERFIL
                    </Link>
                </div>
            </div>
            ))}
            
            {owners.length === 0 && (
            <div className="p-10 text-center text-gray-400 border-2 border-dashed rounded-lg bg-gray-50">
                {query ? "No se encontraron due√±os." : "No hay due√±os registrados."}
            </div>
            )}
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\balance) ---

// src/app/owners/balance/page.tsx
import { prisma } from "@/lib/prisma";
import Link from "next/link";

export default async function OwnersBalancePage() {
  // 1. LA CONSULTA MAESTRA ACTUALIZADA
  // Buscamos due√±os, sus ventas pendientes Y sus ajustes pendientes
  const ownersData = await prisma.owner.findMany({
    where: { isActive: true },
    include: {
      // A. Ventas pendientes (Deuda del Local -> Due√±o)
      products: {
        include: {
          variants: {
            include: {
              saleItems: {
                where: { isSettled: false },
              },
            },
          },
        },
      },
      // B. Ajustes pendientes (Deuda del Due√±o -> Local, usualmente negativo)
      balanceAdjustments: {
        where: { isApplied: false }
      }
    },
  });

  // 2. PROCESAMIENTO DE DATOS
  const report = ownersData.map((owner) => {
    let debtFromSales = 0;
    let debtFromAdjustments = 0;
    let itemsCount = 0;

    // A. Sumar deuda por ventas (Mercader√≠a vendida y no pagada)
    owner.products.forEach((product) => {
      product.variants.forEach((variant) => {
        variant.saleItems.forEach((item) => {
          debtFromSales += Number(item.costAtSale) * item.quantity;
          itemsCount += item.quantity;
        });
      });
    });

    // B. Sumar deuda por ajustes (Devoluciones de ventas ya pagadas)
    owner.balanceAdjustments.forEach(adjustment => {
      debtFromAdjustments += Number(adjustment.amount);
    });

    // C. Deuda Neta Total (Suma algebraica)
    // Ejemplo: Ventas ($1000) + Devoluci√≥n (-$200) = Total a Pagar ($800)
    const totalDebt = debtFromSales + debtFromAdjustments;

    return {
      ownerId: owner.id,
      name: owner.name,
      phone: owner.phone,
      totalDebt,
      itemsCount,
      hasAdjustments: owner.balanceAdjustments.length > 0
    };
  });

  // Filtramos: Mostramos si hay deuda O si hay saldo a favor del local (deuda negativa)
  const ownersWithActivity = report
    .filter((r) => r.totalDebt !== 0)
    .sort((a, b) => b.totalDebt - a.totalDebt);

  const ownersClean = report.filter((r) => r.totalDebt === 0);

  return (
    <div className="p-10 max-w-5xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">
          Estado de Cuenta
        </h1>
        <div className="bg-slate-800 text-white px-6 py-3 rounded-lg font-bold shadow-lg">
          Total a Pagar: $
          {report.reduce((sum, r) => sum + r.totalDebt, 0).toLocaleString()}
        </div>
      </div>

      {/* TABLA DE DEUDAS */}
      <div className="bg-white rounded-lg shadow overflow-hidden border mb-10">
        <table className="w-full text-left">
          <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold border-b">
            <tr>
              <th className="p-4">Due√±o</th>
              <th className="p-4 text-center">Items Pend.</th>
              <th className="p-4 text-right">Saldo Neto</th>
              <th className="p-4 text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {ownersWithActivity.map((row) => (
              <tr key={row.ownerId} className="hover:bg-blue-50 transition">
                <td className="p-4">
                  <p className="font-bold text-lg text-gray-800">{row.name}</p>
                  <p className="text-xs text-gray-500">
                    {row.phone || "Sin tel√©fono"}
                  </p>
                  {row.hasAdjustments && (
                    <span className="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded border border-yellow-200 inline-block mt-1">
                      ‚ö†Ô∏è Incluye ajustes/devoluciones
                    </span>
                  )}
                </td>
                
                <td className="p-4 text-center font-mono text-lg text-gray-600">
                  {row.itemsCount}
                </td>
                
                <td className="p-4 text-right">
                  <span className={`text-xl font-bold ${row.totalDebt >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                    ${row.totalDebt.toLocaleString()}
                  </span>
                  {row.totalDebt < 0 && (
                     <p className="text-xs text-green-600 font-bold">Saldo a favor Local</p>
                  )}
                </td>
                
                <td className="p-4 text-center">
                  <Link
                    href={`/owners/settlement/${row.ownerId}`}
                    className="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700 shadow inline-block font-medium"
                  >
                    Ver Detalle
                  </Link>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {ownersWithActivity.length === 0 && (
          <div className="p-10 text-center text-gray-500 text-lg">
            ‚úÖ ¬°Todo al d√≠a! No hay saldos pendientes.
          </div>
        )}
      </div>

      {/* DUE√ëOS AL D√çA */}
      {ownersClean.length > 0 && (
        <details className="mt-8">
          <summary className="cursor-pointer text-gray-500 font-medium hover:text-gray-700 select-none">
            Ver due√±os sin saldo pendiente ({ownersClean.length})
          </summary>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 opacity-75">
            {ownersClean.map((o) => (
              <div
                key={o.ownerId}
                className="border p-3 rounded bg-gray-50 text-sm flex justify-between"
              >
                <span>{o.name}</span>
                <span className="text-green-600 font-bold">‚úì</span>
              </div>
            ))}
          </div>
        </details>
      )}
    </div>
  );
}

--- File: page.tsx (in subfolder: app\owners\settlement\[id]) ---

// src/app/owners/settlement/[id]/page.tsx

import { prisma } from "@/lib/prisma"
import { createSettlement } from "@/actions/settlement-actions"
import Link from "next/link"
import SettlementButton from "@/components/SettlementButton"

interface Props {
  params: Promise<{ id: string }>
}

export default async function SettlementPage({ params }: Props) {
  const { id } = await params
  
  // 1. Buscamos al due√±o, sus ventas pendientes Y sus ajustes pendientes
  const owner = await prisma.owner.findUnique({
    where: { id },
    include: {
      // A. Ventas
      products: {
        include: {
          variants: {
            include: {
              saleItems: {
                where: { isSettled: false },
                include: { sale: true }
              }
            }
          }
        }
      },
      // B. Ajustes
      balanceAdjustments: {
        where: { isApplied: false }
      }
    }
  })

  if (!owner) {
    return (
      <div className="p-10 text-center">
        <h1 className="text-xl text-red-600">Due√±o no encontrado</h1>
        <Link href="/owners/balance" className="text-blue-500 underline">Volver</Link>
      </div>
    )
  }

  // 2. Unificar listas (Ventas + Ajustes) para la tabla
  let totalToPay = 0
  const detailRows: any[] = []

  // Procesar Ventas
  owner.products.forEach(p => {
    p.variants.forEach(v => {
      v.saleItems.forEach(item => {
        const subtotal = Number(item.costAtSale) * item.quantity
        totalToPay += subtotal
        
        detailRows.push({
          id: item.id,
          type: 'SALE',
          date: item.sale.createdAt,
          description: `${item.description} (${item.quantity} u.)`,
          amount: subtotal
        })
      })
    })
  })

  // Procesar Ajustes
  owner.balanceAdjustments.forEach(adj => {
    const amount = Number(adj.amount)
    totalToPay += amount
    
    detailRows.push({
      id: adj.id,
      type: 'ADJUSTMENT',
      date: adj.createdAt,
      description: adj.description, // Ej: "Devoluci√≥n Venta..."
      amount: amount
    })
  })

  // Ordenar cronol√≥gicamente
  detailRows.sort((a, b) => a.date.getTime() - b.date.getTime())

  return (
    <div className="p-8 max-w-4xl mx-auto">
      
      {/* CABECERA */}
      <div className="mb-8">
        <Link href="/owners/balance" className="text-blue-600 hover:underline mb-4 block">
          ‚Üê Volver al Balance General
        </Link>
        <h1 className="text-3xl font-bold text-gray-800">
          Liquidaci√≥n: {owner.name}
        </h1>
        <p className="text-gray-500">Revis√° el detalle antes de pagar.</p>
      </div>

      {/* CAJA DE RESUMEN Y ACCI√ìN */}
      <div className="bg-gray-50 p-6 rounded-lg border flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 shadow-sm">
        <div>
            <p className="text-sm text-gray-500 uppercase font-bold">Total Neto a Pagar</p>
            <p className={`text-4xl font-bold ${totalToPay >= 0 ? 'text-gray-800' : 'text-green-600'}`}>
                ${totalToPay.toLocaleString()}
            </p>
            {totalToPay < 0 && <span className="text-xs text-green-600 font-bold">Saldo a favor del local</span>}
        </div>
        
        {/* Solo mostramos el bot√≥n si hay algo que mover (positivo o negativo) */}
        {detailRows.length > 0 ? (
          <form action={createSettlement}>
            <input type="hidden" name="ownerId" value={owner.id} />
            <SettlementButton />
          </form>
        ) : (
          <div className="bg-green-100 text-green-800 px-4 py-2 rounded font-bold">
             DUE√ëO AL D√çA
          </div>
        )}
      </div>

      {/* TABLA DE DETALLE */}
      <div className="bg-white rounded shadow overflow-hidden border">
        <table className="w-full text-left text-sm">
          <thead className="bg-gray-100 text-gray-700 uppercase">
            <tr>
              <th className="p-3">Fecha</th>
              <th className="p-3">Concepto</th>
              <th className="p-3 text-right">Monto</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {detailRows.map(row => (
              <tr key={row.id} className="hover:bg-gray-50">
                <td className="p-3 text-gray-500">
                    {row.date.toLocaleDateString()}
                </td>
                
                <td className="p-3 font-medium text-gray-800">
                    {/* Iconos visuales para distinguir */}
                    {row.type === 'SALE' ? (
                        <span className="text-blue-600 mr-2">üõí</span> 
                    ) : (
                        <span className="text-orange-500 mr-2">‚Ü©Ô∏è</span>
                    )}
                    {row.description}
                </td>
                
                <td className={`p-3 text-right font-bold ${row.amount < 0 ? 'text-green-600' : 'text-gray-800'}`}>
                    {/* Formato de moneda */}
                    {row.amount < 0 ? '' : ''}${row.amount.toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        
        {detailRows.length === 0 && (
            <div className="p-10 text-center text-gray-400">
                Este due√±o no tiene movimientos pendientes.
            </div>
        )}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\[id]) ---

// src/app/owners/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { notFound } from "next/navigation"

interface Props {
  params: Promise<{ id: string }>
}

export default async function OwnerProfilePage({ params }: Props) {
  const { id } = await params

  // 1. Buscamos TODOS los datos del due√±o
  const owner = await prisma.owner.findUnique({
    where: { id },
    include: {
      // A. Sus productos y stock actual
      products: {
        where: { isActive: true },
        include: { variants: true }
      },
      // B. Historial de Pagos (Liquidaciones pasadas)
      settlements: {
        orderBy: { createdAt: 'desc' },
        take: 20 // √öltimos 20 pagos
      },
      // C. Deuda Pendiente
      balanceAdjustments: { where: { isApplied: false } }
    }
  })

  if (!owner) return notFound()

  // 2. C√ÅLCULOS
  const activeInventory = owner.products.flatMap(p => 
    p.variants.filter(v => v.stock > 0).map(v => ({
      name: v.name === 'Est√°ndar' ? p.name : `${p.name} - ${v.name}`,
      // ‚ö†Ô∏è CORRECCI√ìN AQU√ç: Convertimos Decimal a Number
      price: Number(v.salePrice),
      cost: Number(v.costPrice),
      stock: v.stock,
      image: v.imageUrl
    }))
  )

  // Calcular Deuda Pendiente
  const pendingItems = await prisma.saleItem.findMany({
    where: {
      isSettled: false,
      variant: { product: { ownerId: id } }
    }
  })

  const debtFromSales = pendingItems.reduce((sum, item) => sum + (Number(item.costAtSale) * item.quantity), 0)
  const debtFromAdj = owner.balanceAdjustments.reduce((sum, adj) => sum + Number(adj.amount), 0)
  const totalDebt = debtFromSales + debtFromAdj

  return (
    <div className="p-8 max-w-6xl mx-auto">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-start gap-6 mb-8">
        <div>
            <Link href="/owners" className="text-sm text-blue-600 hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-bold text-gray-800 flex items-center gap-3">
                {owner.name}
                {!owner.isActive && <span className="text-sm bg-red-100 text-red-600 px-2 py-1 rounded">INACTIVO</span>}
            </h1>
            <div className="mt-2 text-gray-600 space-y-1">
                <p>üìß {owner.email || "Sin email"}</p>
                <p>üìû {owner.phone || "Sin tel√©fono"}</p>
            </div>
            <div className="mt-4">
                <Link 
                    href={`/owners/${owner.id}/edit`}
                    className="text-xs font-bold bg-gray-100 text-gray-600 px-3 py-1.5 rounded border hover:bg-gray-200"
                >
                    ‚úèÔ∏è EDITAR DATOS
                </Link>
            </div>
        </div>

        {/* CAJA DE ESTADO DE CUENTA */}
        <div className={`p-6 rounded-lg shadow-lg border text-white min-w-[300px]
            ${totalDebt > 0 ? 'bg-slate-800' : 'bg-green-600'}
        `}>
            <p className="text-xs font-bold uppercase opacity-80 mb-1">Saldo Pendiente</p>
            <p className="text-4xl font-bold mb-4">${totalDebt.toLocaleString()}</p>
            
            {totalDebt !== 0 ? (
                <Link 
                    href={`/owners/settlement/${owner.id}`}
                    className="block text-center bg-white text-gray-900 font-bold py-2 rounded shadow hover:bg-gray-100 transition"
                >
                    {totalDebt > 0 ? "üí∏ LIQUIDAR (PAGAR)" : "‚öñÔ∏è AJUSTAR SALDO"}
                </Link>
            ) : (
                <div className="flex items-center gap-2 text-sm font-bold bg-white/20 p-2 rounded">
                    <span>‚úÖ</span> Todo al d√≠a
                </div>
            )}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* COLUMNA IZQUIERDA: INVENTARIO ACTUAL */}
        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 className="font-bold text-lg text-gray-800">üì¶ En Stock ({activeInventory.length})</h2>
                <span className="text-xs text-gray-500">Mercader√≠a en el local</span>
            </div>
            
            <div className="max-h-[400px] overflow-y-auto divide-y">
                {activeInventory.length === 0 ? (
                    <div className="p-8 text-center text-gray-400">Este due√±o no tiene productos activos.</div>
                ) : (
                    activeInventory.map((item, idx) => (
                        <div key={idx} className="p-3 flex justify-between items-center hover:bg-gray-50">
                            <div className="flex items-center gap-3">
                                {item.image ? (
                                    <img src={item.image} className="w-10 h-10 rounded object-cover border" />
                                ) : (
                                    <div className="w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-[8px]">FOTO</div>
                                )}
                                <div>
                                    <p className="font-bold text-sm text-gray-800">{item.name}</p>
                                    <p className="text-xs text-gray-500">Stock: {item.stock} u.</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="font-bold text-gray-800 text-sm">${item.price}</p>
                                <p className="text-[10px] text-green-600">Costo: ${item.cost}</p>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE PAGOS */}
        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50">
                <h2 className="font-bold text-lg text-gray-800">üìú Historial de Pagos</h2>
            </div>
            
            <div className="max-h-[400px] overflow-y-auto divide-y">
                {owner.settlements.length === 0 ? (
                    <div className="p-8 text-center text-gray-400">Nunca se le ha pagado.</div>
                ) : (
                    owner.settlements.map(settlement => (
                        <div key={settlement.id} className="p-4 flex justify-between items-center hover:bg-gray-50 group">
                            <div>
                                <p className="font-bold text-gray-800">
                                    {settlement.createdAt.toLocaleDateString()}
                                </p>
                                <p className="text-xs text-gray-400 font-mono">
                                    REF: {settlement.id.slice(0, 8)}
                                </p>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-lg font-bold text-green-700">
                                    ${Number(settlement.totalAmount).toLocaleString()}
                                </span>
                                <Link 
                                    href={`/settlements/${settlement.id}`}
                                    className="px-3 py-1 bg-blue-50 text-blue-600 rounded text-xs font-bold border border-blue-100 hover:bg-blue-100 transition"
                                >
                                    üìÑ Ver Recibo
                                </Link>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\[id]\edit) ---

// src/app/owners/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditOwnerPage({ params }: Props) {
  const { id } = await params

  const owner = await prisma.owner.findUnique({
    where: { id }
  })

  if (!owner) return <div>Due√±o no encontrado</div>

  return (
    <div className="p-10 max-w-lg mx-auto">
      <Link href="/owners" className="text-blue-500 mb-4 block hover:underline">‚Üê Volver al listado</Link>
      
      {/* Reutilizamos el formulario pas√°ndole los datos */}
      <OwnerForm initialData={owner} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets) ---

// src/app/pets/page.tsx
import { prisma } from "@/lib/prisma"
import { createPet, deletePet } from "@/actions/pet-actions"
import Link from "next/link"
import SearchInput from "@/components/SearchInput" // üëà Importamos

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function PetsPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  // FILTRO
  const pets = await prisma.pet.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { ownerName: { contains: query, mode: 'insensitive' } },
            { breed: { contains: query, mode: 'insensitive' } }
        ]
    } : undefined,
    orderBy: { name: 'asc' }
  })

  // Action para borrar (inline por simplicidad)
  async function handleDelete(formData: FormData) {
    'use server'
    const id = formData.get("id") as string
    await deletePet(id)
  }

  return (
    <div className="p-8 max-w-6xl mx-auto">
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 className="text-3xl font-bold text-gray-800">Clientes (Mascotas)</h1>
      </div>

      {/* BUSCADOR */}
      <div className="mb-8 max-w-md">
         <SearchInput placeholder="Buscar por mascota, due√±o o raza..." />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO */}
        <div className="lg:col-span-1">
          <div className="bg-white p-6 rounded-lg shadow border sticky top-24">
            <h2 className="text-xl font-bold mb-4">Nueva Ficha</h2>
            <form action={createPet} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">Nombre Mascota *</label>
                <input name="name" type="text" required placeholder="Ej: Bobby" className="w-full border p-2 rounded"/>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Raza</label>
                <input name="breed" type="text" placeholder="Ej: Caniche" className="w-full border p-2 rounded"/>
              </div>
              <div className="pt-2 border-t">
                <p className="text-xs text-gray-400 mb-2 uppercase font-bold">Datos del Due√±o</p>
                <div className="mb-2">
                    <label className="block text-sm font-medium text-gray-700">Nombre Humano *</label>
                    <input name="ownerName" type="text" required placeholder="Ej: Maria Perez" className="w-full border p-2 rounded"/>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Tel√©fono / WhatsApp *</label>
                    <input name="ownerPhone" type="text" required placeholder="Ej: 11 1234 5678" className="w-full border p-2 rounded"/>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Notas Generales</label>
                <textarea name="notes" rows={2} className="w-full border p-2 rounded" placeholder="Ej: Al√©rgico al pollo"></textarea>
              </div>
              <button type="submit" className="w-full bg-purple-600 text-white py-3 rounded hover:bg-purple-700 font-bold">
                Guardar Ficha
              </button>
            </form>
          </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="lg:col-span-2">
          <div className="grid gap-4">
            {pets.map((pet) => (
              <div key={pet.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-start hover:shadow-md transition">
                <div>
                  <div className="flex items-center gap-2">
                    <h3 className="text-lg font-bold text-gray-800">{pet.name}</h3>
                    <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">{pet.breed}</span>
                  </div>
                  <div className="mt-1 text-sm text-gray-600">
                    <span className="font-semibold">Due√±o:</span> {pet.ownerName} 
                    <span className="mx-2 text-gray-300">|</span>
                    <span className="text-green-600 font-mono">üìû {pet.ownerPhone}</span>
                  </div>
                  {pet.notes && (
                    <p className="mt-2 text-xs text-gray-500 italic bg-yellow-50 p-2 rounded border border-yellow-100 inline-block">
                      ‚ö†Ô∏è {pet.notes}
                    </p>
                  )}
                </div>
                <div className="flex flex-col gap-2 items-end">
                    <Link href={`/pets/${pet.id}`} className="bg-purple-100 text-purple-700 text-xs font-bold px-3 py-1.5 rounded hover:bg-purple-200 border border-purple-200">
                        VER FICHA
                    </Link>
                    <form action={handleDelete}>
                        <input type="hidden" name="id" value={pet.id} />
                        <button type="submit" className="text-red-300 hover:text-red-500 text-[10px] font-bold px-2 py-1 hover:underline">
                            ELIMINAR
                        </button>
                    </form>
                </div>
              </div>
            ))}

            {pets.length === 0 && (
              <div className="text-center py-10 text-gray-400 bg-gray-50 rounded border border-dashed">
                {query ? "No encontr√© mascotas con ese nombre." : "No hay mascotas registradas."}
              </div>
            )}
          </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets\[id]) ---

// src/app/pets/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import { createNote, deleteNote } from "@/actions/note-actions"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function PetDetailPage({ params }: Props) {
  const { id } = await params

  // 1. Buscamos la Mascota con TODO su historial (Turnos y Notas)
  const pet = await prisma.pet.findUnique({
    where: { id },
    include: {
      appointments: {
        orderBy: { startTime: 'desc' } // Los m√°s recientes primero
      },
      groomingNotes: {
        orderBy: { createdAt: 'desc' }
      }
    }
  })

  if (!pet) return <div className="p-10">Mascota no encontrada</div>

  return (
    <div className="p-8 max-w-6xl mx-auto">
      
      {/* CABECERA DE PERFIL */}
      <div className="mb-8 flex items-center justify-between">
        <div>
            <Link href="/pets" className="text-sm text-blue-600 hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-bold text-gray-800 flex items-center gap-3">
                {pet.name}
                <span className="text-lg font-normal bg-gray-100 text-gray-600 px-3 py-1 rounded-full border">
                    {pet.breed || "Mestizo"}
                </span>
            </h1>
            <div className="mt-2 text-gray-600 flex gap-4 text-sm">
                <p>üë§ Due√±o: <strong>{pet.ownerName}</strong></p>
                <p>üìû Tel: <strong>{pet.ownerPhone}</strong></p>
            </div>
            {pet.notes && (
                <p className="mt-3 text-red-600 bg-red-50 p-2 rounded border border-red-100 inline-block text-sm font-bold">
                    ‚ö†Ô∏è Alerta: {pet.notes}
                </p>
            )}
        </div>
        
        <div className="text-right">
             <div className="bg-slate-800 text-white px-6 py-4 rounded-lg text-center">
                <p className="text-xs uppercase opacity-70">Turnos Totales</p>
                <p className="text-3xl font-bold">{pet.appointments.length}</p>
             </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: NUEVA NOTA + HISTORIAL T√âCNICO */}
        <div className="lg:col-span-2 space-y-8">
            
            {/* Formulario Agregar Nota */}
            <div className="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                <h2 className="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                    üìù Nueva Nota T√©cnica
                </h2>
                <form action={createNote}>
                    <input type="hidden" name="petId" value={pet.id} />
                    <textarea 
                        name="content" 
                        required
                        rows={3} 
                        className="w-full p-3 border rounded bg-white focus:ring-2 focus:ring-yellow-400 outline-none"
                        placeholder="Ej: Corte con alza 4, se port√≥ bien, usar shampoo hipoalerg√©nico..."
                    ></textarea>
                    <div className="mt-2 text-right">
                        <button className="bg-yellow-600 text-white px-4 py-2 rounded font-bold hover:bg-yellow-700">
                            Guardar Nota
                        </button>
                    </div>
                </form>
            </div>

            {/* Listado de Notas */}
            <div>
                <h3 className="text-xl font-bold mb-4 text-gray-800">Historial T√©cnico</h3>
                {pet.groomingNotes.length === 0 ? (
                    <p className="text-gray-400 italic">No hay notas guardadas.</p>
                ) : (
                    <div className="space-y-4">
                        {pet.groomingNotes.map(note => (
                            <div key={note.id} className="bg-white p-4 rounded shadow-sm border border-l-4 border-l-yellow-400 group">
                                <div className="flex justify-between items-start">
                                    <p className="text-gray-800 whitespace-pre-wrap">{note.content}</p>
                                    <form action={deleteNote}>
                                        <input type="hidden" name="id" value={note.id} />
                                        <input type="hidden" name="petId" value={pet.id} />
                                        <button className="text-gray-300 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100 transition">
                                            Borrar
                                        </button>
                                    </form>
                                </div>
                                <p className="text-xs text-gray-400 mt-2 text-right">
                                    {note.createdAt.toLocaleDateString()} a las {note.createdAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE TURNOS */}
        <div className="lg:col-span-1">
            <h3 className="text-xl font-bold mb-4 text-gray-800">Historial de Visitas</h3>
            <div className="bg-white rounded-lg shadow border overflow-hidden">
                {pet.appointments.length === 0 ? (
                    <div className="p-8 text-center text-gray-400">Sin visitas a√∫n.</div>
                ) : (
                    <div className="divide-y">
                        {pet.appointments.map(appt => (
                            <div key={appt.id} className="p-4 hover:bg-gray-50">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold text-gray-700">
                                        {appt.startTime.toLocaleDateString()}
                                    </span>
                                    <span className={`text-[10px] px-2 py-0.5 rounded font-bold border 
                                        ${appt.status === 'COMPLETED' || appt.status === 'BILLED' 
                                            ? 'bg-green-100 text-green-700 border-green-200' 
                                            : appt.status === 'CANCELLED' 
                                                ? 'bg-red-50 text-red-500 border-red-100'
                                                : 'bg-blue-50 text-blue-600 border-blue-100'}
                                    `}>
                                        {appt.status === 'BILLED' ? 'COBRADO' : appt.status}
                                    </span>
                                </div>
                                <p className="text-sm text-gray-500">
                                    Hora: {appt.startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pos) ---

// src/app/pos/page.tsx
import { prisma } from "@/lib/prisma"
import PosSystem from "@/components/PosSystem"

export default async function PosPage() {
  // 1. Buscamos productos activos con sus variantes
  const products = await prisma.product.findMany({
    where: { isActive: true },
    include: { 
        variants: true, 
        owner: true,
        category: true 
    },
    orderBy: { name: 'asc' }
  })

  // 2. ESTRUCTURAMOS JER√ÅRQUICAMENTE
  // En lugar de aplanar, mandamos el objeto Producto con un array de sus variantes dentro.
  const groupedProducts = products.map(p => {
    // Calculamos el stock total para mostrar en la tarjeta principal
    const totalStock = p.variants.reduce((sum, v) => sum + v.stock, 0)
    
    // Imagen principal (usamos la de la primera variante que tenga foto, o null)
    const mainImage = p.variants.find(v => v.imageUrl)?.imageUrl || null

    return {
      id: p.id,
      name: p.name,
      categoryName: p.category.name,
      ownerName: p.owner.name,
      imageUrl: mainImage,
      totalStock: totalStock,
      // Detalle de variantes para el modal
      variants: p.variants.map(v => ({
        id: v.id,
        name: v.name, // "Rojo", "XL", "Est√°ndar"
        price: Number(v.salePrice),
        stock: v.stock
      }))
    }
  })

  return (
    <div className="h-screen flex flex-col p-4 bg-gray-50">
      <header className="mb-4 flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
            üõí Punto de Venta
        </h1>
        <div className="text-sm font-bold bg-white px-3 py-1 rounded border shadow-sm text-gray-500">
            Caja Principal
        </div>
      </header>
      
      {/* Pasamos la lista agrupada */}
      <PosSystem products={groupedProducts} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products) ---

// src/app/products/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import ProductActions from "@/components/ProductActions"
import SearchInput from "@/components/SearchInput"
import Link from "next/link"

interface Props {
  searchParams?: Promise<{
    query?: string
    page?: string
  }>
}

export default async function ProductsPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  // 1. Datos para selectores
  const owners = await prisma.owner.findMany({ select: { id: true, name: true } })
  const categories = await prisma.category.findMany({ select: { id: true, name: true } })

  // 2. Consulta de Productos
  const products = await prisma.product.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { owner: { name: { contains: query, mode: 'insensitive' } } }
        ]
    } : undefined,
    include: {
      variants: true,
      category: true,
      owner: true
    },
    orderBy: { name: 'asc' }
  })

  return (
    <div className="p-8 max-w-7xl mx-auto">
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 className="text-3xl font-bold text-gray-800">Inventario</h1>
        
        <div className="flex gap-3">
            <Link 
              href="/inventory" 
              className="bg-slate-800 text-white px-4 py-2 rounded-lg shadow hover:bg-slate-900 font-bold text-sm flex items-center gap-2 transition"
            >
              üì¶ Stock
            </Link>
            <Link 
              href="/products/import" 
              className="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 font-bold text-sm flex items-center gap-2 transition"
            >
              üìÑ Importar
            </Link>
        </div>
      </div>

      {/* BARRA DE B√öSQUEDA */}
      <div className="mb-8 max-w-md">
         <SearchInput placeholder="Buscar por producto o due√±o..." />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO */}
        <div className="lg:col-span-1">
          <div className="sticky top-24">
             <ProductForm owners={owners} categories={categories} />
          </div>
        </div>

        {/* COLUMNA DERECHA: TABLA */}
        <div className="lg:col-span-2">
          <div className="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
            <table className="w-full text-sm text-left">
              <thead className="bg-gray-100 text-gray-700 uppercase font-bold text-xs">
                <tr>
                  <th className="px-4 py-3">Producto / Due√±o</th>
                  <th className="px-4 py-3">Categor√≠a</th>
                  <th className="px-4 py-3">Precio Venta</th>
                  <th className="px-4 py-3 text-center">Stock Total</th>
                  <th className="px-4 py-3 text-center">Acciones</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {products.map(p => {
                  const isArchived = !p.isActive
                  
                  // C√ÅLCULOS
                  const totalStock = p.variants.reduce((sum, v) => sum + v.stock, 0)
                  const variantCount = p.variants.length
                  const prices = p.variants.map(v => Number(v.salePrice))
                  const minPrice = Math.min(...prices)
                  const maxPrice = Math.max(...prices)
                  const mainImage = p.variants[0]?.imageUrl

                  return (
                    <tr 
                      key={p.id} 
                      className={`transition duration-150 ${isArchived ? 'bg-gray-100 opacity-60 grayscale' : 'hover:bg-blue-50 bg-white'}`}
                    >
                      <td className="px-4 py-3">
                        
                        {/* üëá LINK AGREGADO AQU√ç: ENVOLVIENDO LA INFO PRINCIPAL */}
                        <Link href={`/products/${p.id}`} className="group block">
                            <div className="flex items-center gap-3">
                                {mainImage ? (
                                    <img src={mainImage} className="w-10 h-10 object-cover rounded border group-hover:border-blue-400 transition" />
                                ) : (
                                    <div className="w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-400 group-hover:bg-gray-300 transition">Sin foto</div>
                                )}
                                <div>
                                    <div className="flex items-center gap-2">
                                        <p className="font-bold text-gray-900 leading-tight group-hover:text-blue-600 transition">{p.name}</p>
                                        {isArchived && <span className="text-[10px] text-red-600 border border-red-200 px-1 rounded">ARCHIVADO</span>}
                                    </div>
                                    
                                    <div className="text-xs text-gray-500 flex gap-2">
                                        <span>{p.owner.name}</span>
                                        {variantCount > 1 && (
                                            <span className="bg-blue-100 text-blue-700 px-1.5 rounded font-bold text-[10px]">
                                                +{variantCount} Variantes
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </Link>

                      </td>
                      
                      <td className="px-4 py-3 text-gray-600">
                        <span className="bg-gray-100 px-2 py-1 rounded text-xs">{p.category.name}</span>
                      </td>
                      
                      <td className="px-4 py-3 font-bold text-green-700 text-base">
                        {variantCount > 1 && minPrice !== maxPrice ? (
                            <span className="text-sm">${minPrice} - ${maxPrice}</span>
                        ) : (
                            <span>${minPrice || 0}</span>
                        )}
                      </td>
                      
                      <td className="px-4 py-3 text-center">
                        {totalStock === 0 ? (
                          <span className="text-red-600 bg-red-100 px-2 py-1 rounded text-xs font-bold">AGOTADO</span>
                        ) : (
                          <span className={`font-mono font-bold text-lg ${totalStock <= 5 ? 'text-orange-500' : 'text-gray-700'}`}>
                            {totalStock}
                          </span>
                        )}
                      </td>
                      
                      <td className="px-4 py-3">
                        <div className="flex justify-center">
                            <ProductActions id={p.id} isActive={p.isActive} stock={totalStock} />
                        </div>
                      </td>
                    </tr>
                  )
                })}
                
                {products.length === 0 && (
                  <tr>
                    <td colSpan={5} className="text-center py-12 text-gray-500">
                      {query ? "No se encontraron resultados para tu b√∫squeda." : "Inventario vac√≠o."}
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\import) ---

// src/app/products/import/page.tsx
import ExcelImporter from "@/components/ExcelImporter"
import ExportButtons from "@/components/ExportButtons" // üëà Importamos
import Link from "next/link"

export default function ImportPage() {
  return (
    <div className="p-8 max-w-4xl mx-auto">
      <Link href="/products" className="text-blue-600 hover:underline mb-4 block font-bold text-sm">
        ‚Üê Volver a Productos
      </Link>
      
      <div className="flex flex-col gap-2 mb-8">
        <h1 className="text-3xl font-bold text-gray-800">Centro de Carga Masiva</h1>
        <p className="text-gray-500">Administr√° tu inventario usando Excel.</p>
      </div>

      {/* SECCI√ìN 1: DESCARGAS (NUEVO) */}
      <ExportButtons />

      <hr className="my-8 border-gray-200" />

      {/* SECCI√ìN 2: IMPORTADOR (EXISTENTE) */}
      <h2 className="text-xl font-bold mb-4 text-gray-800">Subir Archivo Modificado</h2>
      <ExcelImporter />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\[id]) ---

// src/app/products/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import { translateMovementType } from "@/services/inventory-service"
import Link from "next/link"
import { notFound } from "next/navigation"
import StockMovementForm from "@/components/StockMovementForm" // üëà Importamos el form

interface Props {
  params: Promise<{ id: string }>
}

export default async function ProductDetailPage({ params }: Props) {
  const { id } = await params

  // 1. CONSULTA PRINCIPAL
  const product = await prisma.product.findUnique({
    where: { id },
    include: {
      category: true,
      owner: true,
      variants: {
        orderBy: { name: 'asc' }
      }
    }
  })

  if (!product) return notFound()

  // 2. CONSULTA DE HISTORIAL
  const history = await prisma.stockMovement.findMany({
    where: {
      variant: { productId: id }
    },
    include: {
      variant: true,
    },
    orderBy: { createdAt: 'desc' },
    take: 50
  })

  // 3. DATOS PARA EL FORMULARIO (Mapeo)
  // Convertimos las variantes de ESTE producto al formato que espera el selector
  const formOptions = product.variants.map(v => ({
    variantId: v.id,
    // Como ya estamos dentro del producto, mostramos solo el nombre de la variante para que quede m√°s limpio
    productName: v.name === 'Est√°ndar' ? product.name : v.name, 
    ownerName: product.owner.name,
    stock: v.stock
  }))

  // 4. C√ÅLCULOS KPI
  const totalStock = product.variants.reduce((sum, v) => sum + v.stock, 0)
  
  let totalCostValue = 0
  let totalSaleValue = 0

  product.variants.forEach(v => {
    totalCostValue += Number(v.costPrice) * v.stock
    totalSaleValue += Number(v.salePrice) * v.stock
  })

  const mainImage = product.variants.find(v => v.imageUrl)?.imageUrl || null

  return (
    <div className="p-8 max-w-6xl mx-auto">
      
      {/* HEADER DE NAVEGACI√ìN */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/products" className="text-blue-600 hover:underline font-bold text-sm">
           ‚Üê Volver al Inventario
        </Link>
        <div>
             <Link 
                href={`/products/${id}/edit`}
                className="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-200 transition text-sm"
             >
                ‚úèÔ∏è Editar Datos
             </Link>
             {/* El bot√≥n de ir a /inventory lo sacamos porque ahora el form est√° ac√° */}
        </div>
      </div>

      {/* TARJETA PRINCIPAL DEL PRODUCTO */}
      <div className="bg-white rounded-lg shadow border overflow-hidden mb-8">
        <div className="p-6 flex flex-col md:flex-row gap-8">
            <div className="w-32 h-32 flex-shrink-0 bg-gray-100 rounded-lg border flex items-center justify-center overflow-hidden">
                {mainImage ? (
                    <img src={mainImage} alt={product.name} className="w-full h-full object-cover" />
                ) : (
                    <span className="text-gray-400 text-xs">Sin Foto</span>
                )}
            </div>

            <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                    <h1 className="text-3xl font-bold text-gray-800">{product.name}</h1>
                    {!product.isActive && (
                        <span className="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold border border-red-200">
                            ARCHIVADO
                        </span>
                    )}
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                    <p>üìÇ Categor√≠a: <strong className="text-gray-900">{product.category.name}</strong></p>
                    <p>üë§ Due√±o: <strong className="text-gray-900">{product.owner.name}</strong></p>
                </div>

                <p className="text-gray-500 italic text-sm border-l-4 border-gray-200 pl-3">
                    {product.description || "Sin descripci√≥n."}
                </p>
            </div>

            <div className="flex flex-col gap-2 min-w-[200px]">
                <div className="bg-blue-50 p-3 rounded border border-blue-100">
                    <p className="text-xs text-blue-600 font-bold uppercase">Stock Total</p>
                    <p className="text-2xl font-bold text-blue-900">{totalStock} <span className="text-sm font-normal">unidades</span></p>
                </div>
                <div className="bg-green-50 p-3 rounded border border-green-100">
                    <p className="text-xs text-green-600 font-bold uppercase">Valor Venta (Est.)</p>
                    <p className="text-xl font-bold text-green-900">${totalSaleValue.toLocaleString()}</p>
                </div>
            </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {/* COLUMNA IZQUIERDA: VARIANTES + FORMULARIO R√ÅPIDO */}
        <div className="lg:col-span-1 space-y-8">
            
            {/* Tabla Variantes */}
            <div>
                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    üè∑Ô∏è Variantes
                </h2>
                <div className="bg-white rounded-lg shadow border overflow-hidden">
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50 text-gray-500 font-bold text-xs uppercase">
                            <tr>
                                <th className="p-3 text-left">Nombre</th>
                                <th className="p-3 text-right">Precio</th>
                                <th className="p-3 text-center">Stock</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y">
                            {product.variants.map(v => (
                                <tr key={v.id} className="hover:bg-gray-50">
                                    <td className="p-3 font-medium text-gray-800">{v.name}</td>
                                    <td className="p-3 text-right text-gray-600">${Number(v.salePrice)}</td>
                                    <td className="p-3 text-center">
                                        <span className={`font-bold px-2 py-0.5 rounded text-xs ${v.stock === 0 ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-800'}`}>
                                            {v.stock}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* FORMULARIO INCRUSTADO */}
            <div className="bg-slate-50 p-6 rounded-lg border border-slate-200 shadow-inner">
                <h3 className="font-bold text-slate-800 mb-4 border-b pb-2">üì¶ Ajuste R√°pido de Stock</h3>
                {/* 
                    Pasamos redirectPath para que al guardar recargue ESTA misma p√°gina 
                    y no nos mande al listado general.
                */}
                <StockMovementForm 
                    products={formOptions} 
                    redirectPath={`/products/${id}`} 
                />
            </div>

            {/* Info Financiera */}
            <div className="bg-yellow-50 p-4 rounded border border-yellow-200 text-xs text-yellow-800">
                <p className="font-bold mb-1">üí° Informaci√≥n Financiera:</p>
                <p>Costo Total del Stock: <strong>${totalCostValue.toLocaleString()}</strong></p>
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE MOVIMIENTOS */}
        <div className="lg:col-span-2">
            <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                üìú Historial (Auditor√≠a)
            </h2>
            
            <div className="bg-white rounded-lg shadow border overflow-hidden">
                <table className="w-full text-sm text-left">
                    <thead className="bg-gray-100 text-gray-500 font-bold text-xs uppercase">
                        <tr>
                            <th className="p-3">Fecha</th>
                            <th className="p-3">Variante</th>
                            <th className="p-3">Acci√≥n</th>
                            <th className="p-3 text-right">Cant.</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y">
                        {history.length === 0 ? (
                            <tr>
                                <td colSpan={4} className="p-8 text-center text-gray-400 italic">
                                    No hay movimientos registrados a√∫n.
                                </td>
                            </tr>
                        ) : (
                            history.map(mov => {
                                const isPositive = mov.quantity > 0
                                const typeLabel = translateMovementType(mov.type)

                                return (
                                    <tr key={mov.id} className="hover:bg-gray-50 group">
                                        <td className="p-3">
                                            <p className="font-bold text-gray-700">
                                                {mov.createdAt.toLocaleDateString()}
                                            </p>
                                            <p className="text-xs text-gray-400">
                                                {mov.createdAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                            </p>
                                        </td>
                                        <td className="p-3 text-gray-600">
                                            {mov.variant.name === 'Est√°ndar' ? '-' : mov.variant.name}
                                        </td>
                                        <td className="p-3">
                                            <p className="font-medium text-gray-800">{typeLabel}</p>
                                            {mov.reason && (
                                                <p className="text-xs text-gray-500 italic mt-0.5">
                                                    "{mov.reason}"
                                                </p>
                                            )}
                                        </td>
                                        <td className={`p-3 text-right font-bold text-base ${isPositive ? 'text-green-600' : 'text-red-600'}`}>
                                            {isPositive ? '+' : ''}{mov.quantity}
                                        </td>
                                    </tr>
                                )
                            })
                        )}
                    </tbody>
                </table>
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\[id]\edit) ---

// src/app/products/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditProductPage({ params }: Props) {
  const { id } = await params

  // 1. Buscar datos maestros
  const owners = await prisma.owner.findMany()
  const categories = await prisma.category.findMany()

  // 2. Buscar el producto CON TODAS sus variantes
  const product = await prisma.product.findUnique({
    where: { id },
    include: { variants: { orderBy: { name: 'asc' } } } // Ordenamos por nombre
  })

  if (!product) return <div>Producto no encontrado</div>

  // 3. Estructura de datos para el form
  const initialData = {
    id: product.id,
    name: product.name,
    description: product.description,
    ownerId: product.ownerId,
    categoryId: product.categoryId,
    imageUrl: product.variants[0]?.imageUrl || "", // Tomamos la foto de la primera como referencia
    // Pasamos el array completo de variantes
    variants: product.variants.map(v => ({
      id: v.id,
      name: v.name,
      costPrice: Number(v.costPrice),
      salePrice: Number(v.salePrice),
      stock: v.stock
    }))
  }

  return (
    <div className="p-8 max-w-4xl mx-auto">
        <Link href="/products" className="text-blue-500 mb-4 block font-bold">‚Üê Cancelar y Volver</Link>
        <ProductForm 
            owners={owners} 
            categories={categories} 
            initialData={initialData} 
        />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\sales) ---

// src/app/sales/page.tsx
import { prisma } from "@/lib/prisma"
import { getLocalDateISO, getArgentinaDayRange } from "@/lib/utils" // üëà Importamos
import Link from "next/link"
import SaleRow from "@/components/SaleRow"

interface Props {
  searchParams: Promise<{ 
    dateFrom?: string 
    dateTo?: string 
    method?: string
  }>
}

export default async function SalesHistoryPage({ searchParams }: Props) {
  const { dateFrom, dateTo, method } = await searchParams

  const today = getLocalDateISO()
  const fromStr = dateFrom || today
  const toStr = dateTo || today

  // 1. Usar Helper para rangos (Garantiza GMT-3)
  const fromDate = getArgentinaDayRange(fromStr).start
  const toDate = getArgentinaDayRange(toStr).end

  // 2. Consulta a DB
  const sales = await prisma.sale.findMany({
    where: {
      createdAt: {
        gte: fromDate,
        lte: toDate
      },
      paymentMethod: method ? { equals: method } : undefined
    },
    include: {
      items: true
    },
    orderBy: { createdAt: 'desc' }
  })

  // 3. C√°lculos de Totales
  const totalPeriodo = sales
    .filter(s => s.status === 'COMPLETED')
    .reduce((sum, s) => sum + Number(s.total), 0)

  const cantVentas = sales.filter(s => s.status === 'COMPLETED').length

  return (
    <div className="p-8 max-w-5xl mx-auto">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <h1 className="text-3xl font-bold text-gray-800">Historial de Ventas</h1>
        
        {/* Resumen Flotante */}
        <div className="bg-slate-900 text-white px-6 py-3 rounded-lg shadow-lg text-right">
            <p className="text-xs text-slate-400 uppercase font-bold">Total Periodo</p>
            <p className="text-2xl font-bold">${totalPeriodo.toLocaleString()}</p>
            <p className="text-xs text-slate-500">{cantVentas} operaciones</p>
        </div>
      </div>

      {/* BARRA DE FILTROS */}
      <div className="bg-white p-4 rounded-lg shadow-sm border mb-6">
        <form className="flex flex-wrap items-end gap-4">
            
            {/* Desde */}
            <div className="flex flex-col gap-1">
                <label className="text-xs font-bold text-gray-500 uppercase">Desde</label>
                <input 
                    name="dateFrom" 
                    type="date" 
                    defaultValue={fromStr}
                    className="border p-2 rounded text-sm font-bold"
                />
            </div>

            {/* Hasta */}
            <div className="flex flex-col gap-1">
                <label className="text-xs font-bold text-gray-500 uppercase">Hasta</label>
                <input 
                    name="dateTo" 
                    type="date" 
                    defaultValue={toStr}
                    className="border p-2 rounded text-sm font-bold"
                />
            </div>

            {/* M√©todo */}
            <div className="flex flex-col gap-1">
                <label className="text-xs font-bold text-gray-500 uppercase">Medio Pago</label>
                <select 
                    name="method" 
                    defaultValue={method || ""}
                    className="border p-2 rounded text-sm bg-white min-w-[120px]"
                >
                    <option value="">Todos</option>
                    <option value="CASH">Efectivo</option>
                    <option value="TRANSFER">Transferencia</option>
                </select>
            </div>

            <button className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm font-bold shadow transition">
                Filtrar
            </button>
            
            {(dateFrom || dateTo || method) && (
                <Link href="/sales" className="text-sm text-red-500 underline py-2">
                    Borrar Filtros
                </Link>
            )}
        </form>
      </div>

      {/* TABLA DE RESULTADOS */}
      <div className="bg-white rounded-lg shadow overflow-hidden border">
        <table className="w-full text-left">
          <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
            <tr>
              <th className="p-4">Fecha</th>
              <th className="p-4">M√©todo</th>
              <th className="p-4">Total</th>
              <th className="p-4 text-center">Detalle</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {sales.length === 0 ? (
                <tr>
                    <td colSpan={4} className="p-10 text-center text-gray-400">
                        No hay ventas en este per√≠odo.
                    </td>
                </tr>
            ) : (
                sales.map(sale => {
                    const saleForClient = {
                        ...sale,
                        total: Number(sale.total),
                        items: sale.items.map(i => ({
                            ...i,
                            priceAtSale: Number(i.priceAtSale)
                        }))
                    }
                    return <SaleRow key={sale.id} sale={saleForClient} />
                })
            )}
          </tbody>
        </table>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\settlements\[id]) ---

// src/app/settlements/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import SettlementTicket from "@/components/SettlementTicket"
import { notFound } from "next/navigation"

interface Props {
  params: Promise<{ id: string }>
}

export default async function SettlementDetailPage({ params }: Props) {
  const { id } = await params

  // Buscamos la liquidaci√≥n con TODO el detalle
  const settlement = await prisma.settlement.findUnique({
    where: { id },
    include: {
      owner: true,
      items: {
        // ‚ö†Ô∏è CORRECCI√ìN 1: Ordenamos por la fecha de la VENTA padre, no del item
        orderBy: { sale: { createdAt: 'desc' } },
        // ‚ö†Ô∏è CORRECCI√ìN 2: Incluimos la venta para leer esa fecha
        include: { sale: true }
      },
      adjustments: {
        orderBy: { createdAt: 'desc' }
      }
    }
  })

  if (!settlement) return notFound()

  // Mapeo de datos para el componente visual
  const formattedData = {
    ...settlement,
    totalAmount: Number(settlement.totalAmount),
    items: settlement.items.map(i => ({
        id: i.id,
        description: i.description,
        quantity: i.quantity,
        costAtSale: Number(i.costAtSale),
        // ‚ö†Ô∏è CORRECCI√ìN 3: Extraemos la fecha desde la relaci√≥n 'sale'
        createdAt: i.sale.createdAt 
    })),
    adjustments: settlement.adjustments.map(a => ({
        ...a,
        amount: Number(a.amount)
    }))
  }

  return (
    <SettlementTicket data={formattedData} />
  )
}

--- File: AppointmentCard.tsx (in subfolder: components) ---

// src/components/AppointmentCard.tsx
'use client'

import { cancelAppointment, updateAppointmentStatus } from "@/actions/appointment-actions"
import Link from "next/link"
import { useState } from "react"

// Definimos el tipo de datos que recibe la tarjeta (lo que viene de Prisma)
type AppointmentData = {
  id: string
  startTime: Date
  endTime: Date
  status: string // En Prisma es un Enum, aqu√≠ lo manejamos como string
  pet: {
    name: string
    breed: string | null
    ownerName: string
  }
}

export default function AppointmentCard({ appt }: { appt: AppointmentData }) {
  const [loading, setLoading] = useState(false)

  // Helpers de formato
  const start = appt.startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  const end = appt.endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })

  // Funci√≥n gen√©rica para cambiar estado
  const handleStatusChange = async (newStatus: 'CONFIRMED' | 'COMPLETED') => {
    setLoading(true)
    await updateAppointmentStatus(appt.id, newStatus)
    setLoading(false)
  }

  // Definir colores seg√∫n estado
  let statusColor = "bg-white border-l-4 border-gray-300" // Default
  if (appt.status === 'PENDING') statusColor = "bg-white border-l-4 border-yellow-400"
  if (appt.status === 'CONFIRMED') statusColor = "bg-blue-50 border-l-4 border-blue-500" // En proceso
  if (appt.status === 'COMPLETED') statusColor = "bg-green-50 border-l-4 border-green-500" // Terminado
  if (appt.status === 'BILLED') statusColor = "bg-gray-100 border-l-4 border-gray-400 opacity-75" // Cobrado

  return (
    <div className={`p-4 rounded-lg shadow-sm border border-gray-200 transition-all ${statusColor}`}>
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        
        {/* INFO PRINCIPAL */}
        <div className="flex items-center gap-4">
            {/* Hora */}
            <div className="flex flex-col items-center justify-center min-w-[60px]">
                <span className="text-xl font-bold text-gray-800">{start}</span>
                <span className="text-xs text-gray-500">{end}</span>
            </div>

            {/* Datos Mascota */}
            <div>
                <h3 className="font-bold text-lg text-gray-900 leading-none mb-1">
                    {appt.pet.name}
                </h3>
                <p className="text-xs text-gray-600">
                    {appt.pet.breed} ‚Ä¢ {appt.pet.ownerName}
                </p>
                {/* Badge de Estado Visual */}
                <span className={`
                    inline-block mt-2 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider
                    ${appt.status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' : ''}
                    ${appt.status === 'CONFIRMED' ? 'bg-blue-100 text-blue-800' : ''}
                    ${appt.status === 'COMPLETED' ? 'bg-green-100 text-green-800' : ''}
                    ${appt.status === 'BILLED' ? 'bg-gray-200 text-gray-600' : ''}
                `}>
                    {appt.status === 'CONFIRMED' ? 'EN PROCESO' : appt.status}
                </span>
            </div>
        </div>

        {/* BOTONERA DE ACCIONES (WORKFLOW) */}
        <div className="flex flex-wrap gap-2 items-center justify-end w-full sm:w-auto">
            
            {/* 1. SI EST√Å PENDIENTE -> CONFIRMAR (LLEG√ì) */}
            {appt.status === 'PENDING' && (
                <button 
                    disabled={loading}
                    onClick={() => handleStatusChange('CONFIRMED')}
                    className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-2 rounded transition"
                >
                    üêï LLEG√ì
                </button>
            )}

            {/* 2. SI EST√Å EN PROCESO -> TERMINAR (LISTO) */}
            {appt.status === 'CONFIRMED' && (
                <button 
                    disabled={loading}
                    onClick={() => handleStatusChange('COMPLETED')}
                    className="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-3 py-2 rounded transition shadow-sm animate-pulse"
                >
                    ‚ú® LISTO
                </button>
            )}

            {/* 3. BOT√ìN COBRAR (Siempre disponible si no est√° cobrado) */}
            {appt.status !== 'BILLED' && (
                <Link
                    href={`/pos?apptId=${appt.id}&petName=${encodeURIComponent(appt.pet.name)}`}
                    className="bg-slate-800 hover:bg-black text-white text-xs font-bold px-3 py-2 rounded transition flex items-center gap-1 shadow"
                >
                    üí∞ COBRAR
                </Link>
            )}

            {/* 4. CANCELAR (Solo si no se cobr√≥ ni complet√≥) */}
            {(appt.status === 'PENDING' || appt.status === 'CONFIRMED') && (
                <form action={cancelAppointment}>
                    <input type="hidden" name="id" value={appt.id} />
                    <button className="text-red-400 hover:text-red-600 text-xs font-bold px-2 py-2 hover:bg-red-50 rounded">
                        ‚úñ
                    </button>
                </form>
            )}

        </div>
      </div>
    </div>
  )
}

--- File: AppointmentForm.tsx (in subfolder: components) ---

// src/components/AppointmentForm.tsx
'use client'

import { useState } from "react"
import { createAppointment } from "@/actions/appointment-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"

type Props = {
  pets: { id: string, name: string, breed: string | null }[]
  selectedDate: string // Viene 'YYYY-MM-DD'
}

export default function AppointmentForm({ pets, selectedDate }: Props) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault() 
    setLoading(true)

    const form = e.currentTarget
    const formData = new FormData(form)

    // Nota: Ahora 'date' viene del input visible, ya no lo inyectamos manualmente
    
    const result = await createAppointment(formData)

    setLoading(false)

    if (result.error) {
      alert("‚ùå NO SE PUDO AGENDAR:\n" + result.error)
    } else {
      alert("‚úÖ Turno agendado correctamente")
      form.reset() 
      router.refresh()
    }
  }

  return (
    <div className="bg-slate-50 p-6 rounded-lg border border-slate-200 shadow-sm sticky top-6">
      <h2 className="text-xl font-bold mb-4 text-slate-800">Agendar Turno</h2>
      
      <form onSubmit={handleSubmit} className="space-y-4">
        
        {/* SELECCI√ìN DE MASCOTA */}
        <div>
          <label className="block text-sm font-bold text-gray-700 mb-1">Mascota</label>
          <select name="petId" required className="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none">
            <option value="">Seleccionar...</option>
            {pets.map(p => (
              <option key={p.id} value={p.id}>{p.name} ({p.breed || 'Sin raza'})</option>
            ))}
          </select>
          <div className="text-right mt-1">
            <Link href="/pets" className="text-xs text-blue-600 underline hover:text-blue-800">
                + Nueva Mascota
            </Link>
          </div>
        </div>

        {/* FECHA (Ahora editable) */}
        <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Fecha</label>
            <input 
                type="date" 
                name="date"
                defaultValue={selectedDate} // Pre-cargamos la fecha actual de la vista
                required
                className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
            />
        </div>

        {/* HORA Y DURACI√ìN */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Hora Inicio</label>
            <input 
              name="time" 
              type="time" 
              required 
              className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Duraci√≥n</label>
            <select name="duration" className="w-full p-2 border rounded bg-white">
              <option value="30">30 min</option>
              <option value="60">1 h</option>
              <option value="90">1 h 30m</option>
              <option value="120">2 hs</option>
              <option value="180">3 hs</option>
            </select>
          </div>
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={`w-full py-3 rounded font-bold transition text-white shadow
            ${loading 
                ? 'bg-slate-400 cursor-wait' 
                : 'bg-slate-800 hover:bg-slate-900 hover:scale-[1.02] active:scale-95'
            }
          `}
        >
          {loading ? "Verificando..." : "Confirmar Reserva"}
        </button>

      </form>
    </div>
  )
}

--- File: CancelSaleButton.tsx (in subfolder: components) ---

// src/components/CancelSaleButton.tsx
'use client'

import { cancelSale } from "@/actions/sale-actions"
import { useState } from "react"

export default function CancelSaleButton({ saleId }: { saleId: string }) {
  const [loading, setLoading] = useState(false)

  const handleCancel = async () => {
    // 1. Log en el NAVEGADOR (Mirar F12 > Console)
    console.log(`üîµ [CLIENTE] Click en anular venta ID: ${saleId}`)

    const confirmed = confirm("¬øEst√°s SEGURO de anular esta venta?\n\nSi ya fue liquidada, se generar√° una deuda al due√±o.")
    if (!confirmed) return

    setLoading(true)

    try {
      // 2. Llamada al Servidor
      console.log("‚è≥ [CLIENTE] Llamando al servidor...")
      const result = await cancelSale(saleId)

      // 3. Respuesta del Servidor
      console.log("üü¢ [CLIENTE] Respuesta recibida:", result)

      if (result.success) {
        alert("‚úÖ ¬°Venta Anulada con √âxito!")
        // La p√°gina se refrescar√° sola gracias al revalidatePath del servidor
      } else {
        alert(`‚ùå Error: ${result.error}`)
      }
    } catch (err) {
      console.error("üî¥ [CLIENTE] Error de red o c√≥digo:", err)
      alert("Error inesperado al intentar anular.")
    } finally {
      setLoading(false)
    }
  }

  return (
    <button
      onClick={handleCancel}
      disabled={loading}
      className={`text-sm font-semibold border px-3 py-1 rounded transition
        ${loading 
          ? 'bg-gray-200 text-gray-500 cursor-wait' 
          : 'text-red-600 border-red-200 hover:bg-red-50 hover:text-red-800'
        }
      `}
    >
      {loading ? "Procesando..." : "Anular"}
    </button>
  )
}

--- File: ExcelImporter.tsx (in subfolder: components) ---

// src/components/ExcelImporter.tsx
'use client'

import { useState } from "react"
import readXlsxFile from "read-excel-file"
import { importSingleProduct } from "@/actions/bulk-actions"

export default function ExcelImporter() {
  const [rows, setRows] = useState<any[]>([])
  const [processing, setProcessing] = useState(false)
  const [progress, setProgress] = useState({ current: 0, total: 0, errors: 0 })
  const [logs, setLogs] = useState<string[]>([])

  // 1. LEER EL ARCHIVO
  const handleFile = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    try {
      // Leemos el Excel. 
      // NUEVO ORDEN DE COLUMNAS:
      // 0: Producto | 1: Variante | 2: Categor√≠a | 3: Due√±o | 4: Costo | 5: Precio
      const data = await readXlsxFile(file)
      
      // Eliminamos la cabecera (fila 0) y mapeamos
      const cleanData = data.slice(1).map(row => ({
        name: row[0] as string,
        variantName: row[1] as string, // üëà Nueva columna le√≠da
        categoryName: row[2] as string,
        ownerName: row[3] as string,
        cost: Number(row[4]),
        price: Number(row[5])
      }))

      setRows(cleanData)
      setLogs(prev => [...prev, `Archivo cargado: ${cleanData.length} filas detectadas.`])
    } catch (error) {
      console.error(error)
      alert("Error leyendo Excel. Verific√° el formato.")
    }
  }

  // 2. PROCESAR BUCLE
  const startImport = async () => {
    setProcessing(true)
    setProgress({ current: 0, total: rows.length, errors: 0 })
    setLogs([])

    let successCount = 0
    let errorCount = 0

    // BUCLE SECUENCIAL
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i]
      
      // Validaci√≥n b√°sica visual
      if (!row.name || !row.ownerName) {
        setLogs(prev => [...prev, `‚ùå Fila ${i+2}: Faltan datos (Nombre o Due√±o)`])
        errorCount++
        setProgress(p => ({ ...p, current: i + 1, errors: p.errors + 1 }))
        continue
      }

      // Llamada al Server
      const result = await importSingleProduct(row)

      if (result.success) {
        successCount++
      } else {
        errorCount++
        // Mostramos el nombre completo (Producto - Variante) en el log de error
        const fullName = row.variantName ? `${row.name} (${row.variantName})` : row.name
        setLogs(prev => [...prev, `‚ùå Error en "${fullName}": ${result.error}`])
      }

      // Actualizar progreso
      setProgress(p => ({ 
        current: i + 1, 
        total: rows.length, 
        errors: errorCount 
      }))
    }

    setProcessing(false)
    setLogs(prev => [...prev, `üèÅ FINALIZADO. Procesados: ${successCount}, Errores: ${errorCount}`])
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow border">
      <h2 className="text-xl font-bold mb-4">Importaci√≥n Masiva (Excel)</h2>
      
      <div className="mb-6 p-4 bg-blue-50 text-blue-900 text-sm rounded border border-blue-100">
        <strong className="block mb-2 text-blue-700">Formato requerido (Columnas):</strong>
        <ol className="list-decimal list-inside space-y-1 font-mono text-xs">
            <li>Nombre Producto (Ej: Collar Nylon)</li>
            <li><strong>Variante (Ej: Rojo / XL)</strong> - <em>Nuevo! Dejar vac√≠o para "Est√°ndar"</em></li>
            <li>Categor√≠a (Ej: Accesorios)</li>
            <li>Nombre Due√±o (Ej: Juan Perez)</li>
            <li>Costo (Num√©rico)</li>
            <li>Precio Venta (Num√©rico)</li>
        </ol>
      </div>

      {!processing && rows.length === 0 && (
        <input 
          type="file" 
          accept=".xlsx" 
          onChange={handleFile}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer"
        />
      )}

      {rows.length > 0 && !processing && progress.current === 0 && (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
             <p className="font-bold text-lg text-gray-800">{rows.length} filas listas.</p>
             <button 
               onClick={() => setRows([])} 
               className="text-red-500 text-xs font-bold hover:underline"
             >
               Cancelar
             </button>
          </div>
          <button 
            onClick={startImport}
            className="w-full bg-green-600 text-white py-3 rounded hover:bg-green-700 font-bold shadow transition"
          >
            Iniciar Importaci√≥n
          </button>
        </div>
      )}

      {/* BARRA DE PROGRESO */}
      {(processing || progress.current > 0) && (
        <div className="mt-4 space-y-2">
          <div className="flex justify-between text-sm font-bold">
            <span>Procesando: {progress.current} / {progress.total}</span>
            <span className={`${progress.errors > 0 ? 'text-red-600' : 'text-gray-400'}`}>Errores: {progress.errors}</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div 
              className={`h-4 rounded-full transition-all duration-300 ${processing ? 'bg-blue-600 animate-pulse' : 'bg-green-600'}`}
              style={{ width: `${(progress.current / progress.total) * 100}%` }}
            ></div>
          </div>
        </div>
      )}

      {/* LOGS DE ERRORES */}
      <div className="mt-6 bg-slate-900 text-slate-300 p-4 rounded font-mono text-xs h-48 overflow-y-auto border border-slate-700 shadow-inner">
        {logs.length === 0 ? (
            <span className="opacity-50">Esperando inicio...</span>
        ) : (
            logs.map((log, i) => (
                <div key={i} className={`mb-1 ${log.includes('‚ùå') ? 'text-red-400' : 'text-green-400'}`}>
                    {log}
                </div>
            ))
        )}
      </div>
    </div>
  )
}

--- File: ExportButtons.tsx (in subfolder: components) ---

// src/components/ExportButtons.tsx
'use client'

import { useState } from "react"
import { exportProducts } from "@/actions/export-actions"

export default function ExportButtons() {
  const [loading, setLoading] = useState<'TEMPLATE' | 'FULL' | null>(null)

  const handleExport = async (mode: 'TEMPLATE' | 'FULL') => {
    setLoading(mode)
    
    try {
      const result = await exportProducts(mode)

      if (result.success && result.base64 && result.filename) {
        // Truco para descargar archivo desde Base64 en el cliente
        const link = document.createElement("a")
        link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${result.base64}`
        link.download = result.filename
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
      } else {
        alert("Error: " + result.error)
      }
    } catch (error) {
      console.error(error)
      alert("Error de conexi√≥n al exportar.")
    } finally {
      setLoading(null)
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
      
      {/* OPCI√ìN 1: PLANTILLA VAC√çA */}
      <div className="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 flex flex-col items-center justify-center text-center gap-2">
        <h3 className="font-bold text-gray-700">¬øCarga Nueva?</h3>
        <p className="text-xs text-gray-500 max-w-xs">Descarg√° el formato oficial para completar y subir.</p>
        <button 
          onClick={() => handleExport('TEMPLATE')}
          disabled={!!loading}
          className="mt-2 bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded text-sm font-bold hover:bg-gray-100 transition shadow-sm w-full md:w-auto"
        >
          {loading === 'TEMPLATE' ? "Generando..." : "üìÑ Descargar Plantilla Vac√≠a"}
        </button>
      </div>

      {/* OPCI√ìN 2: EXPORTAR DATOS REALES */}
      <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex flex-col items-center justify-center text-center gap-2">
        <h3 className="font-bold text-blue-900">Edici√≥n Masiva</h3>
        <p className="text-xs text-blue-700 max-w-xs">Baj√° todo tu inventario actual, edit√° precios en Excel y volv√© a subirlo.</p>
        <button 
           onClick={() => handleExport('FULL')}
           disabled={!!loading}
           className="mt-2 bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 transition shadow w-full md:w-auto"
        >
          {loading === 'FULL' ? "Procesando..." : "üì• Exportar Inventario Completo"}
        </button>
      </div>

    </div>
  )
}

--- File: ImageUpload.tsx (in subfolder: components) ---

// src/components/ImageUpload.tsx
'use client' // Necesario para interactuar con el usuario

import { useState } from "react"

export default function ImageUpload({ onImageUpload }: { onImageUpload: (url: string) => void }) {
  const [uploading, setUploading] = useState(false)
  const [preview, setPreview] = useState<string | null>(null)

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setUploading(true)

    // 1. Preparar los datos para Cloudinary
    const formData = new FormData()
    formData.append("file", file)
    formData.append("upload_preset", process.env.NEXT_PUBLIC_CLOUDINARY_PRESET!)

    try {
      // 2. Enviar a Cloudinary (Petici√≥n directa desde el navegador)
      const cloudName = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData,
      })

      const data = await response.json()

      if (data.secure_url) {
        // 3. √âxito: Guardamos la URL y avisamos al componente padre
        setPreview(data.secure_url)
        onImageUpload(data.secure_url) // üëà Esta funci√≥n viene de afuera
      } else {
        alert("Error al subir imagen")
      }
    } catch (error) {
      console.error(error)
      alert("Error de conexi√≥n al subir imagen")
    } finally {
      setUploading(false)
    }
  }

  return (
    <div className="flex flex-col gap-2">
      <label className="text-sm font-medium text-gray-700">Imagen del Producto</label>
      
      <div className="flex items-center gap-4">
        {/* Input de archivo */}
        <input 
          type="file" 
          accept="image/*"
          onChange={handleFileChange}
          disabled={uploading}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
        
        {/* Indicador de carga */}
        {uploading && <span className="text-sm text-blue-600">Subiendo...</span>}
      </div>

      {/* Previsualizaci√≥n */}
      {preview && (
        <div className="mt-2">
          <img src={preview} alt="Vista previa" className="h-32 w-32 object-cover rounded-md border" />
        </div>
      )}
    </div>
  )
}

--- File: InventoryImporter.tsx (in subfolder: components) ---

// src/components/InventoryImporter.tsx
'use client'

import { useState } from "react"
import { exportInventorySheet } from "@/actions/inventory-export-actions"
import { bulkUpdateStock } from "@/actions/inventory-bulk-actions"
import readXlsxFile from "read-excel-file"

export default function InventoryImporter() {
  const [downloading, setDownloading] = useState(false)
  const [uploading, setUploading] = useState(false)
  const [logs, setLogs] = useState<string[]>([])

  // 1. DESCARGAR PLANILLA
  const handleDownload = async () => {
    setDownloading(true)
    const res = await exportInventorySheet()
    if (res.success && res.base64) {
        const link = document.createElement("a")
        link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${res.base64}`
        link.download = res.filename!
        link.click()
    } else {
        alert("Error descargando planilla")
    }
    setDownloading(false)
  }

  // 2. IMPORTAR PLANILLA
  const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro de procesar este archivo?\n\nLas cantidades ingresadas se SUMAR√ÅN al stock actual.")) {
        e.target.value = "" // Reset
        return
    }

    setUploading(true)
    setLogs([])

    try {
        // Mapeo de columnas por √≠ndice (A=0, B=1...)
        // A: ID (0), F: CANTIDAD (5), G: MOTIVO (6)
        const rows = await readXlsxFile(file)
        
        // Omitir cabecera
        const dataRows = rows.slice(1)
        
        const payload = dataRows.map(r => ({
            variantId: r[0] as string,
            quantity: Number(r[5]), // Columna F
            reason: r[6] as string  // Columna G
        })).filter(item => item.variantId && item.quantity !== 0 && !isNaN(item.quantity))

        if (payload.length === 0) {
            alert("No se detectaron cantidades v√°lidas para procesar.")
            setUploading(false)
            return
        }

        setLogs(prev => [...prev, `‚è≥ Procesando ${payload.length} movimientos...`])

        const res = await bulkUpdateStock(payload)

        if (res.success) {
            setLogs(prev => [...prev, `‚úÖ √âxito: ${res.count} items actualizados.`])
            if (res.errors && res.errors.length > 0) {
                res.errors.forEach(err => setLogs(p => [...p, `‚ùå ${err}`]))
            }
        } else {
            setLogs(prev => [...prev, `‚õî Error General: ${res.error}`])
        }

    } catch (error) {
        console.error(error)
        alert("Error leyendo el archivo.")
    } finally {
        setUploading(false)
        e.target.value = "" // Reset input
    }
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8">
      <h2 className="text-lg font-bold text-gray-800 mb-4">Gesti√≥n Masiva de Stock</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
        
        {/* PASO 1: BAJAR */}
        <div className="border-r md:pr-6 border-gray-100">
            <p className="text-sm text-gray-500 mb-2">1. Descarg√° la planilla con tus productos actuales.</p>
            <button 
                onClick={handleDownload}
                disabled={downloading}
                className="w-full bg-blue-50 text-blue-700 px-4 py-2 rounded font-bold border border-blue-200 hover:bg-blue-100 transition flex items-center justify-center gap-2"
            >
                {downloading ? "Generando..." : "üì• Descargar Planilla de Carga"}
            </button>
        </div>

        {/* PASO 2: SUBIR */}
        <div>
            <p className="text-sm text-gray-500 mb-2">2. Sub√≠ el Excel con la columna "CANTIDAD" completa.</p>
            <div className="relative">
                {uploading ? (
                    <div className="text-center py-2 text-sm font-bold text-blue-600 animate-pulse">
                        Procesando movimientos...
                    </div>
                ) : (
                    <input 
                        type="file" 
                        accept=".xlsx"
                        onChange={handleUpload}
                        className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-green-600 file:text-white hover:file:bg-green-700 cursor-pointer"
                    />
                )}
            </div>
        </div>
      </div>

      {/* LOGS */}
      {logs.length > 0 && (
        <div className="mt-4 bg-gray-900 text-green-400 p-3 rounded text-xs font-mono max-h-32 overflow-y-auto">
            {logs.map((l, i) => <div key={i}>{l}</div>)}
        </div>
      )}
    </div>
  )
}

--- File: MainNav.tsx (in subfolder: components) ---

// src/components/MainNav.tsx
'use client'

import Link from "next/link"
import { usePathname } from "next/navigation"
import { cn } from "@/lib/utils"
import { ThemeToggle } from "./ThemeToggle"

export default function MainNav() {
  const pathname = usePathname()

  const routes = [
    { href: "/dashboard", label: "Inicio", icon: "üè†", exact: true },
    { href: "/pos", label: "Caja", icon: "üõçÔ∏è", exact: true, highlight: true },
    { href: "/agenda", label: "Agenda", icon: "üìÖ", exact: false },
    { href: "/sales", label: "Ventas", icon: "üßæ", exact: false },
    { href: "/products", label: "Stock", icon: "ü¶¥", exact: false },
    { href: "/pets", label: "Mascotas", icon: "üê∂", exact: false },
    { href: "/owners", label: "Due√±os", icon: "üë•", exact: false },
    { href: "/owners/balance", label: "Finanzas", icon: "üíé", exact: true },
  ]

  return (
    <>
      {/* === DESKTOP SIDEBAR === */}
      <aside className="hidden md:flex w-72 flex-col bg-card border-r border-border h-screen sticky top-0 z-50 transition-colors duration-300">
        
        {/* LOGO */}
        <div className="p-8 pb-6">
          <h1 className="text-3xl font-black font-nunito tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-primary to-foreground animate-in fade-in">
            GUAPECANES
          </h1>
          <p className="text-[10px] font-bold text-muted-foreground mt-0.5 uppercase tracking-widest">
            Sistema Profesional v3
          </p>
        </div>

        {/* NAV */}
        <nav className="flex-1 px-4 space-y-2 py-4 overflow-y-auto custom-scrollbar">
          {routes.map((route) => {
            const isActive = route.exact 
                ? pathname === route.href
                : pathname.startsWith(route.href)

            return (
              <Link
                key={route.href}
                href={route.href}
                className={cn(
                  "flex items-center gap-4 px-4 py-3 rounded-2xl text-sm font-bold transition-all duration-200 group relative",
                  
                  // 1. ESTILO BOT√ìN DESTACADO (CAJA) - Degradado Primario
                  route.highlight 
                    ? "bg-gradient-to-r from-primary to-accent text-primary-foreground shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:scale-[1.02] justify-center text-base mb-6"
                    
                  // 2. ESTILO ACTIVO - Tinte suave del color primario
                  : isActive 
                        ? "bg-primary/10 text-primary" 
                        
                  // 3. ESTILO INACTIVO - Color muted
                        : "text-muted-foreground hover:bg-secondary/20 hover:text-foreground"
                )}
              >
                <span className={cn("text-xl transition-transform group-hover:scale-110", route.highlight && "animate-pulse")}>
                    {route.icon}
                </span>
                {route.label}
                
                {/* Indicador de Activo (Puntito) */}
                {!route.highlight && isActive && (
                    <div className="ml-auto w-1.5 h-1.5 rounded-full bg-primary" />
                )}
              </Link>
            )
          })}
        </nav>

        {/* FOOTER & TOGGLE */}
        <div className="p-4 border-t border-border">
            <div className="flex justify-between items-center bg-background/50 p-3 rounded-2xl border border-border">
                <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full bg-secondary flex items-center justify-center text-secondary-foreground text-xs font-bold">
                        ST
                    </div>
                    <div>
                        <p className="text-xs font-bold text-foreground">Staff Turno</p>
                        <p className="text-[10px] text-green-500 font-bold uppercase">‚óè Online</p>
                    </div>
                </div>
                {/* Aqu√≠ integramos el Toggle que creamos antes */}
                <ThemeToggle />
            </div>
        </div>
      </aside>

      {/* === MOBILE NAV === */}
      <nav className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-card/95 backdrop-blur-md border-t border-border pb-safe pt-2 px-4 shadow-[0_-5px_20px_rgba(0,0,0,0.2)]">
        <div className="flex justify-between items-center">
            {routes.slice(0, 5).map((route) => {
                const isActive = route.exact ? pathname === route.href : pathname.startsWith(route.href)
                
                // Bot√≥n flotante central en m√≥vil
                if (route.highlight) {
                    return (
                        <Link key={route.href} href={route.href} className="relative -top-6">
                            <div className="w-14 h-14 rounded-full bg-gradient-to-r from-primary to-accent flex items-center justify-center text-2xl shadow-lg shadow-primary/40 border-4 border-background text-primary-foreground">
                                {route.icon}
                            </div>
                        </Link>
                    )
                }

                return (
                <Link
                    key={route.href}
                    href={route.href}
                    className={cn(
                    "flex flex-col items-center justify-center p-2 rounded-xl transition-all",
                    isActive ? "text-primary font-bold" : "text-muted-foreground"
                    )}
                >
                    <span className="text-xl mb-0.5">{route.icon}</span>
                    <span className="text-[9px]">{route.label}</span>
                </Link>
                )
            })}
             <div className="p-2 opacity-80"><ThemeToggle /></div>
        </div>
      </nav>
    </>
  )
}

--- File: OwnerForm.tsx (in subfolder: components) ---

// src/components/OwnerForm.tsx
'use client'

import { createOwner, updateOwner } from "@/actions/owner-actions"
import { useRouter } from "next/navigation"
import { useState } from "react"

type OwnerData = {
  id?: string
  name: string
  email: string | null
  phone: string | null
}

export default function OwnerForm({ initialData }: { initialData?: OwnerData }) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    
    let result;
    
    if (initialData?.id) {
        // MODO EDICI√ìN
        formData.append("id", initialData.id)
        result = await updateOwner(formData)
        if (result.success) {
            alert("Due√±o actualizado")
            router.push("/owners") // Volver a la lista
            router.refresh()
        }
    } else {
        // MODO CREACI√ìN
        result = await createOwner(formData)
        if (result?.success) {
            // Limpiamos el form manualmente si es creaci√≥n
            const form = document.getElementById("owner-form") as HTMLFormElement
            form?.reset()
            router.refresh()
        }
    }

    setLoading(false)
    if (result?.error) alert(result.error)
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow border">
      <h2 className="text-xl font-bold mb-4">
        {initialData ? "Editar Due√±o" : "Nuevo Due√±o"}
      </h2>
      
      <form id="owner-form" action={handleSubmit} className="flex flex-col gap-4">
        
        <div>
          <label className="text-sm text-gray-600 font-bold">Nombre *</label>
          <input 
            name="name" 
            defaultValue={initialData?.name}
            type="text" 
            required 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="Juan P√©rez"
          />
        </div>

        <div>
          <label className="text-sm text-gray-600 font-bold">Email</label>
          <input 
            name="email" 
            defaultValue={initialData?.email || ""}
            type="email" 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="juan@mail.com"
          />
        </div>

        <div>
          <label className="text-sm text-gray-600 font-bold">Tel√©fono</label>
          <input 
            name="phone" 
            defaultValue={initialData?.phone || ""}
            type="text" 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="11 1234 5678"
          />
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={`w-full py-2 rounded text-white font-bold transition
            ${loading ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}
          `}
        >
          {loading ? "Guardando..." : "Guardar"}
        </button>
      </form>
    </div>
  )
}

--- File: PosSystem.tsx (in subfolder: components) ---

'use client'

import { useState, useEffect, useMemo } from "react"
import Image from "next/image"
import { useSearchParams, useRouter } from "next/navigation"
import { processSale } from "@/actions/sale-actions"
import { useToast } from "@/components/ui/Toast" // ‚úÖ Feedback
import TicketView from "./TicketView"
import { cn } from "@/lib/utils"

// --- TIPOS ---
type VariantType = {
  id: string
  name: string
  price: number
  stock: number
}

type ProductGroupType = {
  id: string
  name: string
  categoryName: string
  ownerName: string
  imageUrl: string | null
  totalStock: number
  variants: VariantType[]
}

type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string
  name: string
  price: number
  quantity: number
  stockMax?: number
}

type PaymentMethod = "CASH" | "TRANSFER"

type SaleResult = {
    id: string
    date: Date
    items: { description: string; quantity: number; price: number }[]
    total: number
    method: PaymentMethod
}

export default function PosSystem({ products }: { products: ProductGroupType[] }) {
  // --- HOOKS ---
  const { addToast } = useToast()
  const searchParams = useSearchParams()
  const router = useRouter()
  
  // Estados
  const [cart, setCart] = useState<CartItem[]>([])
  const [loading, setLoading] = useState(false)
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>("CASH")
  const [lastSale, setLastSale] = useState<SaleResult | null>(null)

  // Estados Filtros (Optimizaci√≥n)
  const [displaySearch, setDisplaySearch] = useState("") 
  const [debouncedSearch, setDebouncedSearch] = useState("") 
  const [selectedCategory, setSelectedCategory] = useState<string | "ALL">("ALL")

  // Modal
  const [selectedProductForModal, setSelectedProductForModal] = useState<ProductGroupType | null>(null)

  // --- 1. DEBOUNCE EFFECT (Performance) ---
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearch(displaySearch)
    }, 300) // Espera 300ms al escribir
    return () => clearTimeout(timer)
  }, [displaySearch])

  // --- 2. CARGA DESDE URL (Agenda) ---
  useEffect(() => {
    const apptId = searchParams.get("apptId")
    const petName = searchParams.get("petName")
    
    if (apptId && petName && cart.length === 0) {
      setCart([{
        type: 'SERVICE',
        id: apptId,
        name: `Servicio: ${petName}`,
        price: 0, 
        quantity: 1
      }])
      addToast(`Servicio para ${petName} cargado`, 'info')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams])

  // --- 3. FILTROS MEMORIZADOS (Performance) ---
  const categories = useMemo(() => {
    const cats = products.map(p => p.categoryName)
    return ["ALL", ...Array.from(new Set(cats))].sort()
  }, [products])

  const filteredProducts = useMemo(() => {
    const term = debouncedSearch.toLowerCase()
    return products.filter(p => {
        const matchesCategory = selectedCategory === "ALL" || p.categoryName === selectedCategory
        const matchesText = 
            p.name.toLowerCase().includes(term) || 
            p.ownerName.toLowerCase().includes(term) ||
            p.categoryName.toLowerCase().includes(term)
        return matchesCategory && matchesText
    })
  }, [products, debouncedSearch, selectedCategory])

  // --- L√ìGICA CARRITO ---

  const addVariantToCart = (productName: string, variant: VariantType) => {
    if (variant.stock <= 0) {
        addToast(`Sin stock para ${variant.name}`, 'error')
        return
    }

    setCart(current => {
        const existing = current.find(item => item.id === variant.id && item.type === 'PRODUCT')
        const displayName = variant.name === "Est√°ndar" ? productName : `${productName} - ${variant.name}`

        if (existing) {
            if (existing.quantity >= variant.stock) {
                addToast("Stock m√°ximo alcanzado", 'error')
                return current
            }
            return current.map(item => item.id === variant.id ? { ...item, quantity: item.quantity + 1 } : item)
        }
        
        // Animaci√≥n visual simple podr√≠a ir aqu√≠
        return [...current, { 
            type: 'PRODUCT', 
            id: variant.id, 
            name: displayName, 
            price: variant.price, 
            quantity: 1, 
            stockMax: variant.stock 
        }]
    })
  }

  const handleProductClick = (product: ProductGroupType) => {
    const activeVariants = product.variants.filter(v => v.stock > 0)

    if (activeVariants.length === 0) {
        addToast("Producto agotado", 'error')
        return
    }

    if (activeVariants.length === 1) {
        addVariantToCart(product.name, activeVariants[0])
    } else {
        setSelectedProductForModal(product)
    }
  }

  const updateServicePrice = (index: number, newPrice: string) => {
    const val = parseFloat(newPrice)
    setCart(current => current.map((item, i) => i === index ? { ...item, price: isNaN(val) ? 0 : val } : item))
  }

  const removeFromCart = (index: number) => {
    setCart(current => current.filter((_, i) => i !== index))
  }

  const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)

  const handleCheckout = async () => {
    if (total === 0 && !confirm("¬øConfirmar venta por $0?")) return
    
    setLoading(true)
    
    const payload = cart.map(item => ({ 
        type: item.type, 
        id: item.id, 
        description: item.name, 
        price: item.price, 
        quantity: item.quantity 
    }))
    
    const result = await processSale(payload, total, paymentMethod)
    
    setLoading(false)

    if (result.success && result.saleId && result.date) {
      addToast("‚úÖ Venta Exitosa", 'success')
      setLastSale({
        id: result.saleId,
        date: result.date,
        items: cart.map(i => ({ description: i.name, quantity: i.quantity, price: i.price })),
        total: total,
        method: paymentMethod
      })
      setCart([]) 
      if (searchParams.get("apptId")) router.replace("/pos") 
    } else {
      addToast(result.error || "Error al procesar", 'error')
    }
  }

  if (lastSale) {
    return (
        <TicketView 
            mode="POS"
            saleId={lastSale.id}
            date={lastSale.date}
            items={lastSale.items}
            total={lastSale.total}
            paymentMethod={lastSale.method}
            onClose={() => setLastSale(null)}
        />
    )
  }

  return (
    <>
    {/* Layout Principal: 2 Columnas (Cat√°logo + Ticket) */}
    <div className="flex flex-col md:flex-row h-[calc(100vh-80px)] md:h-[calc(100vh-20px)] gap-6 pb-4 md:pb-0">
      
      {/* === COLUMNA 1: CAT√ÅLOGO === */}
      <div className="flex-1 flex flex-col gap-6 overflow-hidden h-full">
        
        {/* Header de Filtros */}
        <div className="bg-card p-4 rounded-3xl shadow-sm border border-border space-y-3 shrink-0">
            <div className="relative">
                <input 
                    type="text" 
                    placeholder="üîç Buscar producto..." 
                    value={displaySearch}
                    onChange={(e) => setDisplaySearch(e.target.value)}
                    className="w-full p-3 pl-10 border border-input rounded-2xl bg-background text-foreground focus:ring-2 focus:ring-ring outline-none transition font-medium placeholder:text-muted-foreground"
                    autoFocus
                />
                {displaySearch && (
                    <button 
                        onClick={() => setDisplaySearch("")} 
                        className="absolute right-3 top-3 text-muted-foreground hover:text-primary transition"
                    >
                        ‚úï
                    </button>
                )}
            </div>
            
            <div className="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
                {categories.map(cat => (
                    <button
                        key={cat}
                        onClick={() => setSelectedCategory(cat === selectedCategory ? "ALL" : cat)}
                        className={cn(
                            "px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition",
                            selectedCategory === cat 
                                ? 'bg-primary text-primary-foreground border-primary shadow-md' 
                                : 'bg-card text-muted-foreground border-border hover:bg-secondary/20 hover:text-foreground'
                        )}
                    >
                        {cat === "ALL" ? "Todo" : cat}
                    </button>
                ))}
            </div>
        </div>

        {/* Grid de Productos */}
        <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
            {filteredProducts.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-64 text-muted-foreground opacity-60">
                    <span className="text-5xl mb-3">üßê</span>
                    <p className="font-medium">Sin resultados para "{debouncedSearch}"</p>
                    <button 
                        onClick={() => {setDisplaySearch(""); setSelectedCategory("ALL")}} 
                        className="text-primary underline text-sm mt-2 font-bold"
                    >
                        Limpiar b√∫squeda
                    </button>
                </div>
            ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 pb-20">
                    {filteredProducts.map(p => {
                        const isOOS = p.totalStock === 0
                        // Badges de stock con colores sem√°nticos o hardcoded para alerta visual clara
                        const stockColor = isOOS 
                            ? 'bg-zinc-500' 
                            : p.totalStock <= 3 ? 'bg-orange-500' : 'bg-green-500'

                        return (
                        <button 
                            key={p.id}
                            onClick={() => handleProductClick(p)}
                            disabled={isOOS}
                            className={cn(
                                "group relative flex flex-col p-3 rounded-2xl border transition-all duration-200 text-left overflow-hidden",
                                isOOS 
                                    ? "bg-muted border-border opacity-50 grayscale cursor-not-allowed" 
                                    : "bg-card border-border hover:border-primary hover:shadow-lg hover:shadow-primary/10 hover:-translate-y-1"
                            )}
                        >
                            {/* IMAGEN */}
                            <div className="w-full aspect-square bg-muted rounded-xl overflow-hidden relative mb-3">
                                {p.imageUrl ? (
                                    <Image 
                                        src={p.imageUrl} 
                                        alt={p.name} 
                                        fill
                                        className="object-cover transition-transform duration-500 group-hover:scale-110"
                                        sizes="(max-width: 768px) 50vw, 20vw"
                                    />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center text-xs text-muted-foreground font-bold">
                                        Sin Foto
                                    </div>
                                )}
                                <div className={cn(
                                    "absolute top-2 right-2 px-2 py-0.5 rounded-md text-[10px] font-black text-white shadow-sm z-10",
                                    stockColor
                                )}>
                                    {p.totalStock}
                                </div>
                            </div>
                            
                            {/* INFO */}
                            <div className="flex-1 min-w-0">
                                <h3 className="font-bold text-foreground text-sm leading-tight line-clamp-2 mb-1 group-hover:text-primary transition-colors">
                                    {p.name}
                                </h3>
                                <p className="text-[10px] font-bold text-muted-foreground uppercase truncate">
                                    {p.ownerName}
                                </p>
                            </div>
                            
                            {/* PRECIO */}
                            <div className="mt-3 pt-2 border-t border-dashed border-border flex justify-between items-center w-full">
                                {p.variants.length > 1 ? (
                                    <span className="text-[10px] font-bold bg-secondary/20 text-foreground px-2 py-1 rounded-full">
                                        Opciones
                                    </span>
                                ) : (
                                    <span className="text-primary font-black text-lg">
                                        ${p.variants[0]?.price || 0}
                                    </span>
                                )}
                            </div>
                        </button>
                    )})}
                </div>
            )}
        </div>
      </div>

      {/* === COLUMNA 2: TICKET / CARRITO === */}
      <div className="w-full md:w-[380px] shrink-0 h-full flex flex-col">
        <div className="bg-card border border-border rounded-3xl shadow-xl flex flex-col h-full overflow-hidden relative">
          
          {/* Header Ticket */}
          <div className="p-5 border-b border-border bg-muted/30 backdrop-blur-sm flex justify-between items-center">
            <h2 className="font-black text-lg text-foreground font-nunito flex items-center gap-2">
                üõçÔ∏è Ticket
            </h2>
            <span className="text-xs font-bold bg-background text-muted-foreground border border-border px-2 py-1 rounded-lg">
                {cart.length} items
            </span>
          </div>
          
          {/* Items del Carrito */}
          <div className="p-4 space-y-3 flex-1 overflow-y-auto custom-scrollbar">
            {cart.length === 0 && (
              <div className="h-full flex flex-col items-center justify-center text-center opacity-40 p-8">
                <span className="text-6xl mb-4 grayscale">üõí</span>
                <p className="text-sm font-bold text-foreground">Carrito vac√≠o</p>
                <p className="text-xs text-muted-foreground mt-1">Seleccion√° productos para cobrar.</p>
              </div>
            )}
            
            {cart.map((item, index) => (
              <div key={index} className="flex justify-between items-start p-3 bg-background rounded-2xl border border-transparent hover:border-border transition animate-in slide-in-from-right-4">
                <div className="flex-1 min-w-0 pr-3">
                  <p className="font-bold text-foreground text-sm truncate">
                    {item.type === 'SERVICE' && <span className="mr-1">‚úÇÔ∏è</span>}
                    {item.name}
                  </p>
                  
                  {item.type === 'SERVICE' ? (
                     <div className="mt-1 flex items-center gap-2">
                        <span className="text-xs text-muted-foreground font-bold">$</span>
                        <input 
                            type="number" 
                            value={item.price} 
                            onChange={(e) => updateServicePrice(index, e.target.value)}
                            className="w-20 border border-input rounded px-1 py-0.5 text-sm font-bold bg-card text-foreground focus:ring-1 focus:ring-ring outline-none"
                        />
                     </div>
                  ) : (
                     <div className="flex items-center gap-2 mt-1">
                        <span className="text-xs font-medium text-muted-foreground bg-card px-1.5 py-0.5 rounded border border-border">
                            {item.quantity} un.
                        </span>
                        <span className="text-xs text-muted-foreground">x ${item.price}</span>
                     </div>
                  )}
                </div>

                <div className="flex flex-col items-end gap-1">
                    <span className="font-black text-foreground">
                        ${(item.quantity * item.price).toLocaleString()}
                    </span>
                    <button 
                        onClick={() => removeFromCart(index)} 
                        className="text-[10px] font-bold text-red-400 hover:text-red-600 hover:bg-red-100 dark:hover:bg-red-900/20 px-2 py-1 rounded transition"
                    >
                        ELIMINAR
                    </button>
                </div>
              </div>
            ))}
          </div>

          {/* Footer Pago */}
          <div className="p-5 bg-card border-t border-border z-10">
             {/* Selector M√©todo Pago */}
             <div className="grid grid-cols-2 gap-3 mb-5">
                <button 
                    onClick={() => setPaymentMethod("CASH")}
                    className={cn(
                        "p-3 rounded-xl text-xs font-black border transition flex items-center justify-center gap-2",
                        paymentMethod === "CASH" 
                            ? "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border-green-500" 
                            : "bg-background border-border text-muted-foreground"
                    )}
                >
                    üíµ EFECTIVO
                </button>
                <button 
                    onClick={() => setPaymentMethod("TRANSFER")}
                    className={cn(
                        "p-3 rounded-xl text-xs font-black border transition flex items-center justify-center gap-2",
                        paymentMethod === "TRANSFER" 
                            ? "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border-blue-500" 
                            : "bg-background border-border text-muted-foreground"
                    )}
                >
                    üè¶ TRANSFER
                </button>
             </div>

             <div className="flex justify-between items-end mb-5">
                <span className="text-muted-foreground text-sm font-bold uppercase">Total a Pagar</span>
                <span className="text-4xl font-black text-foreground tracking-tight">
                    ${total.toLocaleString()}
                </span>
             </div>
             
             <button 
              onClick={handleCheckout}
              disabled={cart.length === 0 || loading}
              className={cn(
                  "w-full py-4 rounded-xl font-black text-lg transition active:scale-95 text-primary-foreground shadow-xl flex items-center justify-center gap-2",
                  cart.length === 0 
                    ? 'bg-muted text-muted-foreground cursor-not-allowed shadow-none' 
                    : 'bg-gradient-to-r from-primary to-accent hover:from-accent hover:to-primary hover:shadow-primary/25'
              )}
            >
              {loading ? (
                  <span className="animate-pulse">Procesando...</span>
              ) : (
                  <>
                    <span>COBRAR</span>
                    <span>‚Üí</span>
                  </>
              )}
            </button>
          </div>
        </div>
      </div>
    </div>

    {/* ==============================================
        MODAL SELECCI√ìN VARIANTE
       ============================================== */}
    {selectedProductForModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-card rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-border">
                <div className="p-5 border-b border-border flex justify-between items-center bg-muted/30">
                    <div>
                        <h3 className="font-black text-lg text-foreground font-nunito">{selectedProductForModal.name}</h3>
                        <p className="text-xs text-muted-foreground font-bold uppercase">Seleccion√° variante</p>
                    </div>
                    <button 
                        onClick={() => setSelectedProductForModal(null)} 
                        className="w-8 h-8 rounded-full bg-border flex items-center justify-center text-muted-foreground hover:bg-input transition"
                    >
                        ‚úï
                    </button>
                </div>
                
                <div className="p-4 max-h-[60vh] overflow-y-auto custom-scrollbar grid grid-cols-2 gap-3">
                    {selectedProductForModal.variants.map(variant => {
                        const hasStock = variant.stock > 0
                        return (
                            <button
                                key={variant.id}
                                disabled={!hasStock}
                                onClick={() => {
                                    addVariantToCart(selectedProductForModal.name, variant)
                                    setSelectedProductForModal(null)
                                }}
                                className={cn(
                                    "p-4 border rounded-2xl text-left transition flex flex-col justify-between h-24 relative overflow-hidden",
                                    hasStock 
                                        ? 'bg-background border-border hover:border-primary hover:ring-1 hover:ring-primary/50' 
                                        : 'bg-muted border-transparent opacity-50 cursor-not-allowed'
                                )}
                            >
                                <div className="z-10 relative">
                                    <span className="font-bold text-foreground block text-sm mb-1">{variant.name}</span>
                                    {hasStock ? (
                                        <span className="text-primary font-black text-lg">${variant.price}</span>
                                    ) : (
                                        <span className="text-xs font-bold text-red-500 uppercase bg-red-100 dark:bg-red-900/30 px-2 py-0.5 rounded">Agotado</span>
                                    )}
                                </div>

                                {hasStock && (
                                    <div className="absolute bottom-2 right-2 text-[10px] font-bold bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-1 rounded-full">
                                        {variant.stock} u.
                                    </div>
                                )}
                            </button>
                        )
                    })}
                </div>
            </div>
        </div>
    )}
    </>
  )
}

--- File: ProductActions.tsx (in subfolder: components) ---

// src/components/ProductActions.tsx
'use client'

import { toggleProductStatus } from "@/actions/product-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"

export default function ProductActions({ id, isActive, stock }: { id: string, isActive: boolean, stock: number }) {
  const router = useRouter()

  const handleToggle = async () => {
    if (isActive && stock > 0) {
        alert("‚ö†Ô∏è No pod√©s archivar un producto con stock.\nHac√© un retiro o ajuste a 0 primero.")
        return
    }

    if (!confirm(isActive ? "¬øArchivar producto?" : "¬øReactivar producto?")) return

    const res = await toggleProductStatus(id, isActive)
    if (res.error) alert(res.error)
    else router.refresh()
  }

  return (
    <div className="flex gap-2">
      {/* Bot√≥n EDITAR (Link simple) */}
      <Link 
        href={`/products/${id}/edit`} 
        className="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold hover:bg-blue-200"
      >
        EDITAR
      </Link>

      {/* Bot√≥n ARCHIVAR/ACTIVAR */}
      <button
        onClick={handleToggle}
        className={`px-3 py-1 rounded text-xs font-bold border transition
          ${isActive 
            ? 'bg-white text-red-600 border-red-200 hover:bg-red-50' 
            : 'bg-green-100 text-green-700 border-transparent hover:bg-green-200'
          }
        `}
      >
        {isActive ? "ARCHIVAR" : "ACTIVAR"}
      </button>
    </div>
  )
}

--- File: ProductForm.tsx (in subfolder: components) ---

// src/components/ProductForm.tsx
'use client'

import { useState } from "react"
import { createProduct, updateProduct } from "@/actions/product-actions"
import ImageUpload from "./ImageUpload"
import { useRouter } from "next/navigation"

// Tipo para las variantes en el estado local
type VariantItem = {
  id?: string // Si tiene ID, existe en DB. Si no, es nueva.
  name: string
  costPrice: number
  salePrice: number
  stock?: number // Solo lectura (el stock se mueve por inventario)
}

type Props = {
  owners: { id: string; name: string }[]
  categories: { id: string; name: string }[]
  initialData?: {
    id: string
    name: string
    description: string | null
    ownerId: string
    categoryId: string
    imageUrl: string | null
    variants: VariantItem[] // üëà Ahora recibimos lista
  }
}

export default function ProductForm({ owners, categories, initialData }: Props) {
  const router = useRouter()
  const [imageUrl, setImageUrl] = useState(initialData?.imageUrl || "")
  const [loading, setLoading] = useState(false)
  const [isNewCategory, setIsNewCategory] = useState(false)

  // ESTADO DE VARIANTES
  // Si es nuevo producto, arrancamos con una variante "Est√°ndar" por comodidad
  const [variants, setVariants] = useState<VariantItem[]>(
    initialData?.variants || [{ name: "Est√°ndar", costPrice: 0, salePrice: 0 }]
  )

  const addVariant = () => {
    setVariants([...variants, { name: "", costPrice: 0, salePrice: 0 }])
  }

  const removeVariant = (index: number) => {
    // No permitimos vaciar la lista, m√≠nimo 1 variante.
    if (variants.length <= 1) return alert("Debe haber al menos una variante.")
    
    // Si tiene ID (existe en DB), advertimos que esto NO borra la variante de la DB en este form simple
    // Para borrar variantes con historia se requiere otra l√≥gica. Aqu√≠ solo la quitamos de la vista de edici√≥n.
    if (variants[index].id) {
       alert("‚ö†Ô∏è Nota: Las variantes ya guardadas no se eliminan desde aqu√≠ para proteger el historial de stock.\nSolo se ignorar√°n los cambios.")
    }

    const newList = [...variants]
    newList.splice(index, 1)
    setVariants(newList)
  }

  const updateVariant = (index: number, field: keyof VariantItem, value: string | number) => {
    const newList = [...variants]
    newList[index] = { ...newList[index], [field]: value }
    setVariants(newList)
  }

  const handleSubmit = async (formData: FormData) => {
    // Validar antes de enviar
    if (variants.some(v => !v.name.trim())) return alert("Todas las variantes deben tener nombre (Ej: Talle S)")
    if (variants.some(v => v.salePrice < v.costPrice)) return alert("Revis√° los precios: Hay variantes con rentabilidad negativa.")

    setLoading(true)

    // Agregamos la imagen si existe
    if (imageUrl) formData.append("imageUrl", imageUrl)
    
    // Flag de categor√≠a nueva
    if (isNewCategory) formData.append("isNewCategory", "true")

    // üî• SERIALIZAMOS LAS VARIANTES
    formData.append("variantsJson", JSON.stringify(variants))

    let result;

    if (initialData) {
        // MODO EDICI√ìN
        formData.append("id", initialData.id)
        result = await updateProduct(formData)
        
        if (result?.success) {
            alert("‚úÖ Producto actualizado")
            router.push("/products")
            router.refresh()
        } else {
            alert("‚ùå Error: " + result?.error)
        }

    } else {
        // MODO CREACI√ìN
        result = await createProduct(formData)
        if (result?.error) alert("‚ùå Error: " + result.error)
    }
    
    setLoading(false)
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto border">
      <h2 className="text-xl font-bold mb-6 text-gray-800">
        {initialData ? "Editar Producto y Variantes" : "Nuevo Producto"}
      </h2>
      
      <form action={handleSubmit} className="space-y-6">
        
        {/* === DATOS GENERALES === */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-4">
                <div>
                    <label className="block text-sm font-bold text-gray-700">Nombre del Producto *</label>
                    <input 
                        name="name" 
                        defaultValue={initialData?.name} 
                        type="text" 
                        required 
                        placeholder="Ej: Collar de Cuero"
                        className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                    />
                </div>
                <div>
                    <label className="block text-sm font-bold text-gray-700">Descripci√≥n</label>
                    <textarea 
                        name="description" 
                        defaultValue={initialData?.description || ""} 
                        className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                        rows={2} 
                    />
                </div>
            </div>

            <div className="space-y-4">
                 <div>
                    <label className="block text-sm font-bold text-gray-700">Due√±o *</label>
                    <select 
                        name="ownerId" 
                        defaultValue={initialData?.ownerId || ""} 
                        required 
                        className="w-full border p-2 rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none"
                    >
                        <option value="">Seleccionar...</option>
                        {owners.map(o => (
                            <option key={o.id} value={o.id}>{o.name}</option>
                        ))}
                    </select>
                </div>

                <div>
                    <div className="flex justify-between items-center mb-1">
                        <label className="block text-sm font-bold text-gray-700">Categor√≠a *</label>
                        <button 
                            type="button"
                            onClick={() => setIsNewCategory(!isNewCategory)}
                            className="text-xs text-blue-600 font-bold hover:underline"
                        >
                            {isNewCategory ? "Volver a Lista" : "+ Nueva"}
                        </button>
                    </div>
                    {isNewCategory ? (
                        <input 
                            name="categoryName"
                            type="text"
                            placeholder="Nueva categor√≠a..."
                            className="w-full border p-2 rounded bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                    ) : (
                        <select 
                            name="categoryId" 
                            defaultValue={initialData?.categoryId || ""} 
                            required 
                            className="w-full border p-2 rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                            <option value="">Seleccionar...</option>
                            {categories.map(c => (
                                <option key={c.id} value={c.id}>{c.name}</option>
                            ))}
                        </select>
                    )}
                </div>
            </div>
        </div>

        <hr className="border-gray-200" />

        {/* === VARIANTES (TABLA DIN√ÅMICA) === */}
        <div>
            <div className="flex justify-between items-end mb-2">
                <label className="text-sm font-bold text-gray-700">Variantes / Talles / Colores</label>
                <button 
                    type="button" 
                    onClick={addVariant}
                    className="text-xs bg-slate-800 text-white px-3 py-1 rounded hover:bg-black font-bold"
                >
                    + Agregar Variante
                </button>
            </div>
            
            <div className="border rounded-lg overflow-hidden shadow-sm">
                <table className="w-full text-sm">
                    <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                        <tr>
                            <th className="p-3 text-left">Variante (Ej: "XL")</th>
                            <th className="p-3 text-left w-32">Costo</th>
                            <th className="p-3 text-left w-32">Venta</th>
                            <th className="p-3 text-center w-20">Stock</th>
                            <th className="p-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody className="divide-y bg-white">
                        {variants.map((variant, idx) => (
                            <tr key={idx}>
                                <td className="p-2">
                                    <input 
                                        type="text" 
                                        value={variant.name}
                                        onChange={(e) => updateVariant(idx, 'name', e.target.value)}
                                        placeholder="Ej: Est√°ndar, Rojo S..."
                                        className="w-full border p-1.5 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                    />
                                </td>
                                <td className="p-2">
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={variant.costPrice}
                                        onChange={(e) => updateVariant(idx, 'costPrice', parseFloat(e.target.value) || 0)}
                                        className="w-full border p-1.5 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                    />
                                </td>
                                <td className="p-2">
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={variant.salePrice}
                                        onChange={(e) => updateVariant(idx, 'salePrice', parseFloat(e.target.value) || 0)}
                                        className="w-full border p-1.5 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                    />
                                </td>
                                <td className="p-2 text-center text-gray-500 font-mono">
                                    {variant.id ? variant.stock : '-'}
                                </td>
                                <td className="p-2 text-center">
                                    <button 
                                        type="button" 
                                        onClick={() => removeVariant(idx)}
                                        className="text-red-400 hover:text-red-600 font-bold px-2"
                                        title="Quitar de la lista"
                                    >
                                        ‚úï
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <p className="text-xs text-gray-400 mt-2">
                * El stock inicial de nuevas variantes es 0. Hac√© un Ingreso de Mercader√≠a luego de crear el producto.
            </p>
        </div>

        {/* === IMAGEN Y SUBMIT === */}
        <div className="border-t pt-4 flex items-center justify-between">
            <div className="w-1/2">
                <ImageUpload onImageUpload={(url) => setImageUrl(url)} />
                {imageUrl && <p className="text-xs text-green-600 mt-1">‚úì Imagen lista para guardar</p>}
            </div>
            
            <button 
                type="submit" 
                disabled={loading}
                className={`px-8 py-3 rounded font-bold text-white shadow transition
                    ${loading 
                        ? 'bg-gray-400 cursor-wait' 
                        : 'bg-green-600 hover:bg-green-700 active:scale-95'
                    }
                `}
            >
                {loading ? "Guardando..." : "GUARDAR TODO"}
            </button>
        </div>

      </form>
    </div>
  )
}

--- File: ReceiptModal.tsx (in subfolder: components) ---

// src/components/ReceiptModal.tsx
'use client'

import { useState } from "react"
import TicketView from "./TicketView"

type SaleData = {
  id: string
  total: number
  paymentMethod: string
  createdAt: Date
  items: { description: string; quantity: number; priceAtSale: number }[]
}

export default function ReceiptModal({ sale }: { sale: SaleData }) {
  const [isOpen, setIsOpen] = useState(false)

  // Mapeamos los datos de DB a lo que espera el Ticket
  const ticketItems = sale.items.map(i => ({
    description: i.description,
    quantity: i.quantity,
    price: i.priceAtSale // El ticket espera 'price', la DB tiene 'priceAtSale'
  }))

  return (
    <>
      {/* EL BOT√ìN ACTIVADOR */}
      <button 
        onClick={(e) => {
            e.stopPropagation() // Evita que se cierre/abra el acorde√≥n de la fila
            setIsOpen(true)
        }}
        className="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold px-3 py-1 rounded border border-gray-300 flex items-center gap-1 transition"
      >
        üìÑ Ver Ticket
      </button>

      {/* EL MODAL (Solo visible si isOpen === true) */}
      {isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            
            {/* Contenedor del Ticket (Con scroll si es muy alto) */}
            <div className="bg-transparent w-full max-w-lg max-h-screen overflow-y-auto">
                <TicketView 
                    mode="HISTORY"
                    saleId={sale.id}
                    date={sale.createdAt}
                    items={ticketItems}
                    total={sale.total}
                    paymentMethod={sale.paymentMethod}
                    onClose={() => setIsOpen(false)} // Cierra el modal
                />
            </div>

        </div>
      )}
    </>
  )
}

--- File: SaleRow.tsx (in subfolder: components) ---

// src/components/SaleRow.tsx
'use client'

import { useState } from "react"
import CancelSaleButton from "./CancelSaleButton"
import ReceiptModal from "./ReceiptModal" // üëà Importamos

type SaleItem = {
  description: string
  quantity: number
  priceAtSale: number 
}

type SaleData = {
  id: string
  total: number
  paymentMethod: string
  status: string
  createdAt: Date
  items: SaleItem[]
}

export default function SaleRow({ sale }: { sale: SaleData }) {
  const [isOpen, setIsOpen] = useState(false)

  const dateStr = sale.createdAt.toLocaleDateString()
  const timeStr = sale.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  const isCancelled = sale.status === 'CANCELLED'

  return (
    <>
      <tr 
        onClick={() => setIsOpen(!isOpen)}
        className={`cursor-pointer transition-colors border-b ${isCancelled ? 'bg-red-50 text-gray-500' : 'hover:bg-blue-50 bg-white'}`}
      >
        <td className="p-4 whitespace-nowrap">
            <div className="flex flex-col">
                <span className="font-bold text-gray-800">{dateStr}</span>
                <span className="text-xs text-gray-500">{timeStr}</span>
            </div>
        </td>
        
        <td className="p-4">
            <span className={`text-xs font-bold px-2 py-1 rounded border
                ${sale.paymentMethod === 'CASH' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-blue-100 text-blue-700 border-blue-200'}
            `}>
                {sale.paymentMethod === 'CASH' ? 'EFECTIVO' : 'TRANSFER.'}
            </span>
        </td>

        <td className="p-4">
            <div className="flex items-center gap-2">
                <span className={`font-mono font-bold text-lg ${isCancelled ? 'line-through opacity-50' : 'text-gray-900'}`}>
                    ${sale.total.toLocaleString()}
                </span>
                {isCancelled && <span className="text-xs text-red-600 font-bold bg-red-100 px-1 rounded">ANULADA</span>}
            </div>
        </td>

        <td className="p-4 text-center">
            <span className={`inline-block transition-transform ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
        </td>
      </tr>

      {isOpen && (
        <tr className="bg-gray-50 border-b">
            <td colSpan={4} className="p-4 shadow-inner">
                <div className="flex flex-col sm:flex-row justify-between items-start gap-4">
                    
                    <div className="space-y-2">
                        <p className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Detalle de la venta:</p>
                        <ul className="text-sm space-y-1">
                            {sale.items.map((item, idx) => (
                                <li key={idx} className="flex gap-2">
                                    <span className="font-bold text-gray-700">{item.quantity} x</span>
                                    <span>{item.description}</span>
                                    <span className="text-gray-400">(${Number(item.priceAtSale).toLocaleString()} c/u)</span>
                                </li>
                            ))}
                        </ul>
                        <p className="text-xs text-gray-400 mt-2 font-mono">ID: {sale.id}</p>
                    </div>

                    <div className="flex flex-col gap-2 items-end">
                        
                        {/* üëá AQU√ç AGREGAMOS EL BOT√ìN DE TICKET */}
                        <ReceiptModal sale={sale} />

                        {!isCancelled && (
                            <>
                                <CancelSaleButton saleId={sale.id} />
                                <p className="text-[10px] text-red-500 max-w-[150px] leading-tight text-right">
                                    ‚ö†Ô∏è Anular restaura stock y ajusta deuda.
                                </p>
                            </>
                        )}
                    </div>
                </div>
            </td>
        </tr>
      )}
    </>
  )
}

--- File: SearchInput.tsx (in subfolder: components) ---

// src/components/SearchInput.tsx
'use client'

import { useSearchParams, usePathname, useRouter } from 'next/navigation'
import { useState, useEffect } from 'react'

export default function SearchInput({ placeholder }: { placeholder: string }) {
  const searchParams = useSearchParams()
  const pathname = usePathname()
  const { replace } = useRouter()
  
  // Inicializamos con el valor de la URL
  const [term, setTerm] = useState(searchParams.get('query')?.toString() || '')

  useEffect(() => {
    const timeoutId = setTimeout(() => {
      const params = new URLSearchParams(searchParams)
      
      // L√≥gica de Protecci√≥n anti-bucle:
      // Obtenemos el valor que YA tiene la URL
      const currentQueryInUrl = params.get('query') || ''
      
      // Si lo que escrib√≠ es IGUAL a lo que ya est√° en la URL, NO hago nada.
      // Esto detiene el ciclo infinito de actualizaciones.
      if (currentQueryInUrl === term) return

      if (term) {
        params.set('query', term)
      } else {
        params.delete('query')
      }
      
      replace(`${pathname}?${params.toString()}`)
    }, 300)

    return () => clearTimeout(timeoutId)
  }, [term, searchParams, pathname, replace])

  return (
    <div className="relative flex flex-1 flex-shrink-0">
      <label htmlFor="search" className="sr-only">
        Buscar
      </label>
      <input
        className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 text-sm outline-2 placeholder:text-gray-500 focus:border-blue-500 focus:ring-blue-500"
        placeholder={placeholder}
        value={term}
        onChange={(e) => setTerm(e.target.value)}
      />
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
        className="absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
        />
      </svg>
    </div>
  )
}

--- File: SettlementButton.tsx (in subfolder: components) ---

// src/components/SettlementButton.tsx
'use client' // üëà Esto permite usar onClick y hooks

import { useFormStatus } from "react-dom"

export default function SettlementButton() {
  // useFormStatus detecta si la Server Action se est√° ejecutando
  const { pending } = useFormStatus()

  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    // Confirmaci√≥n nativa del navegador
    const confirmed = confirm("¬øEst√°s seguro de que vas a entregar el dinero?\n\nEsta acci√≥n marcar√° los items como PAGADOS y no se puede deshacer f√°cilmente.")
    
    if (!confirmed) {
      e.preventDefault() // Cancela el env√≠o del formulario
    }
  }

  return (
    <button
      type="submit"
      onClick={handleClick}
      disabled={pending}
      className={`
        px-8 py-3 rounded-lg font-bold text-lg shadow-lg transition transform 
        ${pending 
          ? 'bg-gray-400 cursor-not-allowed' 
          : 'bg-green-600 hover:bg-green-700 hover:scale-105 text-white'
        }
      `}
    >
      {pending ? "Procesando..." : "‚úÖ Confirmar Pago"}
    </button>
  )
}

--- File: SettlementTicket.tsx (in subfolder: components) ---

// src/components/SettlementTicket.tsx
'use client'

import { useRef, useState } from "react"
import html2canvas from "html2canvas"
import jsPDF from "jspdf"
import Link from "next/link"

// Tipos de datos necesarios
type SettlementData = {
  id: string
  createdAt: Date
  totalAmount: number
  owner: { name: string; email: string | null }
  items: { 
    id: string
    description: string
    quantity: number
    costAtSale: number // Lo que se le paga al due√±o
    createdAt: Date // Fecha de venta original
  }[]
  adjustments: {
    id: string
    description: string
    amount: number
    createdAt: Date
  }[]
}

export default function SettlementTicket({ data }: { data: SettlementData }) {
  const [downloading, setDownloading] = useState(false)
  const ticketRef = useRef<HTMLDivElement>(null)

  const handleDownloadPDF = async () => {
    const element = ticketRef.current
    if (!element) return
    setDownloading(true)

    try {
      const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#ffffff" })
      const imgData = canvas.toDataURL('image/png')
      const pdf = new jsPDF('p', 'mm', 'a4')
      
      const pdfWidth = pdf.internal.pageSize.getWidth()
      // Ajustamos altura proporcionalmente
      const imgProps = pdf.getImageProperties(imgData)
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width
      
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight)
      pdf.save(`Liquidacion_${data.owner.name}_${data.createdAt.toISOString().split('T')[0]}.pdf`)
    } catch (e) {
      console.error(e)
      alert("Error generando PDF")
    } finally {
      setDownloading(false)
    }
  }

  return (
    <div className="flex flex-col items-center gap-6 p-8 bg-gray-100 min-h-screen">
      
      {/* BOTONERA SUPERIOR */}
      <div className="flex gap-4 w-full max-w-2xl">
        <Link href={`/owners`} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-bold text-sm">
            ‚Üê Volver
        </Link>
        <button 
            onClick={handleDownloadPDF}
            disabled={downloading}
            className="flex-1 bg-slate-900 hover:bg-black text-white py-2 rounded font-bold shadow transition"
        >
            {downloading ? "Generando..." : "üì• Descargar PDF"}
        </button>
      </div>

      {/* DOCUMENTO IMPRIMIBLE */}
      <div 
        ref={ticketRef} 
        className="bg-white p-12 shadow-2xl max-w-2xl w-full text-sm text-gray-800"
        style={{ minHeight: '800px' }} // Altura A4 aprox visual
      >
        {/* CABECERA */}
        <div className="border-b-2 border-gray-800 pb-6 mb-8 flex justify-between items-start">
            <div>
                <h1 className="text-3xl font-black tracking-tighter text-slate-900">GUAPECANES</h1>
                <p className="text-xs uppercase tracking-widest text-gray-500 mt-1">Liquidaci√≥n de Cuenta</p>
            </div>
            <div className="text-right">
                <p className="font-mono text-gray-500 text-xs">REF: {data.id.slice(0,8)}</p>
                <p className="font-bold text-lg">{data.createdAt.toLocaleDateString()}</p>
            </div>
        </div>

        {/* INFO DUE√ëO */}
        <div className="mb-8 p-4 bg-gray-50 rounded border border-gray-100">
            <p className="text-xs uppercase font-bold text-gray-400 mb-1">Beneficiario</p>
            <h2 className="text-xl font-bold text-gray-800">{data.owner.name}</h2>
            <p className="text-gray-600">{data.owner.email || "Sin email registrado"}</p>
        </div>

        {/* TABLA DE VENTAS LIQUIDADAS */}
        <div className="mb-8">
            <h3 className="font-bold text-gray-700 border-b pb-2 mb-2 uppercase text-xs">Productos Vendidos</h3>
            <table className="w-full text-left">
                <thead className="text-gray-400 text-xs uppercase">
                    <tr>
                        <th className="py-2">Fecha Venta</th>
                        <th className="py-2">Descripci√≥n</th>
                        <th className="py-2 text-right">Subtotal</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-100 font-medium">
                    {data.items.length === 0 ? (
                        <tr><td colSpan={3} className="py-4 text-center text-gray-400 italic">Sin items de venta</td></tr>
                    ) : (
                        data.items.map(item => (
                            <tr key={item.id}>
                                <td className="py-2 text-gray-500">{item.createdAt.toLocaleDateString()}</td>
                                <td className="py-2">
                                    <span className="font-bold mr-1">{item.quantity}x</span>
                                    {item.description}
                                </td>
                                <td className="py-2 text-right">
                                    ${(Number(item.costAtSale) * item.quantity).toLocaleString()}
                                </td>
                            </tr>
                        ))
                    )}
                </tbody>
            </table>
        </div>

        {/* TABLA DE AJUSTES */}
        {data.adjustments.length > 0 && (
            <div className="mb-8">
                <h3 className="font-bold text-gray-700 border-b pb-2 mb-2 uppercase text-xs">Otros Movimientos / Ajustes</h3>
                <table className="w-full text-left">
                    <tbody className="divide-y divide-gray-100 font-medium">
                        {data.adjustments.map(adj => (
                            <tr key={adj.id}>
                                <td className="py-2 text-gray-500">{adj.createdAt.toLocaleDateString()}</td>
                                <td className="py-2">{adj.description}</td>
                                <td className={`py-2 text-right font-bold ${Number(adj.amount) < 0 ? 'text-red-600' : 'text-gray-800'}`}>
                                    ${Number(adj.amount).toLocaleString()}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        )}

        {/* TOTAL FINAL */}
        <div className="flex justify-end mt-10">
            <div className="text-right bg-slate-900 text-white p-6 rounded-lg min-w-[250px]">
                <p className="text-xs uppercase font-bold opacity-70 mb-1">Total Liquidado</p>
                <p className="text-4xl font-black">${Number(data.totalAmount).toLocaleString()}</p>
            </div>
        </div>
        
        <div className="mt-12 pt-8 border-t text-center text-xs text-gray-400">
            <p>Comprobante generado electr√≥nicamente por Sistema Guapecanes.</p>
        </div>

      </div>
    </div>
  )
}

--- File: StockMovementForm.tsx (in subfolder: components) ---

// src/components/StockMovementForm.tsx
'use client'

import { useState } from "react"
import { registerStockMovement } from "@/actions/inventory-actions"
import { useRouter } from "next/navigation"

type ProductOption = {
  variantId: string
  productName: string
  ownerName: string
  stock: number
}

// Props aceptadas: lista de productos y ruta de redirecci√≥n opcional
export default function StockMovementForm({ 
  products, 
  redirectPath 
}: { 
  products: ProductOption[], 
  redirectPath?: string 
}) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setLoading(true)

    const form = e.currentTarget
    const formData = new FormData(form)

    const result = await registerStockMovement(formData)

    if (result.success) {
      alert("‚úÖ Movimiento registrado correctamente")
      form.reset() 
      router.refresh() // Refresca los datos en pantalla (Kardex o Lista)

      // L√≥gica de redirecci√≥n din√°mica
      if (redirectPath) {
          router.push(redirectPath)
      } else {
          router.push("/products")
      }
    } else {
      alert("‚ùå ERROR: " + result.error)
    }

    setLoading(false)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
          
      {/* SELECCI√ìN DE TIPO DE MOVIMIENTO */}
      <div className="flex flex-col gap-3">
        <label className="block text-sm font-medium text-gray-700">Tipo de Acci√≥n</label>
        
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 bg-gray-50 rounded border">
            {/* Opci√≥n 1: Ingreso */}
            <label className="flex items-center gap-2 cursor-pointer p-2 hover:bg-white rounded border border-transparent hover:border-green-200 transition">
                <input type="radio" name="type" value="ENTRY" defaultChecked className="w-5 h-5 text-green-600 focus:ring-green-500" />
                <span className="font-bold text-green-700 text-sm">üü¢ Ingreso <br/><span className="text-xs font-normal text-gray-500">Nuevo stock</span></span>
            </label>

            {/* Opci√≥n 2: Retiro Due√±o */}
            <label className="flex items-center gap-2 cursor-pointer p-2 hover:bg-white rounded border border-transparent hover:border-orange-200 transition">
                <input type="radio" name="type" value="OWNER_WITHDRAWAL" className="w-5 h-5 text-orange-600 focus:ring-orange-500" />
                <span className="font-bold text-orange-700 text-sm">üü† Retiro Due√±o <br/><span className="text-xs font-normal text-gray-500">Devoluci√≥n</span></span>
            </label>

            {/* Opci√≥n 3: Ajuste/Rotura */}
            <label className="flex items-center gap-2 cursor-pointer p-2 hover:bg-white rounded border border-transparent hover:border-red-200 transition">
                <input type="radio" name="type" value="ADJUSTMENT" className="w-5 h-5 text-red-600 focus:ring-red-500" />
                <span className="font-bold text-red-700 text-sm">üî¥ Baja / Rotura <br/><span className="text-xs font-normal text-gray-500">P√©rdida</span></span>
            </label>
        </div>
      </div>

      {/* SELECCI√ìN DE PRODUCTO */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Variante a Ajustar</label>
        <select 
            name="variantId" 
            required 
            className="w-full border p-3 rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none"
        >
          {products.length > 1 && <option value="">Seleccionar variante...</option>}
          {products.map(p => (
            <option key={p.variantId} value={p.variantId}>
              {p.productName} (Stock actual: {p.stock})
            </option>
          ))}
        </select>
      </div>

      {/* CANTIDAD */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Cantidad (Unidades)</label>
        <input 
          name="quantity" 
          type="number" 
          min="1" 
          required 
          className="w-full border p-3 rounded text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none" 
          placeholder="Ej: 5"
        />
      </div>

      {/* MOTIVO */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Nota / Motivo (Opcional)</label>
        <input 
          name="reason" 
          type="text" 
          className="w-full border p-3 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
          placeholder="Ej: Remito #1234 / Se rompi√≥ al limpiar"
        />
      </div>

      <button 
        type="submit" 
        disabled={loading}
        className={`w-full py-3 rounded text-white font-bold text-lg shadow-lg transform transition 
            ${loading 
                ? 'bg-slate-400 cursor-wait' 
                : 'bg-slate-800 hover:bg-slate-900 hover:scale-[1.02] active:scale-95'
            }
        `}
      >
        {loading ? "Procesando..." : "Confirmar Movimiento"}
      </button>

    </form>
  )
}

--- File: ThemeProvider.tsx (in subfolder: components) ---

"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

--- File: ThemeToggle.tsx (in subfolder: components) ---

"use client"

import { useTheme } from "next-themes"
import { useEffect, useState } from "react"

export function ThemeToggle() {
  const { theme, setTheme } = useTheme()
  const [mounted, setMounted] = useState(false)

  // Esperar a que el cliente monte para evitar error de hidrataci√≥n
  useEffect(() => setMounted(true), [])

  if (!mounted) return null

  return (
    <button
      onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
      className="
        p-2 rounded-full transition-all duration-300
        bg-secondary hover:bg-primary text-secondary-foreground hover:scale-110 shadow-lg
      "
      aria-label="Cambiar tema"
    >
      {theme === "dark" ? "üåô" : "‚òÄÔ∏è"}
    </button>
  )
}

--- File: TicketView.tsx (in subfolder: components) ---

// src/components/TicketView.tsx
'use client'

import { useState, useRef } from "react"
import jsPDF from "jspdf"
import html2canvas from "html2canvas"

type TicketProps = {
  saleId: string
  date: Date
  items: { description: string; quantity: number; price: number }[]
  total: number
  paymentMethod: string
  onClose: () => void // üëà Renombramos onNewSale a onClose para que sea gen√©rico
  mode?: 'POS' | 'HISTORY' // üëà Nuevo: Para saber qu√© texto mostrar
}

export default function TicketView({ saleId, date, items, total, paymentMethod, onClose, mode = 'POS' }: TicketProps) {
  const [downloading, setDownloading] = useState(false)
  const ticketRef = useRef<HTMLDivElement>(null)

  const handleDownloadPDF = async () => {
    const element = ticketRef.current
    if (!element) return

    setDownloading(true)

    try {
      const canvas = await html2canvas(element, {
        scale: 2,
        backgroundColor: "#ffffff",
        logging: false,
        useCORS: true,
        onclone: (documentClone) => {
            const el = documentClone.getElementById('printable-ticket')
            if (el) {
                el.style.backgroundColor = "#ffffff"
                el.style.color = "#000000"
            }
        }
      })

      const imgData = canvas.toDataURL('image/png')
      const pdf = new jsPDF('p', 'mm', 'a4')
      
      const pdfWidth = pdf.internal.pageSize.getWidth()
      const imgWidth = canvas.width
      const imgHeight = canvas.height
      
      const margin = 20
      const finalWidth = pdfWidth - (margin * 2)
      const finalHeight = (imgHeight * finalWidth) / imgWidth

      pdf.addImage(imgData, 'PNG', margin, 20, finalWidth, finalHeight)
      pdf.save(`Ticket_${saleId.slice(0, 8)}.pdf`)

    } catch (error: any) {
      console.error("Error PDF:", error)
      alert("Error al crear PDF.")
    } finally {
      setDownloading(false)
    }
  }

  return (
    <div className="flex flex-col items-center justify-center h-full p-4 animate-in zoom-in-95 duration-300 w-full">
        
        {/* TICKET VISUAL */}
        <div 
            id="printable-ticket"
            ref={ticketRef} 
            className="p-10 rounded-none shadow-xl border w-full max-w-md relative overflow-hidden bg-white text-black"
            style={{ backgroundColor: "#ffffff", color: "#000000" }}
        >
            <div className="text-center mb-8 border-b-2 pb-4" style={{ borderColor: "#1e293b" }}>
                <h2 className="text-3xl font-black tracking-tighter" style={{ color: "#1e293b" }}>GUAPECANES</h2>
                <p className="text-xs uppercase tracking-[0.3em] mt-1" style={{ color: "#64748b" }}>
                    {mode === 'POS' ? 'Comprobante de Venta' : 'Copia de Comprobante'}
                </p>
            </div>

            <div className="grid grid-cols-2 gap-4 text-sm mb-6" style={{ color: "#475569" }}>
                <div>
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>Fecha</p>
                    <p>{new Date(date).toLocaleDateString()}</p>
                </div>
                <div className="text-right">
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>Hora</p>
                    <p>{new Date(date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                </div>
                <div>
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>ID Operaci√≥n</p>
                    <p className="font-mono text-xs">{saleId.slice(0,8)}</p>
                </div>
                <div className="text-right">
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>Pago</p>
                    <p>{paymentMethod === 'CASH' ? 'Efectivo' : 'Transferencia'}</p>
                </div>
            </div>

            <table className="w-full text-sm mb-6">
                <thead>
                    <tr className="border-b-2 text-xs uppercase" style={{ borderColor: "#f1f5f9", color: "#94a3b8" }}>
                        <th className="text-left py-2">Item</th>
                        <th className="text-right py-2">Total</th>
                    </tr>
                </thead>
                <tbody className="font-medium">
                    {items.map((item, i) => (
                        <tr key={i} className="border-b" style={{ borderColor: "#f8fafc" }}>
                            <td className="py-2">
                                <span className="font-bold mr-2">{item.quantity}x</span>
                                {item.description}
                            </td>
                            <td className="py-2 text-right">${(item.price * item.quantity).toLocaleString()}</td>
                        </tr>
                    ))}
                </tbody>
            </table>

            <div className="p-4 rounded-lg flex justify-between items-center" style={{ backgroundColor: "#f8fafc" }}>
                <span className="text-sm font-bold uppercase" style={{ color: "#64748b" }}>Total a Pagar</span>
                <span className="text-3xl font-black" style={{ color: "#0f172a" }}>${total.toLocaleString()}</span>
            </div>
            
            <div className="mt-8 text-center text-[10px]" style={{ color: "#94a3b8" }}>
               <p>Documento generado electr√≥nicamente.</p>
            </div>
        </div>

        {/* BOTONERA */}
        <div className="mt-8 flex flex-col gap-3 w-full max-w-sm">
            <button 
                onClick={handleDownloadPDF}
                disabled={downloading}
                className={`w-full py-4 rounded-lg font-bold flex items-center justify-center gap-2 shadow-lg transition text-white
                    ${downloading ? 'bg-slate-400 cursor-wait' : 'bg-red-600 hover:bg-red-700'}
                `}
            >
                {downloading ? "Generando PDF..." : "üì• Descargar Comprobante"}
            </button>

            <button 
                onClick={onClose}
                className="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-lg mt-2 shadow transition"
            >
                {mode === 'POS' ? '‚ú® Nueva Venta' : 'Cerrar Vista'}
            </button>
        </div>
    </div>
  )
}

--- File: Toast.tsx (in subfolder: components\ui) ---

// src/components/ui/Toast.tsx
'use client'

import { useState, useEffect } from 'react'
import { create } from 'zustand' // Recomiendo instalar zustand: npm install zustand

// 1. Store simple para manejar estado global de notificaciones
type ToastType = { id: string; message: string; type: 'success' | 'error' | 'info' }

interface ToastStore {
  toasts: ToastType[]
  addToast: (message: string, type: 'success' | 'error' | 'info') => void
  removeToast: (id: string) => void
}

export const useToast = create<ToastStore>((set) => ({
  toasts: [],
  addToast: (msg, type) => {
    const id = Math.random().toString(36).substring(2, 9)
    set((state) => ({ toasts: [...state.toasts, { id, message: msg, type }] }))
    setTimeout(() => {
      set((state) => ({ toasts: state.toasts.filter((t) => t.id !== id) }))
    }, 4000) // Auto-cierre
  },
  removeToast: (id) => set((state) => ({ toasts: state.toasts.filter((t) => t.id !== id) })),
}))

// 2. Componente Visual
export function Toaster() {
  const { toasts, removeToast } = useToast()

  return (
    <div className="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2">
      {toasts.map((toast) => (
        <div
          key={toast.id}
          onClick={() => removeToast(toast.id)}
          className={`
            px-4 py-3 rounded-xl shadow-lg border cursor-pointer transition-all animate-in slide-in-from-right-10 fade-in
            ${toast.type === 'success' ? 'bg-white border-green-200 text-green-700 border-l-4 border-l-green-500' : ''}
            ${toast.type === 'error' ? 'bg-white border-red-200 text-red-700 border-l-4 border-l-red-500' : ''}
            ${toast.type === 'info' ? 'bg-slate-800 text-white border-slate-700' : ''}
          `}
        >
          <div className="flex items-center gap-3">
            <span className="text-xl">
              {toast.type === 'success' && '‚ú®'}
              {toast.type === 'error' && 'üö´'}
              {toast.type === 'info' && '‚ÑπÔ∏è'}
            </span>
            <p className="font-bold text-sm">{toast.message}</p>
          </div>
        </div>
      ))}
    </div>
  )
}

--- File: prisma.ts (in subfolder: lib) ---

// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    // üëá QUITAMOS 'query' para reducir el ruido en consola
    log: ['error', 'warn'], 
  })

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

--- File: utils.ts (in subfolder: lib) ---

// src/lib/utils.ts
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

/**
 * Combina clases de Tailwind CSS de forma inteligente.
 * Resuelve conflictos (ej: si pasas 'bg-red-500' y luego 'bg-blue-500', gana el √∫ltimo).
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Devuelve la fecha actual en Argentina (GMT-3) en formato YYYY-MM-DD.
 * √ötil para establecer el valor por defecto en inputs type="date".
 */
export function getLocalDateISO(): string {
  // Obtenemos la fecha actual
  const now = new Date()
  
  // Forzamos el offset de Argentina (-3 horas)
  // Nota: Esto es una aproximaci√≥n manual r√°pida para evitar librer√≠as pesadas como date-fns-tz
  const offsetMs = -3 * 60 * 60 * 1000
  const argentinaTime = new Date(now.getTime() + offsetMs)
  
  return argentinaTime.toISOString().split('T')[0]
}

/**
 * Construye un objeto Date asegurando que sea interpretado como GMT-3 (Argentina).
 * Prisma guardar√° esto en UTC, pero la conversi√≥n ser√° correcta.
 * 
 * @param dateStr Formato "YYYY-MM-DD"
 * @param timeStr Formato "HH:MM" (opcional, default 00:00)
 */
export function buildArgentinaDate(dateStr: string, timeStr: string = "00:00:00"): Date {
  // Aseguramos formato de segundos
  const timeFull = timeStr.length === 5 ? `${timeStr}:00` : timeStr
  
  // Construimos string ISO con el offset expl√≠cito de Argentina
  const isoString = `${dateStr}T${timeFull}-03:00`
  
  return new Date(isoString)
}

/**
 * Devuelve el rango de inicio y fin de un d√≠a espec√≠fico en Argentina.
 * Se usa para buscar en la base de datos (ej: "Dames los turnos de hoy").
 */
export function getArgentinaDayRange(dateStr?: string) {
  const targetDate = dateStr || getLocalDateISO()
  
  // Inicio del d√≠a: 00:00:00.000 GMT-3
  const start = buildArgentinaDate(targetDate, "00:00:00")
  
  // Fin del d√≠a: 23:59:59.999 GMT-3
  // Sumamos casi 24hs (menos 1ms) al inicio
  const end = new Date(start.getTime() + (24 * 60 * 60 * 1000) - 1)
  
  return { start, end, dateStr: targetDate }
}

--- File: inventory-service.ts (in subfolder: services) ---

// src/services/inventory-service.ts
import { prisma } from "@/lib/prisma"

export type StockHistoryEntry = {
  id: string
  date: Date
  type: string      // Traducido o raw
  quantity: number  // + o -
  reason: string | null
  user: string
  balanceAfter: number | null // Futuro: Para c√°lculo de saldo parcial
}

/**
 * Obtiene el historial de movimientos de una variante.
 * Ordenado del m√°s reciente al m√°s antiguo.
 */
export async function getVariantStockHistory(variantId: string, limit = 50): Promise<StockHistoryEntry[]> {
  const movements = await prisma.stockMovement.findMany({
    where: { variantId },
    orderBy: { createdAt: 'desc' },
    take: limit
  })

  // Mapeamos a una estructura limpia para el frontend
  return movements.map(m => ({
    id: m.id,
    date: m.createdAt,
    type: m.type, // ENTRY, SALE, etc.
    quantity: m.quantity,
    reason: m.reason || "Sin detalle",
    user: m.userId,
    balanceAfter: null // Por ahora null, implementar si se requiere c√°lculo costoso
  }))
}

/**
 * Helper para traducir los c√≥digos t√©cnicos a humano
 */
export function translateMovementType(type: string): string {
  const dictionary: Record<string, string> = {
    ENTRY: "üü¢ Ingreso Mercader√≠a",
    SALE: "üõí Venta",
    ADJUSTMENT: "‚ö†Ô∏è Ajuste Manual",
    OWNER_WITHDRAWAL: "üì¶ Retiro de Due√±o",
    RETURN: "‚Ü©Ô∏è Devoluci√≥n",
    SALE_CANCELLED: "üö´ Venta Anulada"
  }
  return dictionary[type] || type
}

--- File: owner-service.ts (in subfolder: services) ---

// src/services/owner-service.ts
import { prisma } from "@/lib/prisma"

export type OwnerBalance = {
  debtFromSales: number     // Dinero por ventas no liquidadas (+)
  debtFromAdjustments: number // Ajustes manuales/devoluciones (+ o -)
  totalNetDebt: number      // El total final (lo que se va a pagar)
  pendingItemsCount: number // Cantidad de productos vendidos sin pagar
}

/**
 * Calcula la deuda exacta que el sistema (Local) tiene con un Due√±o.
 * Positivo = El local debe pagarle al due√±o.
 * Negativo = El due√±o le debe al local (saldo a favor local).
 */
export async function getOwnerBalance(ownerId: string): Promise<OwnerBalance> {
  // 1. Buscar Ventas Pendientes (Items vendidos pero no liquidados)
  const pendingSaleItems = await prisma.saleItem.findMany({
    where: {
      isSettled: false,
      variant: { product: { ownerId: ownerId } }
    },
    select: {
      quantity: true,
      costAtSale: true
    }
  })

  // 2. Buscar Ajustes Pendientes (Cr√©ditos o D√©bitos manuales no aplicados)
  const pendingAdjustments = await prisma.balanceAdjustment.findMany({
    where: {
      ownerId: ownerId,
      isApplied: false
    },
    select: {
      amount: true
    }
  })

  // 3. C√°lculos en memoria (M√°s seguro que SQL raw para manejo de decimales JS)
  const debtFromSales = pendingSaleItems.reduce((sum, item) => {
    return sum + (Number(item.costAtSale) * item.quantity)
  }, 0)

  const debtFromAdjustments = pendingAdjustments.reduce((sum, adj) => {
    return sum + Number(adj.amount)
  }, 0)

  const totalNetDebt = debtFromSales + debtFromAdjustments

  return {
    debtFromSales,
    debtFromAdjustments,
    totalNetDebt,
    pendingItemsCount: pendingSaleItems.reduce((acc, item) => acc + item.quantity, 0)
  }
}

--- File: schema.prisma (in subfolder: TEMP\prisma) ---

// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Usamos PostgreSQL por defecto. Si usas localmente SQLite, cambi√° a "sqlite"
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// ENUMS (Listas de valores fijos)
// ==============================

enum Role {
  ADMIN
  STAFF
}

// Tipos de movimiento de stock para auditor√≠a estricta
enum StockMovementType {
  ENTRY            // Ingreso de mercader√≠a (Suma)
  SALE             // Venta por caja (Resta)
  ADJUSTMENT       // Ajuste manual por rotura/p√©rdida (Resta o Suma)
  OWNER_WITHDRAWAL // Retiro del due√±o (Resta sin venta)
  RETURN           // Devoluci√≥n de cliente (Suma)
  SALE_CANCELLED   // Anulaci√≥n de venta (Suma autom√°tica)
}

// Estados del turno de peluquer√≠a
enum ApptStatus {
  PENDING   // Reci√©n creado
  CONFIRMED // Cliente lleg√≥ / Confirmado
  COMPLETED // Servicio terminado
  BILLED    // Ya se cobr√≥ en caja
  CANCELLED // Turno cancelado
}

// ==============================
// MODELOS DEL NEGOCIO
// ==============================

// 1. Due√±os de Mercader√≠a (Consignaci√≥n)
model Owner {
  id                 String    @id @default(uuid())
  name               String
  phone              String?
  email              String?
  isActive           Boolean   @default(true) 
  createdAt          DateTime  @default(now())
  
  // Relaciones
  products           Product[]
  settlements        Settlement[]
  balanceAdjustments BalanceAdjustment[] 

  // √çndices para b√∫squeda r√°pida
  @@index([name])
}

// 2. Categor√≠as de Productos
model Category {
  id       String    @id @default(uuid())
  name     String    @unique 
  products Product[]
}

// 3. Productos (Cabecera)
model Product {
  id          String    @id @default(uuid())
  name        String
  description String?
  
  // Relaciones
  ownerId     String
  owner       Owner     @relation(fields: [ownerId], references: [id])
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])
  
  variants    ProductVariant[]
  
  isActive    Boolean   @default(true)

  @@index([name])
  @@index([ownerId])
}

// 4. Variantes (Talle/Color/Precio) - Es lo que realmente se vende
model ProductVariant {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  name      String   // Ej: "Rojo - XL" o "Est√°ndar"
  imageUrl  String?  // URL externa (Cloudinary)
  
  // PRECIOS: Usamos Decimal para exactitud monetaria
  costPrice Decimal  @db.Decimal(10, 2) 
  salePrice Decimal  @db.Decimal(10, 2)
  stock     Int      @default(0)
  
  // Relaciones
  stockMovements StockMovement[]
  saleItems      SaleItem[]

  // Evitar duplicados del mismo nombre dentro del mismo producto
  @@unique([productId, name]) 
}

// 5. Historial de Stock (Kardex)
model StockMovement {
  id          String            @id @default(uuid())
  variantId   String
  variant     ProductVariant    @relation(fields: [variantId], references: [id])
  quantity    Int               // Positivo (entrada) o Negativo (salida)
  type        StockMovementType
  reason      String?
  userId      String            // ID del usuario que hizo la acci√≥n (si hubiera auth)
  createdAt   DateTime          @default(now())

  @@index([variantId])
  @@index([createdAt])
}

// 6. Ventas (Cabecera)
model Sale {
  id            String        @id @default(uuid())
  total         Decimal       @db.Decimal(10, 2)
  paymentMethod String        // "CASH", "TRANSFER", etc.
  status        String        @default("COMPLETED") // "COMPLETED" o "CANCELLED"
  createdAt     DateTime      @default(now())
  
  items         SaleItem[]

  @@index([createdAt])
}

// 7. Items de Venta (Detalle)
model SaleItem {
  id            String         @id @default(uuid())
  saleId        String
  sale          Sale           @relation(fields: [saleId], references: [id])
  
  // Puede ser null si vendemos un "Servicio" que no tiene stock
  variantId     String?        
  variant       ProductVariant? @relation(fields: [variantId], references: [id])
  
  description   String         // Guardamos el nombre tal cual se vendi√≥ (snapshot)
  quantity      Int
  
  // SNAPSHOT DE PRECIOS: Fundamental para liquidar correctamente aunque cambien los precios despu√©s
  costAtSale    Decimal        @db.Decimal(10, 2)
  priceAtSale   Decimal        @db.Decimal(10, 2)
  
  // CONTROL DE LIQUIDACI√ìN AL DUE√ëO
  isSettled     Boolean        @default(false) // ¬øYa se le pag√≥ al due√±o?
  settlementId  String?
  settlement    Settlement?    @relation(fields: [settlementId], references: [id])

  @@index([isSettled])
  @@index([saleId])
}

// 8. Liquidaciones (Pagos a Due√±os)
model Settlement {
  id          String   @id @default(uuid())
  ownerId     String
  owner       Owner    @relation(fields: [ownerId], references: [id])
  totalAmount Decimal  @db.Decimal(10, 2) // Total pagado en este recibo
  createdAt   DateTime @default(now())
  
  items       SaleItem[]
  adjustments BalanceAdjustment[]
}

// 9. Ajustes de Saldo (Cr√©ditos/D√©bitos manuales a Due√±os)
model BalanceAdjustment {
  id           String      @id @default(uuid())
  ownerId      String
  owner        Owner       @relation(fields: [ownerId], references: [id])
  amount       Decimal     @db.Decimal(10, 2) // Negativo = Due√±o debe al local. Positivo = Local debe al due√±o.
  description  String
  
  isApplied    Boolean     @default(false) // ¬øYa se descont√≥/pag√≥ en una liquidaci√≥n?
  settlementId String?
  settlement   Settlement? @relation(fields: [settlementId], references: [id])
  createdAt    DateTime    @default(now())
}

// ==============================
// MODELOS DE PELUQUER√çA
// ==============================

// 10. Clientes (Mascotas)
model Pet {
  id          String   @id @default(uuid())
  name        String
  ownerName   String   // Texto libre, no relacionado a la tabla Owner
  ownerPhone  String?
  breed       String?
  notes       String?  // Alertas (ej: "Muerde", "Alergia")
  
  appointments Appointment[]
  groomingNotes GroomingNote[]

  @@index([name])
  @@index([ownerName])
}

// 11. Turnos
model Appointment {
  id        String     @id @default(uuid())
  petId     String
  pet       Pet        @relation(fields: [petId], references: [id])
  startTime DateTime
  endTime   DateTime
  status    ApptStatus @default(PENDING)
  
  @@index([startTime])
  @@index([status])
}

// 12. Notas T√©cnicas (Historial cl√≠nico de peluquer√≠a)
model GroomingNote {
  id        String   @id @default(uuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id])
  content   String   @db.Text
  createdAt DateTime @default(now())
}

--- File: migration.sql (in subfolder: TEMP\prisma\migrations\20260109022200_init_db) ---

-- CreateEnum
CREATE TYPE "Role" AS ENUM ('ADMIN', 'STAFF');

-- CreateEnum
CREATE TYPE "StockMovementType" AS ENUM ('ENTRY', 'SALE', 'ADJUSTMENT', 'OWNER_WITHDRAWAL', 'RETURN', 'SALE_CANCELLED');

-- CreateEnum
CREATE TYPE "ApptStatus" AS ENUM ('PENDING', 'CONFIRMED', 'COMPLETED', 'BILLED', 'CANCELLED');

-- CreateTable
CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "role" "Role" NOT NULL DEFAULT 'STAFF',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Owner" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "phone" TEXT,
    "email" TEXT,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Owner_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Category" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,

    CONSTRAINT "Category_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Product" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "tags" TEXT[],
    "ownerId" TEXT NOT NULL,
    "categoryId" TEXT NOT NULL,
    "isActive" BOOLEAN NOT NULL DEFAULT true,

    CONSTRAINT "Product_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "ProductVariant" (
    "id" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "imageUrl" TEXT,
    "costPrice" DECIMAL(10,2) NOT NULL,
    "salePrice" DECIMAL(10,2) NOT NULL,
    "stock" INTEGER NOT NULL DEFAULT 0,

    CONSTRAINT "ProductVariant_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "StockMovement" (
    "id" TEXT NOT NULL,
    "variantId" TEXT NOT NULL,
    "quantity" INTEGER NOT NULL,
    "type" "StockMovementType" NOT NULL,
    "reason" TEXT,
    "userId" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "StockMovement_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Sale" (
    "id" TEXT NOT NULL,
    "total" DECIMAL(10,2) NOT NULL,
    "paymentMethod" TEXT NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'COMPLETED',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Sale_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "SaleItem" (
    "id" TEXT NOT NULL,
    "saleId" TEXT NOT NULL,
    "variantId" TEXT,
    "description" TEXT NOT NULL,
    "quantity" INTEGER NOT NULL,
    "costAtSale" DECIMAL(10,2) NOT NULL,
    "priceAtSale" DECIMAL(10,2) NOT NULL,
    "isSettled" BOOLEAN NOT NULL DEFAULT false,
    "settlementId" TEXT,

    CONSTRAINT "SaleItem_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Settlement" (
    "id" TEXT NOT NULL,
    "ownerId" TEXT NOT NULL,
    "totalAmount" DECIMAL(10,2) NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Settlement_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "BalanceAdjustment" (
    "id" TEXT NOT NULL,
    "ownerId" TEXT NOT NULL,
    "amount" DECIMAL(10,2) NOT NULL,
    "description" TEXT NOT NULL,
    "isApplied" BOOLEAN NOT NULL DEFAULT false,
    "settlementId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "BalanceAdjustment_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Pet" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "ownerName" TEXT NOT NULL,
    "ownerPhone" TEXT,
    "breed" TEXT,
    "notes" TEXT,

    CONSTRAINT "Pet_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Appointment" (
    "id" TEXT NOT NULL,
    "petId" TEXT NOT NULL,
    "startTime" TIMESTAMP(3) NOT NULL,
    "endTime" TIMESTAMP(3) NOT NULL,
    "status" "ApptStatus" NOT NULL DEFAULT 'PENDING',
    "price" DECIMAL(10,2),

    CONSTRAINT "Appointment_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "GroomingNote" (
    "id" TEXT NOT NULL,
    "petId" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "appointmentId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "GroomingNote_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

-- CreateIndex
CREATE UNIQUE INDEX "Category_name_key" ON "Category"("name");

-- CreateIndex
CREATE UNIQUE INDEX "ProductVariant_productId_name_key" ON "ProductVariant"("productId", "name");

-- AddForeignKey
ALTER TABLE "Product" ADD CONSTRAINT "Product_ownerId_fkey" FOREIGN KEY ("ownerId") REFERENCES "Owner"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Product" ADD CONSTRAINT "Product_categoryId_fkey" FOREIGN KEY ("categoryId") REFERENCES "Category"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ProductVariant" ADD CONSTRAINT "ProductVariant_productId_fkey" FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "StockMovement" ADD CONSTRAINT "StockMovement_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "ProductVariant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SaleItem" ADD CONSTRAINT "SaleItem_saleId_fkey" FOREIGN KEY ("saleId") REFERENCES "Sale"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SaleItem" ADD CONSTRAINT "SaleItem_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "ProductVariant"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SaleItem" ADD CONSTRAINT "SaleItem_settlementId_fkey" FOREIGN KEY ("settlementId") REFERENCES "Settlement"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Settlement" ADD CONSTRAINT "Settlement_ownerId_fkey" FOREIGN KEY ("ownerId") REFERENCES "Owner"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "BalanceAdjustment" ADD CONSTRAINT "BalanceAdjustment_ownerId_fkey" FOREIGN KEY ("ownerId") REFERENCES "Owner"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "BalanceAdjustment" ADD CONSTRAINT "BalanceAdjustment_settlementId_fkey" FOREIGN KEY ("settlementId") REFERENCES "Settlement"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Appointment" ADD CONSTRAINT "Appointment_petId_fkey" FOREIGN KEY ("petId") REFERENCES "Pet"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "GroomingNote" ADD CONSTRAINT "GroomingNote_petId_fkey" FOREIGN KEY ("petId") REFERENCES "Pet"("id") ON DELETE RESTRICT ON UPDATE CASCADE;


--- File: migration.sql (in subfolder: TEMP\prisma\migrations\20260112034842_init_db) ---

/*
  Warnings:

  - You are about to drop the column `price` on the `Appointment` table. All the data in the column will be lost.
  - You are about to drop the column `appointmentId` on the `GroomingNote` table. All the data in the column will be lost.
  - You are about to drop the column `tags` on the `Product` table. All the data in the column will be lost.
  - You are about to drop the `User` table. If the table is not empty, all the data it contains will be lost.

*/
-- AlterTable
ALTER TABLE "Appointment" DROP COLUMN "price";

-- AlterTable
ALTER TABLE "GroomingNote" DROP COLUMN "appointmentId";

-- AlterTable
ALTER TABLE "Product" DROP COLUMN "tags";

-- DropTable
DROP TABLE "User";

-- CreateIndex
CREATE INDEX "Appointment_startTime_idx" ON "Appointment"("startTime");

-- CreateIndex
CREATE INDEX "Appointment_status_idx" ON "Appointment"("status");

-- CreateIndex
CREATE INDEX "Owner_name_idx" ON "Owner"("name");

-- CreateIndex
CREATE INDEX "Pet_name_idx" ON "Pet"("name");

-- CreateIndex
CREATE INDEX "Pet_ownerName_idx" ON "Pet"("ownerName");

-- CreateIndex
CREATE INDEX "Product_name_idx" ON "Product"("name");

-- CreateIndex
CREATE INDEX "Product_ownerId_idx" ON "Product"("ownerId");

-- CreateIndex
CREATE INDEX "Sale_createdAt_idx" ON "Sale"("createdAt");

-- CreateIndex
CREATE INDEX "SaleItem_isSettled_idx" ON "SaleItem"("isSettled");

-- CreateIndex
CREATE INDEX "SaleItem_saleId_idx" ON "SaleItem"("saleId");

-- CreateIndex
CREATE INDEX "StockMovement_variantId_idx" ON "StockMovement"("variantId");

-- CreateIndex
CREATE INDEX "StockMovement_createdAt_idx" ON "StockMovement"("createdAt");


