--- File: appointment-actions.ts (in subfolder: actions) ---

// src/actions/appointment-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createAppointment(formData: FormData) {
  const petId = formData.get("petId") as string
  const dateStr = formData.get("date") as string // "2024-01-20"
  const timeStr = formData.get("time") as string // "14:30"
  const duration = parseInt(formData.get("duration") as string) || 60 // Minutos

  if (!petId || !dateStr || !timeStr) {
    return { error: "Faltan datos (Mascota, Fecha u Hora)" }
  }

  try {
    // 1. CONSTRUIR FECHAS (Start y End)
    // Combinamos fecha y hora en un objeto Date
    const startTime = new Date(`${dateStr}T${timeStr}:00`)
    // Calculamos el final sumando minutos
    const endTime = new Date(startTime.getTime() + duration * 60000)

    // Validar que sea una fecha v√°lida
    if (isNaN(startTime.getTime())) {
      return { error: "Fecha u hora inv√°lida" }
    }

    // 2. VALIDAR COLISIONES (La Regla de Oro)
    // Buscamos si existe alg√∫n turno que NO est√© cancelado Y que se superponga
    const collision = await prisma.appointment.findFirst({
      where: {
        status: { not: 'CANCELLED' }, // Ignoramos los cancelados
        AND: [
          { startTime: { lt: endTime } }, // Que empiece antes de que yo termine
          { endTime: { gt: startTime } }  // Y que termine despu√©s de que yo empiece
        ]
      },
      include: { pet: true }
    })

    if (collision) {
      return { 
        error: `Horario ocupado por ${collision.pet.name} (${collision.startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${collision.endTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})})` 
      }
    }

    // 3. GUARDAR TURNO
    await prisma.appointment.create({
      data: {
        petId,
        startTime,
        endTime,
        status: 'PENDING'
      }
    })

    revalidatePath("/agenda")
    return { success: true }

  } catch (error) {
    console.error("Error agendando:", error)
    return { error: "Error interno al crear turno" }
  }
}

export async function cancelAppointment(formData: FormData) {
    const id = formData.get("id") as string
    try {
        await prisma.appointment.update({
            where: { id },
            data: { status: 'CANCELLED' }
        })
        revalidatePath("/agenda")
    } catch (error) {
        console.error(error)
    }
}

--- File: bulk-actions.ts (in subfolder: actions) ---

// src/actions/bulk-actions.ts
'use server'

import { prisma } from "@/lib/prisma"

// Definimos qu√© esperamos recibir de cada fila del Excel
type ImportRow = {
  name: string
  categoryName: string
  ownerName: string
  cost: number
  price: number
}

export async function importSingleProduct(data: ImportRow) {
  try {
    // 1. BUSCAR O CREAR CATEGOR√çA (Case Insensitive)
    // Truco: Buscamos primero para no fallar por unique constraint
    let category = await prisma.category.findFirst({
      where: { name: { equals: data.categoryName, mode: 'insensitive' } }
    })

    if (!category) {
      category = await prisma.category.create({
        data: { name: data.categoryName } // Creamos si no existe
      })
    }

    // 2. BUSCAR DUE√ëO (Por nombre exacto o aproximado)
    // Aqu√≠ asumimos que el due√±o YA DEBE EXISTIR. Si no, es riesgoso crearlo auto.
    const owner = await prisma.owner.findFirst({
      where: { name: { equals: data.ownerName, mode: 'insensitive' } }
    })

    if (!owner) {
      return { success: false, error: `Due√±o no encontrado: ${data.ownerName}` }
    }

    // 3. CREAR PRODUCTO Y VARIANTE
    await prisma.$transaction(async (tx) => {
      const newProduct = await tx.product.create({
        data: {
          name: data.name,
          categoryId: category.id,
          ownerId: owner.id,
          isActive: true
        }
      })

      await tx.productVariant.create({
        data: {
          productId: newProduct.id,
          name: "Est√°ndar",
          costPrice: data.cost,
          salePrice: data.price,
          stock: 0, // Siempre nace en 0, luego se hace ingreso de stock
          imageUrl: null 
        }
      })
    })

    return { success: true }

  } catch (error: any) {
    console.error("Error importando:", error)
    return { success: false, error: error.message }
  }
}

--- File: category-actions.ts (in subfolder: actions) ---

// src/actions/category-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createCategory(formData: FormData) {
  const name = formData.get("name") as string

  if (!name) return

  try {
    await prisma.category.create({
      data: { name }
    })
    
    revalidatePath("/categories")
    return { success: true }
  
  } catch (error) {
    // Si el error es porque ya existe (c√≥digo P2002 de Prisma), no hacemos nada
    console.error("Error creando categor√≠a:", error)
    return { success: false, error: "Error al crear (¬øQuiz√°s ya existe?)" }
  }
}

--- File: inventory-actions.ts (in subfolder: actions) ---

// src/actions/inventory-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function registerStockMovement(formData: FormData) {
  const variantId = formData.get("variantId") as string
  const quantity = parseInt(formData.get("quantity") as string)
  const reason = formData.get("reason") as string
  // Capturamos el tipo de movimiento del formulario
  const type = formData.get("type") as "ENTRY" | "OWNER_WITHDRAWAL"

  if (!variantId || quantity <= 0 || !type) {
    throw new Error("Datos inv√°lidos")
  }

  try {
    // ‚ö†Ô∏è VALIDACI√ìN CR√çTICA PARA RETIROS
    // Si van a sacar mercader√≠a, primero vemos si alcanza.
    if (type === "OWNER_WITHDRAWAL") {
      const currentVariant = await prisma.productVariant.findUnique({
        where: { id: variantId }
      })

      if (!currentVariant || currentVariant.stock < quantity) {
        // Retornamos un objeto de error en lugar de lanzar excepci√≥n para manejarlo en UI (simple)
        // Nota: En un sistema m√°s avanzado, usar√≠amos try/catch en el componente cliente.
        console.error("Stock insuficiente")
        return { error: `Stock insuficiente. Tienes ${currentVariant?.stock || 0}` }
      }
    }

    await prisma.$transaction([
      // 1. Crear el movimiento hist√≥rico (La auditor√≠a)
      prisma.stockMovement.create({
        data: {
          variantId,
          quantity: type === "ENTRY" ? quantity : -quantity, // Positivo si entra, Negativo si sale
          type: type, // ENTRY o OWNER_WITHDRAWAL
          reason: reason || (type === "ENTRY" ? "Ingreso manual" : "Retiro de due√±o"),
          userId: "sistema",
        }
      }),

      // 2. Actualizar el stock actual (El contador)
      prisma.productVariant.update({
        where: { id: variantId },
        data: {
          stock: type === "ENTRY" 
            ? { increment: quantity } // Si entra, suma
            : { decrement: quantity } // Si sale, resta
        }
      })
    ])

    revalidatePath("/products")
    revalidatePath("/inventory") // Revalidamos la misma p√°gina por si queremos ver cambios

  } catch (error) {
    console.error("Error gestionando stock:", error)
    return { error: "Fall√≥ el movimiento de stock" }
  }

  // Redirigimos para limpiar el formulario
  redirect("/products")
}

--- File: note-actions.ts (in subfolder: actions) ---

// src/actions/note-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createNote(formData: FormData) {
  const petId = formData.get("petId") as string
  const content = formData.get("content") as string

  if (!petId || !content) return

  try {
    await prisma.groomingNote.create({
      data: {
        petId,
        content
      }
    })

    // Revalidamos la ruta din√°mica espec√≠fica de esa mascota
    revalidatePath(`/pets/${petId}`)
    return { success: true }

  } catch (error) {
    console.error("Error creando nota:", error)
    return { error: "Error al guardar la nota" }
  }
}

export async function deleteNote(formData: FormData) {
    const id = formData.get("id") as string
    const petId = formData.get("petId") as string
    
    try {
        await prisma.groomingNote.delete({ where: { id } })
        revalidatePath(`/pets/${petId}`)
    } catch (e) {
        console.error(e)
    }
}

--- File: owner-actions.ts (in subfolder: actions) ---

// src/actions/owner-actions.ts
"use server";

import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";

export async function createOwner(formData: FormData) {
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const phone = formData.get("phone") as string;

  if (!name) return { error: "El nombre es obligatorio" };

  try {
    await prisma.owner.create({
      data: { name, email, phone, isActive: true },
    });
    revalidatePath("/owners");
    return { success: true };
  } catch (error) {
    return { error: "Error creando due√±o" };
  }
}

// üëá NUEVA FUNCI√ìN
export async function updateOwner(formData: FormData) {
  const id = formData.get("id") as string;
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const phone = formData.get("phone") as string;

  if (!id || !name) return { error: "Faltan datos" };

  try {
    await prisma.owner.update({
      where: { id },
      data: { name, email, phone },
    });
    
    revalidatePath("/owners");
    return { success: true };
  } catch (error) {
    console.error(error);
    return { error: "Error actualizando due√±o" };
  }
}

--- File: pet-actions.ts (in subfolder: actions) ---

// src/actions/pet-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createPet(formData: FormData) {
  const name = formData.get("name") as string
  const breed = formData.get("breed") as string
  const ownerName = formData.get("ownerName") as string
  const ownerPhone = formData.get("ownerPhone") as string
  const notes = formData.get("notes") as string

  // Validaci√≥n b√°sica
  if (!name || !ownerName || !ownerPhone) {
    return { error: "Faltan datos obligatorios (Nombre, Due√±o, Tel√©fono)" }
  }

  try {
    await prisma.pet.create({
      data: {
        name,
        breed: breed || "Mestizo",
        ownerName,
        ownerPhone,
        notes
      }
    })

    revalidatePath("/pets")
    return { success: true }

  } catch (error) {
    console.error("Error creando mascota:", error)
    return { error: "Error al guardar la ficha." }
  }
}

export async function deletePet(id: string) {
    try {
        await prisma.pet.delete({ where: { id } })
        revalidatePath("/pets")
        return { success: true }
    } catch (error) {
        return { error: "No se puede eliminar (¬øTiene turnos asignados?)" }
    }
}

--- File: product-actions.ts (in subfolder: actions) ---

// src/actions/product-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createProduct(formData: FormData) {
  // 1. Obtener datos simples
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const ownerId = formData.get("ownerId") as string
  const categoryId = formData.get("categoryId") as string
  const imageUrl = formData.get("imageUrl") as string // URL de Cloudinary
  
  // 2. Obtener y convertir n√∫meros (Prisma usa Strings para Decimals, pero validamos aqu√≠)
  const costPrice = parseFloat(formData.get("costPrice") as string)
  const salePrice = parseFloat(formData.get("salePrice") as string)

  // Validaciones b√°sicas
  if (!name || !ownerId || !categoryId || !costPrice || !salePrice) {
    throw new Error("Faltan datos obligatorios")
  }

  try {
    // 3. LA TRANSACCI√ìN (Todo o Nada)
    await prisma.$transaction(async (tx) => {
      
      // A. Crear el "Padre" (Producto gen√©rico)
      const newProduct = await tx.product.create({
        data: {
          name,
          description,
          ownerId,
          categoryId,
          isActive: true
        }
      })

      // B. Crear el "Hijo" (Variante inicial)
      // Usamos el ID del padre que acabamos de crear (newProduct.id)
      await tx.productVariant.create({
        data: {
          productId: newProduct.id,
          name: "Est√°ndar", // Por ahora, variante √∫nica por defecto
          imageUrl: imageUrl || null,
          costPrice: costPrice,
          salePrice: salePrice,
          stock: 0 // Regla de oro: Nace con stock 0. Se carga despu√©s.
        }
      })
    })

    // 4. Si todo sali√≥ bien
    revalidatePath("/products")

  } catch (error) {
    console.error("Error creando producto:", error)
    return { error: "Error al guardar el producto" }
  }
  
  // Redirigir al listado (fuera del try/catch)
  redirect("/products")
}

// --- AGREGAR AL FINAL DE src/actions/product-actions.ts ---

export async function updateProduct(formData: FormData) {
  const id = formData.get("id") as string
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const categoryId = formData.get("categoryId") as string
  const ownerId = formData.get("ownerId") as string
  const costPrice = parseFloat(formData.get("costPrice") as string)
  const salePrice = parseFloat(formData.get("salePrice") as string)
  const imageUrl = formData.get("imageUrl") as string

  if (!id || !name || !costPrice || !salePrice) throw new Error("Datos faltantes")

  try {
    await prisma.$transaction(async (tx) => {
      // 1. Actualizar datos base del producto
      await tx.product.update({
        where: { id },
        data: { name, description, categoryId, ownerId }
      })

      // 2. Actualizar precios en la variante (Asumimos variante √∫nica por ahora)
      // Primero buscamos la variante asociada a este producto
      const variant = await tx.productVariant.findFirst({ where: { productId: id } })
      
      if (variant) {
        await tx.productVariant.update({
          where: { id: variant.id },
          data: {
            costPrice,
            salePrice,
            // Si viene una imagen nueva, la actualizamos. Si viene vac√≠a, NO la tocamos (mantenemos la vieja)
            ...(imageUrl ? { imageUrl } : {}) 
          }
        })
      }
    })

    revalidatePath("/products")
    revalidatePath("/pos") // Importante: actualizar precios en el punto de venta
    return { success: true }

  } catch (error) {
    console.error("Error actualizando:", error)
    return { error: "No se pudo actualizar el producto" }
  }
}

export async function toggleProductStatus(productId: string, currentStatus: boolean) {
  try {
    // REGLA DE ORO: No archivar si hay stock positivo
    if (currentStatus === true) { // Si queremos desactivar...
      const variant = await prisma.productVariant.findFirst({ where: { productId } })
      if (variant && variant.stock > 0) {
        return { error: "No se puede archivar un producto con stock. Hac√© un retiro o ajuste a 0 primero." }
      }
    }

    await prisma.product.update({
      where: { id: productId },
      data: { isActive: !currentStatus }
    })

    revalidatePath("/products")
    revalidatePath("/pos")
    return { success: true }
  } catch (error) {
    return { error: "Error cambiando estado" }
  }
}

--- File: sale-actions.ts (in subfolder: actions) ---

// src/actions/sale-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

// Definimos la estructura del carrito polim√≥rfico (Producto o Servicio)
type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string       // variantId (si es producto) O appointmentId (si es servicio)
  description: string
  price: number    // Precio final de venta
  quantity: number
}

export async function processSale(cart: CartItem[], totalEstimado: number) {
  if (cart.length === 0) return { error: "El carrito est√° vac√≠o" }

  try {
    await prisma.$transaction(async (tx) => {
      let totalReal = 0
      const saleItemsData = []
      
      // Lista de turnos a marcar como cobrados (para servicios)
      const appointmentIdsToBill: string[] = []

      for (const item of cart) {
        
        // --- CASO A: PRODUCTO (Con Control de Stock) ---
        if (item.type === 'PRODUCT') {
            // Buscamos el producto para validar stock y precio real
            const variant = await tx.productVariant.findUnique({
                where: { id: item.id },
                include: { product: true }
            })

            if (!variant) throw new Error(`Producto no encontrado: ${item.description}`)
            if (variant.stock < item.quantity) throw new Error(`Stock insuficiente: ${variant.product.name}`)

            // Usamos precio de DB por seguridad
            const subtotal = Number(variant.salePrice) * item.quantity
            totalReal += subtotal

            saleItemsData.push({
                variantId: variant.id,
                description: variant.product.name,
                quantity: item.quantity,
                costAtSale: variant.costPrice,
                priceAtSale: variant.salePrice
            })

            // Baja de Stock
            await tx.productVariant.update({
                where: { id: variant.id },
                data: { stock: { decrement: item.quantity } }
            })

            // Auditor√≠a de Movimiento
            await tx.stockMovement.create({
                data: {
                    variantId: variant.id,
                    quantity: -item.quantity,
                    type: "SALE",
                    reason: "Venta Mostrador",
                    userId: "sistema"
                }
            })
        } 
        
        // --- CASO B: SERVICIO (Sin Stock, Precio Variable) ---
        else if (item.type === 'SERVICE') {
            // En servicios confiamos en el precio que manda el cajero
            const subtotal = item.price * item.quantity
            totalReal += subtotal

            saleItemsData.push({
                variantId: null, // Es servicio, no tiene variante
                description: item.description,
                quantity: item.quantity,
                costAtSale: 0,     // Mano de obra (asumimos 0 costo directo por ahora)
                priceAtSale: item.price
            })

            // Guardamos el ID del turno para actualizarlo luego
            appointmentIdsToBill.push(item.id)
        }
      }

      // 4. Crear la Venta Cabecera
      await tx.sale.create({
        data: {
          total: totalReal,
          paymentMethod: "CASH", // Por ahora fijo efectivo
          status: "COMPLETED",
          items: {
            create: saleItemsData
          }
        }
      })

      // 5. Actualizar Turnos a BILLED (Cobrados)
      if (appointmentIdsToBill.length > 0) {
        await tx.appointment.updateMany({
            where: { id: { in: appointmentIdsToBill } },
            data: { status: 'BILLED' }
        })
      }
    })

    revalidatePath("/products")
    revalidatePath("/pos")
    revalidatePath("/agenda") // Importante: para que el turno cambie de color
    return { success: true }

  } catch (error: any) {
    console.error("Error en venta:", error)
    return { error: error.message || "Error al procesar venta" }
  }
}

export async function cancelSale(saleId: string) {
  console.log(`üîç [DEBUG] Iniciando anulaci√≥n para Venta ID: ${saleId}`)
  
  try {
    await prisma.$transaction(async (tx) => {
      // 1. Buscar la venta
      const sale = await tx.sale.findUnique({
        where: { id: saleId },
        include: { 
          items: {
            include: {
              variant: {
                include: { product: true }
              }
            }
          } 
        }
      })

      if (!sale) throw new Error("Venta no encontrada")
      if (sale.status === 'CANCELLED') throw new Error("Ya est√° anulada")

      // 2. Marcar como ANULADA
      await tx.sale.update({
        where: { id: saleId },
        data: { status: 'CANCELLED' }
      })

      // 3. Procesar items
      for (const item of sale.items) {
        
        // A. Si es PRODUCTO (tiene variantId)
        if (item.variantId && item.variant) {
          // Devolver stock
          await tx.productVariant.update({
            where: { id: item.variantId },
            data: { stock: { increment: item.quantity } }
          })

          // Auditar movimiento
          await tx.stockMovement.create({
            data: {
              variantId: item.variantId,
              quantity: item.quantity,
              type: 'SALE_CANCELLED',
              reason: `Anulaci√≥n Venta #${sale.id.slice(0, 8)}`,
              userId: 'sistema'
            }
          })

          // AJUSTE FINANCIERO: Si ya estaba pagado, generar deuda al due√±o
          if (item.isSettled) {
            const amountOwedBack = Number(item.costAtSale) * item.quantity
            const ownerId = item.variant.product.ownerId

            await tx.balanceAdjustment.create({
              data: {
                ownerId: ownerId,
                amount: -amountOwedBack, 
                description: `Devoluci√≥n liquidada: ${item.description}`,
                isApplied: false
              }
            })
          }
        }
        
        // B. Si es SERVICIO (variantId null)
        // Por ahora no hacemos nada espec√≠fico m√°s que anular la venta.
        // Idealmente, deber√≠amos buscar el turno y volverlo a 'PENDING',
        // pero eso requiere guardar el appointmentId en SaleItem, cosa que haremos en v2.
      }
    })

    revalidatePath("/sales")
    revalidatePath("/products") 
    revalidatePath("/owners/balance")
    return { success: true }

  } catch (error: any) {
    console.error("‚ùå [DEBUG] Error anulando venta:", error)
    return { error: error.message || "Error al anular venta" }
  }
}

--- File: settlement-actions.ts (in subfolder: actions) ---

// src/actions/settlement-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createSettlement(formData: FormData) {
  const ownerId = formData.get("ownerId") as string
  
  if (!ownerId) throw new Error("ID de due√±o requerido")

  try {
    // 1. SEGURIDAD: Recalculamos todo en el servidor.
    
    // A. Buscar Ventas Pendientes (Suman deuda)
    const pendingItems = await prisma.saleItem.findMany({
      where: {
        isSettled: false,
        variant: {
          product: { ownerId: ownerId }
        }
      }
    })

    // B. Buscar Ajustes Pendientes (Restan deuda, generalmente)
    const pendingAdjustments = await prisma.balanceAdjustment.findMany({
      where: {
        ownerId: ownerId,
        isApplied: false
      }
    })

    if (pendingItems.length === 0 && pendingAdjustments.length === 0) {
      return { error: "No hay movimientos pendientes para liquidar." }
    }

    // 2. Calcular Totales
    const totalSales = pendingItems.reduce((sum, item) => {
      return sum + (Number(item.costAtSale) * item.quantity)
    }, 0)

    const totalAdjustments = pendingAdjustments.reduce((sum, adj) => {
      return sum + Number(adj.amount)
    }, 0)

    // Total Neto (Suma algebraica)
    const totalToPay = totalSales + totalAdjustments

    // 3. TRANSACCI√ìN AT√ìMICA
    await prisma.$transaction(async (tx) => {
      // A. Crear la Cabecera ("El Recibo")
      const newSettlement = await tx.settlement.create({
        data: {
          ownerId,
          totalAmount: totalToPay,
        }
      })

      // B. Marcar items como pagados
      if (pendingItems.length > 0) {
        await tx.saleItem.updateMany({
          where: { id: { in: pendingItems.map(i => i.id) } },
          data: {
            isSettled: true,
            settlementId: newSettlement.id
          }
        })
      }

      // C. Marcar ajustes como aplicados
      if (pendingAdjustments.length > 0) {
        await tx.balanceAdjustment.updateMany({
            where: { id: { in: pendingAdjustments.map(a => a.id) } },
            data: {
                isApplied: true,
                settlementId: newSettlement.id
            }
        })
      }
    })

    revalidatePath("/owners/balance")

  } catch (error) {
    console.error("Error en liquidaci√≥n:", error)
    return { error: "Error al procesar el pago." }
  }

  redirect("/owners/balance")
}

--- File: layout.tsx (in subfolder: app) ---

// src/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import MainNav from "@/components/MainNav"; // üëà Importamos la barra

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Guapecanes - Sistema de Gesti√≥n",
  description: "Gesti√≥n de Peluquer√≠a y Consignaci√≥n",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased bg-gray-50 min-h-screen`}
      >
        {/* 1. Barra de Navegaci√≥n Fija Arriba */}
        <MainNav />

        {/* 2. Contenido de la p√°gina (con un poco de margen para respirar) */}
        <main>
          {children}
        </main>
      </body>
    </html>
  );
}

--- File: page.tsx (in subfolder: app) ---

import Image from "next/image";

export default function Home() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
        <Image
          className="dark:invert"
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-zinc-50">
            To get started, edit the page.tsx file.
          </h1>
          <p className="max-w-md text-lg leading-8 text-zinc-600 dark:text-zinc-400">
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
          <a
            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className="dark:invert"
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}


--- File: page.tsx (in subfolder: app\agenda) ---

// src/app/agenda/page.tsx
import { prisma } from "@/lib/prisma"
import { cancelAppointment } from "@/actions/appointment-actions"
import Link from "next/link"
import AppointmentForm from "@/components/AppointmentForm"

interface Props {
  searchParams: Promise<{ date?: string }>
}

export default async function AgendaPage({ searchParams }: Props) {
  const { date } = await searchParams
  
  // L√≥gica de fechas
  const todayStr = new Date().toISOString().split('T')[0]
  const selectedDateStr = date || todayStr

  // Rango de b√∫squeda: Todo el d√≠a seleccionado
  const startOfDay = new Date(`${selectedDateStr}T00:00:00`)
  const endOfDay = new Date(`${selectedDateStr}T23:59:59`)

  // 1. Buscar Mascotas (Para el selector de nuevo turno)
  const pets = await prisma.pet.findMany({ 
    orderBy: { name: 'asc' },
    select: { id: true, name: true, breed: true }
  })

  // 2. Buscar Turnos del d√≠a
  const appointments = await prisma.appointment.findMany({
    where: {
      startTime: { gte: startOfDay, lte: endOfDay },
      status: { not: 'CANCELLED' }
    },
    include: { pet: true },
    orderBy: { startTime: 'asc' }
  })

  return (
    <div className="p-8 max-w-7xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-gray-800">Agenda de Turnos</h1>
        
        {/* Navegaci√≥n r√°pida */}
        <div className="space-x-4 text-blue-600 font-bold text-sm">
            <Link href="/dashboard" className="hover:underline">Dashboard</Link>
            <Link href="/pets" className="hover:underline">Mascotas</Link>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {/* COLUMNA IZQUIERDA: LISTADO DE TURNOS */}
        <div className="lg:col-span-2 space-y-4">
            
            {/* Selector de Fecha */}
            <div className="bg-white p-4 rounded-lg shadow border flex items-center gap-4">
                <label className="font-bold text-gray-700">Fecha:</label>
                <form className="flex gap-2">
                    <input 
                        type="date" 
                        name="date" 
                        defaultValue={selectedDateStr} 
                        className="border p-2 rounded"
                    />
                    <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-blue-700">
                        Ir
                    </button>
                </form>
                
                {selectedDateStr !== todayStr && (
                     <Link href="/agenda" className="text-sm text-gray-500 underline ml-auto">Volver a Hoy</Link>
                )}
            </div>

            {/* Grilla de Turnos */}
            <div className="bg-white rounded-lg shadow border overflow-hidden min-h-[300px]">
                {appointments.length === 0 ? (
                    <div className="h-full flex flex-col items-center justify-center text-gray-400 py-20">
                        <span className="text-4xl mb-2">üìÖ</span>
                        <p>Agenda libre.</p>
                    </div>
                ) : (
                    <div className="divide-y">
                        {appointments.map(appt => {
                            const start = appt.startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                            const end = appt.endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                            
                            return (
                                <div key={appt.id} className="p-4 flex flex-col sm:flex-row justify-between items-center hover:bg-gray-50">
                                    {/* Info del Turno */}
                                    <div className="flex items-center gap-4">
                                        <div className={`
                                            px-3 py-2 rounded text-lg font-bold font-mono border 
                                            ${appt.status === 'BILLED' 
                                                ? 'bg-gray-100 text-gray-500 border-gray-200' 
                                                : 'bg-blue-100 text-blue-800 border-blue-200'}
                                        `}>
                                            {start}
                                        </div>
                                        <div>
                                            <p className="font-bold text-lg text-gray-800">{appt.pet.name}</p>
                                            <p className="text-xs text-gray-500">
                                                Finaliza: {end} | Due√±o: {appt.pet.ownerName}
                                            </p>
                                        </div>
                                    </div>

                                    {/* Botonera de Acciones */}
                                    <div className="mt-4 sm:mt-0 flex gap-2 items-center">
                                        
                                        {/* BOT√ìN COBRAR: Solo aparece si est√° pendiente */}
                                        {appt.status === 'PENDING' && (
                                            <Link
                                                href={`/pos?apptId=${appt.id}&petName=${encodeURIComponent(appt.pet.name)}`}
                                                className="bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded hover:bg-green-700 shadow-sm flex items-center gap-1 transition"
                                            >
                                                <span>üí∞</span> COBRAR
                                            </Link>
                                        )}

                                        {/* Etiqueta de Cobrado */}
                                        {appt.status === 'BILLED' && (
                                            <span className="text-xs bg-gray-100 text-gray-500 border border-gray-200 px-3 py-1 rounded cursor-not-allowed font-medium">
                                                ‚úÖ Cobrado
                                            </span>
                                        )}

                                        {/* Bot√≥n Cancelar */}
                                        {appt.status === 'PENDING' && (
                                            <form action={cancelAppointment}>
                                                <input type="hidden" name="id" value={appt.id} />
                                                <button className="text-red-500 text-xs font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50 hover:text-red-700 transition ml-2">
                                                    CANCELAR
                                                </button>
                                            </form>
                                        )}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: FORMULARIO CLIENTE */}
        <div className="lg:col-span-1">
            <AppointmentForm pets={pets} selectedDate={selectedDateStr} />
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\categories) ---

// src/app/categories/page.tsx
import { createCategory } from "@/actions/category-actions"
import { prisma } from "@/lib/prisma"

export default async function CategoriesPage() {
  const categories = await prisma.category.findMany({
    orderBy: { name: 'asc' } // Orden alfab√©tico
  })

  return (
    <div className="p-10 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Categor√≠as de Productos</h1>

      {/* FORMULARIO */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-10 border">
        <form action={createCategory} className="flex gap-4">
          <input 
            name="name" 
            type="text" 
            required 
            className="border p-2 rounded flex-1" 
            placeholder="Ej: Alimentos, Accesorios..."
          />
          <button 
            type="submit" 
            className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          >
            Agregar
          </button>
        </form>
      </div>

      {/* LISTADO */}
      <div className="grid grid-cols-2 gap-4">
        {categories.map((cat) => (
          <div key={cat.id} className="border p-4 rounded bg-gray-50 flex justify-between items-center">
            <span className="font-semibold">{cat.name}</span>
            <span className="text-xs text-gray-400">ID: {cat.id.slice(0, 8)}...</span>
          </div>
        ))}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\dashboard) ---

// src/app/dashboard/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { getLocalDateISO } from "@/lib/utils" // üëà Importamos

export default async function DashboardPage() {
  const now = new Date()
  
  const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1)
  const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1)

  // üëá CAMBIO CLAVE: Usamos la fecha local segura
  const todayStr = getLocalDateISO() 
  const startOfToday = new Date(`${todayStr}T00:00:00`)
  const endOfToday = new Date(`${todayStr}T23:59:59`)

  // ... (El resto del c√≥digo sigue IGUAL) ...
  
  const [monthSales, todaySales, todayAppointments, lowStockVariants] = await Promise.all([
      // ... tus consultas prisma ...
      prisma.sale.findMany({
        where: {
            status: "COMPLETED",
            createdAt: { gte: firstDayOfMonth, lt: nextMonth }
        },
        include: { items: true }
      }),
      prisma.sale.findMany({
        where: {
            status: "COMPLETED",
            createdAt: { gte: startOfToday, lte: endOfToday }
        }
      }),
      prisma.appointment.findMany({
        where: {
            startTime: { gte: startOfToday, lte: endOfToday },
            status: { not: 'CANCELLED' }
        },
        include: { pet: true },
        orderBy: { startTime: 'asc' }
      }),
      prisma.productVariant.findMany({
        where: { stock: { lte: 3 } },
        include: { product: true },
        orderBy: { stock: 'asc' },
        take: 5
      })
  ])

  // ... (Resto de c√°lculos y renderizado igual) ...
  
  // (Copi√° el resto del archivo anterior o avisame si necesit√°s que lo pegue todo de nuevo)
  // Lo importante es que uses `todayStr` generado por `getLocalDateISO()`
  
  // Para simplificar, te paso solo el bloque de return, asumiendo que manten√©s los c√°lculos:
  // ...
  
  // Calculos m√©tricas (igual que antes)
  let monthRevenue = 0
  let monthCost = 0
  monthSales.forEach(sale => {
    monthRevenue += Number(sale.total)
    sale.items.forEach(item => { if (item.variantId) monthCost += Number(item.costAtSale) * item.quantity })
  })
  const monthProfit = monthRevenue - monthCost
  const monthMargin = monthRevenue > 0 ? (monthProfit / monthRevenue) * 100 : 0
  const todayRevenue = todaySales.reduce((sum, sale) => sum + Number(sale.total), 0)
  const todayTransactions = todaySales.length

  return (
    <div className="p-8 max-w-7xl mx-auto">
      <h1 className="text-3xl font-bold text-gray-800 mb-2">Tablero de Control</h1>
      <p className="text-gray-500 mb-8">
        {/* Mostramos la fecha formateada localmente */}
        Visi√≥n general del negocio hoy, {new Date(todayStr).toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' })}.
      </p>
      
      {/* ... Resto del JSX id√©ntico al anterior ... */}
      
      {/* SECCI√ìN 1: CAJA DEL D√çA */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div className="bg-gradient-to-br from-green-600 to-green-700 text-white p-6 rounded-lg shadow-lg transform hover:scale-105 transition">
            <p className="text-green-100 text-sm font-bold uppercase tracking-wider">Caja de Hoy</p>
            <p className="text-4xl font-bold mt-2">${todayRevenue.toLocaleString()}</p>
            <p className="text-sm opacity-80 mt-1">{todayTransactions} ventas registradas</p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow border-l-4 border-blue-600">
            <p className="text-gray-500 text-sm font-bold uppercase">Acumulado Mes</p>
            <p className="text-3xl font-bold text-gray-800 mt-2">${monthRevenue.toLocaleString()}</p>
            <p className="text-xs text-gray-400 mt-1">
                Ganancia Neta: <span className="text-green-600 font-bold">${monthProfit.toLocaleString()}</span>
            </p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow border-l-4 border-purple-600">
            <p className="text-gray-500 text-sm font-bold uppercase">Rentabilidad</p>
            <p className="text-3xl font-bold text-gray-800 mt-2">{monthMargin.toFixed(1)}%</p>
            <p className="text-xs text-gray-400 mt-1">Margen promedio sobre ventas</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 className="font-bold text-lg text-gray-800">üìÖ Agenda de Hoy</h2>
                <Link href="/agenda" className="text-sm text-blue-600 hover:underline">Ver completa ‚Üí</Link>
            </div>
            {todayAppointments.length === 0 ? (
                <div className="p-8 text-center text-gray-400">No hay turnos para hoy.</div>
            ) : (
                <div className="divide-y">
                    {todayAppointments.map(appt => {
                        // Ajustamos visualizaci√≥n de hora
                        const time = appt.startTime.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Argentina/Buenos_Aires' })
                        return (
                            <div key={appt.id} className="p-4 flex items-center justify-between hover:bg-gray-50">
                                <div className="flex items-center gap-3">
                                    <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">{time}</span>
                                    <div>
                                        <p className="font-bold text-gray-800">{appt.pet.name}</p>
                                        <p className="text-xs text-gray-500">{appt.pet.breed} - {appt.pet.ownerName}</p>
                                    </div>
                                </div>
                                <div>
                                    {appt.status === 'PENDING' && <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Pendiente</span>}
                                    {appt.status === 'BILLED' && <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Cobrado</span>}
                                    {appt.status === 'COMPLETED' && <span className="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Listo</span>}
                                </div>
                            </div>
                        )
                    })}
                </div>
            )}
        </div>

        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-red-50 flex justify-between items-center">
                <h2 className="font-bold text-lg text-red-800">‚ö†Ô∏è Alertas de Stock</h2>
                <Link href="/inventory" className="text-sm text-red-600 hover:underline">Gestionar ‚Üí</Link>
            </div>
            {lowStockVariants.length === 0 ? (
                <div className="p-8 text-center text-gray-400">‚úÖ Inventario saludable.</div>
            ) : (
                <div className="divide-y">
                    {lowStockVariants.map(v => (
                        <div key={v.id} className="p-4 flex items-center justify-between hover:bg-red-50 transition">
                            <div className="flex items-center gap-3">
                                <div className="text-2xl">üì¶</div>
                                <div>
                                    <p className="font-bold text-gray-800">{v.product.name}</p>
                                    <p className="text-xs text-gray-500">Var: {v.name}</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className={`text-xl font-bold ${v.stock === 0 ? 'text-red-600' : 'text-orange-500'}`}>{v.stock}</p>
                                <p className="text-[10px] text-gray-400 uppercase font-bold">Unidades</p>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\inventory) ---

// src/app/inventory/page.tsx
import { prisma } from "@/lib/prisma"
// Importamos la nueva funci√≥n (asegurate de cambiar el nombre en el import tambi√©n si lo cambiaste en el archivo)
import { registerStockMovement } from "@/actions/inventory-actions"

export default async function InventoryPage() {
  const products = await prisma.product.findMany({
    include: { variants: true, owner: true },
    orderBy: { name: 'asc' }
  })

  return (
    <div className="p-8 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Control de Stock</h1>

      <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        {/* Cambiamos la acci√≥n a la nueva funci√≥n */}
        <form action={registerStockMovement} className="space-y-6">
          
          {/* NUEVO: TIPO DE MOVIMIENTO */}
          <div className="flex gap-4 p-4 bg-gray-50 rounded border">
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="type" value="ENTRY" defaultChecked className="w-5 h-5 text-green-600" />
              <span className="font-bold text-green-700">üü¢ Ingreso (Remito)</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="type" value="OWNER_WITHDRAWAL" className="w-5 h-5 text-orange-600" />
              <span className="font-bold text-orange-700">üü† Retiro de Due√±o</span>
            </label>
          </div>

          {/* SELECCI√ìN DE PRODUCTO */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Producto</label>
            <select name="variantId" required className="w-full border p-3 rounded bg-white">
              <option value="">Seleccionar producto...</option>
              {products.map(p => {
                const v = p.variants[0]
                return (
                  <option key={v.id} value={v.id}>
                    {p.name} (Stock: {v.stock}) - Due√±o: {p.owner.name}
                  </option>
                )
              })}
            </select>
          </div>

          {/* CANTIDAD */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
            <input 
              name="quantity" 
              type="number" 
              min="1" 
              required 
              className="w-full border p-3 rounded text-lg font-bold" 
              placeholder="Ej: 5"
            />
          </div>

          {/* MOTIVO */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Nota / Motivo</label>
            <input 
              name="reason" 
              type="text" 
              className="w-full border p-3 rounded" 
              placeholder="Ej: Remito #123 o 'Se lo llev√≥ para evento'"
            />
          </div>

          <button 
            type="submit" 
            className="w-full bg-slate-800 text-white py-3 rounded hover:bg-slate-900 font-bold text-lg"
          >
            Registrar Movimiento
          </button>

        </form>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners) ---

// src/app/owners/page.tsx
import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm" // üëà Usamos el componente nuevo
import Link from "next/link"

export default async function OwnersPage() {
  const owners = await prisma.owner.findMany({
    orderBy: { createdAt: 'desc' }
  })

  return (
    <div className="p-10 max-w-6xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">Gesti√≥n de Due√±os</h1>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO ALTA */}
        <div className="md:col-span-1">
            <div className="sticky top-24">
                <OwnerForm /> {/* üëà Formulario limpio, sin props es creaci√≥n */}
            </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="md:col-span-2 grid gap-4">
            {owners.map((owner) => (
            <div key={owner.id} className="border p-4 rounded-lg bg-white shadow-sm hover:shadow-md transition flex justify-between items-center">
                <div>
                    <div className="flex items-center gap-2">
                        <p className="font-bold text-lg text-gray-800">{owner.name}</p>
                        {owner.isActive && <span className="w-2 h-2 rounded-full bg-green-500"></span>}
                    </div>
                    <p className="text-gray-500 text-sm mt-1">
                        üìß {owner.email || "Sin email"}
                    </p>
                    <p className="text-gray-500 text-sm">
                        üìû {owner.phone || "Sin tel√©fono"}
                    </p>
                </div>
                
                {/* BOT√ìN EDITAR */}
                <Link 
                    href={`/owners/${owner.id}/edit`}
                    className="bg-gray-100 text-gray-600 hover:bg-blue-50 hover:text-blue-600 px-4 py-2 rounded text-sm font-bold border transition"
                >
                    EDITAR
                </Link>
            </div>
            ))}
            
            {owners.length === 0 && (
            <div className="p-10 text-center text-gray-400 border-2 border-dashed rounded-lg">
                No hay due√±os registrados.
            </div>
            )}
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\balance) ---

// src/app/owners/balance/page.tsx
import { prisma } from "@/lib/prisma";
import Link from "next/link";

export default async function OwnersBalancePage() {
  // 1. LA CONSULTA MAESTRA ACTUALIZADA
  // Buscamos due√±os, sus ventas pendientes Y sus ajustes pendientes
  const ownersData = await prisma.owner.findMany({
    where: { isActive: true },
    include: {
      // A. Ventas pendientes (Deuda del Local -> Due√±o)
      products: {
        include: {
          variants: {
            include: {
              saleItems: {
                where: { isSettled: false },
              },
            },
          },
        },
      },
      // B. Ajustes pendientes (Deuda del Due√±o -> Local, usualmente negativo)
      balanceAdjustments: {
        where: { isApplied: false }
      }
    },
  });

  // 2. PROCESAMIENTO DE DATOS
  const report = ownersData.map((owner) => {
    let debtFromSales = 0;
    let debtFromAdjustments = 0;
    let itemsCount = 0;

    // A. Sumar deuda por ventas (Mercader√≠a vendida y no pagada)
    owner.products.forEach((product) => {
      product.variants.forEach((variant) => {
        variant.saleItems.forEach((item) => {
          debtFromSales += Number(item.costAtSale) * item.quantity;
          itemsCount += item.quantity;
        });
      });
    });

    // B. Sumar deuda por ajustes (Devoluciones de ventas ya pagadas)
    owner.balanceAdjustments.forEach(adjustment => {
      debtFromAdjustments += Number(adjustment.amount);
    });

    // C. Deuda Neta Total (Suma algebraica)
    // Ejemplo: Ventas ($1000) + Devoluci√≥n (-$200) = Total a Pagar ($800)
    const totalDebt = debtFromSales + debtFromAdjustments;

    return {
      ownerId: owner.id,
      name: owner.name,
      phone: owner.phone,
      totalDebt,
      itemsCount,
      hasAdjustments: owner.balanceAdjustments.length > 0
    };
  });

  // Filtramos: Mostramos si hay deuda O si hay saldo a favor del local (deuda negativa)
  const ownersWithActivity = report
    .filter((r) => r.totalDebt !== 0)
    .sort((a, b) => b.totalDebt - a.totalDebt);

  const ownersClean = report.filter((r) => r.totalDebt === 0);

  return (
    <div className="p-10 max-w-5xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">
          Estado de Cuenta
        </h1>
        <div className="bg-slate-800 text-white px-6 py-3 rounded-lg font-bold shadow-lg">
          Total a Pagar: $
          {report.reduce((sum, r) => sum + r.totalDebt, 0).toLocaleString()}
        </div>
      </div>

      {/* TABLA DE DEUDAS */}
      <div className="bg-white rounded-lg shadow overflow-hidden border mb-10">
        <table className="w-full text-left">
          <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold border-b">
            <tr>
              <th className="p-4">Due√±o</th>
              <th className="p-4 text-center">Items Pend.</th>
              <th className="p-4 text-right">Saldo Neto</th>
              <th className="p-4 text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {ownersWithActivity.map((row) => (
              <tr key={row.ownerId} className="hover:bg-blue-50 transition">
                <td className="p-4">
                  <p className="font-bold text-lg text-gray-800">{row.name}</p>
                  <p className="text-xs text-gray-500">
                    {row.phone || "Sin tel√©fono"}
                  </p>
                  {row.hasAdjustments && (
                    <span className="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded border border-yellow-200 inline-block mt-1">
                      ‚ö†Ô∏è Incluye ajustes/devoluciones
                    </span>
                  )}
                </td>
                
                <td className="p-4 text-center font-mono text-lg text-gray-600">
                  {row.itemsCount}
                </td>
                
                <td className="p-4 text-right">
                  <span className={`text-xl font-bold ${row.totalDebt >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                    ${row.totalDebt.toLocaleString()}
                  </span>
                  {row.totalDebt < 0 && (
                     <p className="text-xs text-green-600 font-bold">Saldo a favor Local</p>
                  )}
                </td>
                
                <td className="p-4 text-center">
                  <Link
                    href={`/owners/settlement/${row.ownerId}`}
                    className="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700 shadow inline-block font-medium"
                  >
                    Ver Detalle
                  </Link>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {ownersWithActivity.length === 0 && (
          <div className="p-10 text-center text-gray-500 text-lg">
            ‚úÖ ¬°Todo al d√≠a! No hay saldos pendientes.
          </div>
        )}
      </div>

      {/* DUE√ëOS AL D√çA */}
      {ownersClean.length > 0 && (
        <details className="mt-8">
          <summary className="cursor-pointer text-gray-500 font-medium hover:text-gray-700 select-none">
            Ver due√±os sin saldo pendiente ({ownersClean.length})
          </summary>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 opacity-75">
            {ownersClean.map((o) => (
              <div
                key={o.ownerId}
                className="border p-3 rounded bg-gray-50 text-sm flex justify-between"
              >
                <span>{o.name}</span>
                <span className="text-green-600 font-bold">‚úì</span>
              </div>
            ))}
          </div>
        </details>
      )}
    </div>
  );
}

--- File: page.tsx (in subfolder: app\owners\settlement\[id]) ---

// src/app/owners/settlement/[id]/page.tsx

import { prisma } from "@/lib/prisma"
import { createSettlement } from "@/actions/settlement-actions"
import Link from "next/link"
import SettlementButton from "@/components/SettlementButton"

interface Props {
  params: Promise<{ id: string }>
}

export default async function SettlementPage({ params }: Props) {
  const { id } = await params
  
  // 1. Buscamos al due√±o, sus ventas pendientes Y sus ajustes pendientes
  const owner = await prisma.owner.findUnique({
    where: { id },
    include: {
      // A. Ventas
      products: {
        include: {
          variants: {
            include: {
              saleItems: {
                where: { isSettled: false },
                include: { sale: true }
              }
            }
          }
        }
      },
      // B. Ajustes
      balanceAdjustments: {
        where: { isApplied: false }
      }
    }
  })

  if (!owner) {
    return (
      <div className="p-10 text-center">
        <h1 className="text-xl text-red-600">Due√±o no encontrado</h1>
        <Link href="/owners/balance" className="text-blue-500 underline">Volver</Link>
      </div>
    )
  }

  // 2. Unificar listas (Ventas + Ajustes) para la tabla
  let totalToPay = 0
  const detailRows: any[] = []

  // Procesar Ventas
  owner.products.forEach(p => {
    p.variants.forEach(v => {
      v.saleItems.forEach(item => {
        const subtotal = Number(item.costAtSale) * item.quantity
        totalToPay += subtotal
        
        detailRows.push({
          id: item.id,
          type: 'SALE',
          date: item.sale.createdAt,
          description: `${item.description} (${item.quantity} u.)`,
          amount: subtotal
        })
      })
    })
  })

  // Procesar Ajustes
  owner.balanceAdjustments.forEach(adj => {
    const amount = Number(adj.amount)
    totalToPay += amount
    
    detailRows.push({
      id: adj.id,
      type: 'ADJUSTMENT',
      date: adj.createdAt,
      description: adj.description, // Ej: "Devoluci√≥n Venta..."
      amount: amount
    })
  })

  // Ordenar cronol√≥gicamente
  detailRows.sort((a, b) => a.date.getTime() - b.date.getTime())

  return (
    <div className="p-8 max-w-4xl mx-auto">
      
      {/* CABECERA */}
      <div className="mb-8">
        <Link href="/owners/balance" className="text-blue-600 hover:underline mb-4 block">
          ‚Üê Volver al Balance General
        </Link>
        <h1 className="text-3xl font-bold text-gray-800">
          Liquidaci√≥n: {owner.name}
        </h1>
        <p className="text-gray-500">Revis√° el detalle antes de pagar.</p>
      </div>

      {/* CAJA DE RESUMEN Y ACCI√ìN */}
      <div className="bg-gray-50 p-6 rounded-lg border flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 shadow-sm">
        <div>
            <p className="text-sm text-gray-500 uppercase font-bold">Total Neto a Pagar</p>
            <p className={`text-4xl font-bold ${totalToPay >= 0 ? 'text-gray-800' : 'text-green-600'}`}>
                ${totalToPay.toLocaleString()}
            </p>
            {totalToPay < 0 && <span className="text-xs text-green-600 font-bold">Saldo a favor del local</span>}
        </div>
        
        {/* Solo mostramos el bot√≥n si hay algo que mover (positivo o negativo) */}
        {detailRows.length > 0 ? (
          <form action={createSettlement}>
            <input type="hidden" name="ownerId" value={owner.id} />
            <SettlementButton />
          </form>
        ) : (
          <div className="bg-green-100 text-green-800 px-4 py-2 rounded font-bold">
             DUE√ëO AL D√çA
          </div>
        )}
      </div>

      {/* TABLA DE DETALLE */}
      <div className="bg-white rounded shadow overflow-hidden border">
        <table className="w-full text-left text-sm">
          <thead className="bg-gray-100 text-gray-700 uppercase">
            <tr>
              <th className="p-3">Fecha</th>
              <th className="p-3">Concepto</th>
              <th className="p-3 text-right">Monto</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {detailRows.map(row => (
              <tr key={row.id} className="hover:bg-gray-50">
                <td className="p-3 text-gray-500">
                    {row.date.toLocaleDateString()}
                </td>
                
                <td className="p-3 font-medium text-gray-800">
                    {/* Iconos visuales para distinguir */}
                    {row.type === 'SALE' ? (
                        <span className="text-blue-600 mr-2">üõí</span> 
                    ) : (
                        <span className="text-orange-500 mr-2">‚Ü©Ô∏è</span>
                    )}
                    {row.description}
                </td>
                
                <td className={`p-3 text-right font-bold ${row.amount < 0 ? 'text-green-600' : 'text-gray-800'}`}>
                    {/* Formato de moneda */}
                    {row.amount < 0 ? '' : ''}${row.amount.toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        
        {detailRows.length === 0 && (
            <div className="p-10 text-center text-gray-400">
                Este due√±o no tiene movimientos pendientes.
            </div>
        )}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\[id]\edit) ---

// src/app/owners/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditOwnerPage({ params }: Props) {
  const { id } = await params

  const owner = await prisma.owner.findUnique({
    where: { id }
  })

  if (!owner) return <div>Due√±o no encontrado</div>

  return (
    <div className="p-10 max-w-lg mx-auto">
      <Link href="/owners" className="text-blue-500 mb-4 block hover:underline">‚Üê Volver al listado</Link>
      
      {/* Reutilizamos el formulario pas√°ndole los datos */}
      <OwnerForm initialData={owner} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets) ---

// src/app/pets/page.tsx
import { prisma } from "@/lib/prisma"
import { createPet, deletePet } from "@/actions/pet-actions"
import Link from "next/link"

export default async function PetsPage() {
  // Listamos todas las mascotas ordenadas por nombre
  const pets = await prisma.pet.findMany({
    orderBy: { name: 'asc' }
  })

  // Server Action peque√±a para el bot√≥n de borrar
  async function handleDelete(formData: FormData) {
    'use server'
    const id = formData.get("id") as string
    await deletePet(id)
  }

  return (
    <div className="p-8 max-w-6xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-gray-800">Clientes (Mascotas)</h1>
        {/* Un peque√±o men√∫ de navegaci√≥n temporal */}
        <div className="space-x-4 text-sm font-bold text-blue-600">
             <Link href="/dashboard" className="hover:underline">Dashboard</Link>
             <Link href="/agenda" className="hover:underline">Agenda</Link>
             <Link href="/products" className="hover:underline">Productos</Link>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO DE ALTA */}
        <div className="lg:col-span-1">
          <div className="bg-white p-6 rounded-lg shadow border sticky top-4">
            <h2 className="text-xl font-bold mb-4">Nueva Ficha</h2>
            <form action={createPet} className="space-y-4">
              
              <div>
                <label className="block text-sm font-medium text-gray-700">Nombre Mascota *</label>
                <input name="name" type="text" required placeholder="Ej: Bobby" className="w-full border p-2 rounded"/>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Raza</label>
                <input name="breed" type="text" placeholder="Ej: Caniche" className="w-full border p-2 rounded"/>
              </div>

              <div className="pt-2 border-t">
                <p className="text-xs text-gray-400 mb-2 uppercase font-bold">Datos del Due√±o</p>
                
                <div className="mb-2">
                    <label className="block text-sm font-medium text-gray-700">Nombre Humano *</label>
                    <input name="ownerName" type="text" required placeholder="Ej: Maria Perez" className="w-full border p-2 rounded"/>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700">Tel√©fono / WhatsApp *</label>
                    <input name="ownerPhone" type="text" required placeholder="Ej: 11 1234 5678" className="w-full border p-2 rounded"/>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700">Notas Generales (Alertas)</label>
                <textarea name="notes" rows={2} className="w-full border p-2 rounded" placeholder="Ej: Al√©rgico al pollo"></textarea>
              </div>

              <button type="submit" className="w-full bg-purple-600 text-white py-3 rounded hover:bg-purple-700 font-bold">
                Guardar Ficha
              </button>
            </form>
          </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="lg:col-span-2">
          <div className="grid gap-4">
            {pets.map((pet) => (
              <div key={pet.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-start hover:shadow-md transition">
                <div>
                  <div className="flex items-center gap-2">
                    <h3 className="text-lg font-bold text-gray-800">{pet.name}</h3>
                    <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">{pet.breed}</span>
                  </div>
                  
                  <div className="mt-1 text-sm text-gray-600">
                    <span className="font-semibold">Due√±o:</span> {pet.ownerName} 
                    <span className="mx-2 text-gray-300">|</span>
                    <span className="text-green-600 font-mono">üìû {pet.ownerPhone}</span>
                  </div>

                  {pet.notes && (
                    <p className="mt-2 text-xs text-gray-500 italic bg-yellow-50 p-2 rounded border border-yellow-100 inline-block">
                      ‚ö†Ô∏è {pet.notes}
                    </p>
                  )}
                </div>
                
                <div className="flex flex-col gap-2 items-end">
                    {/* BOT√ìN VER FICHA (NUEVO) */}
                    <Link 
                        href={`/pets/${pet.id}`}
                        className="bg-purple-100 text-purple-700 text-xs font-bold px-3 py-1.5 rounded hover:bg-purple-200 border border-purple-200"
                    >
                        VER FICHA
                    </Link>

                    <form action={handleDelete}>
                        <input type="hidden" name="id" value={pet.id} />
                        <button type="submit" className="text-red-300 hover:text-red-500 text-[10px] font-bold px-2 py-1 hover:underline">
                            ELIMINAR
                        </button>
                    </form>
                </div>
              </div>
            ))}

            {pets.length === 0 && (
              <div className="text-center py-10 text-gray-400 bg-gray-50 rounded border border-dashed">
                No hay mascotas registradas.<br/>Us√° el formulario de la izquierda.
              </div>
            )}
          </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets\[id]) ---

// src/app/pets/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import { createNote, deleteNote } from "@/actions/note-actions"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function PetDetailPage({ params }: Props) {
  const { id } = await params

  // 1. Buscamos la Mascota con TODO su historial (Turnos y Notas)
  const pet = await prisma.pet.findUnique({
    where: { id },
    include: {
      appointments: {
        orderBy: { startTime: 'desc' } // Los m√°s recientes primero
      },
      groomingNotes: {
        orderBy: { createdAt: 'desc' }
      }
    }
  })

  if (!pet) return <div className="p-10">Mascota no encontrada</div>

  return (
    <div className="p-8 max-w-6xl mx-auto">
      
      {/* CABECERA DE PERFIL */}
      <div className="mb-8 flex items-center justify-between">
        <div>
            <Link href="/pets" className="text-sm text-blue-600 hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-bold text-gray-800 flex items-center gap-3">
                {pet.name}
                <span className="text-lg font-normal bg-gray-100 text-gray-600 px-3 py-1 rounded-full border">
                    {pet.breed || "Mestizo"}
                </span>
            </h1>
            <div className="mt-2 text-gray-600 flex gap-4 text-sm">
                <p>üë§ Due√±o: <strong>{pet.ownerName}</strong></p>
                <p>üìû Tel: <strong>{pet.ownerPhone}</strong></p>
            </div>
            {pet.notes && (
                <p className="mt-3 text-red-600 bg-red-50 p-2 rounded border border-red-100 inline-block text-sm font-bold">
                    ‚ö†Ô∏è Alerta: {pet.notes}
                </p>
            )}
        </div>
        
        <div className="text-right">
             <div className="bg-slate-800 text-white px-6 py-4 rounded-lg text-center">
                <p className="text-xs uppercase opacity-70">Turnos Totales</p>
                <p className="text-3xl font-bold">{pet.appointments.length}</p>
             </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: NUEVA NOTA + HISTORIAL T√âCNICO */}
        <div className="lg:col-span-2 space-y-8">
            
            {/* Formulario Agregar Nota */}
            <div className="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                <h2 className="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                    üìù Nueva Nota T√©cnica
                </h2>
                <form action={createNote}>
                    <input type="hidden" name="petId" value={pet.id} />
                    <textarea 
                        name="content" 
                        required
                        rows={3} 
                        className="w-full p-3 border rounded bg-white focus:ring-2 focus:ring-yellow-400 outline-none"
                        placeholder="Ej: Corte con alza 4, se port√≥ bien, usar shampoo hipoalerg√©nico..."
                    ></textarea>
                    <div className="mt-2 text-right">
                        <button className="bg-yellow-600 text-white px-4 py-2 rounded font-bold hover:bg-yellow-700">
                            Guardar Nota
                        </button>
                    </div>
                </form>
            </div>

            {/* Listado de Notas */}
            <div>
                <h3 className="text-xl font-bold mb-4 text-gray-800">Historial T√©cnico</h3>
                {pet.groomingNotes.length === 0 ? (
                    <p className="text-gray-400 italic">No hay notas guardadas.</p>
                ) : (
                    <div className="space-y-4">
                        {pet.groomingNotes.map(note => (
                            <div key={note.id} className="bg-white p-4 rounded shadow-sm border border-l-4 border-l-yellow-400 group">
                                <div className="flex justify-between items-start">
                                    <p className="text-gray-800 whitespace-pre-wrap">{note.content}</p>
                                    <form action={deleteNote}>
                                        <input type="hidden" name="id" value={note.id} />
                                        <input type="hidden" name="petId" value={pet.id} />
                                        <button className="text-gray-300 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100 transition">
                                            Borrar
                                        </button>
                                    </form>
                                </div>
                                <p className="text-xs text-gray-400 mt-2 text-right">
                                    {note.createdAt.toLocaleDateString()} a las {note.createdAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE TURNOS */}
        <div className="lg:col-span-1">
            <h3 className="text-xl font-bold mb-4 text-gray-800">Historial de Visitas</h3>
            <div className="bg-white rounded-lg shadow border overflow-hidden">
                {pet.appointments.length === 0 ? (
                    <div className="p-8 text-center text-gray-400">Sin visitas a√∫n.</div>
                ) : (
                    <div className="divide-y">
                        {pet.appointments.map(appt => (
                            <div key={appt.id} className="p-4 hover:bg-gray-50">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold text-gray-700">
                                        {appt.startTime.toLocaleDateString()}
                                    </span>
                                    <span className={`text-[10px] px-2 py-0.5 rounded font-bold border 
                                        ${appt.status === 'COMPLETED' || appt.status === 'BILLED' 
                                            ? 'bg-green-100 text-green-700 border-green-200' 
                                            : appt.status === 'CANCELLED' 
                                                ? 'bg-red-50 text-red-500 border-red-100'
                                                : 'bg-blue-50 text-blue-600 border-blue-100'}
                                    `}>
                                        {appt.status === 'BILLED' ? 'COBRADO' : appt.status}
                                    </span>
                                </div>
                                <p className="text-sm text-gray-500">
                                    Hora: {appt.startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pos) ---

// src/app/pos/page.tsx
import { prisma } from "@/lib/prisma"
import PosSystem from "@/components/PosSystem"

export default async function PosPage() {
  // Buscamos productos con stock > 0 (o todos, para mostrar agotados visualmente)
  const products = await prisma.product.findMany({
    where: { isActive: true },
    include: { variants: true, owner: true }
  })

  // Transformamos los datos complejos de Prisma a una estructura simple para el Frontend
  const simpleProducts = products.map(p => {
    const v = p.variants[0] // Asumimos variante √∫nica
    return {
      id: v.id,
      name: p.name,
      price: Number(v.salePrice), // Convertimos Decimal a Number para JS
      stock: v.stock,
      imageUrl: v.imageUrl,
      ownerName: p.owner.name
    }
  })

  return (
    <div className="h-screen flex flex-col p-4 bg-gray-50">
      <header className="mb-4 flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">Punto de Venta</h1>
        <div className="text-sm text-gray-500">Caja Principal</div>
      </header>
      
      {/* Cargamos el sistema interactivo */}
      <PosSystem products={simpleProducts} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products) ---

// src/app/products/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import ProductActions from "@/components/ProductActions" // üëà El componente nuevo
import Link from "next/link"

export default async function ProductsPage() {
  // 1. Datos necesarios para los selectores del formulario
  const owners = await prisma.owner.findMany({ select: { id: true, name: true } })
  const categories = await prisma.category.findMany({ select: { id: true, name: true } })

  // 2. Listado de productos (Traemos TODO para gestionar el inventario)
  const products = await prisma.product.findMany({
    include: {
      variants: true,
      category: true,
      owner: true
    },
    orderBy: { name: 'asc' }
  })

  return (
    <div className="p-8 max-w-7xl mx-auto">
      {/* HEADER */}
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-gray-800">Inventario de Productos</h1>
        
        {/* Enlace r√°pido al importador masivo */}
        <Link 
          href="/products/import" 
          className="bg-green-600 text-white px-5 py-2 rounded-lg shadow hover:bg-green-700 font-bold text-sm flex items-center gap-2"
        >
          üìÑ Importar Excel
        </Link>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO ALTA R√ÅPIDA */}
        <div className="lg:col-span-1">
          <div className="sticky top-4">
             <ProductForm owners={owners} categories={categories} />
          </div>
        </div>

        {/* COLUMNA DERECHA: TABLA DE GESTI√ìN */}
        <div className="lg:col-span-2">
          <div className="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
            <table className="w-full text-sm text-left">
              <thead className="bg-gray-100 text-gray-700 uppercase font-bold text-xs">
                <tr>
                  <th className="px-4 py-3">Producto / Due√±o</th>
                  <th className="px-4 py-3">Categor√≠a</th>
                  <th className="px-4 py-3">Precio</th>
                  <th className="px-4 py-3 text-center">Stock</th>
                  <th className="px-4 py-3 text-center">Acciones</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {products.map(p => {
                  const variant = p.variants[0] // Variante principal
                  const isArchived = !p.isActive

                  return (
                    <tr 
                      key={p.id} 
                      className={`transition duration-150
                        ${isArchived 
                            ? 'bg-gray-100 opacity-60 grayscale' // Estilo "desactivado"
                            : 'hover:bg-blue-50 bg-white'
                        }
                      `}
                    >
                      {/* PRODUCTO */}
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-3">
                            {variant?.imageUrl ? (
                            <img src={variant.imageUrl} className="w-10 h-10 object-cover rounded border" />
                            ) : (
                            <div className="w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-400">
                                Sin foto
                            </div>
                            )}
                            <div>
                                <p className="font-bold text-gray-900 leading-tight">
                                    {p.name}
                                    {isArchived && <span className="text-[10px] text-red-600 ml-2 border border-red-200 px-1 rounded">ARCHIVADO</span>}
                                </p>
                                <p className="text-xs text-gray-500">{p.owner.name}</p>
                            </div>
                        </div>
                      </td>

                      {/* CATEGOR√çA */}
                      <td className="px-4 py-3 text-gray-600">
                        {p.category.name}
                      </td>

                      {/* PRECIO */}
                      <td className="px-4 py-3 font-bold text-green-700 text-base">
                        ${variant?.salePrice.toString()}
                      </td>

                      {/* STOCK */}
                      <td className="px-4 py-3 text-center">
                        {variant?.stock === 0 ? (
                          <span className="text-red-600 bg-red-100 px-2 py-1 rounded text-xs font-bold">AGOTADO</span>
                        ) : (
                          <span className="font-mono font-bold text-gray-700">{variant?.stock}</span>
                        )}
                      </td>

                      {/* ACCIONES (Componente Cliente) */}
                      <td className="px-4 py-3">
                        <div className="flex justify-center">
                            <ProductActions 
                                id={p.id} 
                                isActive={p.isActive} 
                                stock={variant?.stock || 0}
                            />
                        </div>
                      </td>
                    </tr>
                  )
                })}
                
                {products.length === 0 && (
                  <tr>
                    <td colSpan={5} className="text-center py-12 text-gray-500">
                      <p className="text-lg">Tu inventario est√° vac√≠o.</p>
                      <p className="text-sm">¬°Agreg√° el primer producto a la izquierda!</p>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\import) ---

import ExcelImporter from "@/components/ExcelImporter"
import Link from "next/link"

export default function ImportPage() {
  return (
    <div className="p-8 max-w-3xl mx-auto">
      <Link href="/products" className="text-blue-600 hover:underline mb-4 block">
        ‚Üê Volver a Productos
      </Link>
      <h1 className="text-3xl font-bold mb-8">Asistente de Importaci√≥n</h1>
      <ExcelImporter />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\[id]\edit) ---

// src/app/products/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditProductPage({ params }: Props) {
  const { id } = await params

  // 1. Buscar datos maestros para los selectores
  const owners = await prisma.owner.findMany()
  const categories = await prisma.category.findMany()

  // 2. Buscar el producto a editar
  const product = await prisma.product.findUnique({
    where: { id },
    include: { variants: true }
  })

  if (!product) return <div>Producto no encontrado</div>

  // 3. Preparar los datos para el formulario
  const variant = product.variants[0] // Asumimos variante √∫nica
  const initialData = {
    id: product.id,
    name: product.name,
    description: product.description,
    ownerId: product.ownerId,
    categoryId: product.categoryId,
    costPrice: Number(variant.costPrice),
    salePrice: Number(variant.salePrice),
    imageUrl: variant.imageUrl
  }

  return (
    <div className="p-8 max-w-2xl mx-auto">
        <Link href="/products" className="text-blue-500 mb-4 block">‚Üê Cancelar y Volver</Link>
        <ProductForm 
            owners={owners} 
            categories={categories} 
            initialData={initialData} // üëà Pasamos los datos
        />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\sales) ---

// src/app/sales/page.tsx
import { prisma } from "@/lib/prisma"
import CancelSaleButton from "@/components/CancelSaleButton" // üëà Importamos el nuevo componente

export default async function SalesHistoryPage() {
  // Buscamos las ventas
  const sales = await prisma.sale.findMany({
    include: {
      items: true
    },
    orderBy: { createdAt: 'desc' }
  })

  return (
    <div className="p-8 max-w-5xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Historial de Ventas</h1>

      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-gray-100 text-gray-700 uppercase text-sm">
            <tr>
              <th className="p-4">Fecha / ID</th>
              <th className="p-4">Items</th>
              <th className="p-4">Total</th>
              <th className="p-4">Estado</th>
              <th className="p-4">Acci√≥n</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {sales.map((sale) => (
              <tr key={sale.id} className={sale.status === 'CANCELLED' ? 'bg-red-50' : 'hover:bg-gray-50'}>
                <td className="p-4">
                  <p className="font-bold">{sale.createdAt.toLocaleDateString()}</p>
                  <p className="text-xs text-gray-500 font-mono">{sale.id.slice(0, 8)}...</p>
                </td>
                
                <td className="p-4">
                  <ul className="text-sm list-disc pl-4">
                    {sale.items.map(item => (
                      <li key={item.id}>
                        {item.quantity} x {item.description}
                      </li>
                    ))}
                  </ul>
                </td>

                <td className="p-4 font-bold text-lg">
                  ${sale.total.toString()}
                </td>

                <td className="p-4">
                  <span className={`px-2 py-1 rounded text-xs font-bold
                    ${sale.status === 'COMPLETED' ? 'bg-green-100 text-green-700' : 'bg-red-200 text-red-800'}
                  `}>
                    {sale.status === 'COMPLETED' ? 'COBRADO' : 'ANULADO'}
                  </span>
                </td>

                <td className="p-4">
                  {sale.status === 'COMPLETED' && (
                    /* üëá Usamos el componente interactivo aqu√≠ */
                    <CancelSaleButton saleId={sale.id} />
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {sales.length === 0 && (
          <div className="p-10 text-center text-gray-500">
            No hay ventas registradas a√∫n.
          </div>
        )}
      </div>
    </div>
  )
}

--- File: AppointmentForm.tsx (in subfolder: components) ---

// src/components/AppointmentForm.tsx
'use client'

import { useState } from "react"
import { createAppointment } from "@/actions/appointment-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"

type Props = {
  pets: { id: string, name: string, breed: string | null }[]
  selectedDate: string
}

export default function AppointmentForm({ pets, selectedDate }: Props) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault() // Evitamos la recarga normal del navegador
    setLoading(true)

    // Capturamos los datos del formulario
    const form = e.currentTarget
    const formData = new FormData(form)

    // Agregamos la fecha que viene por prop (porque el input hidden a veces es ma√±oso)
    formData.set("date", selectedDate)

    // Llamamos al Server Action
    const result = await createAppointment(formData)

    setLoading(false)

    if (result.error) {
      // üõë ERROR: Mostramos alerta con el motivo
      alert("‚ùå NO SE PUDO AGENDAR:\n" + result.error)
    } else {
      // ‚úÖ √âXITO: Limpiamos y refrescamos la vista
      alert("‚úÖ Turno agendado correctamente")
      form.reset() // Limpia los inputs
      router.refresh() // Recarga los datos de la agenda a la izquierda
    }
  }

  return (
    <div className="bg-slate-50 p-6 rounded-lg border border-slate-200 sticky top-4 shadow-sm">
      <h2 className="text-xl font-bold mb-4 text-slate-800">Agendar Turno</h2>
      
      <form onSubmit={handleSubmit} className="space-y-4">
        
        {/* Mostramos visualmente la fecha para que el usuario sepa d√≥nde est√° parado */}
        <div className="text-sm text-slate-500 font-bold uppercase tracking-wider mb-2">
           Fecha: {selectedDate}
        </div>

        <div>
          <label className="block text-sm font-bold text-gray-700 mb-1">Mascota</label>
          <select name="petId" required className="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none">
            <option value="">Seleccionar...</option>
            {pets.map(p => (
              <option key={p.id} value={p.id}>{p.name} ({p.breed || 'Sin raza'})</option>
            ))}
          </select>
          <div className="text-right mt-1">
            <Link href="/pets" className="text-xs text-blue-600 underline hover:text-blue-800">
                + Nueva Mascota
            </Link>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Hora Inicio</label>
            <input 
              name="time" 
              type="time" 
              required 
              className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Duraci√≥n</label>
            <select name="duration" className="w-full p-2 border rounded bg-white">
              <option value="30">30 min</option>
              <option value="60">1 h</option>
              <option value="90">1 h 30m</option>
              <option value="120">2 hs</option>
              <option value="180">3 hs</option>
            </select>
          </div>
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={`w-full py-3 rounded font-bold transition text-white shadow
            ${loading 
                ? 'bg-slate-400 cursor-wait' 
                : 'bg-slate-800 hover:bg-slate-900 hover:scale-[1.02] active:scale-95'
            }
          `}
        >
          {loading ? "Verificando..." : "Confirmar Reserva"}
        </button>

      </form>
    </div>
  )
}

--- File: CancelSaleButton.tsx (in subfolder: components) ---

// src/components/CancelSaleButton.tsx
'use client'

import { cancelSale } from "@/actions/sale-actions"
import { useState } from "react"

export default function CancelSaleButton({ saleId }: { saleId: string }) {
  const [loading, setLoading] = useState(false)

  const handleCancel = async () => {
    // 1. Log en el NAVEGADOR (Mirar F12 > Console)
    console.log(`üîµ [CLIENTE] Click en anular venta ID: ${saleId}`)

    const confirmed = confirm("¬øEst√°s SEGURO de anular esta venta?\n\nSi ya fue liquidada, se generar√° una deuda al due√±o.")
    if (!confirmed) return

    setLoading(true)

    try {
      // 2. Llamada al Servidor
      console.log("‚è≥ [CLIENTE] Llamando al servidor...")
      const result = await cancelSale(saleId)

      // 3. Respuesta del Servidor
      console.log("üü¢ [CLIENTE] Respuesta recibida:", result)

      if (result.success) {
        alert("‚úÖ ¬°Venta Anulada con √âxito!")
        // La p√°gina se refrescar√° sola gracias al revalidatePath del servidor
      } else {
        alert(`‚ùå Error: ${result.error}`)
      }
    } catch (err) {
      console.error("üî¥ [CLIENTE] Error de red o c√≥digo:", err)
      alert("Error inesperado al intentar anular.")
    } finally {
      setLoading(false)
    }
  }

  return (
    <button
      onClick={handleCancel}
      disabled={loading}
      className={`text-sm font-semibold border px-3 py-1 rounded transition
        ${loading 
          ? 'bg-gray-200 text-gray-500 cursor-wait' 
          : 'text-red-600 border-red-200 hover:bg-red-50 hover:text-red-800'
        }
      `}
    >
      {loading ? "Procesando..." : "Anular"}
    </button>
  )
}

--- File: ExcelImporter.tsx (in subfolder: components) ---

'use client'

import { useState } from "react"
import readXlsxFile from "read-excel-file"
import { importSingleProduct } from "@/actions/bulk-actions"

export default function ExcelImporter() {
  const [rows, setRows] = useState<any[]>([])
  const [processing, setProcessing] = useState(false)
  const [progress, setProgress] = useState({ current: 0, total: 0, errors: 0 })
  const [logs, setLogs] = useState<string[]>([])

  // 1. LEER EL ARCHIVO
  const handleFile = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    try {
      // Leemos el Excel. Asumimos columnas en orden: Nombre, Categoria, Due√±o, Costo, Precio
      const data = await readXlsxFile(file)
      
      // Eliminamos la cabecera (fila 0)
      const cleanData = data.slice(1).map(row => ({
        name: row[0] as string,
        categoryName: row[1] as string,
        ownerName: row[2] as string,
        cost: Number(row[3]),
        price: Number(row[4])
      }))

      setRows(cleanData)
      setLogs(prev => [...prev, `Archivo cargado: ${cleanData.length} productos detectados.`])
    } catch (error) {
      alert("Error leyendo Excel. Asegurate que sea un .xlsx v√°lido.")
    }
  }

  // 2. PROCESAR BUCLE (LOOP)
  const startImport = async () => {
    setProcessing(true)
    setProgress({ current: 0, total: rows.length, errors: 0 })
    setLogs([])

    let successCount = 0
    let errorCount = 0

    // BUCLE SECUENCIAL
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i]
      
      // Validar datos m√≠nimos antes de llamar al server
      if (!row.name || !row.ownerName) {
        setLogs(prev => [...prev, `‚ùå Fila ${i+2}: Faltan datos obligatorios`])
        errorCount++
        continue
      }

      // Llamada al Server Action
      const result = await importSingleProduct(row)

      if (result.success) {
        successCount++
      } else {
        errorCount++
        setLogs(prev => [...prev, `‚ùå Error en "${row.name}": ${result.error}`])
      }

      // Actualizar barra de progreso
      setProgress({ 
        current: i + 1, 
        total: rows.length, 
        errors: errorCount 
      })
    }

    setProcessing(false)
    setLogs(prev => [...prev, `üèÅ FINALIZADO. √âxitos: ${successCount}, Errores: ${errorCount}`])
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow border">
      <h2 className="text-xl font-bold mb-4">Importaci√≥n Masiva (Excel)</h2>
      
      <div className="mb-4 p-4 bg-blue-50 text-blue-800 text-sm rounded">
        <strong>Formato requerido (Columnas):</strong>
        <br />
        1. Nombre Producto | 2. Categor√≠a | 3. Nombre Due√±o | 4. Costo | 5. Precio Venta
      </div>

      {!processing && rows.length === 0 && (
        <input 
          type="file" 
          accept=".xlsx" 
          onChange={handleFile}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700"
        />
      )}

      {rows.length > 0 && !processing && progress.current === 0 && (
        <div className="space-y-4">
          <p className="font-bold text-lg">{rows.length} productos listos para importar.</p>
          <button 
            onClick={startImport}
            className="w-full bg-green-600 text-white py-3 rounded hover:bg-green-700 font-bold"
          >
            Iniciar Importaci√≥n
          </button>
        </div>
      )}

      {/* BARRA DE PROGRESO */}
      {(processing || progress.current > 0) && (
        <div className="mt-4 space-y-2">
          <div className="flex justify-between text-sm font-bold">
            <span>Progreso: {progress.current} / {progress.total}</span>
            <span className="text-red-600">Errores: {progress.errors}</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-4">
            <div 
              className="bg-blue-600 h-4 rounded-full transition-all duration-300" 
              style={{ width: `${(progress.current / progress.total) * 100}%` }}
            ></div>
          </div>
        </div>
      )}

      {/* LOGS DE ERRORES */}
      <div className="mt-6 max-h-40 overflow-y-auto bg-gray-900 text-green-400 p-4 rounded font-mono text-xs">
        {logs.length === 0 ? "Esperando log..." : logs.map((log, i) => (
          <div key={i}>{log}</div>
        ))}
      </div>
    </div>
  )
}

--- File: ImageUpload.tsx (in subfolder: components) ---

// src/components/ImageUpload.tsx
'use client' // Necesario para interactuar con el usuario

import { useState } from "react"

export default function ImageUpload({ onImageUpload }: { onImageUpload: (url: string) => void }) {
  const [uploading, setUploading] = useState(false)
  const [preview, setPreview] = useState<string | null>(null)

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setUploading(true)

    // 1. Preparar los datos para Cloudinary
    const formData = new FormData()
    formData.append("file", file)
    formData.append("upload_preset", process.env.NEXT_PUBLIC_CLOUDINARY_PRESET!)

    try {
      // 2. Enviar a Cloudinary (Petici√≥n directa desde el navegador)
      const cloudName = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData,
      })

      const data = await response.json()

      if (data.secure_url) {
        // 3. √âxito: Guardamos la URL y avisamos al componente padre
        setPreview(data.secure_url)
        onImageUpload(data.secure_url) // üëà Esta funci√≥n viene de afuera
      } else {
        alert("Error al subir imagen")
      }
    } catch (error) {
      console.error(error)
      alert("Error de conexi√≥n al subir imagen")
    } finally {
      setUploading(false)
    }
  }

  return (
    <div className="flex flex-col gap-2">
      <label className="text-sm font-medium text-gray-700">Imagen del Producto</label>
      
      <div className="flex items-center gap-4">
        {/* Input de archivo */}
        <input 
          type="file" 
          accept="image/*"
          onChange={handleFileChange}
          disabled={uploading}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
        
        {/* Indicador de carga */}
        {uploading && <span className="text-sm text-blue-600">Subiendo...</span>}
      </div>

      {/* Previsualizaci√≥n */}
      {preview && (
        <div className="mt-2">
          <img src={preview} alt="Vista previa" className="h-32 w-32 object-cover rounded-md border" />
        </div>
      )}
    </div>
  )
}

--- File: MainNav.tsx (in subfolder: components) ---

// src/components/MainNav.tsx
'use client'

import Link from "next/link"
import { usePathname } from "next/navigation"

export default function MainNav() {
  const pathname = usePathname()

  // Definimos las rutas del sistema
  const routes = [
    { href: "/dashboard", label: "üìä Dashboard", exact: true },
    { href: "/agenda", label: "üìÖ Agenda", exact: false },
    { href: "/pos", label: "üí∞ CAJA", exact: true, highlight: true }, // Resaltado especial
    { href: "/sales", label: "üóÇÔ∏è Ventas", exact: false },
    { href: "/products", label: "üì¶ Productos", exact: false },
    { href: "/pets", label: "üê∂ Clientes", exact: false },
    { href: "/owners", label: "üë• Consignantes", exact: false }, // Usamos emoji aproximado
    // Sub-ruta importante que queremos tener a mano
    { href: "/owners/balance", label: "‚öñÔ∏è Finanzas", exact: true },
  ]

  return (
    <nav className="bg-slate-900 text-gray-300 border-b border-slate-800 sticky top-0 z-50">
      <div className="max-w-7xl mx-auto px-4">
        <div className="flex h-16 items-center justify-between overflow-x-auto">
          
          {/* LOGO / NOMBRE */}
          <div className="flex-shrink-0 font-bold text-white text-xl tracking-tight mr-8">
            GUAPECANES
          </div>

          {/* LISTA DE ENLACES */}
          <div className="flex space-x-2">
            {routes.map((route) => {
              // L√≥gica para saber si el link est√° activo
              const isActive = route.exact 
                ? pathname === route.href
                : pathname.startsWith(route.href)

              return (
                <Link
                  key={route.href}
                  href={route.href}
                  className={`
                    px-3 py-2 rounded-md text-sm font-medium transition-colors whitespace-nowrap
                    ${route.highlight 
                        ? 'bg-green-600 text-white hover:bg-green-500 shadow-md shadow-green-900/20' // Estilo bot√≥n Caja
                        : isActive 
                            ? 'bg-slate-800 text-white' // Estilo Activo normal
                            : 'hover:bg-slate-800 hover:text-white' // Estilo Inactivo
                    }
                  `}
                >
                  {route.label}
                </Link>
              )
            })}
          </div>
          
        </div>
      </div>
    </nav>
  )
}

--- File: OwnerForm.tsx (in subfolder: components) ---

// src/components/OwnerForm.tsx
'use client'

import { createOwner, updateOwner } from "@/actions/owner-actions"
import { useRouter } from "next/navigation"
import { useState } from "react"

type OwnerData = {
  id?: string
  name: string
  email: string | null
  phone: string | null
}

export default function OwnerForm({ initialData }: { initialData?: OwnerData }) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    
    let result;
    
    if (initialData?.id) {
        // MODO EDICI√ìN
        formData.append("id", initialData.id)
        result = await updateOwner(formData)
        if (result.success) {
            alert("Due√±o actualizado")
            router.push("/owners") // Volver a la lista
            router.refresh()
        }
    } else {
        // MODO CREACI√ìN
        result = await createOwner(formData)
        if (result?.success) {
            // Limpiamos el form manualmente si es creaci√≥n
            const form = document.getElementById("owner-form") as HTMLFormElement
            form?.reset()
            router.refresh()
        }
    }

    setLoading(false)
    if (result?.error) alert(result.error)
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow border">
      <h2 className="text-xl font-bold mb-4">
        {initialData ? "Editar Due√±o" : "Nuevo Due√±o"}
      </h2>
      
      <form id="owner-form" action={handleSubmit} className="flex flex-col gap-4">
        
        <div>
          <label className="text-sm text-gray-600 font-bold">Nombre *</label>
          <input 
            name="name" 
            defaultValue={initialData?.name}
            type="text" 
            required 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="Juan P√©rez"
          />
        </div>

        <div>
          <label className="text-sm text-gray-600 font-bold">Email</label>
          <input 
            name="email" 
            defaultValue={initialData?.email || ""}
            type="email" 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="juan@mail.com"
          />
        </div>

        <div>
          <label className="text-sm text-gray-600 font-bold">Tel√©fono</label>
          <input 
            name="phone" 
            defaultValue={initialData?.phone || ""}
            type="text" 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="11 1234 5678"
          />
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={`w-full py-2 rounded text-white font-bold transition
            ${loading ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}
          `}
        >
          {loading ? "Guardando..." : "Guardar"}
        </button>
      </form>
    </div>
  )
}

--- File: PosSystem.tsx (in subfolder: components) ---

// src/components/PosSystem.tsx
'use client'

import { useState, useEffect } from "react"
import { processSale } from "@/actions/sale-actions"
import { useSearchParams, useRouter } from "next/navigation"

type ProductType = {
  id: string
  name: string
  price: number
  stock: number
  imageUrl: string | null
  ownerName: string
}

// Estructura interna del carrito en el Frontend
type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string
  name: string
  price: number
  quantity: number
  stockMax?: number // Solo aplica a productos f√≠sicos
}

export default function PosSystem({ products }: { products: ProductType[] }) {
  const [cart, setCart] = useState<CartItem[]>([])
  const [loading, setLoading] = useState(false)
  
  // Hooks de Next.js para leer URL y navegar
  const searchParams = useSearchParams()
  const router = useRouter()

  // 1. DETECTAR SI VENIMOS DE LA AGENDA
  // Se ejecuta al cargar la p√°gina. Si hay "apptId" en la URL, agregamos el servicio.
  useEffect(() => {
    const apptId = searchParams.get("apptId")
    const petName = searchParams.get("petName")
    
    // Solo agregamos si el carrito est√° vac√≠o para no duplicar al recargar
    if (apptId && petName && cart.length === 0) {
      setCart([{
        type: 'SERVICE',
        id: apptId,
        name: `Servicio: ${petName}`,
        price: 0, // Inicia en 0, el usuario debe poner el precio
        quantity: 1
      }])
    }
  }, [searchParams]) // Se ejecuta cuando cambian los params

  // Funci√≥n: Agregar Producto al Carrito
  const addProductToCart = (product: ProductType) => {
    if (product.stock <= 0) return alert("Sin stock")

    setCart(current => {
      // Verificamos si ya est√° en el carrito
      const existing = current.find(item => item.id === product.id && item.type === 'PRODUCT')
      
      if (existing) {
        if (existing.quantity >= product.stock) {
          alert("No hay m√°s stock disponible")
          return current
        }
        return current.map(item => 
          item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
        )
      }
      // Si no existe, lo agregamos
      return [...current, { 
        type: 'PRODUCT',
        id: product.id,
        name: product.name,
        price: product.price,
        quantity: 1,
        stockMax: product.stock
      }]
    })
  }

  // Funci√≥n: Modificar Precio (Exclusivo para Servicios)
  const updateServicePrice = (index: number, newPrice: string) => {
    const val = parseFloat(newPrice)
    setCart(current => current.map((item, i) => 
        i === index ? { ...item, price: isNaN(val) ? 0 : val } : item
    ))
  }

  // Funci√≥n: Quitar del Carrito
  const removeFromCart = (index: number) => {
    setCart(current => current.filter((_, i) => i !== index))
  }

  // Calcular Total en tiempo real
  const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)

  // Funci√≥n Principal: Cobrar
  const handleCheckout = async () => {
    // Validaciones b√°sicas de seguridad en cliente
    if (total === 0 && !confirm("¬øConfirmar venta por $0?")) return
    if (!confirm(`¬øConfirmar venta por $${total.toLocaleString()}?`)) return
    
    setLoading(true)
    
    // Preparamos el payload para el Server Action
    const payload = cart.map(item => ({
      type: item.type,
      id: item.id,
      description: item.name,
      price: item.price,
      quantity: item.quantity
    }))

    // Llamada al servidor
    const result = await processSale(payload, total)
    
    setLoading(false)

    if (result.success) {
      alert("¬°Venta Exitosa!")
      setCart([])
      
      // Si ven√≠amos de la agenda, volvemos a ella autom√°ticamente
      if (searchParams.get("apptId")) {
        router.push("/agenda")
      }
    } else {
      alert("Error: " + result.error)
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pb-20">
      
      {/* SECCI√ìN IZQUIERDA: PRODUCTOS F√çSICOS */}
      <div className="md:col-span-2">
        <div className="grid grid-cols-2 lg:grid-cols-3 gap-4">
          {products.map(p => (
            <button 
              key={p.id}
              onClick={() => addProductToCart(p)}
              disabled={p.stock === 0}
              className={`p-4 border rounded-lg text-left transition shadow-sm flex flex-col gap-2 min-h-[180px]
                ${p.stock === 0 ? 'bg-gray-100 opacity-50 cursor-not-allowed' : 'bg-white hover:border-blue-500 hover:shadow-md'}
              `}
            >
              <div className="flex-1 w-full">
                 {p.imageUrl ? (
                     <img src={p.imageUrl} alt={p.name} className="h-24 w-full object-cover rounded mb-2"/>
                 ) : (
                     <div className="h-24 bg-gray-200 rounded mb-2 flex items-center justify-center text-xs text-gray-500">Sin Foto</div>
                 )}
                 <h3 className="font-bold text-gray-800 text-sm leading-tight">{p.name}</h3>
              </div>
              <div className="flex justify-between items-center w-full">
                <span className="text-blue-600 font-bold">${p.price}</span>
                <span className="text-xs text-gray-500">Stock: {p.stock}</span>
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* SECCI√ìN DERECHA: TICKET / CARRITO */}
      <div className="md:col-span-1">
        <div className="bg-white border rounded-lg shadow-lg sticky top-4 flex flex-col h-[calc(100vh-2rem)]">
          
          {/* Cabecera del Ticket */}
          <div className="p-4 border-b bg-gray-50">
            <h2 className="font-bold text-xl text-gray-800">Ticket Actual</h2>
          </div>
          
          {/* Lista de Items */}
          <div className="p-4 space-y-4 flex-1 overflow-y-auto">
            {cart.length === 0 && (
              <p className="text-gray-400 text-center py-10">
                El carrito est√° vac√≠o.<br/>Seleccion√° productos o servicios.
              </p>
            )}
            
            {cart.map((item, index) => (
              <div key={index} className="flex justify-between items-start border-b pb-3 animate-in fade-in slide-in-from-bottom-2">
                <div className="flex-1">
                  <p className="font-medium text-gray-800">
                    {/* Icono para diferenciar servicios de productos */}
                    {item.type === 'SERVICE' && <span className="mr-1">‚úÇÔ∏è</span>}
                    {item.name}
                  </p>
                  
                  {/* Si es SERVICIO: Input para poner el precio */}
                  {item.type === 'SERVICE' ? (
                     <div className="mt-1 flex items-center gap-2">
                        <span className="text-xs text-gray-500 font-bold">Precio: $</span>
                        <input 
                            type="number" 
                            value={item.price} 
                            onChange={(e) => updateServicePrice(index, e.target.value)}
                            className="w-24 border rounded px-1 py-0.5 text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                            autoFocus
                            placeholder="0.00"
                        />
                     </div>
                  ) : (
                     // Si es PRODUCTO: Cantidad x Precio fijo
                     <p className="text-sm text-gray-500">{item.quantity} x ${item.price}</p>
                  )}
                </div>

                <div className="flex flex-col items-end gap-1">
                    <span className="font-bold text-gray-800">${(item.quantity * item.price).toLocaleString()}</span>
                    <button 
                        onClick={() => removeFromCart(index)}
                        className="text-xs text-red-500 hover:text-red-700 underline"
                    >
                        Quitar
                    </button>
                </div>
              </div>
            ))}
          </div>

          {/* Zona de Totales y Bot√≥n de Cobro */}
          <div className="p-6 bg-slate-900 text-white rounded-b-lg mt-auto">
            <div className="flex justify-between text-2xl font-bold mb-4">
              <span>Total</span>
              <span>${total.toLocaleString()}</span>
            </div>
            <button 
              onClick={handleCheckout}
              disabled={cart.length === 0 || loading}
              className={`w-full py-4 rounded-lg font-bold text-xl transition transform active:scale-95
                ${cart.length === 0 
                    ? 'bg-gray-600 cursor-not-allowed text-gray-400' 
                    : 'bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-900/20'
                }
              `}
            >
              {loading ? "Procesando..." : "COBRAR"}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

--- File: ProductActions.tsx (in subfolder: components) ---

// src/components/ProductActions.tsx
'use client'

import { toggleProductStatus } from "@/actions/product-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"

export default function ProductActions({ id, isActive, stock }: { id: string, isActive: boolean, stock: number }) {
  const router = useRouter()

  const handleToggle = async () => {
    if (isActive && stock > 0) {
        alert("‚ö†Ô∏è No pod√©s archivar un producto con stock.\nHac√© un retiro o ajuste a 0 primero.")
        return
    }

    if (!confirm(isActive ? "¬øArchivar producto?" : "¬øReactivar producto?")) return

    const res = await toggleProductStatus(id, isActive)
    if (res.error) alert(res.error)
    else router.refresh()
  }

  return (
    <div className="flex gap-2">
      {/* Bot√≥n EDITAR (Link simple) */}
      <Link 
        href={`/products/${id}/edit`} 
        className="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold hover:bg-blue-200"
      >
        EDITAR
      </Link>

      {/* Bot√≥n ARCHIVAR/ACTIVAR */}
      <button
        onClick={handleToggle}
        className={`px-3 py-1 rounded text-xs font-bold border transition
          ${isActive 
            ? 'bg-white text-red-600 border-red-200 hover:bg-red-50' 
            : 'bg-green-100 text-green-700 border-transparent hover:bg-green-200'
          }
        `}
      >
        {isActive ? "ARCHIVAR" : "ACTIVAR"}
      </button>
    </div>
  )
}

--- File: ProductForm.tsx (in subfolder: components) ---

// src/components/ProductForm.tsx
'use client'

import { useState } from "react"
import { createProduct, updateProduct } from "@/actions/product-actions" // üëà Importamos update
import ImageUpload from "./ImageUpload"
import { useRouter } from "next/navigation" // Para volver atr√°s despu√©s de editar

type Props = {
  owners: { id: string; name: string }[]
  categories: { id: string; name: string }[]
  // üëá NUEVO: Datos opcionales para edici√≥n
  initialData?: {
    id: string
    name: string
    description: string | null
    ownerId: string
    categoryId: string
    costPrice: number
    salePrice: number
    imageUrl: string | null
  }
}

export default function ProductForm({ owners, categories, initialData }: Props) {
  const router = useRouter()
  const [imageUrl, setImageUrl] = useState(initialData?.imageUrl || "")
  
  // Funci√≥n wrapper para manejar la redirecci√≥n post-guardado si es edici√≥n
  const handleSubmit = async (formData: FormData) => {
    if (initialData) {
        // MODO EDICI√ìN
        formData.append("id", initialData.id) // Agregamos el ID oculto
        await updateProduct(formData)
        alert("Producto actualizado correctamente")
        router.push("/products") // Volver al listado
        router.refresh() // Refrescar datos visuales
    } else {
        // MODO CREACI√ìN
        await createProduct(formData)
        // createProduct ya hace redirect, no hace falta l√≥gica aqu√≠
    }
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto border">
      <h2 className="text-xl font-bold mb-6">
        {initialData ? "Editar Producto" : "Nuevo Producto"}
      </h2>
      
      <form action={handleSubmit} className="space-y-4">
        
        {/* Nombre */}
        <div>
          <label className="block text-sm font-medium text-gray-700">Nombre *</label>
          <input 
            name="name" 
            defaultValue={initialData?.name} // üëà Pre-carga
            type="text" 
            required 
            className="w-full border p-2 rounded" 
          />
        </div>

        {/* Descripci√≥n */}
        <div>
          <label className="block text-sm font-medium text-gray-700">Descripci√≥n</label>
          <textarea 
            name="description" 
            defaultValue={initialData?.description || ""} 
            className="w-full border p-2 rounded" 
            rows={2} 
          />
        </div>

        {/* Selectores */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">Due√±o *</label>
            <select 
              name="ownerId" 
              defaultValue={initialData?.ownerId || ""} 
              required 
              className="w-full border p-2 rounded bg-white"
            >
              <option value="">Seleccionar...</option>
              {owners.map(o => (
                <option key={o.id} value={o.id}>{o.name}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Categor√≠a *</label>
            <select 
              name="categoryId" 
              defaultValue={initialData?.categoryId || ""} 
              required 
              className="w-full border p-2 rounded bg-white"
            >
              <option value="">Seleccionar...</option>
              {categories.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          </div>
        </div>

        {/* Precios */}
        <div className="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded">
          <div>
            <label className="block text-sm font-medium text-gray-700">Costo (Due√±o) *</label>
            <input 
                name="costPrice" 
                defaultValue={initialData?.costPrice} 
                type="number" 
                step="0.01" 
                required 
                className="w-full border p-2 rounded" 
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Precio Venta *</label>
            <input 
                name="salePrice" 
                defaultValue={initialData?.salePrice} 
                type="number" 
                step="0.01" 
                required 
                className="w-full border p-2 rounded" 
            />
          </div>
        </div>

        {/* Imagen */}
        <div className="border-t pt-4">
          {imageUrl && (
            <div className="mb-2">
                <p className="text-xs text-gray-500 mb-1">Imagen Actual:</p>
                <img src={imageUrl} alt="Actual" className="w-20 h-20 object-cover rounded border" />
            </div>
          )}
          <ImageUpload onImageUpload={(url) => setImageUrl(url)} />
          <input type="hidden" name="imageUrl" value={imageUrl} />
        </div>

        <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 font-bold">
          {initialData ? "Actualizar Cambios" : "Guardar Producto"}
        </button>

      </form>
    </div>
  )
}

--- File: SettlementButton.tsx (in subfolder: components) ---

// src/components/SettlementButton.tsx
'use client' // üëà Esto permite usar onClick y hooks

import { useFormStatus } from "react-dom"

export default function SettlementButton() {
  // useFormStatus detecta si la Server Action se est√° ejecutando
  const { pending } = useFormStatus()

  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    // Confirmaci√≥n nativa del navegador
    const confirmed = confirm("¬øEst√°s seguro de que vas a entregar el dinero?\n\nEsta acci√≥n marcar√° los items como PAGADOS y no se puede deshacer f√°cilmente.")
    
    if (!confirmed) {
      e.preventDefault() // Cancela el env√≠o del formulario
    }
  }

  return (
    <button
      type="submit"
      onClick={handleClick}
      disabled={pending}
      className={`
        px-8 py-3 rounded-lg font-bold text-lg shadow-lg transition transform 
        ${pending 
          ? 'bg-gray-400 cursor-not-allowed' 
          : 'bg-green-600 hover:bg-green-700 hover:scale-105 text-white'
        }
      `}
    >
      {pending ? "Procesando..." : "‚úÖ Confirmar Pago"}
    </button>
  )
}

--- File: prisma.ts (in subfolder: lib) ---

// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

--- File: utils.ts (in subfolder: lib) ---

// src/lib/utils.ts

/**
 * Devuelve la fecha actual en formato YYYY-MM-DD respetando la zona horaria local.
 * √ötil para filtrar consultas de base de datos sin errores de UTC.
 */
export function getLocalDateISO() {
  const now = new Date()
  
  // Forzamos zona horaria Argentina (GMT-3)
  const options: Intl.DateTimeFormatOptions = { 
    timeZone: 'America/Argentina/Buenos_Aires',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }
  
  // Usamos Intl nativo de JS (no requiere librer√≠as)
  const formatter = new Intl.DateTimeFormat('es-AR', options)
  const parts = formatter.formatToParts(now)
  
  const year = parts.find(p => p.type === 'year')?.value
  const month = parts.find(p => p.type === 'month')?.value
  const day = parts.find(p => p.type === 'day')?.value
  
  return `${year}-${month}-${day}`
}

/**
 * Devuelve objetos Date de inicio y fin del d√≠a LOCAL
 */
export function getLocalDayRange(dateStr?: string) {
    const targetDate = dateStr || getLocalDateISO()
    
    // Inicio del d√≠a: YYYY-MM-DDT00:00:00
    const start = new Date(`${targetDate}T00:00:00`)
    
    // Fin del d√≠a: YYYY-MM-DDT23:59:59
    const end = new Date(`${targetDate}T23:59:59`)
    
    return { start, end, dateStr: targetDate }
}

