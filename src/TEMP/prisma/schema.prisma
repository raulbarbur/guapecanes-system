// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Usamos PostgreSQL por defecto.
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// ENUMS (Listas de valores fijos)
// ==============================

enum Role {
  ADMIN
  STAFF
}

// Tipos de movimiento de stock para auditoría estricta
enum StockMovementType {
  ENTRY            // Ingreso de mercadería (Suma)
  SALE             // Venta por caja (Resta)
  ADJUSTMENT       // Ajuste manual por rotura/pérdida (Resta o Suma)
  OWNER_WITHDRAWAL // Retiro del dueño (Resta sin venta)
  RETURN           // Devolución de cliente (Suma)
  SALE_CANCELLED   // Anulación de venta (Suma automática)
}

// Estados del turno de peluquería
enum ApptStatus {
  PENDING   // Recién creado
  CONFIRMED // Cliente llegó / Confirmado
  COMPLETED // Servicio terminado
  BILLED    // Ya se cobró en caja
  CANCELLED // Turno cancelado
}

// ==============================
// MODELOS DE SISTEMA
// ==============================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed
  name      String
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
}

// ==============================
// MODELOS DEL NEGOCIO
// ==============================

// 1. Dueños de Mercadería (Consignación)
model Owner {
  id                 String    @id @default(uuid())
  name               String
  phone              String?
  email              String?
  isActive           Boolean   @default(true) 
  createdAt          DateTime  @default(now())
  
  // Relaciones
  products           Product[]
  settlements        Settlement[]
  balanceAdjustments BalanceAdjustment[] 

  // Índices para búsqueda rápida
  @@index([name])
}

// 2. Categorías de Productos
model Category {
  id       String    @id @default(uuid())
  name     String    @unique 
  products Product[]
}

// 3. Productos (Cabecera)
model Product {
  id          String    @id @default(uuid())
  name        String
  description String?
  
  // Relaciones
  ownerId     String
  owner       Owner     @relation(fields: [ownerId], references: [id])
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])
  
  variants    ProductVariant[]
  
  isActive    Boolean   @default(true)

  @@index([name])
  @@index([ownerId])
}

// 4. Variantes (Talle/Color/Precio) - Es lo que realmente se vende
model ProductVariant {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  name      String   // Ej: "Rojo - XL" o "Estándar"
  imageUrl  String?  // URL externa (Cloudinary)
  
  // PRECIOS: Usamos Decimal para exactitud monetaria
  costPrice Decimal  @db.Decimal(10, 2) 
  salePrice Decimal  @db.Decimal(10, 2)
  stock     Int      @default(0)
  
  // Relaciones
  stockMovements StockMovement[]
  saleItems      SaleItem[]

  // Evitar duplicados del mismo nombre dentro del mismo producto
  @@unique([productId, name]) 
}

// 5. Historial de Stock (Kardex)
model StockMovement {
  id          String            @id @default(uuid())
  variantId   String
  variant     ProductVariant    @relation(fields: [variantId], references: [id])
  quantity    Int               // Positivo (entrada) o Negativo (salida)
  type        StockMovementType
  reason      String?
  userId      String            // ID del usuario que hizo la acción
  createdAt   DateTime          @default(now())

  @@index([variantId])
  @@index([createdAt])
}

// 6. Ventas (Cabecera)
model Sale {
  id            String        @id @default(uuid())
  total         Decimal       @db.Decimal(10, 2)
  paymentMethod String        // "CASH", "TRANSFER", etc.
  status        String        @default("COMPLETED") // "COMPLETED" o "CANCELLED"
  createdAt     DateTime      @default(now())
  
  items         SaleItem[]

  @@index([createdAt])
}

// 7. Items de Venta (Detalle)
model SaleItem {
  id            String         @id @default(uuid())
  saleId        String
  sale          Sale           @relation(fields: [saleId], references: [id])
  
  // Puede ser null si vendemos un "Servicio" que no tiene stock
  variantId     String?        
  variant       ProductVariant? @relation(fields: [variantId], references: [id])
  
  description   String         // Guardamos el nombre tal cual se vendió (snapshot)
  quantity      Int
  
  // SNAPSHOT DE PRECIOS: Fundamental para liquidar correctamente aunque cambien los precios después
  costAtSale    Decimal        @db.Decimal(10, 2)
  priceAtSale   Decimal        @db.Decimal(10, 2)
  
  // CONTROL DE LIQUIDACIÓN AL DUEÑO
  isSettled     Boolean        @default(false) // ¿Ya se le pagó al dueño?
  settlementId  String?
  settlement    Settlement?    @relation(fields: [settlementId], references: [id])

  @@index([isSettled])
  @@index([saleId])
}

// 8. Liquidaciones (Pagos a Dueños)
model Settlement {
  id          String   @id @default(uuid())
  ownerId     String
  owner       Owner    @relation(fields: [ownerId], references: [id])
  totalAmount Decimal  @db.Decimal(10, 2) // Total pagado en este recibo
  createdAt   DateTime @default(now())
  
  items       SaleItem[]
  adjustments BalanceAdjustment[]
}

// 9. Ajustes de Saldo (Créditos/Débitos manuales a Dueños)
model BalanceAdjustment {
  id           String      @id @default(uuid())
  ownerId      String
  owner        Owner       @relation(fields: [ownerId], references: [id])
  amount       Decimal     @db.Decimal(10, 2) // Negativo = Dueño debe al local. Positivo = Local debe al dueño.
  description  String
  
  isApplied    Boolean     @default(false) // ¿Ya se descontó/pagó en una liquidación?
  settlementId String?
  settlement   Settlement? @relation(fields: [settlementId], references: [id])
  createdAt    DateTime    @default(now())
}

// ==============================
// MODELOS DE PELUQUERÍA
// ==============================

// 10. Clientes (Mascotas)
model Pet {
  id          String   @id @default(uuid())
  name        String
  ownerName   String   // Texto libre, no relacionado a la tabla Owner
  ownerPhone  String?
  breed       String?
  notes       String?  // Alertas (ej: "Muerde", "Alergia")
  
  appointments Appointment[]
  groomingNotes GroomingNote[]

  @@index([name])
  @@index([ownerName])
}

// 11. Turnos
model Appointment {
  id        String     @id @default(uuid())
  petId     String
  pet       Pet        @relation(fields: [petId], references: [id])
  startTime DateTime
  endTime   DateTime
  status    ApptStatus @default(PENDING)
  
  @@index([startTime])
  @@index([status])
}

// 12. Notas Técnicas (Historial clínico de peluquería)
model GroomingNote {
  id        String   @id @default(uuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id])
  content   String   @db.Text
  createdAt DateTime @default(now())
}