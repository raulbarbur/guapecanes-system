--- File: appointment-actions.ts (in subfolder: actions) ---

// src/actions/appointment-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { buildArgentinaDate } from "@/lib/utils" // üëà Importamos

type ApptStatus = 'PENDING' | 'CONFIRMED' | 'COMPLETED' | 'BILLED' | 'CANCELLED'

export async function createAppointment(formData: FormData) {
  const petId = formData.get("petId") as string
  const dateStr = formData.get("date") as string // "2024-01-20"
  const timeStr = formData.get("time") as string // "14:30"
  const duration = parseInt(formData.get("duration") as string) || 60 

  if (!petId || !dateStr || !timeStr) {
    return { error: "Faltan datos (Mascota, Fecha u Hora)" }
  }

  try {
    // 1. CONSTRUIR FECHAS (Usando utilidad centralizada)
    const startTime = buildArgentinaDate(dateStr, timeStr)
    
    // Calculamos el final
    const endTime = new Date(startTime.getTime() + duration * 60000)

    if (isNaN(startTime.getTime())) {
      return { error: "Fecha u hora inv√°lida" }
    }

    // 2. VALIDAR COLISIONES
    const collision = await prisma.appointment.findFirst({
      where: {
        status: { not: 'CANCELLED' }, 
        AND: [
          { startTime: { lt: endTime } }, 
          { endTime: { gt: startTime } }  
        ]
      },
      include: { pet: true }
    })

    if (collision) {
        // Formateamos para el mensaje de error
        const collisionStart = collision.startTime.toLocaleTimeString('es-AR', {
            hour: '2-digit', minute:'2-digit', timeZone: 'America/Argentina/Buenos_Aires'
        })
        const collisionEnd = collision.endTime.toLocaleTimeString('es-AR', {
            hour: '2-digit', minute:'2-digit', timeZone: 'America/Argentina/Buenos_Aires'
        })

      return { 
        error: `Horario ocupado por ${collision.pet.name} (${collisionStart} - ${collisionEnd})` 
      }
    }

    // 3. GUARDAR TURNO
    await prisma.appointment.create({
      data: {
        petId,
        startTime,
        endTime,
        status: 'PENDING'
      }
    })

    revalidatePath("/agenda")
    revalidatePath("/dashboard")
    return { success: true }

  } catch (error) {
    console.error("Error agendando:", error)
    return { error: "Error interno al crear turno" }
  }
}

export async function cancelAppointment(formData: FormData) {
    const id = formData.get("id") as string
    try {
        await prisma.appointment.update({
            where: { id },
            data: { status: 'CANCELLED' }
        })
        revalidatePath("/agenda")
        revalidatePath("/dashboard")
    } catch (error) {
        console.error(error)
    }
}

export async function updateAppointmentStatus(id: string, newStatus: ApptStatus) {
    try {
        await prisma.appointment.update({
            where: { id },
            data: { status: newStatus }
        })
        revalidatePath("/agenda")
        revalidatePath("/dashboard")
        return { success: true }
    } catch (error) {
        console.error("Error cambiando estado:", error)
        return { error: "No se pudo actualizar el estado" }
    }
}

--- File: bulk-actions.ts (in subfolder: actions) ---

// src/actions/bulk-actions.ts
'use server'

import { prisma } from "@/lib/prisma"

// Definimos qu√© esperamos recibir de cada fila del Excel
type ImportRow = {
  name: string
  categoryName: string
  ownerName: string
  cost: number
  price: number
}

export async function importSingleProduct(data: ImportRow) {
  try {
    // 1. SANITIZACI√ìN Y VALIDACI√ìN PREVIA (Fail Fast)
    if (!data.name || !data.categoryName || !data.ownerName) {
      return { success: false, error: "Datos incompletos: Faltan Nombre, Categor√≠a o Due√±o." }
    }

    // Aseguramos que sean n√∫meros (por si viene texto o vac√≠o del Excel)
    const cost = Number(data.cost)
    const price = Number(data.price)

    if (isNaN(cost) || isNaN(price)) {
      return { success: false, error: "Formato inv√°lido: Costo y Precio deben ser num√©ricos." }
    }

    // 2. REGLAS DE ORO (Validaci√≥n de Negocio)
    if (cost < 0 || price < 0) {
      return { success: false, error: "Error financiero: No se permiten importes negativos." }
    }

    // Regla: Integridad de Rentabilidad (salvo que sea 0 y 0 para carga inicial pendiente)
    if (price < cost) {
      return { success: false, error: `Rentabilidad negativa: Costo ($${cost}) mayor a Venta ($${price}).` }
    }

    // 3. BUSCAR O CREAR CATEGOR√çA
    // Buscamos exacto o insensible a may√∫sculas para evitar duplicados como "Juguetes" y "juguetes"
    let category = await prisma.category.findFirst({
      where: { name: { equals: data.categoryName, mode: 'insensitive' } }
    })

    if (!category) {
      // Si no existe, la creamos (Normalizamos el nombre tal cual viene)
      category = await prisma.category.create({
        data: { name: data.categoryName } 
      })
    }

    // 4. VALIDAR DUE√ëO EXISTENTE
    // Asumimos que el due√±o YA DEBE EXISTIR en la base de datos.
    const owner = await prisma.owner.findFirst({
      where: { name: { equals: data.ownerName, mode: 'insensitive' } }
    })

    if (!owner) {
      return { success: false, error: `Due√±o desconocido: "${data.ownerName}". Crealo antes de importar.` }
    }

    // 5. TRANSACCI√ìN DB (Creaci√≥n del Producto)
    await prisma.$transaction(async (tx) => {
      
      // A. Crear el Producto Padre
      const newProduct = await tx.product.create({
        data: {
          name: data.name,
          categoryId: category.id,
          ownerId: owner.id,
          isActive: true
        }
      })

      // B. Crear la Variante (Hijo)
      await tx.productVariant.create({
        data: {
          productId: newProduct.id,
          name: "Est√°ndar",
          costPrice: cost,
          salePrice: price,
          stock: 0, // Regla: Siempre nace en 0. Se debe hacer Ingreso de Stock despu√©s.
          imageUrl: null 
        }
      })
    })

    return { success: true }

  } catch (error: any) {
    console.error("Error cr√≠tico importando:", error)
    // Devolvemos el mensaje limpio si es posible
    return { success: false, error: error.message || "Error interno del servidor" }
  }
}

--- File: category-actions.ts (in subfolder: actions) ---

// src/actions/category-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createCategory(formData: FormData) {
  const name = formData.get("name") as string

  if (!name) return

  try {
    await prisma.category.create({
      data: { name }
    })
    
    revalidatePath("/categories")
    return { success: true }
  
  } catch (error) {
    // Si el error es porque ya existe (c√≥digo P2002 de Prisma), no hacemos nada
    console.error("Error creando categor√≠a:", error)
    return { success: false, error: "Error al crear (¬øQuiz√°s ya existe?)" }
  }
}

--- File: inventory-actions.ts (in subfolder: actions) ---

// src/actions/inventory-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

// Definimos los tipos permitidos seg√∫n el Schema y la UI
type MovementType = "ENTRY" | "OWNER_WITHDRAWAL" | "ADJUSTMENT"

export async function registerStockMovement(formData: FormData) {
  const variantId = formData.get("variantId") as string
  const reason = formData.get("reason") as string
  const type = formData.get("type") as MovementType
  
  // Convertimos y validamos n√∫mero
  const rawQuantity = parseInt(formData.get("quantity") as string)

  // 1. VALIDACI√ìN PREVIA (Fail Fast)
  if (!variantId || !type) {
    return { error: "Faltan datos obligatorios." }
  }
  
  if (isNaN(rawQuantity) || rawQuantity <= 0) {
    return { error: "La cantidad debe ser un n√∫mero positivo mayor a 0." }
  }

  try {
    // 2. DETERMINAR EL SIGNO DEL MOVIMIENTO
    // ENTRY: Suma (+)
    // OWNER_WITHDRAWAL: Resta (-)
    // ADJUSTMENT: Seg√∫n UI actual es "Baja/Rotura", as√≠ que Resta (-)
    let finalQuantity = rawQuantity
    
    if (type === "OWNER_WITHDRAWAL" || type === "ADJUSTMENT") {
        finalQuantity = -rawQuantity
    }

    // 3. OBTENER VARIANTE ACTUAL (Para validar stock)
    const currentVariant = await prisma.productVariant.findUnique({
        where: { id: variantId },
        include: { product: true }
    })

    if (!currentVariant) return { error: "Producto no encontrado." }

    // 4. VALIDAR STOCK PARA SALIDAS (Regla de Oro)
    // Si el movimiento es negativo, verificamos que no rompa el stock (negativo prohibido)
    if (finalQuantity < 0) {
      const quantityNeeded = Math.abs(finalQuantity)
      if (currentVariant.stock < quantityNeeded) {
        return { 
            error: `Stock insuficiente en "${currentVariant.product.name}". Ten√©s ${currentVariant.stock}, intent√°s sacar ${quantityNeeded}.` 
        }
      }
    }

    // 5. TRANSACCI√ìN AT√ìMICA
    await prisma.$transaction([
      // A. Crear el movimiento hist√≥rico (Auditor√≠a)
      prisma.stockMovement.create({
        data: {
          variantId,
          quantity: finalQuantity, // Guardamos con signo (+ o -)
          type: type, 
          reason: reason || getDefaultReason(type),
          userId: "sistema", 
        }
      }),

      // B. Actualizar el stock actual (Contador)
      prisma.productVariant.update({
        where: { id: variantId },
        data: {
          stock: { increment: finalQuantity } // increment maneja restas si el n√∫mero es negativo
        }
      })
    ])

    // Revalidamos cach√©
    revalidatePath("/products")
    revalidatePath("/inventory")
    revalidatePath("/dashboard")

    return { success: true }

  } catch (error) {
    console.error("Error gestionando stock:", error)
    return { error: "Fall√≥ el movimiento de stock. Intente nuevamente." }
  }
}

// Funci√≥n auxiliar para textos por defecto
function getDefaultReason(type: MovementType): string {
    switch (type) {
        case "ENTRY": return "Ingreso de mercader√≠a"
        case "OWNER_WITHDRAWAL": return "Retiro de due√±o"
        case "ADJUSTMENT": return "Baja por rotura/p√©rdida"
        default: return "Movimiento de stock"
    }
}

--- File: note-actions.ts (in subfolder: actions) ---

// src/actions/note-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createNote(formData: FormData) {
  const petId = formData.get("petId") as string
  const content = formData.get("content") as string

  if (!petId || !content) return

  try {
    await prisma.groomingNote.create({
      data: {
        petId,
        content
      }
    })

    // Revalidamos la ruta din√°mica espec√≠fica de esa mascota
    revalidatePath(`/pets/${petId}`)
    return { success: true }

  } catch (error) {
    console.error("Error creando nota:", error)
    return { error: "Error al guardar la nota" }
  }
}

export async function deleteNote(formData: FormData) {
    const id = formData.get("id") as string
    const petId = formData.get("petId") as string
    
    try {
        await prisma.groomingNote.delete({ where: { id } })
        revalidatePath(`/pets/${petId}`)
    } catch (e) {
        console.error(e)
    }
}

--- File: owner-actions.ts (in subfolder: actions) ---

// src/actions/owner-actions.ts
"use server";

import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";

export async function createOwner(formData: FormData) {
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const phone = formData.get("phone") as string;

  if (!name) return { error: "El nombre es obligatorio" };

  try {
    await prisma.owner.create({
      data: { name, email, phone, isActive: true },
    });
    revalidatePath("/owners");
    return { success: true };
  } catch (error) {
    return { error: "Error creando due√±o" };
  }
}

// üëá NUEVA FUNCI√ìN
export async function updateOwner(formData: FormData) {
  const id = formData.get("id") as string;
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const phone = formData.get("phone") as string;

  if (!id || !name) return { error: "Faltan datos" };

  try {
    await prisma.owner.update({
      where: { id },
      data: { name, email, phone },
    });
    
    revalidatePath("/owners");
    return { success: true };
  } catch (error) {
    console.error(error);
    return { error: "Error actualizando due√±o" };
  }
}

--- File: pet-actions.ts (in subfolder: actions) ---

// src/actions/pet-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createPet(formData: FormData) {
  const name = formData.get("name") as string
  const breed = formData.get("breed") as string
  const ownerName = formData.get("ownerName") as string
  const ownerPhone = formData.get("ownerPhone") as string
  const notes = formData.get("notes") as string

  // Validaci√≥n b√°sica
  if (!name || !ownerName || !ownerPhone) {
    return { error: "Faltan datos obligatorios (Nombre, Due√±o, Tel√©fono)" }
  }

  try {
    await prisma.pet.create({
      data: {
        name,
        breed: breed || "Mestizo",
        ownerName,
        ownerPhone,
        notes
      }
    })

    revalidatePath("/pets")
    return { success: true }

  } catch (error) {
    console.error("Error creando mascota:", error)
    return { error: "Error al guardar la ficha." }
  }
}

export async function deletePet(id: string) {
    try {
        await prisma.pet.delete({ where: { id } })
        revalidatePath("/pets")
        return { success: true }
    } catch (error) {
        return { error: "No se puede eliminar (¬øTiene turnos asignados?)" }
    }
}

--- File: product-actions.ts (in subfolder: actions) ---

// src/actions/product-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createProduct(formData: FormData) {
  // 1. Obtener datos
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const ownerId = formData.get("ownerId") as string
  const categoryId = formData.get("categoryId") as string
  const imageUrl = formData.get("imageUrl") as string 
  
  // Convertir n√∫meros
  const costPrice = parseFloat(formData.get("costPrice") as string)
  const salePrice = parseFloat(formData.get("salePrice") as string)

  // 2. VALIDACIONES DE SISTEMA
  if (!name || !ownerId || !categoryId) {
    return { error: "Faltan datos obligatorios (Nombre, Due√±o o Categor√≠a)" }
  }

  if (isNaN(costPrice) || isNaN(salePrice)) {
    return { error: "Los precios deben ser n√∫meros v√°lidos." }
  }

  // 3. VALIDACIONES DE NEGOCIO (Reglas de Oro)
  if (costPrice < 0 || salePrice < 0) {
    return { error: "Los precios no pueden ser negativos." }
  }

  // Regla: No vender a p√©rdida (salvo excepciones, pero por defecto protegemos)
  if (salePrice < costPrice) {
    return { error: `ERROR DE RENTABILIDAD: Est√°s vendiendo a $${salePrice} algo que cost√≥ $${costPrice}.` }
  }

  try {
    // 4. LA TRANSACCI√ìN
    await prisma.$transaction(async (tx) => {
      // A. Crear Producto
      const newProduct = await tx.product.create({
        data: {
          name,
          description,
          ownerId,
          categoryId,
          isActive: true
        }
      })

      // B. Crear Variante Inicial (Stock 0 siempre)
      await tx.productVariant.create({
        data: {
          productId: newProduct.id,
          name: "Est√°ndar",
          imageUrl: imageUrl || null,
          costPrice: costPrice,
          salePrice: salePrice,
          stock: 0 
        }
      })
    })

    revalidatePath("/products")

  } catch (error) {
    console.error("Error creando producto:", error)
    return { error: "Error interno al guardar el producto." }
  }
  
  // 5. Redirecci√≥n exitosa (fuera del try/catch)
  redirect("/products")
}

export async function updateProduct(formData: FormData) {
  const id = formData.get("id") as string
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const categoryId = formData.get("categoryId") as string
  const ownerId = formData.get("ownerId") as string
  const imageUrl = formData.get("imageUrl") as string
  
  const costPrice = parseFloat(formData.get("costPrice") as string)
  const salePrice = parseFloat(formData.get("salePrice") as string)

  if (!id || !name) return { error: "Datos faltantes" }

  // Validaciones de Negocio tambi√©n al editar
  if (isNaN(costPrice) || isNaN(salePrice)) return { error: "Precios inv√°lidos" }
  if (costPrice < 0 || salePrice < 0) return { error: "Precios negativos no permitidos" }
  if (salePrice < costPrice) return { error: `Rentabilidad negativa: Costo $${costPrice} > Venta $${salePrice}` }

  try {
    await prisma.$transaction(async (tx) => {
      // 1. Actualizar producto base
      await tx.product.update({
        where: { id },
        data: { name, description, categoryId, ownerId }
      })

      // 2. Actualizar precios en la variante
      const variant = await tx.productVariant.findFirst({ where: { productId: id } })
      
      if (variant) {
        await tx.productVariant.update({
          where: { id: variant.id },
          data: {
            costPrice,
            salePrice,
            ...(imageUrl ? { imageUrl } : {}) 
          }
        })
      }
    })

    revalidatePath("/products")
    revalidatePath("/pos") 
    return { success: true }

  } catch (error) {
    console.error("Error actualizando:", error)
    return { error: "No se pudo actualizar el producto" }
  }
}

export async function toggleProductStatus(productId: string, currentStatus: boolean) {
  try {
    // REGLA DE ORO: No archivar si hay stock positivo
    if (currentStatus === true) { 
      const variant = await prisma.productVariant.findFirst({ where: { productId } })
      if (variant && variant.stock > 0) {
        return { error: "No se puede archivar un producto con stock. Hac√© un retiro o ajuste a 0 primero." }
      }
    }

    await prisma.product.update({
      where: { id: productId },
      data: { isActive: !currentStatus }
    })

    revalidatePath("/products")
    revalidatePath("/pos")
    return { success: true }
  } catch (error) {
    return { error: "Error cambiando estado" }
  }
}

--- File: sale-actions.ts (in subfolder: actions) ---

// src/actions/sale-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string
  description: string
  price: number
  quantity: number
}

type PaymentMethod = "CASH" | "TRANSFER"

export async function processSale(
    cart: CartItem[], 
    totalEstimado: number, 
    paymentMethod: PaymentMethod 
) {
  if (cart.length === 0) return { error: "El carrito est√° vac√≠o" }

  try {
    // Variable para guardar la venta creada y devolverla
    let createdSaleId = ""
    let createdDate = new Date()

    await prisma.$transaction(async (tx) => {
      let totalReal = 0
      const saleItemsData = []
      const appointmentIdsToBill: string[] = []

      for (const item of cart) {
        // A. PRODUCTO
        if (item.type === 'PRODUCT') {
            const variant = await tx.productVariant.findUnique({
                where: { id: item.id },
                include: { product: true }
            })

            if (!variant) throw new Error(`Producto no encontrado: ${item.description}`)
            if (variant.stock < item.quantity) throw new Error(`Stock insuficiente: ${variant.product.name}`)

            const subtotal = Number(variant.salePrice) * item.quantity
            totalReal += subtotal

            saleItemsData.push({
                variantId: variant.id,
                description: variant.product.name,
                quantity: item.quantity,
                costAtSale: variant.costPrice,
                priceAtSale: variant.salePrice
            })

            await tx.productVariant.update({
                where: { id: variant.id },
                data: { stock: { decrement: item.quantity } }
            })

            await tx.stockMovement.create({
                data: {
                    variantId: variant.id,
                    quantity: -item.quantity,
                    type: "SALE",
                    reason: "Venta Mostrador",
                    userId: "sistema"
                }
            })
        } 
        // B. SERVICIO
        else if (item.type === 'SERVICE') {
            const subtotal = item.price * item.quantity
            totalReal += subtotal

            saleItemsData.push({
                variantId: null,
                description: item.description,
                quantity: item.quantity,
                costAtSale: 0,
                priceAtSale: item.price
            })

            appointmentIdsToBill.push(item.id)
        }
      }

      // Crear Venta Cabecera
      const sale = await tx.sale.create({
        data: {
          total: totalReal,
          paymentMethod: paymentMethod, 
          status: "COMPLETED",
          items: {
            create: saleItemsData
          }
        }
      })
      
      // Guardamos datos para retornar
      createdSaleId = sale.id
      createdDate = sale.createdAt

      // Actualizar Turnos
      if (appointmentIdsToBill.length > 0) {
        await tx.appointment.updateMany({
            where: { id: { in: appointmentIdsToBill } },
            data: { status: 'BILLED' }
        })
      }
    })

    revalidatePath("/products")
    revalidatePath("/pos")
    revalidatePath("/agenda")
    revalidatePath("/dashboard")
    
    // Retornamos los datos clave
    return { success: true, saleId: createdSaleId, date: createdDate }

  } catch (error: any) {
    console.error("Error en venta:", error)
    return { error: error.message || "Error al procesar venta" }
  }
}

// --- ANULAR VENTA (Sin cambios, pero incluimos el archivo completo por la regla) ---
export async function cancelSale(saleId: string) {
  try {
    await prisma.$transaction(async (tx) => {
      const sale = await tx.sale.findUnique({
        where: { id: saleId },
        include: { items: { include: { variant: { include: { product: true } } } } } 
      })

      if (!sale) throw new Error("Venta no encontrada")
      if (sale.status === 'CANCELLED') throw new Error("Esta venta ya est√° anulada")

      await tx.sale.update({
        where: { id: saleId },
        data: { status: 'CANCELLED' }
      })

      for (const item of sale.items) {
        if (item.variantId && item.variant) {
          await tx.productVariant.update({
            where: { id: item.variantId },
            data: { stock: { increment: item.quantity } }
          })

          await tx.stockMovement.create({
            data: {
              variantId: item.variantId,
              quantity: item.quantity,
              type: 'SALE_CANCELLED',
              reason: `Anulaci√≥n Venta #${sale.id.slice(0, 8)}`,
              userId: 'sistema'
            }
          })

          if (item.isSettled) {
            const amountOwedBack = Number(item.costAtSale) * item.quantity
            await tx.balanceAdjustment.create({
              data: {
                ownerId: item.variant.product.ownerId,
                amount: -amountOwedBack,
                description: `Devoluci√≥n Liq. - Prod: ${item.description}`,
                isApplied: false
              }
            })
          }
        }
      }
    })

    revalidatePath("/sales")
    revalidatePath("/products") 
    revalidatePath("/owners/balance")
    revalidatePath("/dashboard")
    return { success: true }

  } catch (error: any) {
    console.error("Error anulando venta:", error)
    return { error: error.message || "Error al anular venta" }
  }
}

--- File: settlement-actions.ts (in subfolder: actions) ---

// src/actions/settlement-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createSettlement(formData: FormData) {
  const ownerId = formData.get("ownerId") as string
  
  if (!ownerId) return { error: "ID de due√±o requerido" }

  try {
    // 1. Recalcular deuda en el servidor (Fuente de la verdad)
    // No confiamos en lo que diga el frontend, recalculamos aqu√≠.
    const pendingItems = await prisma.saleItem.findMany({
      where: {
        isSettled: false,
        variant: { product: { ownerId: ownerId } }
      }
    })

    const pendingAdjustments = await prisma.balanceAdjustment.findMany({
      where: { ownerId: ownerId, isApplied: false }
    })

    // 2. Sumas
    const debtFromSales = pendingItems.reduce((sum, item) => sum + (Number(item.costAtSale) * item.quantity), 0)
    const debtFromAdj = pendingAdjustments.reduce((sum, adj) => sum + Number(adj.amount), 0)
    
    const totalToPay = debtFromSales + debtFromAdj

    // 3. VALIDACI√ìN DE NEGOCIO (Blindaje)
    // Solo permitimos liquidar si efectivamente le debemos plata al due√±o.
    if (totalToPay <= 0) {
        return { 
            error: `No se puede liquidar. El saldo es $${totalToPay.toLocaleString()}. Solo se registran pagos cuando hay deuda a favor del due√±o.` 
        }
    }

    // 4. TRANSACCI√ìN
    await prisma.$transaction(async (tx) => {
      // A. Crear Recibo
      const newSettlement = await tx.settlement.create({
        data: {
          ownerId,
          totalAmount: totalToPay,
        }
      })

      // B. Marcar items como pagados
      if (pendingItems.length > 0) {
        await tx.saleItem.updateMany({
          where: { id: { in: pendingItems.map(i => i.id) } },
          data: { isSettled: true, settlementId: newSettlement.id }
        })
      }

      // C. Marcar ajustes como aplicados
      if (pendingAdjustments.length > 0) {
        await tx.balanceAdjustment.updateMany({
            where: { id: { in: pendingAdjustments.map(a => a.id) } },
            data: { isApplied: true, settlementId: newSettlement.id }
        })
      }
    })

    revalidatePath("/owners/balance")
    revalidatePath(`/owners/settlement/${ownerId}`)
    revalidatePath(`/owners/${ownerId}`)

    // Nota: No hacemos redirect aqu√≠ para poder retornar el objeto { success: true }
    // El componente cliente (SettlementButton) deber√≠a manejar la navegaci√≥n si lo desea,
    // o simplemente mostrar un √©xito. 
    // Como SettlementButton es un bot√≥n simple dentro de un form action tradicional,
    // haremos un redirect exitoso a la lista general.
    
  } catch (error) {
    console.error("Error en liquidaci√≥n:", error)
    return { error: "Error interno al procesar el pago." }
  }

  // √âxito: Volvemos al balance general
  redirect("/owners/balance")
}

--- File: layout.tsx (in subfolder: app) ---

// src/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import MainNav from "@/components/MainNav";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Guapecanes - Sistema de Gesti√≥n",
  description: "Gesti√≥n de Peluquer√≠a y Consignaci√≥n",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es">
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased bg-gray-50 min-h-screen`}>
        
        {/* CONTENEDOR PRINCIPAL */}
        {/* Mobile: Columna (Contenido arriba, barra abajo) */}
        {/* Desktop (md): Fila (Barra izquierda, contenido derecha) */}
        <div className="flex flex-col md:flex-row min-h-screen">
          
          {/* 1. La Barra de Navegaci√≥n (Se adapta sola por dentro) */}
          <MainNav />

          {/* 2. El √Årea de Contenido */}
          {/* flex-1: Ocupa todo el espacio restante */}
          {/* pb-20: Padding abajo para que en m√≥vil la barra no tape el final de la p√°gina */}
          <main className="flex-1 pb-24 md:pb-0 md:px-0">
            {children}
          </main>

        </div>
      </body>
    </html>
  );
}

--- File: page.tsx (in subfolder: app) ---

import Image from "next/image";

export default function Home() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
        <Image
          className="dark:invert"
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-zinc-50">
            To get started, edit the page.tsx file.
          </h1>
          <p className="max-w-md text-lg leading-8 text-zinc-600 dark:text-zinc-400">
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
          <a
            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className="dark:invert"
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}


--- File: page.tsx (in subfolder: app\agenda) ---

// src/app/agenda/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import AppointmentForm from "@/components/AppointmentForm"
import AppointmentCard from "@/components/AppointmentCard" // üëà Importamos

interface Props {
  searchParams: Promise<{ date?: string }>
}

export default async function AgendaPage({ searchParams }: Props) {
  const { date } = await searchParams
  
  // L√≥gica de fechas
  const todayStr = new Date().toISOString().split('T')[0]
  const selectedDateStr = date || todayStr

  // Rangos de b√∫squeda (Local Day)
  const startOfDay = new Date(`${selectedDateStr}T00:00:00`)
  const endOfDay = new Date(`${selectedDateStr}T23:59:59`)

  // 1. Datos para el Formulario
  const pets = await prisma.pet.findMany({ 
    orderBy: { name: 'asc' },
    select: { id: true, name: true, breed: true }
  })

  // 2. Datos de Turnos
  const appointments = await prisma.appointment.findMany({
    where: {
      startTime: { gte: startOfDay, lte: endOfDay },
      status: { not: 'CANCELLED' }
    },
    include: { pet: true },
    orderBy: { startTime: 'asc' }
  })

  return (
    <div className="p-6 max-w-7xl mx-auto">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 className="text-3xl font-bold text-gray-800">Agenda de Turnos</h1>
            <p className="text-gray-500 text-sm">Organiza el flujo de trabajo diario.</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {/* COLUMNA IZQUIERDA: LISTADO (2/3 de ancho) */}
        <div className="lg:col-span-2 space-y-4">
            
            {/* Barra de Fecha */}
            <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-wrap items-center gap-4 justify-between">
                <div className="flex items-center gap-2">
                    <span className="text-xl">üìÖ</span>
                    <form className="flex gap-2 items-center">
                        <input 
                            type="date" 
                            name="date" 
                            defaultValue={selectedDateStr} 
                            className="border p-2 rounded text-gray-700 font-medium focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                        <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-blue-700">
                            Ir
                        </button>
                    </form>
                </div>
                
                {selectedDateStr !== todayStr && (
                     <Link href="/agenda" className="text-sm font-bold text-blue-600 hover:underline">
                        Volver a Hoy
                     </Link>
                )}
            </div>

            {/* Grilla de Turnos */}
            <div className="space-y-3 min-h-[300px]">
                {appointments.length === 0 ? (
                    <div className="flex flex-col items-center justify-center text-gray-400 py-20 bg-gray-50 rounded-lg border border-dashed">
                        <span className="text-4xl mb-2 opacity-50">üò¥</span>
                        <p>No hay turnos para esta fecha.</p>
                    </div>
                ) : (
                    // Renderizamos cada turno usando el componente nuevo
                    appointments.map(appt => (
                        <AppointmentCard key={appt.id} appt={appt} />
                    ))
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: FORMULARIO (1/3 de ancho) */}
        <div className="lg:col-span-1">
            <div className="sticky top-6">
                <AppointmentForm pets={pets} selectedDate={selectedDateStr} />
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\categories) ---

// src/app/categories/page.tsx
import { createCategory } from "@/actions/category-actions"
import { prisma } from "@/lib/prisma"

export default async function CategoriesPage() {
  const categories = await prisma.category.findMany({
    orderBy: { name: 'asc' } // Orden alfab√©tico
  })

  return (
    <div className="p-10 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Categor√≠as de Productos</h1>

      {/* FORMULARIO */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-10 border">
        <form action={createCategory} className="flex gap-4">
          <input 
            name="name" 
            type="text" 
            required 
            className="border p-2 rounded flex-1" 
            placeholder="Ej: Alimentos, Accesorios..."
          />
          <button 
            type="submit" 
            className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          >
            Agregar
          </button>
        </form>
      </div>

      {/* LISTADO */}
      <div className="grid grid-cols-2 gap-4">
        {categories.map((cat) => (
          <div key={cat.id} className="border p-4 rounded bg-gray-50 flex justify-between items-center">
            <span className="font-semibold">{cat.name}</span>
            <span className="text-xs text-gray-400">ID: {cat.id.slice(0, 8)}...</span>
          </div>
        ))}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\dashboard) ---

// src/app/dashboard/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { getLocalDateISO } from "@/lib/utils"

export default async function DashboardPage() {
  const now = new Date()
  
  const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1)
  const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1)

  const todayStr = getLocalDateISO() 
  const startOfToday = new Date(`${todayStr}T00:00:00`)
  const endOfToday = new Date(`${todayStr}T23:59:59`)

  // Consultas Paralelas
  const [monthSales, todaySales, todayAppointments, lowStockVariants] = await Promise.all([
    // Ventas Mes
    prisma.sale.findMany({
      where: {
        status: "COMPLETED",
        createdAt: { gte: firstDayOfMonth, lt: nextMonth }
      },
      include: { items: true }
    }),
    // Ventas Hoy (Necesitamos saber el paymentMethod)
    prisma.sale.findMany({
      where: {
        status: "COMPLETED",
        createdAt: { gte: startOfToday, lte: endOfToday }
      }
    }),
    // Turnos Hoy
    prisma.appointment.findMany({
      where: {
        startTime: { gte: startOfToday, lte: endOfToday },
        status: { not: 'CANCELLED' }
      },
      include: { pet: true },
      orderBy: { startTime: 'asc' }
    }),
    // Stock Bajo
    prisma.productVariant.findMany({
      where: { stock: { lte: 3 } },
      include: { product: true },
      orderBy: { stock: 'asc' },
      take: 5
    })
  ])

  // C√°lculos Mensuales
  let monthRevenue = 0
  let monthCost = 0
  monthSales.forEach(sale => {
    monthRevenue += Number(sale.total)
    sale.items.forEach(item => { if (item.variantId) monthCost += Number(item.costAtSale) * item.quantity })
  })
  const monthProfit = monthRevenue - monthCost
  const monthMargin = monthRevenue > 0 ? (monthProfit / monthRevenue) * 100 : 0

  // C√°lculos Diarios (Desglose por Medio de Pago)
  const todayStats = {
    total: 0,
    cash: 0,
    digital: 0, // Transfer + Tarjetas
    transactions: todaySales.length
  }

  todaySales.forEach(sale => {
    const amount = Number(sale.total)
    todayStats.total += amount
    if (sale.paymentMethod === 'CASH') {
        todayStats.cash += amount
    } else {
        todayStats.digital += amount
    }
  })

  return (
    <div className="p-8 max-w-7xl mx-auto">
      <h1 className="text-3xl font-bold text-gray-800 mb-2">Tablero de Control</h1>
      
      <p className="text-gray-500 mb-8 capitalize">
        Resumen del {startOfToday.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' })}.
      </p>

      {/* SECCI√ìN 1: CAJA DEL D√çA DETALLADA */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        
        {/* Caja de Hoy (Principal) */}
        <div className="bg-slate-900 text-white p-6 rounded-lg shadow-lg relative overflow-hidden">
            <div className="relative z-10">
                <p className="text-slate-400 text-sm font-bold uppercase tracking-wider">Ventas de Hoy</p>
                <p className="text-4xl font-bold mt-2">${todayStats.total.toLocaleString()}</p>
                <div className="mt-4 flex gap-4 text-sm">
                    <div>
                        <span className="block text-green-400 font-bold">üíµ ${todayStats.cash.toLocaleString()}</span>
                        <span className="text-slate-500 text-xs">Efectivo</span>
                    </div>
                    <div className="border-l border-slate-700 pl-4">
                        <span className="block text-blue-400 font-bold">üí≥ ${todayStats.digital.toLocaleString()}</span>
                        <span className="text-slate-500 text-xs">Digital</span>
                    </div>
                </div>
            </div>
        </div>

        {/* Acumulado Mes */}
        <div className="bg-white p-6 rounded-lg shadow border-l-4 border-blue-600">
            <p className="text-gray-500 text-sm font-bold uppercase">Facturaci√≥n Mes</p>
            <p className="text-3xl font-bold text-gray-800 mt-2">${monthRevenue.toLocaleString()}</p>
            <p className="text-xs text-gray-400 mt-1">
                Ganancia Estimada: <span className="text-green-600 font-bold">${monthProfit.toLocaleString()}</span>
            </p>
        </div>

        {/* Rentabilidad */}
        <div className="bg-white p-6 rounded-lg shadow border-l-4 border-purple-600">
            <p className="text-gray-500 text-sm font-bold uppercase">Margen Promedio</p>
            <p className="text-3xl font-bold text-gray-800 mt-2">{monthMargin.toFixed(1)}%</p>
            <p className="text-xs text-gray-400 mt-1">Sobre ventas totales</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* AGENDA HOY */}
        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 className="font-bold text-lg text-gray-800">üìÖ Agenda de Hoy</h2>
                <Link href="/agenda" className="text-sm text-blue-600 hover:underline">Ver completa ‚Üí</Link>
            </div>
            {todayAppointments.length === 0 ? (
                <div className="p-8 text-center text-gray-400">No hay turnos para hoy.</div>
            ) : (
                <div className="divide-y">
                    {todayAppointments.map(appt => {
                        const time = appt.startTime.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Argentina/Buenos_Aires' })
                        return (
                            <div key={appt.id} className="p-4 flex items-center justify-between hover:bg-gray-50">
                                <div className="flex items-center gap-3">
                                    <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">{time}</span>
                                    <div>
                                        <p className="font-bold text-gray-800">{appt.pet.name}</p>
                                        <p className="text-xs text-gray-500">{appt.pet.breed} - {appt.pet.ownerName}</p>
                                    </div>
                                </div>
                                <div>
                                    {appt.status === 'PENDING' && <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Pendiente</span>}
                                    {appt.status === 'BILLED' && <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Cobrado</span>}
                                    {appt.status === 'COMPLETED' && <span className="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Listo</span>}
                                </div>
                            </div>
                        )
                    })}
                </div>
            )}
        </div>

        {/* ALERTAS STOCK */}
        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-red-50 flex justify-between items-center">
                <h2 className="font-bold text-lg text-red-800">‚ö†Ô∏è Alertas de Stock</h2>
                <Link href="/inventory" className="text-sm text-red-600 hover:underline">Gestionar ‚Üí</Link>
            </div>
            {lowStockVariants.length === 0 ? (
                <div className="p-8 text-center text-gray-400">‚úÖ Inventario saludable.</div>
            ) : (
                <div className="divide-y">
                    {lowStockVariants.map(v => (
                        <div key={v.id} className="p-4 flex items-center justify-between hover:bg-red-50 transition">
                            <div className="flex items-center gap-3">
                                <div className="text-2xl">üì¶</div>
                                <div>
                                    <p className="font-bold text-gray-800">{v.product.name}</p>
                                    <p className="text-xs text-gray-500">Var: {v.name}</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className={`text-xl font-bold ${v.stock === 0 ? 'text-red-600' : 'text-orange-500'}`}>{v.stock}</p>
                                <p className="text-[10px] text-gray-400 uppercase font-bold">Unidades</p>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\inventory) ---

// src/app/inventory/page.tsx
import { prisma } from "@/lib/prisma"
import StockMovementForm from "@/components/StockMovementForm"
import Link from "next/link"

export default async function InventoryPage() {
  // Buscamos datos para el selector
  const products = await prisma.product.findMany({
    where: { isActive: true }, // Solo productos activos
    include: { variants: true, owner: true },
    orderBy: { name: 'asc' }
  })

  // Mapeamos a una estructura simple para pasar al Client Component
  const productOptions = products.map(p => ({
    variantId: p.variants[0].id,
    productName: p.name,
    ownerName: p.owner.name,
    stock: p.variants[0].stock
  }))

  return (
    <div className="p-8 max-w-2xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">Control de Stock</h1>
        <Link href="/products" className="text-blue-600 hover:underline text-sm font-bold">
            ‚Üê Volver a Lista
        </Link>
      </div>

      <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        {/* Renderizamos el formulario interactivo */}
        <StockMovementForm products={productOptions} />
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners) ---

// src/app/owners/page.tsx
import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm" 
import SearchInput from "@/components/SearchInput" 
import Link from "next/link"

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function OwnersPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  const owners = await prisma.owner.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { email: { contains: query, mode: 'insensitive' } },
            { phone: { contains: query, mode: 'insensitive' } }
        ]
    } : undefined,
    orderBy: { createdAt: 'desc' }
  })

  return (
    <div className="p-10 max-w-6xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-gray-800">Gesti√≥n de Due√±os</h1>
      </div>

      <div className="mb-8 max-w-md">
        <SearchInput placeholder="Buscar por nombre, mail o tel√©fono..." />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO ALTA */}
        <div className="md:col-span-1">
            <div className="sticky top-6">
                <OwnerForm /> 
            </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="md:col-span-2 grid gap-4">
            {owners.map((owner) => (
            <div key={owner.id} className="border p-4 rounded-lg bg-white shadow-sm hover:shadow-md transition flex justify-between items-center group">
                {/* Click en toda el √°rea (excepto botones) lleva al perfil */}
                <Link href={`/owners/${owner.id}`} className="flex-1 cursor-pointer">
                    <div className="flex items-center gap-2">
                        <p className="font-bold text-lg text-gray-800 group-hover:text-blue-600 transition">
                            {owner.name}
                        </p>
                        {owner.isActive ? (
                            <span className="w-2 h-2 rounded-full bg-green-500" title="Activo"></span>
                        ) : (
                            <span className="w-2 h-2 rounded-full bg-red-500" title="Inactivo"></span>
                        )}
                    </div>
                    <p className="text-gray-500 text-sm mt-1">
                        üìß {owner.email || "Sin email"}
                    </p>
                    <p className="text-gray-500 text-sm">
                        üìû {owner.phone || "Sin tel√©fono"}
                    </p>
                </Link>
                
                {/* BOT√ìN PERFIL */}
                <div className="flex gap-2">
                    <Link 
                        href={`/owners/${owner.id}`}
                        className="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-black transition"
                    >
                        PERFIL
                    </Link>
                </div>
            </div>
            ))}
            
            {owners.length === 0 && (
            <div className="p-10 text-center text-gray-400 border-2 border-dashed rounded-lg bg-gray-50">
                {query ? "No se encontraron due√±os." : "No hay due√±os registrados."}
            </div>
            )}
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\balance) ---

// src/app/owners/balance/page.tsx
import { prisma } from "@/lib/prisma";
import Link from "next/link";

export default async function OwnersBalancePage() {
  // 1. LA CONSULTA MAESTRA ACTUALIZADA
  // Buscamos due√±os, sus ventas pendientes Y sus ajustes pendientes
  const ownersData = await prisma.owner.findMany({
    where: { isActive: true },
    include: {
      // A. Ventas pendientes (Deuda del Local -> Due√±o)
      products: {
        include: {
          variants: {
            include: {
              saleItems: {
                where: { isSettled: false },
              },
            },
          },
        },
      },
      // B. Ajustes pendientes (Deuda del Due√±o -> Local, usualmente negativo)
      balanceAdjustments: {
        where: { isApplied: false }
      }
    },
  });

  // 2. PROCESAMIENTO DE DATOS
  const report = ownersData.map((owner) => {
    let debtFromSales = 0;
    let debtFromAdjustments = 0;
    let itemsCount = 0;

    // A. Sumar deuda por ventas (Mercader√≠a vendida y no pagada)
    owner.products.forEach((product) => {
      product.variants.forEach((variant) => {
        variant.saleItems.forEach((item) => {
          debtFromSales += Number(item.costAtSale) * item.quantity;
          itemsCount += item.quantity;
        });
      });
    });

    // B. Sumar deuda por ajustes (Devoluciones de ventas ya pagadas)
    owner.balanceAdjustments.forEach(adjustment => {
      debtFromAdjustments += Number(adjustment.amount);
    });

    // C. Deuda Neta Total (Suma algebraica)
    // Ejemplo: Ventas ($1000) + Devoluci√≥n (-$200) = Total a Pagar ($800)
    const totalDebt = debtFromSales + debtFromAdjustments;

    return {
      ownerId: owner.id,
      name: owner.name,
      phone: owner.phone,
      totalDebt,
      itemsCount,
      hasAdjustments: owner.balanceAdjustments.length > 0
    };
  });

  // Filtramos: Mostramos si hay deuda O si hay saldo a favor del local (deuda negativa)
  const ownersWithActivity = report
    .filter((r) => r.totalDebt !== 0)
    .sort((a, b) => b.totalDebt - a.totalDebt);

  const ownersClean = report.filter((r) => r.totalDebt === 0);

  return (
    <div className="p-10 max-w-5xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">
          Estado de Cuenta
        </h1>
        <div className="bg-slate-800 text-white px-6 py-3 rounded-lg font-bold shadow-lg">
          Total a Pagar: $
          {report.reduce((sum, r) => sum + r.totalDebt, 0).toLocaleString()}
        </div>
      </div>

      {/* TABLA DE DEUDAS */}
      <div className="bg-white rounded-lg shadow overflow-hidden border mb-10">
        <table className="w-full text-left">
          <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold border-b">
            <tr>
              <th className="p-4">Due√±o</th>
              <th className="p-4 text-center">Items Pend.</th>
              <th className="p-4 text-right">Saldo Neto</th>
              <th className="p-4 text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {ownersWithActivity.map((row) => (
              <tr key={row.ownerId} className="hover:bg-blue-50 transition">
                <td className="p-4">
                  <p className="font-bold text-lg text-gray-800">{row.name}</p>
                  <p className="text-xs text-gray-500">
                    {row.phone || "Sin tel√©fono"}
                  </p>
                  {row.hasAdjustments && (
                    <span className="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded border border-yellow-200 inline-block mt-1">
                      ‚ö†Ô∏è Incluye ajustes/devoluciones
                    </span>
                  )}
                </td>
                
                <td className="p-4 text-center font-mono text-lg text-gray-600">
                  {row.itemsCount}
                </td>
                
                <td className="p-4 text-right">
                  <span className={`text-xl font-bold ${row.totalDebt >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                    ${row.totalDebt.toLocaleString()}
                  </span>
                  {row.totalDebt < 0 && (
                     <p className="text-xs text-green-600 font-bold">Saldo a favor Local</p>
                  )}
                </td>
                
                <td className="p-4 text-center">
                  <Link
                    href={`/owners/settlement/${row.ownerId}`}
                    className="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700 shadow inline-block font-medium"
                  >
                    Ver Detalle
                  </Link>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {ownersWithActivity.length === 0 && (
          <div className="p-10 text-center text-gray-500 text-lg">
            ‚úÖ ¬°Todo al d√≠a! No hay saldos pendientes.
          </div>
        )}
      </div>

      {/* DUE√ëOS AL D√çA */}
      {ownersClean.length > 0 && (
        <details className="mt-8">
          <summary className="cursor-pointer text-gray-500 font-medium hover:text-gray-700 select-none">
            Ver due√±os sin saldo pendiente ({ownersClean.length})
          </summary>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 opacity-75">
            {ownersClean.map((o) => (
              <div
                key={o.ownerId}
                className="border p-3 rounded bg-gray-50 text-sm flex justify-between"
              >
                <span>{o.name}</span>
                <span className="text-green-600 font-bold">‚úì</span>
              </div>
            ))}
          </div>
        </details>
      )}
    </div>
  );
}

--- File: page.tsx (in subfolder: app\owners\settlement\[id]) ---

// src/app/owners/settlement/[id]/page.tsx

import { prisma } from "@/lib/prisma"
import { createSettlement } from "@/actions/settlement-actions"
import Link from "next/link"
import SettlementButton from "@/components/SettlementButton"

interface Props {
  params: Promise<{ id: string }>
}

export default async function SettlementPage({ params }: Props) {
  const { id } = await params
  
  // 1. Buscamos al due√±o, sus ventas pendientes Y sus ajustes pendientes
  const owner = await prisma.owner.findUnique({
    where: { id },
    include: {
      // A. Ventas
      products: {
        include: {
          variants: {
            include: {
              saleItems: {
                where: { isSettled: false },
                include: { sale: true }
              }
            }
          }
        }
      },
      // B. Ajustes
      balanceAdjustments: {
        where: { isApplied: false }
      }
    }
  })

  if (!owner) {
    return (
      <div className="p-10 text-center">
        <h1 className="text-xl text-red-600">Due√±o no encontrado</h1>
        <Link href="/owners/balance" className="text-blue-500 underline">Volver</Link>
      </div>
    )
  }

  // 2. Unificar listas (Ventas + Ajustes) para la tabla
  let totalToPay = 0
  const detailRows: any[] = []

  // Procesar Ventas
  owner.products.forEach(p => {
    p.variants.forEach(v => {
      v.saleItems.forEach(item => {
        const subtotal = Number(item.costAtSale) * item.quantity
        totalToPay += subtotal
        
        detailRows.push({
          id: item.id,
          type: 'SALE',
          date: item.sale.createdAt,
          description: `${item.description} (${item.quantity} u.)`,
          amount: subtotal
        })
      })
    })
  })

  // Procesar Ajustes
  owner.balanceAdjustments.forEach(adj => {
    const amount = Number(adj.amount)
    totalToPay += amount
    
    detailRows.push({
      id: adj.id,
      type: 'ADJUSTMENT',
      date: adj.createdAt,
      description: adj.description, // Ej: "Devoluci√≥n Venta..."
      amount: amount
    })
  })

  // Ordenar cronol√≥gicamente
  detailRows.sort((a, b) => a.date.getTime() - b.date.getTime())

  return (
    <div className="p-8 max-w-4xl mx-auto">
      
      {/* CABECERA */}
      <div className="mb-8">
        <Link href="/owners/balance" className="text-blue-600 hover:underline mb-4 block">
          ‚Üê Volver al Balance General
        </Link>
        <h1 className="text-3xl font-bold text-gray-800">
          Liquidaci√≥n: {owner.name}
        </h1>
        <p className="text-gray-500">Revis√° el detalle antes de pagar.</p>
      </div>

      {/* CAJA DE RESUMEN Y ACCI√ìN */}
      <div className="bg-gray-50 p-6 rounded-lg border flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 shadow-sm">
        <div>
            <p className="text-sm text-gray-500 uppercase font-bold">Total Neto a Pagar</p>
            <p className={`text-4xl font-bold ${totalToPay >= 0 ? 'text-gray-800' : 'text-green-600'}`}>
                ${totalToPay.toLocaleString()}
            </p>
            {totalToPay < 0 && <span className="text-xs text-green-600 font-bold">Saldo a favor del local</span>}
        </div>
        
        {/* Solo mostramos el bot√≥n si hay algo que mover (positivo o negativo) */}
        {detailRows.length > 0 ? (
          <form action={createSettlement}>
            <input type="hidden" name="ownerId" value={owner.id} />
            <SettlementButton />
          </form>
        ) : (
          <div className="bg-green-100 text-green-800 px-4 py-2 rounded font-bold">
             DUE√ëO AL D√çA
          </div>
        )}
      </div>

      {/* TABLA DE DETALLE */}
      <div className="bg-white rounded shadow overflow-hidden border">
        <table className="w-full text-left text-sm">
          <thead className="bg-gray-100 text-gray-700 uppercase">
            <tr>
              <th className="p-3">Fecha</th>
              <th className="p-3">Concepto</th>
              <th className="p-3 text-right">Monto</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {detailRows.map(row => (
              <tr key={row.id} className="hover:bg-gray-50">
                <td className="p-3 text-gray-500">
                    {row.date.toLocaleDateString()}
                </td>
                
                <td className="p-3 font-medium text-gray-800">
                    {/* Iconos visuales para distinguir */}
                    {row.type === 'SALE' ? (
                        <span className="text-blue-600 mr-2">üõí</span> 
                    ) : (
                        <span className="text-orange-500 mr-2">‚Ü©Ô∏è</span>
                    )}
                    {row.description}
                </td>
                
                <td className={`p-3 text-right font-bold ${row.amount < 0 ? 'text-green-600' : 'text-gray-800'}`}>
                    {/* Formato de moneda */}
                    {row.amount < 0 ? '' : ''}${row.amount.toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        
        {detailRows.length === 0 && (
            <div className="p-10 text-center text-gray-400">
                Este due√±o no tiene movimientos pendientes.
            </div>
        )}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\[id]) ---

// src/app/owners/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { notFound } from "next/navigation"

interface Props {
  params: Promise<{ id: string }>
}

export default async function OwnerProfilePage({ params }: Props) {
  const { id } = await params

  // 1. Buscamos TODOS los datos del due√±o
  const owner = await prisma.owner.findUnique({
    where: { id },
    include: {
      // A. Sus productos y stock actual
      products: {
        where: { isActive: true },
        include: { variants: true }
      },
      // B. Historial de Pagos (Liquidaciones pasadas)
      settlements: {
        orderBy: { createdAt: 'desc' },
        take: 20 // √öltimos 20 pagos
      },
      // C. Deuda Pendiente (C√°lculo en vivo)
      balanceAdjustments: { where: { isApplied: false } }
    }
  })

  if (!owner) return notFound()

  // 2. C√ÅLCULOS EN MEMORIA
  
  // A. Inventario en consignaci√≥n (Stock > 0)
  const activeInventory = owner.products.flatMap(p => 
    p.variants.filter(v => v.stock > 0).map(v => ({
      name: p.name, // Variante podr√≠a tener nombre propio si quisieras
      price: v.salePrice,
      cost: v.costPrice,
      stock: v.stock,
      image: v.imageUrl
    }))
  )

  // B. Calcular Deuda Pendiente (Similar a la p√°gina de Balance)
  // Necesitamos buscar los items vendidos NO pagados. 
  // Nota: Hacemos esta query aparte para no traer TODAS las ventas hist√≥ricas en el include principal.
  const pendingItems = await prisma.saleItem.findMany({
    where: {
      isSettled: false,
      variant: { product: { ownerId: id } }
    }
  })

  const debtFromSales = pendingItems.reduce((sum, item) => sum + (Number(item.costAtSale) * item.quantity), 0)
  const debtFromAdj = owner.balanceAdjustments.reduce((sum, adj) => sum + Number(adj.amount), 0)
  const totalDebt = debtFromSales + debtFromAdj

  return (
    <div className="p-8 max-w-6xl mx-auto">
      
      {/* HEADER / TARJETA DE PERFIL */}
      <div className="flex flex-col md:flex-row justify-between items-start gap-6 mb-8">
        <div>
            <Link href="/owners" className="text-sm text-blue-600 hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-bold text-gray-800 flex items-center gap-3">
                {owner.name}
                {!owner.isActive && <span className="text-sm bg-red-100 text-red-600 px-2 py-1 rounded">INACTIVO</span>}
            </h1>
            <div className="mt-2 text-gray-600 space-y-1">
                <p>üìß {owner.email || "Sin email"}</p>
                <p>üìû {owner.phone || "Sin tel√©fono"}</p>
            </div>
            <div className="mt-4">
                <Link 
                    href={`/owners/${owner.id}/edit`}
                    className="text-xs font-bold bg-gray-100 text-gray-600 px-3 py-1.5 rounded border hover:bg-gray-200"
                >
                    ‚úèÔ∏è EDITAR DATOS
                </Link>
            </div>
        </div>

        {/* CAJA DE ESTADO DE CUENTA */}
        <div className={`p-6 rounded-lg shadow-lg border text-white min-w-[300px]
            ${totalDebt > 0 ? 'bg-slate-800' : 'bg-green-600'}
        `}>
            <p className="text-xs font-bold uppercase opacity-80 mb-1">Saldo Pendiente</p>
            <p className="text-4xl font-bold mb-4">${totalDebt.toLocaleString()}</p>
            
            {totalDebt !== 0 ? (
                <Link 
                    href={`/owners/settlement/${owner.id}`}
                    className="block text-center bg-white text-gray-900 font-bold py-2 rounded shadow hover:bg-gray-100 transition"
                >
                    {totalDebt > 0 ? "üí∏ LIQUIDAR (PAGAR)" : "‚öñÔ∏è AJUSTAR SALDO"}
                </Link>
            ) : (
                <div className="flex items-center gap-2 text-sm font-bold bg-white/20 p-2 rounded">
                    <span>‚úÖ</span> Todo al d√≠a
                </div>
            )}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* COLUMNA IZQUIERDA: INVENTARIO ACTUAL */}
        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 className="font-bold text-lg text-gray-800">üì¶ En Stock ({activeInventory.length})</h2>
                <span className="text-xs text-gray-500">Mercader√≠a en el local</span>
            </div>
            
            <div className="max-h-[400px] overflow-y-auto divide-y">
                {activeInventory.length === 0 ? (
                    <div className="p-8 text-center text-gray-400">Este due√±o no tiene productos activos.</div>
                ) : (
                    activeInventory.map((item, idx) => (
                        <div key={idx} className="p-3 flex justify-between items-center hover:bg-gray-50">
                            <div className="flex items-center gap-3">
                                {item.image ? (
                                    <img src={item.image} className="w-10 h-10 rounded object-cover border" />
                                ) : (
                                    <div className="w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-[8px]">FOTO</div>
                                )}
                                <div>
                                    <p className="font-bold text-sm text-gray-800">{item.name}</p>
                                    <p className="text-xs text-gray-500">Stock: {item.stock} u.</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="font-bold text-gray-800 text-sm">${item.price}</p>
                                <p className="text-[10px] text-green-600">Costo: ${item.cost}</p>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE PAGOS */}
        <div className="bg-white rounded-lg shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50">
                <h2 className="font-bold text-lg text-gray-800">üìú Historial de Pagos</h2>
            </div>
            
            <div className="max-h-[400px] overflow-y-auto divide-y">
                {owner.settlements.length === 0 ? (
                    <div className="p-8 text-center text-gray-400">Nunca se le ha pagado.</div>
                ) : (
                    owner.settlements.map(settlement => (
                        <div key={settlement.id} className="p-4 flex justify-between items-center hover:bg-gray-50">
                            <div>
                                <p className="font-bold text-gray-800">
                                    {settlement.createdAt.toLocaleDateString()}
                                </p>
                                <p className="text-xs text-gray-400 font-mono">
                                    ID: {settlement.id.slice(0, 8)}...
                                </p>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-lg font-bold text-green-700">
                                    ${Number(settlement.totalAmount).toLocaleString()}
                                </span>
                                {/* Futuro: Link al detalle del recibo */}
                                {/* <Link href={`/settlements/${settlement.id}`} className="...">üìÑ</Link> */}
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\[id]\edit) ---

// src/app/owners/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditOwnerPage({ params }: Props) {
  const { id } = await params

  const owner = await prisma.owner.findUnique({
    where: { id }
  })

  if (!owner) return <div>Due√±o no encontrado</div>

  return (
    <div className="p-10 max-w-lg mx-auto">
      <Link href="/owners" className="text-blue-500 mb-4 block hover:underline">‚Üê Volver al listado</Link>
      
      {/* Reutilizamos el formulario pas√°ndole los datos */}
      <OwnerForm initialData={owner} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets) ---

// src/app/pets/page.tsx
import { prisma } from "@/lib/prisma"
import { createPet, deletePet } from "@/actions/pet-actions"
import Link from "next/link"
import SearchInput from "@/components/SearchInput" // üëà Importamos

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function PetsPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  // FILTRO
  const pets = await prisma.pet.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { ownerName: { contains: query, mode: 'insensitive' } },
            { breed: { contains: query, mode: 'insensitive' } }
        ]
    } : undefined,
    orderBy: { name: 'asc' }
  })

  // Action para borrar (inline por simplicidad)
  async function handleDelete(formData: FormData) {
    'use server'
    const id = formData.get("id") as string
    await deletePet(id)
  }

  return (
    <div className="p-8 max-w-6xl mx-auto">
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 className="text-3xl font-bold text-gray-800">Clientes (Mascotas)</h1>
      </div>

      {/* BUSCADOR */}
      <div className="mb-8 max-w-md">
         <SearchInput placeholder="Buscar por mascota, due√±o o raza..." />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO */}
        <div className="lg:col-span-1">
          <div className="bg-white p-6 rounded-lg shadow border sticky top-24">
            <h2 className="text-xl font-bold mb-4">Nueva Ficha</h2>
            <form action={createPet} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">Nombre Mascota *</label>
                <input name="name" type="text" required placeholder="Ej: Bobby" className="w-full border p-2 rounded"/>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Raza</label>
                <input name="breed" type="text" placeholder="Ej: Caniche" className="w-full border p-2 rounded"/>
              </div>
              <div className="pt-2 border-t">
                <p className="text-xs text-gray-400 mb-2 uppercase font-bold">Datos del Due√±o</p>
                <div className="mb-2">
                    <label className="block text-sm font-medium text-gray-700">Nombre Humano *</label>
                    <input name="ownerName" type="text" required placeholder="Ej: Maria Perez" className="w-full border p-2 rounded"/>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Tel√©fono / WhatsApp *</label>
                    <input name="ownerPhone" type="text" required placeholder="Ej: 11 1234 5678" className="w-full border p-2 rounded"/>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Notas Generales</label>
                <textarea name="notes" rows={2} className="w-full border p-2 rounded" placeholder="Ej: Al√©rgico al pollo"></textarea>
              </div>
              <button type="submit" className="w-full bg-purple-600 text-white py-3 rounded hover:bg-purple-700 font-bold">
                Guardar Ficha
              </button>
            </form>
          </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="lg:col-span-2">
          <div className="grid gap-4">
            {pets.map((pet) => (
              <div key={pet.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-start hover:shadow-md transition">
                <div>
                  <div className="flex items-center gap-2">
                    <h3 className="text-lg font-bold text-gray-800">{pet.name}</h3>
                    <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">{pet.breed}</span>
                  </div>
                  <div className="mt-1 text-sm text-gray-600">
                    <span className="font-semibold">Due√±o:</span> {pet.ownerName} 
                    <span className="mx-2 text-gray-300">|</span>
                    <span className="text-green-600 font-mono">üìû {pet.ownerPhone}</span>
                  </div>
                  {pet.notes && (
                    <p className="mt-2 text-xs text-gray-500 italic bg-yellow-50 p-2 rounded border border-yellow-100 inline-block">
                      ‚ö†Ô∏è {pet.notes}
                    </p>
                  )}
                </div>
                <div className="flex flex-col gap-2 items-end">
                    <Link href={`/pets/${pet.id}`} className="bg-purple-100 text-purple-700 text-xs font-bold px-3 py-1.5 rounded hover:bg-purple-200 border border-purple-200">
                        VER FICHA
                    </Link>
                    <form action={handleDelete}>
                        <input type="hidden" name="id" value={pet.id} />
                        <button type="submit" className="text-red-300 hover:text-red-500 text-[10px] font-bold px-2 py-1 hover:underline">
                            ELIMINAR
                        </button>
                    </form>
                </div>
              </div>
            ))}

            {pets.length === 0 && (
              <div className="text-center py-10 text-gray-400 bg-gray-50 rounded border border-dashed">
                {query ? "No encontr√© mascotas con ese nombre." : "No hay mascotas registradas."}
              </div>
            )}
          </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets\[id]) ---

// src/app/pets/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import { createNote, deleteNote } from "@/actions/note-actions"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function PetDetailPage({ params }: Props) {
  const { id } = await params

  // 1. Buscamos la Mascota con TODO su historial (Turnos y Notas)
  const pet = await prisma.pet.findUnique({
    where: { id },
    include: {
      appointments: {
        orderBy: { startTime: 'desc' } // Los m√°s recientes primero
      },
      groomingNotes: {
        orderBy: { createdAt: 'desc' }
      }
    }
  })

  if (!pet) return <div className="p-10">Mascota no encontrada</div>

  return (
    <div className="p-8 max-w-6xl mx-auto">
      
      {/* CABECERA DE PERFIL */}
      <div className="mb-8 flex items-center justify-between">
        <div>
            <Link href="/pets" className="text-sm text-blue-600 hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-bold text-gray-800 flex items-center gap-3">
                {pet.name}
                <span className="text-lg font-normal bg-gray-100 text-gray-600 px-3 py-1 rounded-full border">
                    {pet.breed || "Mestizo"}
                </span>
            </h1>
            <div className="mt-2 text-gray-600 flex gap-4 text-sm">
                <p>üë§ Due√±o: <strong>{pet.ownerName}</strong></p>
                <p>üìû Tel: <strong>{pet.ownerPhone}</strong></p>
            </div>
            {pet.notes && (
                <p className="mt-3 text-red-600 bg-red-50 p-2 rounded border border-red-100 inline-block text-sm font-bold">
                    ‚ö†Ô∏è Alerta: {pet.notes}
                </p>
            )}
        </div>
        
        <div className="text-right">
             <div className="bg-slate-800 text-white px-6 py-4 rounded-lg text-center">
                <p className="text-xs uppercase opacity-70">Turnos Totales</p>
                <p className="text-3xl font-bold">{pet.appointments.length}</p>
             </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: NUEVA NOTA + HISTORIAL T√âCNICO */}
        <div className="lg:col-span-2 space-y-8">
            
            {/* Formulario Agregar Nota */}
            <div className="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                <h2 className="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                    üìù Nueva Nota T√©cnica
                </h2>
                <form action={createNote}>
                    <input type="hidden" name="petId" value={pet.id} />
                    <textarea 
                        name="content" 
                        required
                        rows={3} 
                        className="w-full p-3 border rounded bg-white focus:ring-2 focus:ring-yellow-400 outline-none"
                        placeholder="Ej: Corte con alza 4, se port√≥ bien, usar shampoo hipoalerg√©nico..."
                    ></textarea>
                    <div className="mt-2 text-right">
                        <button className="bg-yellow-600 text-white px-4 py-2 rounded font-bold hover:bg-yellow-700">
                            Guardar Nota
                        </button>
                    </div>
                </form>
            </div>

            {/* Listado de Notas */}
            <div>
                <h3 className="text-xl font-bold mb-4 text-gray-800">Historial T√©cnico</h3>
                {pet.groomingNotes.length === 0 ? (
                    <p className="text-gray-400 italic">No hay notas guardadas.</p>
                ) : (
                    <div className="space-y-4">
                        {pet.groomingNotes.map(note => (
                            <div key={note.id} className="bg-white p-4 rounded shadow-sm border border-l-4 border-l-yellow-400 group">
                                <div className="flex justify-between items-start">
                                    <p className="text-gray-800 whitespace-pre-wrap">{note.content}</p>
                                    <form action={deleteNote}>
                                        <input type="hidden" name="id" value={note.id} />
                                        <input type="hidden" name="petId" value={pet.id} />
                                        <button className="text-gray-300 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100 transition">
                                            Borrar
                                        </button>
                                    </form>
                                </div>
                                <p className="text-xs text-gray-400 mt-2 text-right">
                                    {note.createdAt.toLocaleDateString()} a las {note.createdAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE TURNOS */}
        <div className="lg:col-span-1">
            <h3 className="text-xl font-bold mb-4 text-gray-800">Historial de Visitas</h3>
            <div className="bg-white rounded-lg shadow border overflow-hidden">
                {pet.appointments.length === 0 ? (
                    <div className="p-8 text-center text-gray-400">Sin visitas a√∫n.</div>
                ) : (
                    <div className="divide-y">
                        {pet.appointments.map(appt => (
                            <div key={appt.id} className="p-4 hover:bg-gray-50">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold text-gray-700">
                                        {appt.startTime.toLocaleDateString()}
                                    </span>
                                    <span className={`text-[10px] px-2 py-0.5 rounded font-bold border 
                                        ${appt.status === 'COMPLETED' || appt.status === 'BILLED' 
                                            ? 'bg-green-100 text-green-700 border-green-200' 
                                            : appt.status === 'CANCELLED' 
                                                ? 'bg-red-50 text-red-500 border-red-100'
                                                : 'bg-blue-50 text-blue-600 border-blue-100'}
                                    `}>
                                        {appt.status === 'BILLED' ? 'COBRADO' : appt.status}
                                    </span>
                                </div>
                                <p className="text-sm text-gray-500">
                                    Hora: {appt.startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pos) ---

// src/app/pos/page.tsx
import { prisma } from "@/lib/prisma"
import PosSystem from "@/components/PosSystem"

export default async function PosPage() {
  // Buscamos productos activos
  const products = await prisma.product.findMany({
    where: { isActive: true },
    include: { 
        variants: true, 
        owner: true,
        category: true // üëà Agregamos esto
    }
  })

  // Transformamos los datos para el Frontend
  const simpleProducts = products.map(p => {
    const v = p.variants[0] // Asumimos variante √∫nica
    return {
      id: v.id,
      name: p.name,
      price: Number(v.salePrice),
      stock: v.stock,
      imageUrl: v.imageUrl,
      ownerName: p.owner.name,
      categoryName: p.category.name // üëà Dato clave para el filtro
    }
  })

  return (
    <div className="h-screen flex flex-col p-4 bg-gray-50">
      <header className="mb-4 flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
            üõí Punto de Venta
        </h1>
        <div className="text-sm font-bold bg-white px-3 py-1 rounded border shadow-sm text-gray-500">
            Caja Principal
        </div>
      </header>
      
      {/* Cargamos el sistema interactivo */}
      <PosSystem products={simpleProducts} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products) ---

// src/app/products/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import ProductActions from "@/components/ProductActions"
import SearchInput from "@/components/SearchInput" // üëà Importamos
import Link from "next/link"

// Definimos que esta p√°gina recibe par√°metros de b√∫squeda
interface Props {
  searchParams?: Promise<{
    query?: string
    page?: string
  }>
}

export default async function ProductsPage({ searchParams }: Props) {
  // Esperamos los par√°metros (Next.js 15 requiere await, versiones anteriores no, pero es buena pr√°ctica)
  const params = await searchParams
  const query = params?.query || ""

  // 1. Datos para selectores (Formulario)
  const owners = await prisma.owner.findMany({ select: { id: true, name: true } })
  const categories = await prisma.category.findMany({ select: { id: true, name: true } })

  // 2. FILTRO DIN√ÅMICO
  // Si hay query, filtramos. Si no, traemos todo.
  const products = await prisma.product.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } }, // Nombre producto
            { owner: { name: { contains: query, mode: 'insensitive' } } } // Nombre due√±o
        ]
    } : undefined,
    include: {
      variants: true,
      category: true,
      owner: true
    },
    orderBy: { name: 'asc' }
  })

  return (
    <div className="p-8 max-w-7xl mx-auto">
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 className="text-3xl font-bold text-gray-800">Inventario</h1>
        
        <div className="flex gap-3">
            <Link 
              href="/inventory" 
              className="bg-slate-800 text-white px-4 py-2 rounded-lg shadow hover:bg-slate-900 font-bold text-sm flex items-center gap-2 transition"
            >
              üì¶ Stock
            </Link>
            <Link 
              href="/products/import" 
              className="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 font-bold text-sm flex items-center gap-2 transition"
            >
              üìÑ Importar
            </Link>
        </div>
      </div>

      {/* BARRA DE B√öSQUEDA */}
      <div className="mb-8 max-w-md">
         <SearchInput placeholder="Buscar por producto o due√±o..." />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO */}
        <div className="lg:col-span-1">
          <div className="sticky top-24">
             <ProductForm owners={owners} categories={categories} />
          </div>
        </div>

        {/* COLUMNA DERECHA: TABLA */}
        <div className="lg:col-span-2">
          <div className="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
            <table className="w-full text-sm text-left">
              <thead className="bg-gray-100 text-gray-700 uppercase font-bold text-xs">
                <tr>
                  <th className="px-4 py-3">Producto / Due√±o</th>
                  <th className="px-4 py-3">Categor√≠a</th>
                  <th className="px-4 py-3">Precio</th>
                  <th className="px-4 py-3 text-center">Stock</th>
                  <th className="px-4 py-3 text-center">Acciones</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {products.map(p => {
                  const variant = p.variants[0]
                  const isArchived = !p.isActive

                  return (
                    <tr 
                      key={p.id} 
                      className={`transition duration-150 ${isArchived ? 'bg-gray-100 opacity-60 grayscale' : 'hover:bg-blue-50 bg-white'}`}
                    >
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-3">
                            {variant?.imageUrl ? (
                            <img src={variant.imageUrl} className="w-10 h-10 object-cover rounded border" />
                            ) : (
                            <div className="w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-400">Sin foto</div>
                            )}
                            <div>
                                <p className="font-bold text-gray-900 leading-tight">
                                    {p.name}
                                    {isArchived && <span className="text-[10px] text-red-600 ml-2 border border-red-200 px-1 rounded">ARCHIVADO</span>}
                                </p>
                                <p className="text-xs text-gray-500">{p.owner.name}</p>
                            </div>
                        </div>
                      </td>
                      <td className="px-4 py-3 text-gray-600">{p.category.name}</td>
                      <td className="px-4 py-3 font-bold text-green-700 text-base">${variant?.salePrice.toString()}</td>
                      <td className="px-4 py-3 text-center">
                        {variant?.stock === 0 ? (
                          <span className="text-red-600 bg-red-100 px-2 py-1 rounded text-xs font-bold">AGOTADO</span>
                        ) : (
                          <span className="font-mono font-bold text-gray-700">{variant?.stock}</span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex justify-center">
                            <ProductActions id={p.id} isActive={p.isActive} stock={variant?.stock || 0} />
                        </div>
                      </td>
                    </tr>
                  )
                })}
                
                {products.length === 0 && (
                  <tr>
                    <td colSpan={5} className="text-center py-12 text-gray-500">
                      {query ? "No se encontraron resultados para tu b√∫squeda." : "Inventario vac√≠o."}
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\import) ---

import ExcelImporter from "@/components/ExcelImporter"
import Link from "next/link"

export default function ImportPage() {
  return (
    <div className="p-8 max-w-3xl mx-auto">
      <Link href="/products" className="text-blue-600 hover:underline mb-4 block">
        ‚Üê Volver a Productos
      </Link>
      <h1 className="text-3xl font-bold mb-8">Asistente de Importaci√≥n</h1>
      <ExcelImporter />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\[id]\edit) ---

// src/app/products/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditProductPage({ params }: Props) {
  const { id } = await params

  // 1. Buscar datos maestros para los selectores
  const owners = await prisma.owner.findMany()
  const categories = await prisma.category.findMany()

  // 2. Buscar el producto a editar
  const product = await prisma.product.findUnique({
    where: { id },
    include: { variants: true }
  })

  if (!product) return <div>Producto no encontrado</div>

  // 3. Preparar los datos para el formulario
  const variant = product.variants[0] // Asumimos variante √∫nica
  const initialData = {
    id: product.id,
    name: product.name,
    description: product.description,
    ownerId: product.ownerId,
    categoryId: product.categoryId,
    costPrice: Number(variant.costPrice),
    salePrice: Number(variant.salePrice),
    imageUrl: variant.imageUrl
  }

  return (
    <div className="p-8 max-w-2xl mx-auto">
        <Link href="/products" className="text-blue-500 mb-4 block">‚Üê Cancelar y Volver</Link>
        <ProductForm 
            owners={owners} 
            categories={categories} 
            initialData={initialData} // üëà Pasamos los datos
        />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\sales) ---

// src/app/sales/page.tsx
import { prisma } from "@/lib/prisma"
import { getLocalDateISO, getArgentinaDayRange } from "@/lib/utils" // üëà Importamos
import Link from "next/link"
import SaleRow from "@/components/SaleRow"

interface Props {
  searchParams: Promise<{ 
    dateFrom?: string 
    dateTo?: string 
    method?: string
  }>
}

export default async function SalesHistoryPage({ searchParams }: Props) {
  const { dateFrom, dateTo, method } = await searchParams

  const today = getLocalDateISO()
  const fromStr = dateFrom || today
  const toStr = dateTo || today

  // 1. Usar Helper para rangos (Garantiza GMT-3)
  const fromDate = getArgentinaDayRange(fromStr).start
  const toDate = getArgentinaDayRange(toStr).end

  // 2. Consulta a DB
  const sales = await prisma.sale.findMany({
    where: {
      createdAt: {
        gte: fromDate,
        lte: toDate
      },
      paymentMethod: method ? { equals: method } : undefined
    },
    include: {
      items: true
    },
    orderBy: { createdAt: 'desc' }
  })

  // 3. C√°lculos de Totales
  const totalPeriodo = sales
    .filter(s => s.status === 'COMPLETED')
    .reduce((sum, s) => sum + Number(s.total), 0)

  const cantVentas = sales.filter(s => s.status === 'COMPLETED').length

  return (
    <div className="p-8 max-w-5xl mx-auto">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <h1 className="text-3xl font-bold text-gray-800">Historial de Ventas</h1>
        
        {/* Resumen Flotante */}
        <div className="bg-slate-900 text-white px-6 py-3 rounded-lg shadow-lg text-right">
            <p className="text-xs text-slate-400 uppercase font-bold">Total Periodo</p>
            <p className="text-2xl font-bold">${totalPeriodo.toLocaleString()}</p>
            <p className="text-xs text-slate-500">{cantVentas} operaciones</p>
        </div>
      </div>

      {/* BARRA DE FILTROS */}
      <div className="bg-white p-4 rounded-lg shadow-sm border mb-6">
        <form className="flex flex-wrap items-end gap-4">
            
            {/* Desde */}
            <div className="flex flex-col gap-1">
                <label className="text-xs font-bold text-gray-500 uppercase">Desde</label>
                <input 
                    name="dateFrom" 
                    type="date" 
                    defaultValue={fromStr}
                    className="border p-2 rounded text-sm font-bold"
                />
            </div>

            {/* Hasta */}
            <div className="flex flex-col gap-1">
                <label className="text-xs font-bold text-gray-500 uppercase">Hasta</label>
                <input 
                    name="dateTo" 
                    type="date" 
                    defaultValue={toStr}
                    className="border p-2 rounded text-sm font-bold"
                />
            </div>

            {/* M√©todo */}
            <div className="flex flex-col gap-1">
                <label className="text-xs font-bold text-gray-500 uppercase">Medio Pago</label>
                <select 
                    name="method" 
                    defaultValue={method || ""}
                    className="border p-2 rounded text-sm bg-white min-w-[120px]"
                >
                    <option value="">Todos</option>
                    <option value="CASH">Efectivo</option>
                    <option value="TRANSFER">Transferencia</option>
                </select>
            </div>

            <button className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm font-bold shadow transition">
                Filtrar
            </button>
            
            {(dateFrom || dateTo || method) && (
                <Link href="/sales" className="text-sm text-red-500 underline py-2">
                    Borrar Filtros
                </Link>
            )}
        </form>
      </div>

      {/* TABLA DE RESULTADOS */}
      <div className="bg-white rounded-lg shadow overflow-hidden border">
        <table className="w-full text-left">
          <thead className="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
            <tr>
              <th className="p-4">Fecha</th>
              <th className="p-4">M√©todo</th>
              <th className="p-4">Total</th>
              <th className="p-4 text-center">Detalle</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {sales.length === 0 ? (
                <tr>
                    <td colSpan={4} className="p-10 text-center text-gray-400">
                        No hay ventas en este per√≠odo.
                    </td>
                </tr>
            ) : (
                sales.map(sale => {
                    const saleForClient = {
                        ...sale,
                        total: Number(sale.total),
                        items: sale.items.map(i => ({
                            ...i,
                            priceAtSale: Number(i.priceAtSale)
                        }))
                    }
                    return <SaleRow key={sale.id} sale={saleForClient} />
                })
            )}
          </tbody>
        </table>
      </div>
    </div>
  )
}

--- File: AppointmentCard.tsx (in subfolder: components) ---

// src/components/AppointmentCard.tsx
'use client'

import { cancelAppointment, updateAppointmentStatus } from "@/actions/appointment-actions"
import Link from "next/link"
import { useState } from "react"

// Definimos el tipo de datos que recibe la tarjeta (lo que viene de Prisma)
type AppointmentData = {
  id: string
  startTime: Date
  endTime: Date
  status: string // En Prisma es un Enum, aqu√≠ lo manejamos como string
  pet: {
    name: string
    breed: string | null
    ownerName: string
  }
}

export default function AppointmentCard({ appt }: { appt: AppointmentData }) {
  const [loading, setLoading] = useState(false)

  // Helpers de formato
  const start = appt.startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  const end = appt.endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })

  // Funci√≥n gen√©rica para cambiar estado
  const handleStatusChange = async (newStatus: 'CONFIRMED' | 'COMPLETED') => {
    setLoading(true)
    await updateAppointmentStatus(appt.id, newStatus)
    setLoading(false)
  }

  // Definir colores seg√∫n estado
  let statusColor = "bg-white border-l-4 border-gray-300" // Default
  if (appt.status === 'PENDING') statusColor = "bg-white border-l-4 border-yellow-400"
  if (appt.status === 'CONFIRMED') statusColor = "bg-blue-50 border-l-4 border-blue-500" // En proceso
  if (appt.status === 'COMPLETED') statusColor = "bg-green-50 border-l-4 border-green-500" // Terminado
  if (appt.status === 'BILLED') statusColor = "bg-gray-100 border-l-4 border-gray-400 opacity-75" // Cobrado

  return (
    <div className={`p-4 rounded-lg shadow-sm border border-gray-200 transition-all ${statusColor}`}>
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        
        {/* INFO PRINCIPAL */}
        <div className="flex items-center gap-4">
            {/* Hora */}
            <div className="flex flex-col items-center justify-center min-w-[60px]">
                <span className="text-xl font-bold text-gray-800">{start}</span>
                <span className="text-xs text-gray-500">{end}</span>
            </div>

            {/* Datos Mascota */}
            <div>
                <h3 className="font-bold text-lg text-gray-900 leading-none mb-1">
                    {appt.pet.name}
                </h3>
                <p className="text-xs text-gray-600">
                    {appt.pet.breed} ‚Ä¢ {appt.pet.ownerName}
                </p>
                {/* Badge de Estado Visual */}
                <span className={`
                    inline-block mt-2 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider
                    ${appt.status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' : ''}
                    ${appt.status === 'CONFIRMED' ? 'bg-blue-100 text-blue-800' : ''}
                    ${appt.status === 'COMPLETED' ? 'bg-green-100 text-green-800' : ''}
                    ${appt.status === 'BILLED' ? 'bg-gray-200 text-gray-600' : ''}
                `}>
                    {appt.status === 'CONFIRMED' ? 'EN PROCESO' : appt.status}
                </span>
            </div>
        </div>

        {/* BOTONERA DE ACCIONES (WORKFLOW) */}
        <div className="flex flex-wrap gap-2 items-center justify-end w-full sm:w-auto">
            
            {/* 1. SI EST√Å PENDIENTE -> CONFIRMAR (LLEG√ì) */}
            {appt.status === 'PENDING' && (
                <button 
                    disabled={loading}
                    onClick={() => handleStatusChange('CONFIRMED')}
                    className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-2 rounded transition"
                >
                    üêï LLEG√ì
                </button>
            )}

            {/* 2. SI EST√Å EN PROCESO -> TERMINAR (LISTO) */}
            {appt.status === 'CONFIRMED' && (
                <button 
                    disabled={loading}
                    onClick={() => handleStatusChange('COMPLETED')}
                    className="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-3 py-2 rounded transition shadow-sm animate-pulse"
                >
                    ‚ú® LISTO
                </button>
            )}

            {/* 3. BOT√ìN COBRAR (Siempre disponible si no est√° cobrado) */}
            {appt.status !== 'BILLED' && (
                <Link
                    href={`/pos?apptId=${appt.id}&petName=${encodeURIComponent(appt.pet.name)}`}
                    className="bg-slate-800 hover:bg-black text-white text-xs font-bold px-3 py-2 rounded transition flex items-center gap-1 shadow"
                >
                    üí∞ COBRAR
                </Link>
            )}

            {/* 4. CANCELAR (Solo si no se cobr√≥ ni complet√≥) */}
            {(appt.status === 'PENDING' || appt.status === 'CONFIRMED') && (
                <form action={cancelAppointment}>
                    <input type="hidden" name="id" value={appt.id} />
                    <button className="text-red-400 hover:text-red-600 text-xs font-bold px-2 py-2 hover:bg-red-50 rounded">
                        ‚úñ
                    </button>
                </form>
            )}

        </div>
      </div>
    </div>
  )
}

--- File: AppointmentForm.tsx (in subfolder: components) ---

// src/components/AppointmentForm.tsx
'use client'

import { useState } from "react"
import { createAppointment } from "@/actions/appointment-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"

type Props = {
  pets: { id: string, name: string, breed: string | null }[]
  selectedDate: string // Viene 'YYYY-MM-DD'
}

export default function AppointmentForm({ pets, selectedDate }: Props) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault() 
    setLoading(true)

    const form = e.currentTarget
    const formData = new FormData(form)

    // Nota: Ahora 'date' viene del input visible, ya no lo inyectamos manualmente
    
    const result = await createAppointment(formData)

    setLoading(false)

    if (result.error) {
      alert("‚ùå NO SE PUDO AGENDAR:\n" + result.error)
    } else {
      alert("‚úÖ Turno agendado correctamente")
      form.reset() 
      router.refresh()
    }
  }

  return (
    <div className="bg-slate-50 p-6 rounded-lg border border-slate-200 shadow-sm sticky top-6">
      <h2 className="text-xl font-bold mb-4 text-slate-800">Agendar Turno</h2>
      
      <form onSubmit={handleSubmit} className="space-y-4">
        
        {/* SELECCI√ìN DE MASCOTA */}
        <div>
          <label className="block text-sm font-bold text-gray-700 mb-1">Mascota</label>
          <select name="petId" required className="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none">
            <option value="">Seleccionar...</option>
            {pets.map(p => (
              <option key={p.id} value={p.id}>{p.name} ({p.breed || 'Sin raza'})</option>
            ))}
          </select>
          <div className="text-right mt-1">
            <Link href="/pets" className="text-xs text-blue-600 underline hover:text-blue-800">
                + Nueva Mascota
            </Link>
          </div>
        </div>

        {/* FECHA (Ahora editable) */}
        <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Fecha</label>
            <input 
                type="date" 
                name="date"
                defaultValue={selectedDate} // Pre-cargamos la fecha actual de la vista
                required
                className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
            />
        </div>

        {/* HORA Y DURACI√ìN */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Hora Inicio</label>
            <input 
              name="time" 
              type="time" 
              required 
              className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Duraci√≥n</label>
            <select name="duration" className="w-full p-2 border rounded bg-white">
              <option value="30">30 min</option>
              <option value="60">1 h</option>
              <option value="90">1 h 30m</option>
              <option value="120">2 hs</option>
              <option value="180">3 hs</option>
            </select>
          </div>
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={`w-full py-3 rounded font-bold transition text-white shadow
            ${loading 
                ? 'bg-slate-400 cursor-wait' 
                : 'bg-slate-800 hover:bg-slate-900 hover:scale-[1.02] active:scale-95'
            }
          `}
        >
          {loading ? "Verificando..." : "Confirmar Reserva"}
        </button>

      </form>
    </div>
  )
}

--- File: CancelSaleButton.tsx (in subfolder: components) ---

// src/components/CancelSaleButton.tsx
'use client'

import { cancelSale } from "@/actions/sale-actions"
import { useState } from "react"

export default function CancelSaleButton({ saleId }: { saleId: string }) {
  const [loading, setLoading] = useState(false)

  const handleCancel = async () => {
    // 1. Log en el NAVEGADOR (Mirar F12 > Console)
    console.log(`üîµ [CLIENTE] Click en anular venta ID: ${saleId}`)

    const confirmed = confirm("¬øEst√°s SEGURO de anular esta venta?\n\nSi ya fue liquidada, se generar√° una deuda al due√±o.")
    if (!confirmed) return

    setLoading(true)

    try {
      // 2. Llamada al Servidor
      console.log("‚è≥ [CLIENTE] Llamando al servidor...")
      const result = await cancelSale(saleId)

      // 3. Respuesta del Servidor
      console.log("üü¢ [CLIENTE] Respuesta recibida:", result)

      if (result.success) {
        alert("‚úÖ ¬°Venta Anulada con √âxito!")
        // La p√°gina se refrescar√° sola gracias al revalidatePath del servidor
      } else {
        alert(`‚ùå Error: ${result.error}`)
      }
    } catch (err) {
      console.error("üî¥ [CLIENTE] Error de red o c√≥digo:", err)
      alert("Error inesperado al intentar anular.")
    } finally {
      setLoading(false)
    }
  }

  return (
    <button
      onClick={handleCancel}
      disabled={loading}
      className={`text-sm font-semibold border px-3 py-1 rounded transition
        ${loading 
          ? 'bg-gray-200 text-gray-500 cursor-wait' 
          : 'text-red-600 border-red-200 hover:bg-red-50 hover:text-red-800'
        }
      `}
    >
      {loading ? "Procesando..." : "Anular"}
    </button>
  )
}

--- File: ExcelImporter.tsx (in subfolder: components) ---

'use client'

import { useState } from "react"
import readXlsxFile from "read-excel-file"
import { importSingleProduct } from "@/actions/bulk-actions"

export default function ExcelImporter() {
  const [rows, setRows] = useState<any[]>([])
  const [processing, setProcessing] = useState(false)
  const [progress, setProgress] = useState({ current: 0, total: 0, errors: 0 })
  const [logs, setLogs] = useState<string[]>([])

  // 1. LEER EL ARCHIVO
  const handleFile = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    try {
      // Leemos el Excel. Asumimos columnas en orden: Nombre, Categoria, Due√±o, Costo, Precio
      const data = await readXlsxFile(file)
      
      // Eliminamos la cabecera (fila 0)
      const cleanData = data.slice(1).map(row => ({
        name: row[0] as string,
        categoryName: row[1] as string,
        ownerName: row[2] as string,
        cost: Number(row[3]),
        price: Number(row[4])
      }))

      setRows(cleanData)
      setLogs(prev => [...prev, `Archivo cargado: ${cleanData.length} productos detectados.`])
    } catch (error) {
      alert("Error leyendo Excel. Asegurate que sea un .xlsx v√°lido.")
    }
  }

  // 2. PROCESAR BUCLE (LOOP)
  const startImport = async () => {
    setProcessing(true)
    setProgress({ current: 0, total: rows.length, errors: 0 })
    setLogs([])

    let successCount = 0
    let errorCount = 0

    // BUCLE SECUENCIAL
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i]
      
      // Validar datos m√≠nimos antes de llamar al server
      if (!row.name || !row.ownerName) {
        setLogs(prev => [...prev, `‚ùå Fila ${i+2}: Faltan datos obligatorios`])
        errorCount++
        continue
      }

      // Llamada al Server Action
      const result = await importSingleProduct(row)

      if (result.success) {
        successCount++
      } else {
        errorCount++
        setLogs(prev => [...prev, `‚ùå Error en "${row.name}": ${result.error}`])
      }

      // Actualizar barra de progreso
      setProgress({ 
        current: i + 1, 
        total: rows.length, 
        errors: errorCount 
      })
    }

    setProcessing(false)
    setLogs(prev => [...prev, `üèÅ FINALIZADO. √âxitos: ${successCount}, Errores: ${errorCount}`])
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow border">
      <h2 className="text-xl font-bold mb-4">Importaci√≥n Masiva (Excel)</h2>
      
      <div className="mb-4 p-4 bg-blue-50 text-blue-800 text-sm rounded">
        <strong>Formato requerido (Columnas):</strong>
        <br />
        1. Nombre Producto | 2. Categor√≠a | 3. Nombre Due√±o | 4. Costo | 5. Precio Venta
      </div>

      {!processing && rows.length === 0 && (
        <input 
          type="file" 
          accept=".xlsx" 
          onChange={handleFile}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700"
        />
      )}

      {rows.length > 0 && !processing && progress.current === 0 && (
        <div className="space-y-4">
          <p className="font-bold text-lg">{rows.length} productos listos para importar.</p>
          <button 
            onClick={startImport}
            className="w-full bg-green-600 text-white py-3 rounded hover:bg-green-700 font-bold"
          >
            Iniciar Importaci√≥n
          </button>
        </div>
      )}

      {/* BARRA DE PROGRESO */}
      {(processing || progress.current > 0) && (
        <div className="mt-4 space-y-2">
          <div className="flex justify-between text-sm font-bold">
            <span>Progreso: {progress.current} / {progress.total}</span>
            <span className="text-red-600">Errores: {progress.errors}</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-4">
            <div 
              className="bg-blue-600 h-4 rounded-full transition-all duration-300" 
              style={{ width: `${(progress.current / progress.total) * 100}%` }}
            ></div>
          </div>
        </div>
      )}

      {/* LOGS DE ERRORES */}
      <div className="mt-6 max-h-40 overflow-y-auto bg-gray-900 text-green-400 p-4 rounded font-mono text-xs">
        {logs.length === 0 ? "Esperando log..." : logs.map((log, i) => (
          <div key={i}>{log}</div>
        ))}
      </div>
    </div>
  )
}

--- File: ImageUpload.tsx (in subfolder: components) ---

// src/components/ImageUpload.tsx
'use client' // Necesario para interactuar con el usuario

import { useState } from "react"

export default function ImageUpload({ onImageUpload }: { onImageUpload: (url: string) => void }) {
  const [uploading, setUploading] = useState(false)
  const [preview, setPreview] = useState<string | null>(null)

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setUploading(true)

    // 1. Preparar los datos para Cloudinary
    const formData = new FormData()
    formData.append("file", file)
    formData.append("upload_preset", process.env.NEXT_PUBLIC_CLOUDINARY_PRESET!)

    try {
      // 2. Enviar a Cloudinary (Petici√≥n directa desde el navegador)
      const cloudName = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData,
      })

      const data = await response.json()

      if (data.secure_url) {
        // 3. √âxito: Guardamos la URL y avisamos al componente padre
        setPreview(data.secure_url)
        onImageUpload(data.secure_url) // üëà Esta funci√≥n viene de afuera
      } else {
        alert("Error al subir imagen")
      }
    } catch (error) {
      console.error(error)
      alert("Error de conexi√≥n al subir imagen")
    } finally {
      setUploading(false)
    }
  }

  return (
    <div className="flex flex-col gap-2">
      <label className="text-sm font-medium text-gray-700">Imagen del Producto</label>
      
      <div className="flex items-center gap-4">
        {/* Input de archivo */}
        <input 
          type="file" 
          accept="image/*"
          onChange={handleFileChange}
          disabled={uploading}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
        
        {/* Indicador de carga */}
        {uploading && <span className="text-sm text-blue-600">Subiendo...</span>}
      </div>

      {/* Previsualizaci√≥n */}
      {preview && (
        <div className="mt-2">
          <img src={preview} alt="Vista previa" className="h-32 w-32 object-cover rounded-md border" />
        </div>
      )}
    </div>
  )
}

--- File: MainNav.tsx (in subfolder: components) ---

// src/components/MainNav.tsx
'use client'

import Link from "next/link"
import { usePathname } from "next/navigation"

export default function MainNav() {
  const pathname = usePathname()

  // Definimos las rutas
  const routes = [
    { href: "/dashboard", label: "Dashboard", icon: "üìä", exact: true },
    { href: "/pos", label: "CAJA", icon: "üí∞", exact: true, highlight: true },
    { href: "/agenda", label: "Agenda", icon: "üìÖ", exact: false },
    { href: "/sales", label: "Ventas", icon: "üóÇÔ∏è", exact: false },
    { href: "/products", label: "Productos", icon: "üì¶", exact: false },
    { href: "/pets", label: "Clientes", icon: "üê∂", exact: false },
    { href: "/owners", label: "Consign.", icon: "üë•", exact: false },
    { href: "/owners/balance", label: "Finanzas", icon: "‚öñÔ∏è", exact: true },
  ]

  return (
    <>
      {/* ==============================================
          ESTILO ESCRITORIO (Sidebar Izquierda)
          Visible solo en pantallas medianas o grandes (md:flex)
         ============================================== */}
      <aside className="hidden md:flex w-64 flex-col bg-slate-900 text-gray-300 border-r border-slate-800 h-screen sticky top-0 overflow-y-auto">
        
        {/* LOGO */}
        <div className="p-6 border-b border-slate-800">
          <h1 className="text-2xl font-bold text-white tracking-tight">
            GUAPECANES
            <span className="text-green-500">.</span>
          </h1>
          <p className="text-xs text-slate-500 mt-1">Sistema de Gesti√≥n v3.0</p>
        </div>

        {/* LISTA DE NAVEGACI√ìN VERTICAL */}
        <nav className="flex-1 py-6 px-3 space-y-2">
          {routes.map((route) => {
            const isActive = route.exact 
                ? pathname === route.href
                : pathname.startsWith(route.href)

            return (
              <Link
                key={route.href}
                href={route.href}
                className={`
                  flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200
                  ${route.highlight 
                      ? 'bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg shadow-green-900/20 hover:scale-105 justify-center text-base' 
                      : isActive 
                          ? 'bg-slate-800 text-white border-l-4 border-blue-500' 
                          : 'hover:bg-slate-800 hover:text-white hover:pl-5'
                  }
                `}
              >
                <span className="text-xl">{route.icon}</span>
                {route.label}
              </Link>
            )
          })}
        </nav>

        {/* FOOTER DEL SIDEBAR */}
        <div className="p-4 border-t border-slate-800 text-center">
            <div className="text-xs text-slate-500">
                Usuario: Staff<br/>
                <span className="text-green-500">‚óè Online</span>
            </div>
        </div>
      </aside>


      {/* ==============================================
          ESTILO M√ìVIL (Bottom Navigation)
          Visible solo en pantallas peque√±as (md:hidden)
          Fijo abajo.
         ============================================== */}
      <nav className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-slate-900 border-t border-slate-800 flex justify-between items-center px-2 py-2 safe-area-bottom shadow-2xl">
        {routes.map((route) => {
            // En m√≥vil mostramos menos items o √≠conos m√°s grandes. 
            // Filtramos algunos si son muchos, o usamos scroll horizontal.
            // Aqu√≠ usamos scroll horizontal simple si desborda.
            const isActive = route.exact 
                ? pathname === route.href
                : pathname.startsWith(route.href)

            return (
              <Link
                key={route.href}
                href={route.href}
                className={`
                  flex flex-col items-center justify-center min-w-[60px] p-1 rounded-md transition-colors
                  ${route.highlight 
                      ? 'bg-green-600 text-white -mt-6 h-14 w-14 rounded-full shadow-lg border-4 border-gray-50' // Efecto bot√≥n flotante para CAJA
                      : isActive 
                          ? 'text-white' 
                          : 'text-slate-500 hover:text-slate-300'
                  }
                `}
              >
                <span className={`${route.highlight ? 'text-2xl' : 'text-xl'}`}>{route.icon}</span>
                {!route.highlight && (
                    <span className="text-[9px] font-bold mt-1 uppercase">{route.label.slice(0, 6)}</span>
                )}
              </Link>
            )
        })}
      </nav>
    </>
  )
}

--- File: OwnerForm.tsx (in subfolder: components) ---

// src/components/OwnerForm.tsx
'use client'

import { createOwner, updateOwner } from "@/actions/owner-actions"
import { useRouter } from "next/navigation"
import { useState } from "react"

type OwnerData = {
  id?: string
  name: string
  email: string | null
  phone: string | null
}

export default function OwnerForm({ initialData }: { initialData?: OwnerData }) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    
    let result;
    
    if (initialData?.id) {
        // MODO EDICI√ìN
        formData.append("id", initialData.id)
        result = await updateOwner(formData)
        if (result.success) {
            alert("Due√±o actualizado")
            router.push("/owners") // Volver a la lista
            router.refresh()
        }
    } else {
        // MODO CREACI√ìN
        result = await createOwner(formData)
        if (result?.success) {
            // Limpiamos el form manualmente si es creaci√≥n
            const form = document.getElementById("owner-form") as HTMLFormElement
            form?.reset()
            router.refresh()
        }
    }

    setLoading(false)
    if (result?.error) alert(result.error)
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow border">
      <h2 className="text-xl font-bold mb-4">
        {initialData ? "Editar Due√±o" : "Nuevo Due√±o"}
      </h2>
      
      <form id="owner-form" action={handleSubmit} className="flex flex-col gap-4">
        
        <div>
          <label className="text-sm text-gray-600 font-bold">Nombre *</label>
          <input 
            name="name" 
            defaultValue={initialData?.name}
            type="text" 
            required 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="Juan P√©rez"
          />
        </div>

        <div>
          <label className="text-sm text-gray-600 font-bold">Email</label>
          <input 
            name="email" 
            defaultValue={initialData?.email || ""}
            type="email" 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="juan@mail.com"
          />
        </div>

        <div>
          <label className="text-sm text-gray-600 font-bold">Tel√©fono</label>
          <input 
            name="phone" 
            defaultValue={initialData?.phone || ""}
            type="text" 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            placeholder="11 1234 5678"
          />
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={`w-full py-2 rounded text-white font-bold transition
            ${loading ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}
          `}
        >
          {loading ? "Guardando..." : "Guardar"}
        </button>
      </form>
    </div>
  )
}

--- File: PosSystem.tsx (in subfolder: components) ---

// src/components/PosSystem.tsx
'use client'

import { useState, useEffect, useMemo } from "react"
import { processSale } from "@/actions/sale-actions"
import { useSearchParams, useRouter } from "next/navigation"
import TicketView from "./TicketView"

type ProductType = {
  id: string
  name: string
  price: number
  stock: number
  imageUrl: string | null
  ownerName: string
  categoryName: string 
}

type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string
  name: string
  price: number
  quantity: number
  stockMax?: number
}

type PaymentMethod = "CASH" | "TRANSFER"

// Estructura que espera el TicketView
type SaleResult = {
    id: string
    date: Date
    items: { description: string; quantity: number; price: number }[] // üëà Ajustado
    total: number
    method: PaymentMethod
}

export default function PosSystem({ products }: { products: ProductType[] }) {
  const [cart, setCart] = useState<CartItem[]>([])
  const [loading, setLoading] = useState(false)
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>("CASH")
  const [lastSale, setLastSale] = useState<SaleResult | null>(null)

  const [searchTerm, setSearchTerm] = useState("")
  const [selectedCategory, setSelectedCategory] = useState<string | "ALL">("ALL")
  
  const searchParams = useSearchParams()
  const router = useRouter()

  useEffect(() => {
    const apptId = searchParams.get("apptId")
    const petName = searchParams.get("petName")
    
    if (apptId && petName && cart.length === 0) {
      setCart([{
        type: 'SERVICE',
        id: apptId,
        name: `Servicio: ${petName}`,
        price: 0,
        quantity: 1
      }])
    }
  }, [searchParams])

  const categories = useMemo(() => {
    const cats = products.map(p => p.categoryName)
    return ["ALL", ...Array.from(new Set(cats))].sort()
  }, [products])

  const filteredProducts = useMemo(() => {
    const term = searchTerm.toLowerCase()
    return products.filter(p => {
        const matchesCategory = selectedCategory === "ALL" || p.categoryName === selectedCategory
        const matchesText = 
            p.name.toLowerCase().includes(term) || 
            p.ownerName.toLowerCase().includes(term) ||
            p.categoryName.toLowerCase().includes(term)
        return matchesCategory && matchesText
    })
  }, [products, searchTerm, selectedCategory]) 

  const addProductToCart = (product: ProductType) => {
    if (product.stock <= 0) return alert("Sin stock")

    setCart(current => {
      const existing = current.find(item => item.id === product.id && item.type === 'PRODUCT')
      if (existing) {
        if (existing.quantity >= product.stock) {
          alert("No hay m√°s stock disponible")
          return current
        }
        return current.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item)
      }
      return [...current, { type: 'PRODUCT', id: product.id, name: product.name, price: product.price, quantity: 1, stockMax: product.stock }]
    })
  }

  const updateServicePrice = (index: number, newPrice: string) => {
    const val = parseFloat(newPrice)
    setCart(current => current.map((item, i) => i === index ? { ...item, price: isNaN(val) ? 0 : val } : item))
  }

  const removeFromCart = (index: number) => {
    setCart(current => current.filter((_, i) => i !== index))
  }

  const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)

  const handleCheckout = async () => {
    if (total === 0 && !confirm("¬øConfirmar venta por $0?")) return
    const methodText = paymentMethod === 'CASH' ? 'EFECTIVO' : 'TRANSFERENCIA'
    if (!confirm(`¬øCobrar $${total.toLocaleString()} con ${methodText}?`)) return
    
    setLoading(true)
    
    // Payload para el servidor (Aqu√≠ s√≠ us√°bamos description, eso estaba bien)
    const payload = cart.map(item => ({ 
        type: item.type, 
        id: item.id, 
        description: item.name, 
        price: item.price, 
        quantity: item.quantity 
    }))
    
    const result = await processSale(payload, total, paymentMethod)
    
    setLoading(false)

    if (result.success && result.saleId && result.date) {
      
      // ‚úÖ CORRECCI√ìN AQU√ç:
      // Mapeamos el carrito para que tenga la propiedad 'description' en lugar de 'name'
      // para que coincida con lo que espera el TicketView.
      const ticketItems = cart.map(item => ({
        description: item.name, // üëà EL CAMBIO CLAVE
        quantity: item.quantity,
        price: item.price
      }))

      setLastSale({
        id: result.saleId,
        date: result.date,
        items: ticketItems, // Usamos la lista mapeada
        total: total,
        method: paymentMethod
      })
      
      setCart([]) 
      
      if (searchParams.get("apptId")) {
         router.replace("/pos") 
      }
    } else {
      alert("Error: " + result.error)
    }
  }

  if (lastSale) {
    return (
        <TicketView 
            mode="POS" // üëà Explicito
            saleId={lastSale.id}
            date={lastSale.date}
            items={lastSale.items}
            total={lastSale.total}
            paymentMethod={lastSale.method}
            onClose={() => setLastSale(null)} // üëà Cambiado de onNewSale a onClose
        />
    )
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pb-20 h-full">
      
      {/* === COLUMNA IZQUIERDA === */}
      <div className="md:col-span-2 flex flex-col gap-4 h-full overflow-hidden">
        
        <div className="bg-white p-4 rounded-lg shadow-sm border space-y-3">
            <div className="relative">
                <input 
                    type="text" 
                    placeholder="üîç Buscar producto, due√±o..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full p-3 pl-10 border rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition"
                    autoFocus
                />
                {searchTerm && (
                    <button 
                        onClick={() => setSearchTerm("")}
                        className="absolute right-3 top-3 text-gray-400 hover:text-gray-600"
                    >
                        ‚úï
                    </button>
                )}
            </div>

            <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                {categories.map(cat => (
                    <button
                        key={cat}
                        onClick={() => setSelectedCategory(cat === selectedCategory ? "ALL" : cat)}
                        className={`
                            px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition
                            ${selectedCategory === cat 
                                ? 'bg-slate-800 text-white border-slate-800' 
                                : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-100'
                            }
                        `}
                    >
                        {cat === "ALL" ? "Todo" : cat}
                    </button>
                ))}
            </div>
        </div>

        <div className="flex-1 overflow-y-auto pr-2">
            {filteredProducts.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                    <span className="text-4xl mb-2">üîç</span>
                    <p>No encontr√© nada con "{searchTerm}"</p>
                    <button onClick={() => {setSearchTerm(""); setSelectedCategory("ALL")}} className="text-blue-500 underline text-sm mt-2">Limpiar filtros</button>
                </div>
            ) : (
                <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                    {filteredProducts.map(p => (
                        <button 
                            key={p.id}
                            onClick={() => addProductToCart(p)}
                            disabled={p.stock === 0}
                            className={`p-3 border rounded-lg text-left transition shadow-sm flex flex-col gap-2 relative group
                                ${p.stock === 0 ? 'bg-gray-100 opacity-60 grayscale cursor-not-allowed' : 'bg-white hover:border-blue-500 hover:shadow-md'}
                            `}
                        >
                            <div className="w-full h-24 bg-gray-100 rounded overflow-hidden relative">
                                {p.imageUrl ? (
                                    <img src={p.imageUrl} alt={p.name} className="w-full h-full object-cover"/>
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center text-xs text-gray-400">Sin Foto</div>
                                )}
                                <div className={`absolute top-1 right-1 px-1.5 py-0.5 rounded text-[10px] font-bold text-white shadow
                                    ${p.stock === 0 ? 'bg-red-500' : p.stock <= 3 ? 'bg-orange-500' : 'bg-green-600'}
                                `}>
                                    {p.stock} u.
                                </div>
                            </div>
                            
                            <div className="flex-1">
                                <h3 className="font-bold text-gray-800 text-sm leading-tight line-clamp-2">{p.name}</h3>
                                <p className="text-[10px] text-gray-500 truncate">{p.ownerName}</p>
                            </div>
                            
                            <div className="mt-auto pt-2 border-t border-dashed border-gray-200 flex justify-between items-center">
                                <span className="text-blue-700 font-bold text-lg">${p.price}</span>
                                <span className="text-[10px] bg-gray-100 text-gray-600 px-1.5 rounded">{p.categoryName}</span>
                            </div>
                        </button>
                    ))}
                </div>
            )}
        </div>
      </div>

      {/* === COLUMNA DERECHA === */}
      <div className="md:col-span-1 h-full">
        <div className="bg-white border rounded-lg shadow-lg flex flex-col h-[calc(100vh-2rem)] sticky top-4">
          <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
            <h2 className="font-bold text-lg text-gray-800">Ticket</h2>
            <span className="text-xs bg-slate-200 px-2 py-1 rounded font-mono">{cart.length} items</span>
          </div>
          
          <div className="p-4 space-y-4 flex-1 overflow-y-auto">
            {cart.length === 0 && (
              <div className="text-center py-20 opacity-50">
                <p className="text-4xl mb-2">üõí</p>
                <p className="text-sm">Escane√° o seleccion√°<br/>productos.</p>
              </div>
            )}
            
            {cart.map((item, index) => (
              <div key={index} className="flex justify-between items-start border-b pb-3 animate-in fade-in slide-in-from-right-4">
                <div className="flex-1">
                  <p className="font-medium text-gray-800 text-sm">
                    {item.type === 'SERVICE' && <span className="mr-1">‚úÇÔ∏è</span>}
                    {item.name}
                  </p>
                  
                  {item.type === 'SERVICE' ? (
                     <div className="mt-1 flex items-center gap-2">
                        <span className="text-xs text-gray-500 font-bold">$</span>
                        <input 
                            type="number" 
                            value={item.price} 
                            onChange={(e) => updateServicePrice(index, e.target.value)}
                            className="w-20 border rounded px-1 py-0.5 text-sm font-bold bg-gray-50"
                        />
                     </div>
                  ) : (
                     <p className="text-xs text-gray-500 mt-1">{item.quantity} x ${item.price}</p>
                  )}
                </div>

                <div className="flex flex-col items-end gap-1">
                    <span className="font-bold text-gray-800">${(item.quantity * item.price).toLocaleString()}</span>
                    <button onClick={() => removeFromCart(index)} className="text-xs text-red-500 hover:bg-red-50 px-2 rounded">x</button>
                </div>
              </div>
            ))}
          </div>

          <div className="p-4 bg-gray-50 border-t">
             <div className="grid grid-cols-2 gap-2 mb-4">
                <button 
                    onClick={() => setPaymentMethod("CASH")}
                    className={`p-2 rounded text-xs font-bold border transition flex items-center justify-center gap-1
                        ${paymentMethod === "CASH" ? "bg-green-600 text-white border-green-600" : "bg-white border-gray-300 text-gray-500"}
                    `}
                >
                    üíµ EFECTIVO
                </button>
                <button 
                    onClick={() => setPaymentMethod("TRANSFER")}
                    className={`p-2 rounded text-xs font-bold border transition flex items-center justify-center gap-1
                        ${paymentMethod === "TRANSFER" ? "bg-blue-600 text-white border-blue-600" : "bg-white border-gray-300 text-gray-500"}
                    `}
                >
                    üè¶ TRANSFER.
                </button>
             </div>

             <div className="flex justify-between text-2xl font-bold mb-4">
                <span>Total</span>
                <span>${total.toLocaleString()}</span>
             </div>
             
             <button 
              onClick={handleCheckout}
              disabled={cart.length === 0 || loading}
              className={`w-full py-3 rounded font-bold text-lg transition active:scale-95 text-white shadow-lg
                ${cart.length === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-slate-900 hover:bg-black'}
              `}
            >
              {loading ? "..." : "COBRAR"}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

--- File: ProductActions.tsx (in subfolder: components) ---

// src/components/ProductActions.tsx
'use client'

import { toggleProductStatus } from "@/actions/product-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"

export default function ProductActions({ id, isActive, stock }: { id: string, isActive: boolean, stock: number }) {
  const router = useRouter()

  const handleToggle = async () => {
    if (isActive && stock > 0) {
        alert("‚ö†Ô∏è No pod√©s archivar un producto con stock.\nHac√© un retiro o ajuste a 0 primero.")
        return
    }

    if (!confirm(isActive ? "¬øArchivar producto?" : "¬øReactivar producto?")) return

    const res = await toggleProductStatus(id, isActive)
    if (res.error) alert(res.error)
    else router.refresh()
  }

  return (
    <div className="flex gap-2">
      {/* Bot√≥n EDITAR (Link simple) */}
      <Link 
        href={`/products/${id}/edit`} 
        className="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold hover:bg-blue-200"
      >
        EDITAR
      </Link>

      {/* Bot√≥n ARCHIVAR/ACTIVAR */}
      <button
        onClick={handleToggle}
        className={`px-3 py-1 rounded text-xs font-bold border transition
          ${isActive 
            ? 'bg-white text-red-600 border-red-200 hover:bg-red-50' 
            : 'bg-green-100 text-green-700 border-transparent hover:bg-green-200'
          }
        `}
      >
        {isActive ? "ARCHIVAR" : "ACTIVAR"}
      </button>
    </div>
  )
}

--- File: ProductForm.tsx (in subfolder: components) ---

// src/components/ProductForm.tsx
'use client'

import { useState } from "react"
import { createProduct, updateProduct } from "@/actions/product-actions"
import ImageUpload from "./ImageUpload"
import { useRouter } from "next/navigation"

type Props = {
  owners: { id: string; name: string }[]
  categories: { id: string; name: string }[]
  initialData?: {
    id: string
    name: string
    description: string | null
    ownerId: string
    categoryId: string
    costPrice: number
    salePrice: number
    imageUrl: string | null
  }
}

export default function ProductForm({ owners, categories, initialData }: Props) {
  const router = useRouter()
  const [imageUrl, setImageUrl] = useState(initialData?.imageUrl || "")
  const [loading, setLoading] = useState(false) // Feedback visual
  
  const handleSubmit = async (formData: FormData) => {
    setLoading(true)

    // Agregamos la URL de la imagen manualmente al FormData si cambi√≥
    if (imageUrl) {
        // Si el input file est√° vac√≠o pero tenemos URL en el estado (por carga previa), aseguramos enviarla
        // Nota: En este form simple confiamos en el input hidden, pero esto refuerza.
    }

    let result;

    if (initialData) {
        // MODO EDICI√ìN
        formData.append("id", initialData.id)
        result = await updateProduct(formData)
        
        if (result?.success) {
            alert("‚úÖ Producto actualizado correctamente")
            router.push("/products")
            router.refresh()
        } else {
            alert("‚ùå Error al actualizar:\n" + result?.error)
        }

    } else {
        // MODO CREACI√ìN
        // createProduct hace redirect si todo sale bien. Si retorna algo, es un error.
        result = await createProduct(formData)
        
        if (result?.error) {
            alert("‚ùå No se pudo crear el producto:\n" + result.error)
        }
    }
    
    setLoading(false)
  }

  return (
    <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto border">
      <h2 className="text-xl font-bold mb-6">
        {initialData ? "Editar Producto" : "Nuevo Producto"}
      </h2>
      
      <form action={handleSubmit} className="space-y-4">
        
        {/* Nombre */}
        <div>
          <label className="block text-sm font-medium text-gray-700">Nombre *</label>
          <input 
            name="name" 
            defaultValue={initialData?.name} 
            type="text" 
            required 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
          />
        </div>

        {/* Descripci√≥n */}
        <div>
          <label className="block text-sm font-medium text-gray-700">Descripci√≥n</label>
          <textarea 
            name="description" 
            defaultValue={initialData?.description || ""} 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
            rows={2} 
          />
        </div>

        {/* Selectores */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">Due√±o *</label>
            <select 
              name="ownerId" 
              defaultValue={initialData?.ownerId || ""} 
              required 
              className="w-full border p-2 rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none"
            >
              <option value="">Seleccionar...</option>
              {owners.map(o => (
                <option key={o.id} value={o.id}>{o.name}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Categor√≠a *</label>
            <select 
              name="categoryId" 
              defaultValue={initialData?.categoryId || ""} 
              required 
              className="w-full border p-2 rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none"
            >
              <option value="">Seleccionar...</option>
              {categories.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          </div>
        </div>

        {/* Precios */}
        <div className="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded border">
          <div>
            <label className="block text-sm font-medium text-gray-700">Costo (Due√±o) *</label>
            <div className="relative">
                <span className="absolute left-3 top-2 text-gray-500">$</span>
                <input 
                    name="costPrice" 
                    defaultValue={initialData?.costPrice} 
                    type="number" 
                    step="0.01" 
                    min="0"
                    required 
                    className="w-full border p-2 pl-7 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                />
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Precio Venta *</label>
            <div className="relative">
                <span className="absolute left-3 top-2 text-gray-500">$</span>
                <input 
                    name="salePrice" 
                    defaultValue={initialData?.salePrice} 
                    type="number" 
                    step="0.01" 
                    min="0"
                    required 
                    className="w-full border p-2 pl-7 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                />
            </div>
          </div>
        </div>

        {/* Imagen */}
        <div className="border-t pt-4">
          {imageUrl && (
            <div className="mb-2">
                <p className="text-xs text-gray-500 mb-1">Imagen Actual:</p>
                <img src={imageUrl} alt="Actual" className="w-20 h-20 object-cover rounded border" />
            </div>
          )}
          <ImageUpload onImageUpload={(url) => setImageUrl(url)} />
          <input type="hidden" name="imageUrl" value={imageUrl} />
        </div>

        <button 
            type="submit" 
            disabled={loading}
            className={`w-full text-white py-3 rounded font-bold shadow transition
                ${loading 
                    ? 'bg-gray-400 cursor-not-allowed' 
                    : 'bg-blue-600 hover:bg-blue-700 transform active:scale-95'
                }
            `}
        >
          {loading ? "Procesando..." : (initialData ? "Actualizar Cambios" : "Guardar Producto")}
        </button>

      </form>
    </div>
  )
}

--- File: ReceiptModal.tsx (in subfolder: components) ---

// src/components/ReceiptModal.tsx
'use client'

import { useState } from "react"
import TicketView from "./TicketView"

type SaleData = {
  id: string
  total: number
  paymentMethod: string
  createdAt: Date
  items: { description: string; quantity: number; priceAtSale: number }[]
}

export default function ReceiptModal({ sale }: { sale: SaleData }) {
  const [isOpen, setIsOpen] = useState(false)

  // Mapeamos los datos de DB a lo que espera el Ticket
  const ticketItems = sale.items.map(i => ({
    description: i.description,
    quantity: i.quantity,
    price: i.priceAtSale // El ticket espera 'price', la DB tiene 'priceAtSale'
  }))

  return (
    <>
      {/* EL BOT√ìN ACTIVADOR */}
      <button 
        onClick={(e) => {
            e.stopPropagation() // Evita que se cierre/abra el acorde√≥n de la fila
            setIsOpen(true)
        }}
        className="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold px-3 py-1 rounded border border-gray-300 flex items-center gap-1 transition"
      >
        üìÑ Ver Ticket
      </button>

      {/* EL MODAL (Solo visible si isOpen === true) */}
      {isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            
            {/* Contenedor del Ticket (Con scroll si es muy alto) */}
            <div className="bg-transparent w-full max-w-lg max-h-screen overflow-y-auto">
                <TicketView 
                    mode="HISTORY"
                    saleId={sale.id}
                    date={sale.createdAt}
                    items={ticketItems}
                    total={sale.total}
                    paymentMethod={sale.paymentMethod}
                    onClose={() => setIsOpen(false)} // Cierra el modal
                />
            </div>

        </div>
      )}
    </>
  )
}

--- File: SaleRow.tsx (in subfolder: components) ---

// src/components/SaleRow.tsx
'use client'

import { useState } from "react"
import CancelSaleButton from "./CancelSaleButton"
import ReceiptModal from "./ReceiptModal" // üëà Importamos

type SaleItem = {
  description: string
  quantity: number
  priceAtSale: number 
}

type SaleData = {
  id: string
  total: number
  paymentMethod: string
  status: string
  createdAt: Date
  items: SaleItem[]
}

export default function SaleRow({ sale }: { sale: SaleData }) {
  const [isOpen, setIsOpen] = useState(false)

  const dateStr = sale.createdAt.toLocaleDateString()
  const timeStr = sale.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  const isCancelled = sale.status === 'CANCELLED'

  return (
    <>
      <tr 
        onClick={() => setIsOpen(!isOpen)}
        className={`cursor-pointer transition-colors border-b ${isCancelled ? 'bg-red-50 text-gray-500' : 'hover:bg-blue-50 bg-white'}`}
      >
        <td className="p-4 whitespace-nowrap">
            <div className="flex flex-col">
                <span className="font-bold text-gray-800">{dateStr}</span>
                <span className="text-xs text-gray-500">{timeStr}</span>
            </div>
        </td>
        
        <td className="p-4">
            <span className={`text-xs font-bold px-2 py-1 rounded border
                ${sale.paymentMethod === 'CASH' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-blue-100 text-blue-700 border-blue-200'}
            `}>
                {sale.paymentMethod === 'CASH' ? 'EFECTIVO' : 'TRANSFER.'}
            </span>
        </td>

        <td className="p-4">
            <div className="flex items-center gap-2">
                <span className={`font-mono font-bold text-lg ${isCancelled ? 'line-through opacity-50' : 'text-gray-900'}`}>
                    ${sale.total.toLocaleString()}
                </span>
                {isCancelled && <span className="text-xs text-red-600 font-bold bg-red-100 px-1 rounded">ANULADA</span>}
            </div>
        </td>

        <td className="p-4 text-center">
            <span className={`inline-block transition-transform ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
        </td>
      </tr>

      {isOpen && (
        <tr className="bg-gray-50 border-b">
            <td colSpan={4} className="p-4 shadow-inner">
                <div className="flex flex-col sm:flex-row justify-between items-start gap-4">
                    
                    <div className="space-y-2">
                        <p className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Detalle de la venta:</p>
                        <ul className="text-sm space-y-1">
                            {sale.items.map((item, idx) => (
                                <li key={idx} className="flex gap-2">
                                    <span className="font-bold text-gray-700">{item.quantity} x</span>
                                    <span>{item.description}</span>
                                    <span className="text-gray-400">(${Number(item.priceAtSale).toLocaleString()} c/u)</span>
                                </li>
                            ))}
                        </ul>
                        <p className="text-xs text-gray-400 mt-2 font-mono">ID: {sale.id}</p>
                    </div>

                    <div className="flex flex-col gap-2 items-end">
                        
                        {/* üëá AQU√ç AGREGAMOS EL BOT√ìN DE TICKET */}
                        <ReceiptModal sale={sale} />

                        {!isCancelled && (
                            <>
                                <CancelSaleButton saleId={sale.id} />
                                <p className="text-[10px] text-red-500 max-w-[150px] leading-tight text-right">
                                    ‚ö†Ô∏è Anular restaura stock y ajusta deuda.
                                </p>
                            </>
                        )}
                    </div>
                </div>
            </td>
        </tr>
      )}
    </>
  )
}

--- File: SearchInput.tsx (in subfolder: components) ---

// src/components/SearchInput.tsx
'use client'

import { useSearchParams, usePathname, useRouter } from 'next/navigation'
import { useDebouncedCallback } from 'use-debounce' // Opcional, pero haremos una versi√≥n nativa para no obligarte a instalar librer√≠as extra hoy.

export default function SearchInput({ placeholder }: { placeholder: string }) {
  const searchParams = useSearchParams()
  const pathname = usePathname()
  const { replace } = useRouter()

  // Funci√≥n para manejar el cambio en el input con un peque√±o retraso (Debounce manual)
  const handleSearch = (term: string) => {
    const params = new URLSearchParams(searchParams)
    
    if (term) {
      params.set('query', term)
    } else {
      params.delete('query')
    }
    
    // replace actualiza la URL sin agregar una entrada al historial del navegador
    replace(`${pathname}?${params.toString()}`)
  }

  return (
    <div className="relative flex flex-1 flex-shrink-0">
      <label htmlFor="search" className="sr-only">
        Buscar
      </label>
      <input
        className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 text-sm outline-2 placeholder:text-gray-500 focus:border-blue-500 focus:ring-blue-500"
        placeholder={placeholder}
        onChange={(e) => {
            // Un peque√±o debounce nativo usando timeout si escriben muy r√°pido
            // Nota: En producci√≥n idealmente usamos una librer√≠a como 'use-debounce'
            handleSearch(e.target.value) 
        }}
        defaultValue={searchParams.get('query')?.toString()}
      />
      {/* Icono de Lupa (SVG) */}
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={1.5}
        stroke="currentColor"
        className="absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
        />
      </svg>
    </div>
  )
}

--- File: SettlementButton.tsx (in subfolder: components) ---

// src/components/SettlementButton.tsx
'use client' // üëà Esto permite usar onClick y hooks

import { useFormStatus } from "react-dom"

export default function SettlementButton() {
  // useFormStatus detecta si la Server Action se est√° ejecutando
  const { pending } = useFormStatus()

  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    // Confirmaci√≥n nativa del navegador
    const confirmed = confirm("¬øEst√°s seguro de que vas a entregar el dinero?\n\nEsta acci√≥n marcar√° los items como PAGADOS y no se puede deshacer f√°cilmente.")
    
    if (!confirmed) {
      e.preventDefault() // Cancela el env√≠o del formulario
    }
  }

  return (
    <button
      type="submit"
      onClick={handleClick}
      disabled={pending}
      className={`
        px-8 py-3 rounded-lg font-bold text-lg shadow-lg transition transform 
        ${pending 
          ? 'bg-gray-400 cursor-not-allowed' 
          : 'bg-green-600 hover:bg-green-700 hover:scale-105 text-white'
        }
      `}
    >
      {pending ? "Procesando..." : "‚úÖ Confirmar Pago"}
    </button>
  )
}

--- File: StockMovementForm.tsx (in subfolder: components) ---

// src/components/StockMovementForm.tsx
'use client'

import { useState } from "react"
import { registerStockMovement } from "@/actions/inventory-actions"
import { useRouter } from "next/navigation"

type ProductOption = {
  variantId: string
  productName: string
  ownerName: string
  stock: number
}

export default function StockMovementForm({ products }: { products: ProductOption[] }) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setLoading(true)

    const form = e.currentTarget
    const formData = new FormData(form)

    const result = await registerStockMovement(formData)

    if (result.success) {
      alert("‚úÖ Movimiento registrado correctamente")
      form.reset() // Limpiamos campos
      router.refresh() // Refrescamos datos de fondo
      router.push("/products") // Redirigimos al inventario
    } else {
      alert("‚ùå ERROR: " + result.error)
    }

    setLoading(false)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
          
      {/* SELECCI√ìN DE TIPO DE MOVIMIENTO */}
      <div className="flex flex-col gap-3">
        <label className="block text-sm font-medium text-gray-700">Tipo de Acci√≥n</label>
        
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 bg-gray-50 rounded border">
            {/* Opci√≥n 1: Ingreso */}
            <label className="flex items-center gap-2 cursor-pointer p-2 hover:bg-white rounded border border-transparent hover:border-green-200 transition">
                <input type="radio" name="type" value="ENTRY" defaultChecked className="w-5 h-5 text-green-600 focus:ring-green-500" />
                <span className="font-bold text-green-700 text-sm">üü¢ Ingreso <br/><span className="text-xs font-normal text-gray-500">Nuevo stock</span></span>
            </label>

            {/* Opci√≥n 2: Retiro Due√±o */}
            <label className="flex items-center gap-2 cursor-pointer p-2 hover:bg-white rounded border border-transparent hover:border-orange-200 transition">
                <input type="radio" name="type" value="OWNER_WITHDRAWAL" className="w-5 h-5 text-orange-600 focus:ring-orange-500" />
                <span className="font-bold text-orange-700 text-sm">üü† Retiro Due√±o <br/><span className="text-xs font-normal text-gray-500">Devoluci√≥n</span></span>
            </label>

            {/* Opci√≥n 3: Ajuste/Rotura */}
            <label className="flex items-center gap-2 cursor-pointer p-2 hover:bg-white rounded border border-transparent hover:border-red-200 transition">
                <input type="radio" name="type" value="ADJUSTMENT" className="w-5 h-5 text-red-600 focus:ring-red-500" />
                <span className="font-bold text-red-700 text-sm">üî¥ Baja / Rotura <br/><span className="text-xs font-normal text-gray-500">P√©rdida</span></span>
            </label>
        </div>
      </div>

      {/* SELECCI√ìN DE PRODUCTO */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Producto</label>
        <select 
            name="variantId" 
            required 
            className="w-full border p-3 rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none"
        >
          <option value="">Seleccionar producto...</option>
          {products.map(p => (
            <option key={p.variantId} value={p.variantId}>
              {p.productName} (Stock: {p.stock}) - Due√±o: {p.ownerName}
            </option>
          ))}
        </select>
      </div>

      {/* CANTIDAD */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Cantidad (Unidades)</label>
        <input 
          name="quantity" 
          type="number" 
          min="1" 
          required 
          className="w-full border p-3 rounded text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none" 
          placeholder="Ej: 5"
        />
      </div>

      {/* MOTIVO */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Nota / Motivo (Opcional)</label>
        <input 
          name="reason" 
          type="text" 
          className="w-full border p-3 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
          placeholder="Ej: Remito #1234 / Se rompi√≥ al limpiar"
        />
      </div>

      <button 
        type="submit" 
        disabled={loading}
        className={`w-full py-3 rounded text-white font-bold text-lg shadow-lg transform transition 
            ${loading 
                ? 'bg-slate-400 cursor-wait' 
                : 'bg-slate-800 hover:bg-slate-900 hover:scale-[1.02] active:scale-95'
            }
        `}
      >
        {loading ? "Procesando..." : "Confirmar Movimiento"}
      </button>

    </form>
  )
}

--- File: TicketView.tsx (in subfolder: components) ---

// src/components/TicketView.tsx
'use client'

import { useState, useRef } from "react"
import jsPDF from "jspdf"
import html2canvas from "html2canvas"

type TicketProps = {
  saleId: string
  date: Date
  items: { description: string; quantity: number; price: number }[]
  total: number
  paymentMethod: string
  onClose: () => void // üëà Renombramos onNewSale a onClose para que sea gen√©rico
  mode?: 'POS' | 'HISTORY' // üëà Nuevo: Para saber qu√© texto mostrar
}

export default function TicketView({ saleId, date, items, total, paymentMethod, onClose, mode = 'POS' }: TicketProps) {
  const [downloading, setDownloading] = useState(false)
  const ticketRef = useRef<HTMLDivElement>(null)

  const handleDownloadPDF = async () => {
    const element = ticketRef.current
    if (!element) return

    setDownloading(true)

    try {
      const canvas = await html2canvas(element, {
        scale: 2,
        backgroundColor: "#ffffff",
        logging: false,
        useCORS: true,
        onclone: (documentClone) => {
            const el = documentClone.getElementById('printable-ticket')
            if (el) {
                el.style.backgroundColor = "#ffffff"
                el.style.color = "#000000"
            }
        }
      })

      const imgData = canvas.toDataURL('image/png')
      const pdf = new jsPDF('p', 'mm', 'a4')
      
      const pdfWidth = pdf.internal.pageSize.getWidth()
      const imgWidth = canvas.width
      const imgHeight = canvas.height
      
      const margin = 20
      const finalWidth = pdfWidth - (margin * 2)
      const finalHeight = (imgHeight * finalWidth) / imgWidth

      pdf.addImage(imgData, 'PNG', margin, 20, finalWidth, finalHeight)
      pdf.save(`Ticket_${saleId.slice(0, 8)}.pdf`)

    } catch (error: any) {
      console.error("Error PDF:", error)
      alert("Error al crear PDF.")
    } finally {
      setDownloading(false)
    }
  }

  return (
    <div className="flex flex-col items-center justify-center h-full p-4 animate-in zoom-in-95 duration-300 w-full">
        
        {/* TICKET VISUAL */}
        <div 
            id="printable-ticket"
            ref={ticketRef} 
            className="p-10 rounded-none shadow-xl border w-full max-w-md relative overflow-hidden bg-white text-black"
            style={{ backgroundColor: "#ffffff", color: "#000000" }}
        >
            <div className="text-center mb-8 border-b-2 pb-4" style={{ borderColor: "#1e293b" }}>
                <h2 className="text-3xl font-black tracking-tighter" style={{ color: "#1e293b" }}>GUAPECANES</h2>
                <p className="text-xs uppercase tracking-[0.3em] mt-1" style={{ color: "#64748b" }}>
                    {mode === 'POS' ? 'Comprobante de Venta' : 'Copia de Comprobante'}
                </p>
            </div>

            <div className="grid grid-cols-2 gap-4 text-sm mb-6" style={{ color: "#475569" }}>
                <div>
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>Fecha</p>
                    <p>{new Date(date).toLocaleDateString()}</p>
                </div>
                <div className="text-right">
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>Hora</p>
                    <p>{new Date(date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                </div>
                <div>
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>ID Operaci√≥n</p>
                    <p className="font-mono text-xs">{saleId.slice(0,8)}</p>
                </div>
                <div className="text-right">
                    <p className="font-bold text-xs uppercase" style={{ color: "#94a3b8" }}>Pago</p>
                    <p>{paymentMethod === 'CASH' ? 'Efectivo' : 'Transferencia'}</p>
                </div>
            </div>

            <table className="w-full text-sm mb-6">
                <thead>
                    <tr className="border-b-2 text-xs uppercase" style={{ borderColor: "#f1f5f9", color: "#94a3b8" }}>
                        <th className="text-left py-2">Item</th>
                        <th className="text-right py-2">Total</th>
                    </tr>
                </thead>
                <tbody className="font-medium">
                    {items.map((item, i) => (
                        <tr key={i} className="border-b" style={{ borderColor: "#f8fafc" }}>
                            <td className="py-2">
                                <span className="font-bold mr-2">{item.quantity}x</span>
                                {item.description}
                            </td>
                            <td className="py-2 text-right">${(item.price * item.quantity).toLocaleString()}</td>
                        </tr>
                    ))}
                </tbody>
            </table>

            <div className="p-4 rounded-lg flex justify-between items-center" style={{ backgroundColor: "#f8fafc" }}>
                <span className="text-sm font-bold uppercase" style={{ color: "#64748b" }}>Total a Pagar</span>
                <span className="text-3xl font-black" style={{ color: "#0f172a" }}>${total.toLocaleString()}</span>
            </div>
            
            <div className="mt-8 text-center text-[10px]" style={{ color: "#94a3b8" }}>
               <p>Documento generado electr√≥nicamente.</p>
            </div>
        </div>

        {/* BOTONERA */}
        <div className="mt-8 flex flex-col gap-3 w-full max-w-sm">
            <button 
                onClick={handleDownloadPDF}
                disabled={downloading}
                className={`w-full py-4 rounded-lg font-bold flex items-center justify-center gap-2 shadow-lg transition text-white
                    ${downloading ? 'bg-slate-400 cursor-wait' : 'bg-red-600 hover:bg-red-700'}
                `}
            >
                {downloading ? "Generando PDF..." : "üì• Descargar Comprobante"}
            </button>

            <button 
                onClick={onClose}
                className="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-lg mt-2 shadow transition"
            >
                {mode === 'POS' ? '‚ú® Nueva Venta' : 'Cerrar Vista'}
            </button>
        </div>
    </div>
  )
}

--- File: prisma.ts (in subfolder: lib) ---

// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

--- File: utils.ts (in subfolder: lib) ---

// src/lib/utils.ts

/**
 * Devuelve la fecha actual en Argentina (GMT-3) en formato YYYY-MM-DD.
 * √ötil para inputs type="date".
 */
export function getLocalDateISO() {
  const now = new Date()
  
  // Ajuste manual a GMT-3 (Argentina)
  // getTimezoneOffset() devuelve minutos. Argentina es UTC-3 (180 min).
  // Pero para estar 100% seguros independientemente del servidor, forzamos el c√°lculo:
  const ARGENTINA_OFFSET = -3 * 60 * 60 * 1000 // -3 horas en milisegundos
  
  // Obtenemos el tiempo UTC actual y le restamos 3 horas
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000)
  const argentinaTime = new Date(utc + ARGENTINA_OFFSET)
  
  return argentinaTime.toISOString().split('T')[0]
}

/**
 * Convierte un string "YYYY-MM-DD" y una hora "HH:MM" en un objeto Date
 * que representa ese momento EXACTO en Argentina (GMT-3).
 * El servidor lo guardar√° como UTC, pero el punto en el tiempo ser√° el correcto.
 */
export function buildArgentinaDate(dateStr: string, timeStr: string = "00:00:00"): Date {
    // Si timeStr viene solo como "14:30", le agregamos segundos para cumplir formato ISO
    const timeFull = timeStr.length === 5 ? `${timeStr}:00` : timeStr
    
    // Construimos ISO forzando el offset "-03:00"
    const isoString = `${dateStr}T${timeFull}-03:00`
    
    return new Date(isoString)
}

/**
 * Devuelve el rango de inicio y fin de un d√≠a en Argentina.
 * √ötil para filtros de base de datos (Prisma gte/lte).
 */
export function getArgentinaDayRange(dateStr?: string) {
    const targetDate = dateStr || getLocalDateISO()
    
    // Inicio del d√≠a: 00:00:00.000
    const start = buildArgentinaDate(targetDate, "00:00:00")
    
    // Fin del d√≠a: 23:59:59.999
    // Nota: Usamos buildArgentinaDate base y ajustamos manual o pasamos hora final
    // Para mayor precisi√≥n, seteamos la hora final
    const end = new Date(buildArgentinaDate(targetDate, "23:59:59").getTime() + 999)
    
    return { start, end, dateStr: targetDate }
}

