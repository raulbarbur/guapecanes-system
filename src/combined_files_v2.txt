--- File: middleware.ts (root directory) ---

// src/middleware.ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
import { jwtVerify } from "jose";

// R-01: Validaci√≥n estricta de entorno.
if (!process.env.JWT_SECRET) {
  throw new Error("FATAL: JWT_SECRET no est√° definida en variables de entorno.");
}

const SECRET_KEY = new TextEncoder().encode(process.env.JWT_SECRET);

// Rutas p√∫blicas (No requieren login)
const publicRoutes = ["/login"];

export async function middleware(req: NextRequest) {
  const path = req.nextUrl.pathname;

  // 1. Permitir acceso a archivos est√°ticos y rutas p√∫blicas
  if (
    publicRoutes.includes(path) ||
    path.startsWith("/_next") ||
    path.startsWith("/static") ||
    path.includes(".") // Archivos con extensi√≥n (jpg, ico, png, etc)
  ) {
    return NextResponse.next();
  }

  // 2. Leer la cookie de sesi√≥n
  const session = req.cookies.get("session")?.value;

  // 3. Si no hay sesi√≥n, mandar al Login
  if (!session) {
    return NextResponse.redirect(new URL("/login", req.url));
  }

  try {
    // 4. Verificar criptogr√°ficamente el token
    await jwtVerify(session, SECRET_KEY, {
      algorithms: ["HS256"],
    });

    // ¬°Token v√°lido! Pasa.
    return NextResponse.next();

  } catch (error) {
    // 5. Token inv√°lido o expirado -> Mandar al login y limpiar cookie basura
    const response = NextResponse.redirect(new URL("/login", req.url));
    response.cookies.delete("session");
    return response;
  }
}

// Configuraci√≥n: Ejecutar en todas las rutas excepto API internas y est√°ticos de Next
export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};

--- File: appointment-actions.ts (in subfolder: actions) ---

// src/actions/appointment-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { buildArgentinaDate } from "@/lib/utils"
import { getSession } from "@/lib/auth"

type ApptStatus = 'PENDING' | 'CONFIRMED' | 'COMPLETED' | 'BILLED' | 'CANCELLED'

export async function createAppointment(formData: FormData) {
  const session = await getSession()
  if (!session) return { error: "No autorizado" }

  const petId = formData.get("petId") as string
  const dateStr = formData.get("date") as string // "2024-01-20"
  const timeStr = formData.get("time") as string // "14:30"
  // Si no viene o es 0/NaN, asume 60. Si viene un n√∫mero negativo o gigante, lo captura la variable.
  const duration = parseInt(formData.get("duration") as string) || 60 

  if (!petId || !dateStr || !timeStr) {
    return { error: "Faltan datos (Mascota, Fecha u Hora)" }
  }

  // R-04: Validaci√≥n de rango de duraci√≥n (Sanitizaci√≥n)
  if (duration <= 0 || duration > 480) {
      return { error: "La duraci√≥n del turno debe ser entre 1 y 480 minutos." }
  }

  try {
    // 1. CONSTRUIR FECHAS (Usando utilidad centralizada)
    const startTime = buildArgentinaDate(dateStr, timeStr)
    
    // R-04: Validaci√≥n Temporal (No permitir turnos en el pasado, con tolerancia de 5 min)
    const now = new Date()
    // Restamos 5 min para tolerar peque√±a latencia/desfase del usuario
    const toleranceThreshold = new Date(now.getTime() - 5 * 60000)
    
    // Si la fecha construida es anterior a "hace 5 minutos"
    if (startTime < toleranceThreshold) {
         // Opcional: Solo si es estricto. A veces se cargan turnos retroactivos para historial.
         // Si el requerimiento es estricto PRE-PROD:
         // return { error: "No se pueden agendar turnos en el pasado." }
         // Por ahora, dejamos warning en log o permitimos si es rol ADMIN.
    }

    // Calculamos el final
    const endTime = new Date(startTime.getTime() + duration * 60000)

    if (isNaN(startTime.getTime())) {
      return { error: "Fecha u hora inv√°lida" }
    }

    // 2. VALIDAR COLISIONES
    const collision = await prisma.appointment.findFirst({
      where: {
        status: { not: 'CANCELLED' }, 
        AND: [
          { startTime: { lt: endTime } }, 
          { endTime: { gt: startTime } }  
        ]
      },
      include: { pet: true }
    })

    if (collision) {
        // Formateamos para el mensaje de error
        const collisionStart = collision.startTime.toLocaleTimeString('es-AR', {
            hour: '2-digit', minute:'2-digit', timeZone: 'America/Argentina/Buenos_Aires'
        })
        const collisionEnd = collision.endTime.toLocaleTimeString('es-AR', {
            hour: '2-digit', minute:'2-digit', timeZone: 'America/Argentina/Buenos_Aires'
        })

      return { 
        error: `Horario ocupado por ${collision.pet.name} (${collisionStart} - ${collisionEnd})` 
      }
    }

    // 3. GUARDAR TURNO
    await prisma.appointment.create({
      data: {
        petId,
        startTime,
        endTime,
        status: 'PENDING'
      }
    })

    revalidatePath("/agenda")
    revalidatePath("/dashboard")
    revalidatePath(`/pets/${petId}`) // Refrescamos tambi√©n la ficha de la mascota
    return { success: true }

  } catch (error) {
    console.error("Error agendando:", error)
    return { error: "Error interno al crear turno" }
  }
}

export async function cancelAppointment(formData: FormData) {
    const session = await getSession()
    if (!session) return { error: "No autorizado" }

    const id = formData.get("id") as string

    if (!id) return { error: "ID no provisto" }

    try {
        // 1. LEER ANTES DE ESCRIBIR (Validaci√≥n de Estado)
        const appointment = await prisma.appointment.findUnique({
            where: { id },
            select: { status: true }
        })

        if (!appointment) return { error: "Turno no encontrado" }

        // 2. REGLA DE ORO: No cancelar lo cobrado ni lo completado
        if (appointment.status === 'BILLED') {
            console.warn(`Intento de cancelar turno cobrado: ${id}`)
            return { error: "‚õî No se puede cancelar: El turno ya fue COBRADO. Deb√©s anular la venta en la secci√≥n Ventas." }
        }
        
        if (appointment.status === 'COMPLETED') {
             return { error: "‚ö†Ô∏è El turno ya fue realizado (COMPLETADO). No se puede cancelar." }
        }

        // 3. EJECUTAR CANCELACI√ìN
        await prisma.appointment.update({
            where: { id },
            data: { status: 'CANCELLED' }
        })

        revalidatePath("/agenda")
        revalidatePath("/dashboard")
        return { success: true }

    } catch (error) {
        console.error("Error cancelando:", error)
        return { error: "Error interno al cancelar" }
    }
}

export async function updateAppointmentStatus(id: string, newStatus: ApptStatus) {
    const session = await getSession()
    if (!session) return { error: "No autorizado" }

    try {
        // 1. LEER ESTADO ACTUAL
        const currentAppt = await prisma.appointment.findUnique({
            where: { id },
            select: { status: true }
        })

        if (!currentAppt) return { error: "Turno inexistente" }

        // 2. VALIDACIONES DE TRANSICI√ìN

        // A. Si ya est√° cobrado, es INMUTABLE desde la agenda
        if (currentAppt.status === 'BILLED') {
            return { error: "‚õî Turno cerrado/cobrado. No admite cambios de estado." }
        }

        // B. No permitir pasar a 'BILLED' manualmente (eso lo hace la Caja)
        if (newStatus === 'BILLED') {
            return { error: "‚õî Acci√≥n denegada. El estado 'COBRADO' solo lo asigna el sistema de Caja." }
        }

        // 3. ACTUALIZAR
        await prisma.appointment.update({
            where: { id },
            data: { status: newStatus }
        })

        revalidatePath("/agenda")
        revalidatePath("/dashboard")
        return { success: true }

    } catch (error) {
        console.error("Error cambiando estado:", error)
        return { error: "No se pudo actualizar el estado" }
    }
}

--- File: auth-actions.ts (in subfolder: actions) ---

// src/actions/auth-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { verifyPassword, createSession, deleteSession } from "@/lib/auth"
import { redirect } from "next/navigation"

export async function login(formData: FormData) {
  const email = formData.get("email") as string
  const password = formData.get("password") as string

  if (!email || !password) return { error: "Complet√° todos los campos." }

  try {
    // 1. Buscar usuario
    const user = await prisma.user.findUnique({
      where: { email }
    })

    if (!user) {
      // Por seguridad, mensaje gen√©rico para no revelar si existe el mail
      return { error: "Credenciales inv√°lidas." }
    }

    // 2. Verificar contrase√±a
    const isValid = await verifyPassword(password, user.password)

    if (!isValid) {
      return { error: "Credenciales inv√°lidas." }
    }

    // 3. Crear Sesi√≥n (Cookie)
    await createSession(user.id, user.role, user.name)

  } catch (error) {
    console.error("Login error:", error)
    return { error: "Error intentando iniciar sesi√≥n." }
  }

  // Redirecci√≥n fuera del try/catch (requisito de Next.js)
  redirect("/dashboard")
}

export async function logout() {
  await deleteSession()
  redirect("/login")
}

--- File: bulk-actions.ts (in subfolder: actions) ---

// src/actions/bulk-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { getSession } from "@/lib/auth" 

// Definimos la estructura esperada
type ImportRow = {
  name: string
  variantName?: string 
  categoryName: string
  ownerName: string
  cost: number
  price: number
}

// Helper simple para convertir a Title Case
function toTitleCase(str: string) {
  return str.replace(
    /\w\S*/g,
    (txt) => txt.charAt(0).toUpperCase() + txt.substring(1).toLowerCase()
  )
}

/**
 * L√≥gica central de procesamiento de UN producto dentro de una transacci√≥n.
 * Se extrae para reutilizaci√≥n y consistencia.
 * Lanza errores para provocar rollback si algo falla.
 */
async function processProductRow(tx: any, data: ImportRow, rowIndex: number) {
    // 1. SANITIZACI√ìN
    if (typeof data !== 'object' || data === null) {
        throw new Error(`Fila ${rowIndex}: Datos corruptos o formato inv√°lido.`)
    }

    const name = String(data.name || "").trim()
    const categoryName = String(data.categoryName || "").trim()
    const ownerName = String(data.ownerName || "").trim()
    
    if (!name || !categoryName || !ownerName) {
        throw new Error(`Fila ${rowIndex} (${name}): Faltan datos obligatorios.`)
    }

    const cost = Number(data.cost)
    const price = Number(data.price)

    if (isNaN(cost) || isNaN(price)) {
        throw new Error(`Fila ${rowIndex} (${name}): Importes num√©ricos inv√°lidos.`)
    }

    if (cost < 0 || price < 0) {
        throw new Error(`Fila ${rowIndex} (${name}): No se permiten importes negativos.`)
    }

    if (price < cost) {
        throw new Error(`Fila ${rowIndex} (${name}): Rentabilidad negativa (Precio < Costo).`)
    }

    const variantName = data.variantName && String(data.variantName).trim() !== "" 
        ? String(data.variantName).trim() 
        : "Est√°ndar"

    // 2. DEPENDENCIAS
    // A. Due√±o
    const owner = await tx.owner.findFirst({
        where: { name: { equals: ownerName, mode: 'insensitive' } }
    })

    if (!owner) {
        throw new Error(`Fila ${rowIndex}: Due√±o desconocido "${ownerName}".`)
    }

    // B. Categor√≠a (Upsert manual dentro de la TX)
    const normalizedCategory = toTitleCase(categoryName)
    let category = await tx.category.findFirst({
        where: { name: { equals: normalizedCategory, mode: 'insensitive' } }
    })

    if (!category) {
        category = await tx.category.create({
            data: { name: normalizedCategory } 
        })
    }

    // 3. PRODUCTO Y VARIANTE
    const existingProduct = await tx.product.findFirst({
        where: {
            name: { equals: name, mode: 'insensitive' },
            ownerId: owner.id
        }
    })

    if (existingProduct) {
        // Verificar variante
        const existingVariant = await tx.productVariant.findFirst({
            where: {
                productId: existingProduct.id,
                name: { equals: variantName, mode: 'insensitive' }
            }
        })

        if (!existingVariant) {
            await tx.productVariant.create({
                data: {
                    productId: existingProduct.id,
                    name: variantName,
                    costPrice: cost,
                    salePrice: price,
                    stock: 0,
                    imageUrl: null
                }
            })
        }
        // Si existe, lo omitimos silenciosamente (Idempotencia)
    } else {
        // Crear Padre + Hijo
        await tx.product.create({
            data: {
                name: name,
                categoryId: category.id,
                ownerId: owner.id,
                isActive: true,
                variants: {
                    create: {
                        name: variantName,
                        costPrice: cost,
                        salePrice: price,
                        stock: 0,
                        imageUrl: null
                    }
                }
            }
        })
    }
}

// --- ACTIONS P√öBLICAS ---

export async function importSingleProduct(data: ImportRow) {
  try {
    const session = await getSession()
    if (!session || session.role !== 'ADMIN') {
        return { success: false, error: "Requiere permisos de Administrador." }
    }

    // Reutilizamos la l√≥gica envolvi√©ndola en una transacci√≥n unitaria
    await prisma.$transaction(async (tx) => {
        await processProductRow(tx, data, 1)
    })

    return { success: true }

  } catch (error: any) {
    console.error("Error importando single:", error)
    return { success: false, error: error.message || "Error interno." }
  }
}

// R-03: Nueva acci√≥n para procesamiento por lotes
export async function importProductBatch(rows: ImportRow[]) {
    const session = await getSession()
    if (!session || session.role !== 'ADMIN') {
        return { success: false, error: "Requiere permisos de Administrador." }
    }

    if (!Array.isArray(rows) || rows.length === 0) {
        return { success: false, error: "Lote vac√≠o o inv√°lido." }
    }

    try {
        // Ejecutamos todo el lote en una √∫nica transacci√≥n at√≥mica
        // Si una fila falla, todo el lote se revierte (All-or-Nothing)
        await prisma.$transaction(async (tx) => {
            for (let i = 0; i < rows.length; i++) {
                // Pasamos i + 1 para que el mensaje de error tenga sentido humano (Fila 1, no Fila 0)
                await processProductRow(tx, rows[i], i + 1)
            }
        }, {
            timeout: 20000 // Aumentamos timeout a 20s para lotes grandes
        })

        return { success: true, count: rows.length }

    } catch (error: any) {
        console.error("Error en batch:", error)
        // Retornamos el error exacto que lanz√≥ processProductRow
        return { success: false, error: error.message || "Error procesando el lote." }
    }
}

--- File: category-actions.ts (in subfolder: actions) ---

// src/actions/category-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { getSession } from "@/lib/auth"

export async function createCategory(formData: FormData) {
  const session = await getSession()
  // Mantenemos la estructura de error consistente con este archivo
  if (!session) return { success: false, error: "No autorizado" }

  const name = formData.get("name") as string

  if (!name) return

  try {
    await prisma.category.create({
      data: { name }
    })
    
    revalidatePath("/categories")
    return { success: true }
  
  } catch (error) {
    // Si el error es porque ya existe (c√≥digo P2002 de Prisma), no hacemos nada
    console.error("Error creando categor√≠a:", error)
    return { success: false, error: "Error al crear (¬øQuiz√°s ya existe?)" }
  }
}

--- File: customer-actions.ts (in subfolder: actions) ---

// src/actions/customer-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { getSession } from "@/lib/auth"

export async function createCustomer(formData: FormData) {
  const name = formData.get("name") as string
  const phone = formData.get("phone") as string
  const email = formData.get("email") as string
  const address = formData.get("address") as string

  if (!name) return { error: "El nombre es obligatorio" }

  try {
    // 1. Guardamos el resultado en una variable
    const newCustomer = await prisma.customer.create({
      data: {
        name,
        phone: phone || null,
        email: email || null,
        address: address || null
      }
    })

    revalidatePath("/customers")
    revalidatePath("/pos") 
    
    // 2. Retornamos el cliente creado junto con el √©xito
    return { success: true, customer: newCustomer }

  } catch (error) {
    console.error("Error creando cliente:", error)
    return { error: "Error interno al crear cliente." }
  }
}


export async function updateCustomer(formData: FormData) {
  const id = formData.get("id") as string
  const name = formData.get("name") as string
  const phone = formData.get("phone") as string
  const email = formData.get("email") as string
  const address = formData.get("address") as string

  if (!id || !name) return { error: "Faltan datos obligatorios." }

  try {
    await prisma.customer.update({
      where: { id },
      data: {
        name,
        phone: phone || null,
        email: email || null,
        address: address || null
      }
    })

    revalidatePath("/customers")
    revalidatePath(`/customers/${id}`)
    revalidatePath("/pos")
    return { success: true }

  } catch (error) {
    console.error("Error actualizando cliente:", error)
    return { error: "Error al actualizar." }
  }
}

export async function deleteCustomer(formData: FormData) {
  const id = formData.get("id") as string

  if (!id) return { error: "ID requerido" }

  try {
    const pendingDebts = await prisma.sale.count({
        where: {
            customerId: id,
            paymentStatus: 'PENDING'
        }
    })

    if (pendingDebts > 0) {
        return { error: "‚õî No se puede eliminar: El cliente tiene deuda activa (Fiado). Debe saldarla o anular las ventas antes de borrar." }
    }

    const customerWithHistory = await prisma.customer.findUnique({
        where: { id },
        include: { _count: { select: { sales: true } } }
    })

    if (customerWithHistory && customerWithHistory._count.sales > 0) {
        return { error: "‚õî No se puede eliminar: El cliente tiene historial de compras asociado." }
    }

    await prisma.customer.delete({ where: { id } })
    
    revalidatePath("/customers")
    revalidatePath("/pos")
    return { success: true }

  } catch (error) {
    console.error("Error eliminando cliente:", error)
    return { error: "No se pudo eliminar el cliente." }
  }
}

// FUNCION COBRAR DEUDA
export async function markSaleAsPaid(saleId: string) {
    const session = await getSession()
    if (!session) return { error: "No autorizado" }

    try {
        const currentSale = await prisma.sale.findUnique({
            where: { id: saleId },
            select: { paymentStatus: true }
        })

        if (!currentSale) return { error: "Venta no encontrada" }

        if (currentSale.paymentStatus === 'PAID') {
            return { success: true, message: "Venta ya estaba cobrada previamente" }
        }

        await prisma.sale.update({
            where: { id: saleId },
            data: { 
                paymentStatus: 'PAID',
                paidAt: new Date()
            }
        })

        revalidatePath("/customers")
        revalidatePath("/sales") 
        return { success: true }
    } catch (error) {
        return { error: "Error al registrar el pago." }
    }
}

--- File: export-actions.ts (in subfolder: actions) ---

// src/actions/export-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import ExcelJS from "exceljs"
import { getSession } from "@/lib/auth"

export async function exportProducts(mode: 'TEMPLATE' | 'FULL') {
  // R-01: Blindaje de seguridad RBAC
  const session = await getSession()
  // Validamos existencia de sesi√≥n Y rol de administrador
  if (!session || session.role !== 'ADMIN') {
    return { success: false, error: "Requiere permisos de Administrador." }
  }

  try {
    // 1. Crear Libro y Hoja
    const workbook = new ExcelJS.Workbook()
    const worksheet = workbook.addWorksheet("Productos")

    // 2. Definir Columnas (Mismo orden que el Importador)
    worksheet.columns = [
      { header: "Nombre Producto", key: "name", width: 30 },
      { header: "Variante", key: "variant", width: 20 },
      { header: "Categor√≠a", key: "category", width: 20 },
      { header: "Nombre Due√±o", key: "owner", width: 20 },
      { header: "Costo", key: "cost", width: 15 },
      { header: "Precio Venta", key: "price", width: 15 },
    ]

    // Estilar la cabecera (Negrita y fondo gris)
    const headerRow = worksheet.getRow(1)
    headerRow.font = { bold: true }
    headerRow.fill = {
      type: "pattern",
      pattern: "solid",
      fgColor: { argb: "FFE0E0E0" }
    }

    // 3. Si es FULL, llenamos con datos
    if (mode === 'FULL') {
      // R-02: L√≠mite de seguridad para prevenir OOM (Out of Memory)
      const SAFE_LIMIT = 2000 
      
      const products = await prisma.product.findMany({
        where: { isActive: true }, // Solo activos
        include: {
          category: true,
          owner: true,
          variants: true
        },
        orderBy: { name: 'asc' },
        take: SAFE_LIMIT // üëà L√≠mite preventivo
      })

      // APLANAMOS LA DATA (Flatten)
      for (const p of products) {
        for (const v of p.variants) {
          worksheet.addRow({
            name: p.name,
            variant: v.name === "Est√°ndar" ? "" : v.name, // Dejamos vac√≠o si es est√°ndar para limpieza visual
            category: p.category.name,
            owner: p.owner.name,
            cost: Number(v.costPrice),
            price: Number(v.salePrice)
          })
        }
      }
    }

    // 4. Generar Buffer y convertir a Base64
    const buffer = await workbook.xlsx.writeBuffer()
    const base64 = Buffer.from(buffer).toString("base64")
    
    const filename = mode === 'FULL' 
        ? `Inventario_Guapecanes_${new Date().toISOString().split('T')[0]}.xlsx`
        : `Plantilla_Carga_Productos.xlsx`

    return { success: true, base64, filename }

  } catch (error) {
    console.error("Error exportando:", error)
    return { success: false, error: "Error al generar el archivo Excel (Posible exceso de datos)." }
  }
}

--- File: inventory-actions.ts (in subfolder: actions) ---

// src/actions/inventory-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { getVariantStockHistory, translateMovementType } from "@/services/inventory-service"
import { StockMovementType } from "@prisma/client"
import { getSession } from "@/lib/auth" // üëà Auth

export async function registerStockMovement(formData: FormData) {
  // 1. AUTENTICACI√ìN
  const session = await getSession()
  if (!session) return { error: "Sesi√≥n no v√°lida" }

  const variantId = formData.get("variantId") as string
  const reason = formData.get("reason") as string
  const typeStr = formData.get("type") as string // Viene como string del form
  const rawQuantity = parseInt(formData.get("quantity") as string)

  // Mapeo seguro de String -> Enum Prisma
  // Validamos que sea uno de los tipos permitidos manualmente
  const allowedTypes = ["ENTRY", "OWNER_WITHDRAWAL", "ADJUSTMENT"]
  if (!allowedTypes.includes(typeStr)) {
      return { error: "Tipo de movimiento inv√°lido" }
  }
  const type = typeStr as StockMovementType

  if (!variantId || isNaN(rawQuantity) || rawQuantity <= 0) {
    return { error: "Datos incorrectos." }
  }

  try {
    let finalQuantity = rawQuantity
    // Ajustes y Retiros restan
    if (type === "OWNER_WITHDRAWAL" || type === "ADJUSTMENT") {
        finalQuantity = -rawQuantity
    }

    // Obtener variante para chequear stock
    const currentVariant = await prisma.productVariant.findUnique({
        where: { id: variantId },
        include: { product: true }
    })

    if (!currentVariant) return { error: "Producto no encontrado." }

    // Validaci√≥n de stock negativo
    if (finalQuantity < 0) {
      const quantityNeeded = Math.abs(finalQuantity)
      if (currentVariant.stock < quantityNeeded) {
        return { error: `Stock insuficiente. Ten√©s ${currentVariant.stock}.` }
      }
    }

    await prisma.$transaction([
      prisma.stockMovement.create({
        data: {
          variantId,
          quantity: finalQuantity,
          type: type, 
          reason: reason || getDefaultReason(type),
          userId: session.userId, // üëà EL USUARIO LOGUEADO
        }
      }),

      prisma.productVariant.update({
        where: { id: variantId },
        data: { stock: { increment: finalQuantity } }
      })
    ])

    revalidatePath("/products")
    revalidatePath("/inventory")
    revalidatePath("/dashboard")

    return { success: true }

  } catch (error) {
    console.error("Error gestionando stock:", error)
    return { error: "Error interno" }
  }
}

function getDefaultReason(type: string): string {
    switch (type) {
        case "ENTRY": return "Ingreso de mercader√≠a"
        case "OWNER_WITHDRAWAL": return "Retiro de due√±o"
        case "ADJUSTMENT": return "Baja por rotura/p√©rdida"
        default: return "Movimiento de stock"
    }
}

// Lectura p√∫blica (usada en detalle de producto)
export async function getHistory(variantId: string) {
    if (!variantId) return { error: "ID requerido" }
    try {
        const rawHistory = await getVariantStockHistory(variantId)
        const history = rawHistory.map(h => ({
            ...h,
            typeLabel: translateMovementType(h.type)
        }))
        return { success: true, data: history }
    } catch (error) {
        return { error: "Error al obtener datos" }
    }
}

--- File: inventory-bulk-actions.ts (in subfolder: actions) ---

// src/actions/inventory-bulk-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

type StockImportRow = {
  variantId: string
  quantity: number
  reason: string
}

export async function bulkUpdateStock(rows: StockImportRow[]) {
  let successCount = 0
  let errorCount = 0
  const errors: string[] = []

  try {
    // Usamos transaction para asegurar integridad, pero dado que puede ser mucha data,
    // procesaremos en lote. Si falla uno, no queremos que fallen todos en este caso de uso masivo,
    // as√≠ que iteramos.
    
    for (const row of rows) {
      // 1. Validaciones b√°sicas
      if (!row.variantId) continue;
      if (row.quantity === 0 || isNaN(row.quantity)) continue; // Ignoramos filas vac√≠as o 0

      // 2. Ejecutar Movimiento
      try {
        await prisma.$transaction([
            // A. Registrar Historial
            prisma.stockMovement.create({
                data: {
                    variantId: row.variantId,
                    quantity: row.quantity, // Puede ser positivo (entrada) o negativo (ajuste)
                    type: row.quantity > 0 ? "ENTRY" : "ADJUSTMENT",
                    reason: row.reason || "Carga Masiva Excel",
                    userId: "sistema"
                }
            }),
            // B. Actualizar Contador
            prisma.productVariant.update({
                where: { id: row.variantId },
                data: { stock: { increment: row.quantity } }
            })
        ])
        successCount++
      } catch (err) {
        errorCount++
        errors.push(`ID ${row.variantId}: Fall√≥ actualizaci√≥n.`)
      }
    }

    revalidatePath("/inventory")
    revalidatePath("/products")

    return { success: true, count: successCount, errors }

  } catch (error) {
    console.error("Error bulk stock:", error)
    return { success: false, error: "Error cr√≠tico en el servidor." }
  }
}

--- File: inventory-export-actions.ts (in subfolder: actions) ---

// src/actions/inventory-export-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import ExcelJS from "exceljs"

export async function exportInventorySheet() {
  try {
    const workbook = new ExcelJS.Workbook()
    const worksheet = workbook.addWorksheet("Carga de Stock")

    // Columnas
    worksheet.columns = [
      { header: "ID_VARIANTE (NO TOCAR)", key: "id", width: 32 }, // Columna t√©cnica
      { header: "Producto", key: "productName", width: 25 },
      { header: "Variante", key: "variantName", width: 15 },
      { header: "Due√±o", key: "ownerName", width: 20 },
      { header: "Stock Actual", key: "currentStock", width: 12 },
      { header: "CANTIDAD A SUMAR", key: "quantity", width: 20 }, // Aqu√≠ escribe el usuario
      { header: "MOTIVO (Opcional)", key: "reason", width: 25 },
    ]

    // Estilo Cabecera
    worksheet.getRow(1).font = { bold: true }
    worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0E0E0' } }

    // Obtenemos datos
    const variants = await prisma.productVariant.findMany({
      where: { product: { isActive: true } },
      include: { product: { include: { owner: true } } },
      orderBy: { product: { name: 'asc' } }
    })

    // Llenamos filas
    for (const v of variants) {
      worksheet.addRow({
        id: v.id,
        productName: v.product.name,
        variantName: v.name === 'Est√°ndar' ? '-' : v.name,
        ownerName: v.product.owner.name,
        currentStock: v.stock,
        quantity: "", // Vac√≠o para que el usuario complete
        reason: "Ingreso Masivo"
      })
    }

    // Protegemos las columnas informativas para evitar errores (opcional, pero buena pr√°ctica)
    // worksheet.getColumn('A').hidden = true; // Podr√≠amos ocultar el ID, pero mejor dejarlo visible por transparencia

    const buffer = await workbook.xlsx.writeBuffer()
    const base64 = Buffer.from(buffer).toString("base64")
    
    return { 
        success: true, 
        base64, 
        filename: `Planilla_Stock_${new Date().toISOString().split('T')[0]}.xlsx` 
    }

  } catch (error) {
    console.error("Error exportando stock:", error)
    return { success: false, error: "Error generando planilla." }
  }
}

--- File: note-actions.ts (in subfolder: actions) ---

// src/actions/note-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createNote(formData: FormData) {
  const petId = formData.get("petId") as string
  const content = formData.get("content") as string

  if (!petId || !content) return

  try {
    await prisma.groomingNote.create({
      data: {
        petId,
        content
      }
    })

    // Revalidamos la ruta din√°mica espec√≠fica de esa mascota
    revalidatePath(`/pets/${petId}`)
    return { success: true }

  } catch (error) {
    console.error("Error creando nota:", error)
    return { error: "Error al guardar la nota" }
  }
}

export async function deleteNote(formData: FormData) {
    const id = formData.get("id") as string
    const petId = formData.get("petId") as string
    
    try {
        await prisma.groomingNote.delete({ where: { id } })
        revalidatePath(`/pets/${petId}`)
    } catch (e) {
        console.error(e)
    }
}

--- File: owner-actions.ts (in subfolder: actions) ---

// src/actions/owner-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"

export async function createOwner(formData: FormData) {
  const name = formData.get("name") as string
  const email = formData.get("email") as string
  const phone = formData.get("phone") as string

  if (!name) return { error: "El nombre es obligatorio" }

  try {
    await prisma.owner.create({
      data: { name, email, phone, isActive: true },
    })
    revalidatePath("/owners")
    return { success: true }
  } catch (error) {
    return { error: "Error creando due√±o" }
  }
}

export async function updateOwner(formData: FormData) {
  const id = formData.get("id") as string
  const name = formData.get("name") as string
  const email = formData.get("email") as string
  const phone = formData.get("phone") as string

  if (!id || !name) return { error: "Faltan datos" }

  try {
    await prisma.owner.update({
      where: { id },
      data: { name, email, phone },
    })
    
    revalidatePath("/owners")
    return { success: true }
  } catch (error) {
    console.error(error)
    return { error: "Error actualizando due√±o" }
  }
}

--- File: pet-actions.ts (in subfolder: actions) ---

// src/actions/pet-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { getSession } from "@/lib/auth"

export async function createPet(formData: FormData) {
  const session = await getSession()
  if (!session) return { error: "No autorizado" }

  const name = formData.get("name") as string
  const breed = formData.get("breed") as string
  const ownerName = formData.get("ownerName") as string
  const ownerPhone = formData.get("ownerPhone") as string
  const notes = formData.get("notes") as string

  // Validaci√≥n b√°sica
  if (!name || !ownerName || !ownerPhone) {
    return { error: "Faltan datos obligatorios (Nombre, Due√±o, Tel√©fono)" }
  }

  try {
    await prisma.pet.create({
      data: {
        name,
        breed: breed || "Mestizo",
        ownerName,
        ownerPhone,
        notes
      }
    })

    revalidatePath("/pets")
    return { success: true }

  } catch (error) {
    console.error("Error creando mascota:", error)
    return { error: "Error al guardar la ficha." }
  }
}

export async function deletePet(id: string) {
    const session = await getSession()
    if (!session) return { error: "No autorizado" }

    try {
        // R-05: Verificaci√≥n de Integridad de Agenda
        // No permitir borrado si hay turnos pendientes o confirmados a futuro.
        const activeAppointments = await prisma.appointment.findFirst({
            where: {
                petId: id,
                status: { in: ['PENDING', 'CONFIRMED'] }
            }
        })

        if (activeAppointments) {
            return { error: "‚õî No se puede eliminar: La mascota tiene turnos activos en la agenda. Cancele los turnos primero." }
        }

        await prisma.pet.delete({ where: { id } })
        revalidatePath("/pets")
        return { success: true }

    } catch (error) {
        // Captura error gen√©rico o constraints de FK residuales
        console.error("Error eliminando mascota:", error)
        return { error: "No se puede eliminar la mascota (Posible historial asociado)." }
    }
}

--- File: product-actions.ts (in subfolder: actions) ---

// src/actions/product-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"
import { getSession } from "@/lib/auth" // üëà Importamos seguridad

// --- TIPOS INTERNOS ---
type VariantInput = {
    id?: string
    name: string
    costPrice: number
    salePrice: number
}

// --- HELPERS DE VALIDACI√ìN ---

// 1. Resolver Categor√≠a (Existente o Nueva)
async function resolveCategoryId(formData: FormData): Promise<string | null> {
    const isNewCategory = formData.get("isNewCategory") === "true"
    if (isNewCategory) {
        const newName = formData.get("categoryName") as string
        if (!newName || newName.trim() === "") return null
        
        // Buscamos case-insensitive para no duplicar "Juguetes" y "juguetes"
        const existing = await prisma.category.findFirst({
            where: { name: { equals: newName, mode: 'insensitive' } }
        })
        if (existing) return existing.id
        
        const created = await prisma.category.create({ data: { name: newName.trim() } })
        return created.id
    }
    return formData.get("categoryId") as string
}

// 2. Validar Reglas de Negocio Financieras
function validateVariants(variants: VariantInput[]): string | null {
    if (!Array.isArray(variants) || variants.length === 0) {
        return "Debe haber al menos una variante."
    }

    for (const v of variants) {
        const cost = Number(v.costPrice)
        const price = Number(v.salePrice)

        // A. Validaci√≥n de Tipo
        if (isNaN(cost) || isNaN(price)) {
            return `Error en variante "${v.name}": Precios inv√°lidos.`
        }

        // B. Validaci√≥n de Signo (No negativos)
        if (cost < 0 || price < 0) {
            return `Error en variante "${v.name}": Los importes no pueden ser negativos.`
        }

        // C. Regla de Oro: Rentabilidad (Precio >= Costo)
        if (price < cost) {
            return `Rentabilidad negativa en "${v.name}". Costo ($${cost}) es mayor a Venta ($${price}).`
        }

        // D. Validaci√≥n de Nombre
        if (!v.name || v.name.trim() === "") {
            return "Todas las variantes deben tener un nombre."
        }
    }

    return null // null significa que pas√≥ todas las validaciones
}


// --- ACTIONS P√öBLICAS PROTEGIDAS ---

export async function createProduct(formData: FormData) {
  // R-03: Verificaci√≥n de sesi√≥n
  const session = await getSession()
  if (!session) return { error: "Sesi√≥n expirada. Por favor, logueate nuevamente." }

  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const ownerId = formData.get("ownerId") as string
  const imageUrl = formData.get("imageUrl") as string 
  const variantsJson = formData.get("variantsJson") as string

  // 1. Validaciones de Estructura
  const categoryId = await resolveCategoryId(formData)
  if (!name || !ownerId || !categoryId) return { error: "Faltan datos obligatorios." }

  let variants: VariantInput[] = []
  try {
    variants = JSON.parse(variantsJson || "[]")
  } catch (e) {
    return { error: "Error procesando variantes (JSON inv√°lido)." }
  }

  // 2. Validaciones de Negocio (Fail Fast)
  const validationError = validateVariants(variants)
  if (validationError) {
      return { error: validationError }
  }

  try {
    await prisma.$transaction(async (tx) => {
      // 3. Crear Producto Cabecera
      const newProduct = await tx.product.create({
        data: {
          name,
          description,
          ownerId,
          categoryId,
          isActive: true
        }
      })

      // 4. Crear Variantes
      for (const v of variants) {
        await tx.productVariant.create({
            data: {
                productId: newProduct.id,
                name: v.name,
                imageUrl: imageUrl || null,
                costPrice: v.costPrice,
                salePrice: v.salePrice,
                stock: 0 
            }
        })
      }
    })

    revalidatePath("/products")
  } catch (error) {
    console.error("Error creando:", error)
    return { error: "Error interno al guardar producto." }
  }
  
  redirect("/products")
}

export async function updateProduct(formData: FormData) {
  // R-03: Verificaci√≥n de sesi√≥n
  const session = await getSession()
  if (!session) return { error: "No autorizado." }

  const id = formData.get("id") as string
  const name = formData.get("name") as string
  const description = formData.get("description") as string
  const ownerId = formData.get("ownerId") as string
  const imageUrl = formData.get("imageUrl") as string
  const variantsJson = formData.get("variantsJson") as string
  
  const categoryId = await resolveCategoryId(formData)
  if (!id || !name || !categoryId) return { error: "Datos faltantes" }

  let variants: VariantInput[] = []
  try {
    variants = JSON.parse(variantsJson || "[]")
  } catch (e) {
    return { error: "Error en variantes." }
  }

  // 1. Validaciones de Negocio (Fail Fast)
  const validationError = validateVariants(variants)
  if (validationError) {
      return { error: validationError }
  }

  try {
    await prisma.$transaction(async (tx) => {
      // 2. Actualizar Cabecera
      await tx.product.update({
        where: { id },
        data: { name, description, categoryId, ownerId }
      })

      // 3. Upsert Manual de Variantes
      for (const v of variants) {
        if (v.id) {
            await tx.productVariant.update({
                where: { id: v.id },
                data: {
                    name: v.name,
                    costPrice: v.costPrice,
                    salePrice: v.salePrice,
                    imageUrl: imageUrl || undefined 
                }
            })
        } else {
            await tx.productVariant.create({
                data: {
                    productId: id,
                    name: v.name,
                    costPrice: v.costPrice,
                    salePrice: v.salePrice,
                    stock: 0,
                    imageUrl: imageUrl || null
                }
            })
        }
      }
    })

    revalidatePath("/products")
    revalidatePath("/pos") 
    return { success: true }

  } catch (error: any) {
    console.error("Error actualizando:", error)
    if (error.code === 'P2002') {
        return { error: "No pueden haber dos variantes con el mismo nombre." }
    }
    return { error: "No se pudo actualizar el producto." }
  }
}

export async function toggleProductStatus(productId: string, currentStatus: boolean) {
  // R-03: Verificaci√≥n de sesi√≥n
  const session = await getSession()
  if (!session) return { error: "No autorizado." }

  try {
    if (currentStatus === true) { 
      const variantWithStock = await prisma.productVariant.findFirst({ 
        where: { productId, stock: { gt: 0 } }
      })
      if (variantWithStock) {
        return { error: "No se puede archivar: Hay variantes con stock." }
      }
    }
    await prisma.product.update({
      where: { id: productId },
      data: { isActive: !currentStatus }
    })
    revalidatePath("/products")
    revalidatePath("/pos")
    return { success: true }
  } catch (error) {
    return { error: "Error cambiando estado" }
  }
}

--- File: sale-actions.ts (in subfolder: actions) ---

// src/actions/sale-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { StockMovementType, PaymentStatus } from "@prisma/client"
import { getSession } from "@/lib/auth"

type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string
  description: string
  price: number
  quantity: number
}

type PaymentMethodStr = "CASH" | "TRANSFER" | "CHECKING_ACCOUNT"

// R-06: Helper de redondeo para evitar errores de punto flotante
const round = (num: number) => Math.round(num * 100) / 100

export async function processSale(
    cart: CartItem[], 
    totalEstimado: number, 
    paymentMethod: PaymentMethodStr,
    customerId?: string
) {
  // 1. SEGURIDAD
  const session = await getSession()
  if (!session) return { error: "Sesi√≥n expirada. Inici√° sesi√≥n nuevamente." }

  if (cart.length === 0) return { error: "El carrito est√° vac√≠o" }

  try {
    let createdSaleId = ""
    let createdDate = new Date()

    const paymentStatus: PaymentStatus = paymentMethod === 'CHECKING_ACCOUNT' 
        ? 'PENDING' 
        : 'PAID'
    
    const paidAt = paymentStatus === 'PAID' ? new Date() : null

    if (paymentStatus === 'PENDING' && !customerId) {
        return { error: "Para fiar (Cuenta Corriente) deb√©s seleccionar un cliente." }
    }

    // R-04: Sanitizaci√≥n. Ignoramos precios del cliente para Productos.
    const productIds = cart.filter(i => i.type === 'PRODUCT').map(i => i.id)
    
    const dbVariants = await prisma.productVariant.findMany({
      where: { id: { in: productIds } },
      include: { product: true }
    })

    await prisma.$transaction(async (tx) => {
      let totalReal = 0
      const saleItemsData = []
      const stockMovementsData = [] 
      const appointmentIdsToBill: string[] = []

      for (const item of cart) {
        if (item.type === 'PRODUCT') {
            const variant = dbVariants.find(v => v.id === item.id)
            if (!variant) throw new Error(`Producto no encontrado o inactivo: ${item.description}`)
            
            // R-04: Sanitizaci√≥n de Cantidad
            if (item.quantity <= 0 || isNaN(item.quantity)) {
                throw new Error(`Cantidad inv√°lida para producto: ${item.description}`)
            }

            // VALIDACI√ìN DE STOCK
            const updateResult = await tx.productVariant.updateMany({
                where: { 
                    id: item.id,
                    stock: { gte: item.quantity } 
                },
                data: { 
                    stock: { decrement: item.quantity } 
                }
            })

            if (updateResult.count === 0) {
                throw new Error(`Stock insuficiente para: ${variant.product.name}. Refresc√° la p√°gina.`)
            }

            // R-04: Usamos precio de DB
            const currentPrice = Number(variant.salePrice)
            
            // R-06: Redondeo expl√≠cito a nivel de l√≠nea (SUBTOTAL)
            // Esto asegura que 3 items de $33.33 den $99.99 exactos y no $99.99000001
            const subtotal = round(currentPrice * item.quantity)
            totalReal = round(totalReal + subtotal)

            saleItemsData.push({
                variantId: variant.id,
                description: variant.product.name,
                quantity: item.quantity,
                costAtSale: variant.costPrice, // Prisma maneja Decimal, le pasamos number/string
                priceAtSale: currentPrice,
                settledQuantity: 0
            })

            stockMovementsData.push({
                variantId: variant.id,
                quantity: -item.quantity,
                type: StockMovementType.SALE,
                reason: paymentStatus === 'PENDING' ? "Venta Cta. Cte." : "Venta Mostrador",
                userId: session.userId 
            })
        } 
        else if (item.type === 'SERVICE') {
            // R-04: Validaci√≥n de precios manuales
            if (item.price < 0 || isNaN(item.price)) {
                throw new Error(`Precio de servicio inv√°lido: ${item.description}`)
            }
            if (item.quantity <= 0) throw new Error(`Cantidad inv√°lida para servicio.`)

            // R-06: Redondeo para servicios
            const subtotal = round(item.price * item.quantity)
            totalReal = round(totalReal + subtotal)

            saleItemsData.push({
                variantId: null,
                description: item.description,
                quantity: item.quantity,
                costAtSale: 0,
                priceAtSale: item.price,
                settledQuantity: 0
            })

            appointmentIdsToBill.push(item.id)
        }
      }

      // Registro de Movimientos de Stock
      if (stockMovementsData.length > 0) {
          await tx.stockMovement.createMany({ data: stockMovementsData })
      }

      // Creaci√≥n de la Venta con TOTAL REAL redondeado
      const sale = await tx.sale.create({
        data: {
          total: totalReal,
          paymentMethod: paymentMethod, 
          status: "COMPLETED",
          paymentStatus: paymentStatus,
          paidAt: paidAt,
          customerId: customerId || null,
          items: { create: saleItemsData }
        }
      })
      
      createdSaleId = sale.id
      createdDate = sale.createdAt

      if (appointmentIdsToBill.length > 0) {
        await tx.appointment.updateMany({
            where: { id: { in: appointmentIdsToBill } },
            data: { status: 'BILLED' }
        })
      }

    }, { maxWait: 5000, timeout: 10000 })

    revalidatePath("/products")
    revalidatePath("/pos")
    revalidatePath("/dashboard")
    revalidatePath("/sales")
    if (customerId) revalidatePath(`/customers/${customerId}`)
    
    return { success: true, saleId: createdSaleId, date: createdDate }

  } catch (error: any) {
    console.error("Error en venta:", error)
    return { error: error.message || "Error al procesar venta" }
  }
}

export async function markSaleAsPaid(saleId: string) {
    const session = await getSession()
    if (!session) return { error: "No autorizado" }

    try {
        const currentSale = await prisma.sale.findUnique({
          where: { id: saleId },
          select: { paymentStatus: true }
        })

        if (!currentSale) return { error: "Venta no encontrada" }
        
        if (currentSale.paymentStatus === 'PAID') {
          return { success: true, message: "Venta ya estaba cobrada previamente" }
        }

        await prisma.sale.update({
            where: { id: saleId },
            data: {
                paymentStatus: 'PAID',
                paidAt: new Date()
            }
        })

        revalidatePath("/dashboard")
        revalidatePath("/sales")
        return { success: true }
    } catch (error) {
        return { error: "Error al actualizar pago" }
    }
}

export async function cancelSale(saleId: string) {
  const session = await getSession()
  if (!session) return { error: "No autorizado" }

  try {
    await prisma.$transaction(async (tx) => {
      const sale = await tx.sale.findUnique({
        where: { id: saleId },
        include: { items: { include: { variant: { include: { product: true } } } } } 
      })

      if (!sale) throw new Error("Venta no encontrada")
      if (sale.status === 'CANCELLED') throw new Error("Ya est√° anulada")

      await tx.sale.update({
        where: { id: saleId },
        data: { status: 'CANCELLED' }
      })

      const movementsToCreate = []
      const adjustmentsToCreate = []

      for (const item of sale.items) {
        if (item.variantId && item.variant) {
          
          await tx.productVariant.update({
            where: { id: item.variantId },
            data: { stock: { increment: item.quantity } }
          })

          movementsToCreate.push({
            variantId: item.variantId,
            quantity: item.quantity,
            type: StockMovementType.SALE_CANCELLED,
            reason: `Anulaci√≥n Venta #${sale.id.slice(0, 8)}`,
            userId: session.userId 
          })

          if (item.settledQuantity > 0) {
            // R-06: Redondeo tambi√©n en anulaciones
            const amountOwedBack = round(Number(item.costAtSale) * item.settledQuantity)
            
            adjustmentsToCreate.push({
                ownerId: item.variant.product.ownerId,
                amount: -amountOwedBack, 
                description: `Devoluci√≥n Liq. - Prod: ${item.description}`,
                isApplied: false
            })
          }
        }
      }

      if (movementsToCreate.length > 0) {
          await tx.stockMovement.createMany({ data: movementsToCreate })
      }
      
      if (adjustmentsToCreate.length > 0) {
          await tx.balanceAdjustment.createMany({ data: adjustmentsToCreate })
      }

    })

    revalidatePath("/sales")
    revalidatePath("/products") 
    revalidatePath("/owners/balance")
    return { success: true }

  } catch (error: any) {
    return { error: error.message }
  }
}

--- File: settlement-actions.ts (in subfolder: actions) ---

// src/actions/settlement-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"
import { getSession } from "@/lib/auth"

type SettlementItemInput = {
  id: string
  type: 'SALE' | 'ADJUSTMENT'
  quantity?: number 
}

// R-06: Helper de redondeo para moneda
const round = (num: number) => Math.round(num * 100) / 100

export async function createSettlement(formData: FormData) {
  // R-01: Blindaje de seguridad
  const session = await getSession()
  if (!session || session.role !== 'ADMIN') {
    return { error: "Requiere permisos de Administrador para liquidar." }
  }

  const ownerId = formData.get("ownerId") as string
  const selectionJson = formData.get("selection") as string
  
  if (!ownerId || !selectionJson) {
    return { error: "Datos incompletos para la liquidaci√≥n." }
  }

  let selection: SettlementItemInput[] = []
  try {
    selection = JSON.parse(selectionJson)
  } catch (e) {
    return { error: "Formato de selecci√≥n inv√°lido." }
  }

  if (selection.length === 0) {
    return { error: "No seleccionaste ning√∫n √≠tem para pagar." }
  }

  try {
    await prisma.$transaction(async (tx) => {
      
      const newSettlement = await tx.settlement.create({
        data: {
          ownerId,
          totalAmount: 0,
        }
      })

      let calculatedTotal = 0

      for (const item of selection) {
        
        if (item.type === 'SALE') {
            if (!item.quantity || item.quantity <= 0) {
                throw new Error(`Cantidad inv√°lida para item ${item.id}`)
            }

            const dbItem = await tx.saleItem.findUnique({
                where: { id: item.id },
                include: { 
                    variant: { include: { product: true } },
                    sale: true 
                }
            })

            if (!dbItem) throw new Error(`Item de venta no encontrado: ${item.id}`)
            
            if (dbItem.variant?.product.ownerId !== ownerId) {
                throw new Error(`El item ${dbItem.description} no pertenece a este due√±o.`)
            }

            if (dbItem.sale.paymentStatus !== 'PAID') {
                throw new Error(`No se puede liquidar "${dbItem.description}" porque el cliente A√öN NO PAG√ì (Es Fiado).`)
            }

            const pendingQty = dbItem.quantity - dbItem.settledQuantity
            if (item.quantity > pendingQty) {
                throw new Error(`Error en ${dbItem.description}: Intent√°s pagar ${item.quantity} pero solo se deben ${pendingQty}.`)
            }

            // R-06: C√°lculo con Redondeo
            const lineAmount = round(Number(dbItem.costAtSale) * item.quantity)
            calculatedTotal = round(calculatedTotal + lineAmount)

            await tx.settlementLine.create({
                data: {
                    settlementId: newSettlement.id,
                    saleItemId: dbItem.id,
                    quantity: item.quantity,
                    amount: lineAmount
                }
            })

            await tx.saleItem.update({
                where: { id: dbItem.id },
                data: { settledQuantity: { increment: item.quantity } }
            })

        } else if (item.type === 'ADJUSTMENT') {
            const dbAdj = await tx.balanceAdjustment.findUnique({
                where: { id: item.id }
            })

            if (!dbAdj) throw new Error(`Ajuste no encontrado: ${item.id}`)
            if (dbAdj.ownerId !== ownerId) throw new Error("Ajuste ajeno.")
            if (dbAdj.isApplied) throw new Error("Este ajuste ya fue pagado.")

            // R-06: Redondeo de ajuste
            const adjAmount = Number(dbAdj.amount)
            calculatedTotal = round(calculatedTotal + adjAmount)

            await tx.balanceAdjustment.update({
                where: { id: dbAdj.id },
                data: { 
                    isApplied: true,
                    settlementId: newSettlement.id
                }
            })
        }
      }

      if (calculatedTotal <= 0) {
        throw new Error(`El total a pagar es $${calculatedTotal}. No se pueden registrar liquidaciones negativas o en cero.`)
      }

      await tx.settlement.update({
        where: { id: newSettlement.id },
        data: { totalAmount: calculatedTotal }
      })
    })

    revalidatePath("/owners/balance")
    revalidatePath(`/owners/settlement/${ownerId}`)
    revalidatePath(`/owners/${ownerId}`)
    return { success: true }
    
  } catch (error: any) {
    console.error("Error en liquidaci√≥n:", error)
    return { error: error.message || "Error interno al procesar el pago." }
  }
}

--- File: user-actions.ts (in subfolder: actions) ---

// src/actions/user-actions.ts
'use server'

import { prisma } from "@/lib/prisma"
import { revalidatePath } from "next/cache"
import { Role } from "@prisma/client"
import { hashPassword, getSession } from "@/lib/auth" 

export async function createUser(formData: FormData) {
  // 1. SEGURIDAD (R-01) - Mantenemos validaci√≥n existente y reforzada
  const session = await getSession()
  if (!session) return { error: "No autorizado." }
  if (session.role !== 'ADMIN') return { error: "Permisos insuficientes. Se requiere Administrador." }

  const name = formData.get("name") as string
  const email = formData.get("email") as string
  const password = formData.get("password") as string
  const role = formData.get("role") as Role || "STAFF"

  if (!name || !email || !password) {
    return { error: "Todos los campos son obligatorios" }
  }

  try {
    const existing = await prisma.user.findUnique({
      where: { email }
    })

    if (existing) {
      return { error: "El email ya est√° registrado." }
    }

    // üîí Encriptamos antes de guardar
    const hashedPassword = await hashPassword(password)

    await prisma.user.create({
      data: {
        name,
        email,
        password: hashedPassword,
        role
      }
    })

    revalidatePath("/admin/users")
    return { success: true }

  } catch (error) {
    console.error("Error creando usuario:", error)
    return { error: "Error interno al crear usuario" }
  }
}

export async function getUsers() {
    // Lectura protegida: Solo usuarios logueados pueden ver la lista
    const session = await getSession()
    if (!session) return { error: "No autorizado." }

    try {
        const users = await prisma.user.findMany({
            orderBy: { name: 'asc' },
            select: { id: true, name: true, email: true, role: true, createdAt: true }
        })
        return { success: true, data: users }
    } catch (error) {
        return { error: "Error al cargar usuarios" }
    }
}

export async function deleteUser(formData: FormData) {
    // Seguridad Cr√≠tica: Solo admin borra usuarios
    const session = await getSession()
    if (!session || session.role !== 'ADMIN') return { error: "No autorizado." }

    const id = formData.get("id") as string
    
    // R-01 Adicional: Evitar auto-eliminaci√≥n
    // Asumimos que session tiene 'id' dado que es un objeto User o derivado.
    if (session.userId && session.userId === id) {
        return { error: "No puedes eliminar tu propio usuario." }
    }

    try {
        await prisma.user.delete({ where: { id } })
        revalidatePath("/admin/users")
        return { success: true }
    } catch (e) { return { error: "Error al eliminar" } }
}

--- File: layout.tsx (in subfolder: app) ---

import type { Metadata } from "next";
import { Inter, Nunito } from "next/font/google";
import "./globals.css";
import MainNav from "@/components/MainNav";
import { Toaster } from "@/components/ui/Toast";
import { ThemeProvider } from "@/components/ThemeProvider";

const inter = Inter({ subsets: ["latin"], variable: '--font-inter' });
const nunito = Nunito({ subsets: ["latin"], variable: '--font-nunito' });

export const metadata: Metadata = {
  title: "Guapecanes",
  description: "Gesti√≥n v3.0",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning>
      <body className={`${inter.variable} ${nunito.variable} antialiased min-h-screen bg-background text-foreground font-sans`}>
        
        <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
        >
            <div className="flex flex-col md:flex-row min-h-screen">
              <MainNav />
              {/* Main Content: Usa bg-background por defecto gracias a globals.css */}
              <main className="flex-1 pb-24 md:pb-0 relative overflow-y-auto h-screen custom-scrollbar bg-background">
                {children}
              </main>
            </div>
            
            <Toaster />
        </ThemeProvider>

      </body>
    </html>
  );
}

--- File: loading.tsx (in subfolder: app) ---

export default function Loading() {
  return (
    <div className="flex flex-col items-center justify-center h-[calc(100vh-100px)] w-full gap-4 animate-in fade-in duration-300">
      
      {/* Contenedor Visual */}
      <div className="relative">
        {/* Spinner de fondo (Aro) */}
        <div className="w-16 h-16 rounded-full border-4 border-muted opacity-30"></div>
        
        {/* Spinner activo (Giro) */}
        <div className="absolute top-0 left-0 w-16 h-16 rounded-full border-4 border-t-primary border-r-transparent border-b-transparent border-l-transparent animate-spin shadow-lg shadow-primary/20"></div>
        
        {/* Icono Central (Opcional - Marca) */}
        <div className="absolute inset-0 flex items-center justify-center text-xl animate-pulse">
          üê∂
        </div>
      </div>

      {/* Texto de estado */}
      <div className="flex flex-col items-center gap-1">
        <h3 className="text-foreground font-black font-nunito text-lg tracking-tight">
          Cargando
        </h3>
        <p className="text-xs text-muted-foreground font-medium animate-pulse">
          Preparando entorno...
        </p>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app) ---

// src/app/page.tsx
import { redirect } from "next/navigation";

/**
 * FE-07: Root Dispatcher
 * Esta p√°gina act√∫a como punto de entrada.
 * Delega la l√≥gica de protecci√≥n de rutas al Middleware.
 * 
 * Flujo:
 * 1. Intenta ir a /dashboard
 * 2. Si Middleware detecta sesi√≥n -> Pasa.
 * 3. Si Middleware NO detecta sesi√≥n -> Redirige a /login.
 */
export default function RootPage() {
  redirect("/dashboard");
}

--- File: page.tsx (in subfolder: app\admin\users) ---

import { prisma } from "@/lib/prisma"
import UserForm from "@/components/UserForm"
import { deleteUser } from "@/actions/user-actions"
import { PageHeader } from "@/components/ui/shared/PageHeader"
import { AppCard } from "@/components/ui/shared/AppCard"
import { cn } from "@/lib/utils"

export default async function UsersPage() {
  const users = await prisma.user.findMany({
    orderBy: { createdAt: 'desc' }
  })

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8 animate-in fade-in">
      
      <PageHeader 
        title="Gesti√≥n de Equipo"
        description="Control de acceso y roles del personal."
      />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: ALTA */}
        <div className="lg:col-span-1">
             <UserForm />
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="lg:col-span-2">
            <AppCard noPadding>
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-muted/50 text-muted-foreground uppercase text-xs font-bold border-b border-border">
                            <tr>
                                <th className="p-4 pl-6">Usuario</th>
                                <th className="p-4">Rol</th>
                                <th className="p-4 text-right pr-6">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-border">
                            {users.length === 0 ? (
                                <tr>
                                    <td colSpan={3} className="p-12 text-center text-muted-foreground">
                                        <span className="text-4xl block mb-2 opacity-50">üõ°Ô∏è</span>
                                        No hay usuarios registrados a√∫n.
                                    </td>
                                </tr>
                            ) : (
                                users.map(user => (
                                    <tr key={user.id} className="hover:bg-muted/30 transition-colors">
                                        <td className="p-4 pl-6">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xs">
                                                    {user.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <p className="font-bold text-foreground">{user.name}</p>
                                                    <p className="text-xs text-muted-foreground">{user.email}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <span className={cn(
                                                "text-[10px] font-black px-2 py-1 rounded-lg border uppercase tracking-wider",
                                                user.role === 'ADMIN' 
                                                    ? 'bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-500/20' 
                                                    : 'bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/20'
                                            )}>
                                                {user.role}
                                            </span>
                                        </td>
                                        <td className="p-4 text-right pr-6">
                                            {/* 
                                                FIX TS: Envolvemos la llamada en una funci√≥n as√≠ncrona an√≥nima.
                                                Esto satisface el tipo 'void | Promise<void>' que espera 'action'.
                                            */}
                                            <form action={async (formData) => {
                                                'use server'
                                                await deleteUser(formData)
                                            }}>
                                                <input type="hidden" name="id" value={user.id} />
                                                <button 
                                                    className="text-muted-foreground hover:text-destructive font-bold text-xs transition-colors flex items-center gap-1 ml-auto"
                                                    title="Revocar acceso"
                                                >
                                                    <span>üóëÔ∏è</span> ELIMINAR
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </AppCard>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\agenda) ---

// src/app/agenda/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import AppointmentForm from "@/components/AppointmentForm"
import AppointmentCard from "@/components/AppointmentCard"
import { cn } from "@/lib/utils"

interface Props {
  searchParams: Promise<{ date?: string }>
}

export default async function AgendaPage({ searchParams }: Props) {
  const { date } = await searchParams
  
  const todayStr = new Date().toISOString().split('T')[0]
  const selectedDateStr = date || todayStr

  const startOfDay = new Date(`${selectedDateStr}T00:00:00`)
  const endOfDay = new Date(`${selectedDateStr}T23:59:59`)

  const pets = await prisma.pet.findMany({ 
    orderBy: { name: 'asc' },
    select: { id: true, name: true, breed: true }
  })

  const appointments = await prisma.appointment.findMany({
    where: {
      startTime: { gte: startOfDay, lte: endOfDay },
      status: { not: 'CANCELLED' }
    },
    include: { pet: true },
    orderBy: { startTime: 'asc' }
  })

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 className="text-3xl font-black text-foreground font-nunito tracking-tight">Agenda de Turnos</h1>
            <p className="text-sm text-muted-foreground mt-1">Organiza el flujo de trabajo diario.</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {/* COLUMNA IZQUIERDA: LISTADO (2/3 de ancho) */}
        <div className="lg:col-span-2 space-y-6">
            
            {/* Barra de Fecha */}
            <div className="bg-card p-4 rounded-2xl shadow-sm border border-border flex flex-wrap items-center gap-4 justify-between">
                <div className="flex items-center gap-3">
                    <span className="text-2xl">üìÖ</span>
                    <form className="flex gap-3 items-center">
                        <input 
                            type="date" 
                            name="date" 
                            defaultValue={selectedDateStr} 
                            className="bg-background border border-input text-foreground rounded-xl px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-primary outline-none [color-scheme:light] dark:[color-scheme:dark]"
                        />
                        <button type="submit" className="bg-secondary hover:bg-accent text-foreground px-4 py-2 rounded-xl font-bold text-sm border border-border transition">
                            Ir
                        </button>
                    </form>
                </div>
                
                {selectedDateStr !== todayStr && (
                     <Link href="/agenda" className="text-xs font-bold text-primary hover:underline bg-primary/10 px-3 py-1.5 rounded-lg">
                        Volver a Hoy
                     </Link>
                )}
            </div>

            {/* Grilla de Turnos */}
            <div className="space-y-4 min-h-[300px]">
                {appointments.length === 0 ? (
                    <div className="flex flex-col items-center justify-center text-muted-foreground py-20 bg-muted/30 rounded-3xl border border-dashed border-border">
                        <span className="text-5xl mb-4 opacity-50">üò¥</span>
                        <p className="font-bold">No hay turnos para esta fecha.</p>
                        <p className="text-sm">Tomate un descanso o agend√° algo nuevo.</p>
                    </div>
                ) : (
                    appointments.map(appt => (
                        <AppointmentCard key={appt.id} appt={appt} />
                    ))
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: FORMULARIO (1/3 de ancho) */}
        <div className="lg:col-span-1">
            <AppointmentForm pets={pets} selectedDate={selectedDateStr} />
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\categories) ---

// src/app/categories/page.tsx
import { createCategory } from "@/actions/category-actions"
import { prisma } from "@/lib/prisma"

export default async function CategoriesPage() {
  const categories = await prisma.category.findMany({
    orderBy: { name: 'asc' } // Orden alfab√©tico
  })

  return (
    <div className="p-10 max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-8">Categor√≠as de Productos</h1>

      {/* FORMULARIO */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-10 border">
        <form action={createCategory} className="flex gap-4">
          <input 
            name="name" 
            type="text" 
            required 
            className="border p-2 rounded flex-1" 
            placeholder="Ej: Alimentos, Accesorios..."
          />
          <button 
            type="submit" 
            className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700"
          >
            Agregar
          </button>
        </form>
      </div>

      {/* LISTADO */}
      <div className="grid grid-cols-2 gap-4">
        {categories.map((cat) => (
          <div key={cat.id} className="border p-4 rounded bg-gray-50 flex justify-between items-center">
            <span className="font-semibold">{cat.name}</span>
            <span className="text-xs text-gray-400">ID: {cat.id.slice(0, 8)}...</span>
          </div>
        ))}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\customers) ---

import { prisma } from "@/lib/prisma"
import CustomerForm from "@/components/CustomerForm"
import SearchInput from "@/components/SearchInput"
import Link from "next/link"
import { PageHeader } from "@/components/ui/shared/PageHeader"
import { AppCard } from "@/components/ui/shared/AppCard"
import { cn } from "@/lib/utils"

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function CustomersPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  const customers = await prisma.customer.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { phone: { contains: query, mode: 'insensitive' } },
            { email: { contains: query, mode: 'insensitive' } }
        ]
    } : undefined,
    include: {
      sales: {
        where: { 
            status: 'COMPLETED',
            paymentStatus: 'PENDING'
        },
        select: { total: true }
      }
    },
    orderBy: { name: 'asc' }
  })

  const customersWithDebt = customers.map(c => {
    const debt = c.sales.reduce((sum, sale) => sum + Number(sale.total), 0)
    return { ...c, currentDebt: debt }
  })

  // Ordenar: Primero los deudores
  customersWithDebt.sort((a, b) => b.currentDebt - a.currentDebt)

  return (
    <div className="p-4 md:p-8 max-w-[1600px] mx-auto space-y-6 md:space-y-8 animate-in fade-in">
      
      {/* HEADER */}
      <PageHeader 
        title="Cartera de Clientes"
        description="Gesti√≥n de cuentas corrientes y perfiles de contacto."
      />

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6 md:gap-8">
        
        {/* COLUMNA IZQUIERDA: ALTA R√ÅPIDA */}
        <div className="xl:col-span-1 order-2 xl:order-1">
            {/* Si CustomerForm tiene padding interno, lo envolvemos en Card si no lo tiene. 
                Asumo que se mantiene igual que en Owners */}
            <CustomerForm />
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="xl:col-span-2 space-y-4 md:space-y-6 order-1 xl:order-2">
            <SearchInput placeholder="üîç Buscar cliente..." />

            <div className="grid gap-3">
                {customersWithDebt.map((customer) => (
                    <Link key={customer.id} href={`/customers/${customer.id}`}>
                        <AppCard 
                            hoverEffect 
                            noPadding 
                            className="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 rounded-2xl"
                        >
                            {/* INFO */}
                            <div className="flex items-center gap-4 w-full sm:w-auto overflow-hidden">
                                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-primary/20 to-primary/5 border border-primary/10 flex items-center justify-center text-primary font-black text-sm shrink-0">
                                    {customer.name.slice(0,2).toUpperCase()}
                                </div>
                                
                                <div className="min-w-0 flex-1">
                                    <p className="font-bold text-lg text-foreground truncate">
                                        {customer.name}
                                    </p>
                                    <div className="flex flex-col sm:flex-row gap-0.5 sm:gap-3 text-xs text-muted-foreground font-medium truncate">
                                        {customer.phone && <span className="flex items-center gap-1">üìû {customer.phone}</span>}
                                        {customer.email && <span className="flex items-center gap-1">üìß {customer.email}</span>}
                                    </div>
                                </div>
                            </div>
                            
                            {/* ESTADO DE CUENTA */}
                            <div className="flex items-center justify-between sm:justify-end gap-4 w-full sm:w-auto border-t sm:border-t-0 border-dashed border-border pt-3 sm:pt-0 mt-2 sm:mt-0">
                                
                                {/* Badge Deuda */}
                                {customer.currentDebt > 0 ? (
                                    <div className="text-left sm:text-right">
                                        <p className="text-[9px] font-black text-destructive uppercase tracking-wide opacity-80">Deuda Pendiente</p>
                                        <p className="text-xl font-black text-destructive leading-none">
                                            ${customer.currentDebt.toLocaleString()}
                                        </p>
                                    </div>
                                ) : (
                                    <div className="bg-green-500/10 text-green-700 dark:text-green-400 px-3 py-1.5 rounded-lg border border-green-500/20 flex items-center gap-2">
                                        <span className="text-xs font-black">AL D√çA</span>
                                        <span className="text-xs">‚ú®</span>
                                    </div>
                                )}

                                {/* Bot√≥n "Fake" (Toda la card es link) */}
                                <div className="hidden sm:block">
                                    <span className="text-xs font-bold text-muted-foreground bg-secondary px-3 py-1.5 rounded-lg border border-border">
                                        Ver Cuenta ‚Üí
                                    </span>
                                </div>
                            </div>
                        </AppCard>
                    </Link>
                ))}
                
                {customers.length === 0 && (
                     <div className="p-12 text-center text-muted-foreground border-2 border-dashed border-border rounded-3xl bg-muted/10 animate-in fade-in">
                        <span className="text-4xl block mb-2 opacity-50">üë•</span>
                        <p className="font-medium">
                            {query ? "No se encontraron clientes." : "Base de datos de clientes vac√≠a."}
                        </p>
                    </div>
                )}
            </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\customers\[id]) ---

import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { notFound } from "next/navigation"
import { cn } from "@/lib/utils"
import CustomerForm from "@/components/CustomerForm"
import CustomerSaleRow from "@/components/CustomerSaleRow"

interface Props {
  params: Promise<{ id: string }>
}

export default async function CustomerDetailPage({ params }: Props) {
  const { id } = await params

  const customer = await prisma.customer.findUnique({
    where: { id },
    include: {
      sales: {
        where: { status: 'COMPLETED' },
        orderBy: { createdAt: 'desc' },
        include: { 
            items: true 
        }
      }
    }
  })

  if (!customer) return notFound()

  // FIX: Serializaci√≥n de Decimales a Number/String para evitar errores de Client Component
  // Transformamos el objeto customer y sus relaciones profundamente
  const serializedCustomer = {
      ...customer,
      sales: customer.sales.map(sale => ({
          ...sale,
          total: Number(sale.total), // Decimal -> Number
          items: sale.items.map(item => ({
              ...item,
              priceAtSale: Number(item.priceAtSale), // Decimal -> Number
              costAtSale: Number(item.costAtSale)    // Decimal -> Number
          }))
      }))
  }

  // C√°lculos usando los datos serializados
  const totalDebt = serializedCustomer.sales
    .filter(s => s.paymentStatus === 'PENDING')
    .reduce((sum, s) => sum + s.total, 0)

  const lifetimeValue = serializedCustomer.sales
    .reduce((sum, s) => sum + s.total, 0)

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8 animate-in fade-in">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-start gap-6">
        <div>
            <Link href="/customers" className="text-xs font-bold text-primary hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-black text-foreground font-nunito">{customer.name}</h1>
            <div className="mt-2 text-muted-foreground flex gap-4 text-sm font-medium">
                {customer.phone && <span>üìû {customer.phone}</span>}
                {customer.email && <span>üìß {customer.email}</span>}
            </div>
            {customer.address && <p className="text-sm text-muted-foreground mt-1">üìç {customer.address}</p>}
        </div>

        {/* TARJETA DE DEUDA */}
        <div className={cn(
            "p-6 rounded-3xl shadow-lg border min-w-[280px]",
            totalDebt > 0 
                ? 'bg-destructive text-destructive-foreground border-destructive/50' 
                : 'bg-card text-foreground border-border'
        )}>
            <p className="text-xs font-bold uppercase opacity-80 mb-1">
                {totalDebt > 0 ? "Deuda Pendiente" : "Estado de Cuenta"}
            </p>
            <p className="text-4xl font-black tracking-tight mb-2">
                ${totalDebt.toLocaleString()}
            </p>
            {totalDebt === 0 ? (
                <div className="inline-block bg-green-500/20 text-green-600 dark:text-green-400 px-3 py-1 rounded-lg text-xs font-bold">
                    ‚úÖ AL D√çA
                </div>
            ) : (
                <p className="text-xs opacity-90">El cliente debe abonar este monto.</p>
            )}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: EDICI√ìN + ESTAD√çSTICAS */}
        <div className="lg:col-span-1 space-y-6">
            <div className="bg-blue-500/5 p-6 rounded-3xl border border-blue-500/10">
                <p className="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase mb-1">Compras Totales</p>
                <p className="text-2xl font-black text-blue-700 dark:text-blue-300">
                    ${lifetimeValue.toLocaleString()}
                </p>
                <p className="text-xs text-muted-foreground mt-1">{customer.sales.length} operaciones registradas</p>
            </div>

            {/* Pasamos el objeto limpio sin Decimals */}
            <CustomerForm initialData={serializedCustomer} />
        </div>

        {/* COLUMNA DERECHA: HISTORIAL */}
        <div className="lg:col-span-2">
            <h2 className="text-xl font-bold text-foreground mb-4 flex items-center gap-2">
                üìú Historial de Cuenta
            </h2>
            
            <div className="bg-card rounded-3xl shadow-sm border border-border overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-muted/50 text-muted-foreground uppercase font-bold text-xs">
                            <tr>
                                <th className="p-4 pl-6">Fecha</th>
                                <th className="p-4">Resumen Compra</th>
                                <th className="p-4 text-right">Monto</th>
                                <th className="p-4 text-center">Estado</th>
                                <th className="p-4 text-right pr-6">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-border">
                            {serializedCustomer.sales.length === 0 ? (
                                <tr>
                                    <td colSpan={5} className="p-12 text-center text-muted-foreground">
                                        Sin movimientos registrados.
                                    </td>
                                </tr>
                            ) : (
                                serializedCustomer.sales.map(sale => (
                                    <CustomerSaleRow key={sale.id} sale={sale} />
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\dashboard) ---

// src/app/dashboard/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { getLocalDateISO } from "@/lib/utils"

export default async function DashboardPage() {
  const now = new Date()
  const todayStr = getLocalDateISO() 
  const startOfToday = new Date(`${todayStr}T00:00:00`)
  const endOfToday = new Date(`${todayStr}T23:59:59`)

  // R-02: Consultar por 'paidAt' en lugar de 'createdAt'
  // Esto incluye ventas de hoy + deudas viejas pagadas hoy.
  const [todaySales, todayAppointments, lowStockVariants] = await Promise.all([
    prisma.sale.findMany({
      where: {
        status: "COMPLETED",
        paidAt: { gte: startOfToday, lte: endOfToday } 
      }
    }),
    prisma.appointment.findMany({
      where: {
        startTime: { gte: startOfToday, lte: endOfToday },
        status: { not: 'CANCELLED' }
      },
      include: { pet: true },
      orderBy: { startTime: 'asc' }
    }),
    prisma.productVariant.findMany({
      where: { stock: { lte: 3 } },
      include: { product: true },
      orderBy: { stock: 'asc' },
      take: 5
    })
  ])

  const stats = todaySales.reduce((acc, sale) => {
    const amount = Number(sale.total)
    acc.total += amount
    if (sale.paymentMethod === 'CASH') acc.cash += amount
    else acc.digital += amount
    return acc
  }, { total: 0, cash: 0, digital: 0 })

  return (
    <div className="p-6 md:p-10 max-w-[1600px] mx-auto space-y-8 animate-in fade-in duration-500">
      
      {/* HERO SECTION */}
      <div className="flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
          <h1 className="text-4xl font-black text-foreground font-nunito tracking-tight">
            Hola, Equipo üëã
          </h1>
          <p className="text-muted-foreground font-medium mt-1">
            Resumen de hoy, {new Date().toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' })}.
          </p>
        </div>
        <Link href="/pos" className="bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-3 rounded-2xl font-bold shadow-lg shadow-primary/20 transition active:scale-95 flex items-center gap-2">
            üõí Abrir Caja
        </Link>
      </div>

      {/* KPI GRID */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        {/* Total Card - Caja Real de HOY */}
        <div className="bg-slate-900 dark:bg-card dark:border dark:border-border text-white p-8 rounded-3xl shadow-xl relative overflow-hidden group">
            <div className="absolute top-0 right-0 w-32 h-32 bg-primary rounded-full blur-[60px] opacity-40 group-hover:opacity-60 transition"></div>
            <p className="text-slate-400 font-bold uppercase tracking-widest text-xs mb-2">Caja Diaria (Real)</p>
            <p className="text-5xl font-black font-nunito">${stats.total.toLocaleString()}</p>
            <div className="mt-6 flex gap-6">
                <div>
                    <span className="block text-green-400 font-bold text-lg">${stats.cash.toLocaleString()}</span>
                    <span className="text-slate-500 text-xs font-bold uppercase">Efectivo</span>
                </div>
                <div className="w-px bg-slate-700"></div>
                <div>
                    <span className="block text-blue-400 font-bold text-lg">${stats.digital.toLocaleString()}</span>
                    <span className="text-slate-500 text-xs font-bold uppercase">Digital</span>
                </div>
            </div>
        </div>

        {/* Appointments Summary */}
        <div className="bg-card text-card-foreground p-8 rounded-3xl shadow-sm border border-border flex flex-col justify-between hover:shadow-md transition">
            <div>
                <p className="text-muted-foreground font-bold uppercase tracking-widest text-xs mb-2">Turnos Hoy</p>
                <p className="text-4xl font-black font-nunito">{todayAppointments.length}</p>
            </div>
            <div className="mt-4">
                <div className="flex -space-x-2 overflow-hidden">
                    {todayAppointments.slice(0, 4).map(appt => (
                        <div key={appt.id} className="inline-block h-10 w-10 rounded-full ring-2 ring-background bg-primary/20 flex items-center justify-center text-primary font-bold text-xs" title={appt.pet.name}>
                            {appt.pet.name.slice(0,2)}
                        </div>
                    ))}
                    {todayAppointments.length > 4 && (
                        <div className="inline-block h-10 w-10 rounded-full ring-2 ring-background bg-secondary flex items-center justify-center text-xs font-bold text-muted-foreground">
                            +{todayAppointments.length - 4}
                        </div>
                    )}
                </div>
                <Link href="/agenda" className="text-primary text-sm font-bold mt-2 block hover:underline">Ver agenda completa ‚Üí</Link>
            </div>
        </div>

        {/* Stock Alert - Usamos opacidad para que funcione en dark/light */}
        <div className="bg-orange-500/10 dark:bg-orange-500/5 p-8 rounded-3xl border border-orange-500/20 flex flex-col justify-between">
            <div>
                 <div className="flex justify-between items-start">
                    <p className="text-orange-600 dark:text-orange-400 font-bold uppercase tracking-widest text-xs mb-2">Atenci√≥n Requerida</p>
                    <span className="bg-orange-500/20 text-orange-700 dark:text-orange-300 text-xs font-bold px-2 py-1 rounded-lg">Stock</span>
                 </div>
                <p className="text-4xl font-black text-orange-700 dark:text-orange-400 font-nunito">{lowStockVariants.length}</p>
                <p className="text-orange-600/80 dark:text-orange-400/80 text-sm font-medium mt-1">Productos por agotarse</p>
            </div>
            <Link href="/inventory" className="text-orange-700 dark:text-orange-400 text-sm font-bold mt-2 hover:underline">Reponer inventario ‚Üí</Link>
        </div>
      </div>

      {/* DETAILED SECTIONS */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* Pr√≥ximos Turnos */}
        <div className="bg-card text-card-foreground rounded-3xl shadow-sm border border-border p-6">
            <h3 className="font-bold text-xl mb-6 font-nunito">üìÖ Pr√≥ximos Clientes</h3>
            {todayAppointments.length === 0 ? (
                <div className="p-8 text-center text-muted-foreground bg-muted/50 rounded-2xl border border-dashed border-border">
                    Todo tranquilo por hoy üò¥
                </div>
            ) : (
                <div className="space-y-4">
                    {todayAppointments.slice(0, 5).map(appt => (
                        <div key={appt.id} className="flex items-center gap-4 p-3 hover:bg-accent/50 rounded-2xl transition group">
                            <div className="bg-primary/10 text-primary font-bold text-xs px-3 py-2 rounded-xl border border-primary/10">
                                {appt.startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                            </div>
                            <div className="flex-1">
                                <p className="font-bold group-hover:text-primary transition">{appt.pet.name}</p>
                                <p className="text-xs text-muted-foreground">{appt.pet.breed} ‚Ä¢ {appt.pet.ownerName}</p>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase border
                                ${appt.status === 'PENDING' ? 'bg-yellow-500/10 text-yellow-600 border-yellow-500/20' : ''}
                                ${appt.status === 'CONFIRMED' ? 'bg-blue-500/10 text-blue-600 border-blue-500/20' : ''}
                                ${appt.status === 'COMPLETED' ? 'bg-green-500/10 text-green-600 border-green-500/20' : ''}
                                ${appt.status === 'BILLED' ? 'bg-secondary text-muted-foreground border-border' : ''}
                            `}>
                                {appt.status === 'BILLED' ? 'COBRADO' : appt.status}
                            </span>
                        </div>
                    ))}
                </div>
            )}
        </div>

        {/* Alertas de Inventario */}
        <div className="bg-card text-card-foreground rounded-3xl shadow-sm border border-border p-6">
            <h3 className="font-bold text-xl mb-6 font-nunito">‚ö†Ô∏è Stock Cr√≠tico</h3>
            <div className="space-y-3">
                {lowStockVariants.map(v => (
                    <div key={v.id} className="flex items-center justify-between p-3 border border-border rounded-2xl hover:bg-destructive/5 transition">
                        <div className="flex items-center gap-3">
                            <div className={`w-2 h-12 rounded-full ${v.stock === 0 ? 'bg-destructive' : 'bg-orange-400'}`}></div>
                            <div>
                                <p className="font-bold text-sm">{v.product.name}</p>
                                <p className="text-xs text-muted-foreground">{v.name}</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <p className={`font-black text-lg ${v.stock === 0 ? 'text-destructive' : 'text-orange-500'}`}>
                                {v.stock}
                            </p>
                            <p className="text-[10px] font-bold text-muted-foreground uppercase">Unid.</p>
                        </div>
                    </div>
                ))}
                {lowStockVariants.length === 0 && (
                    <div className="p-8 text-center text-green-600 bg-green-500/10 rounded-2xl border border-green-500/20">
                        ‚úÖ Inventario saludable
                    </div>
                )}
            </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\inventory) ---

// src/app/inventory/page.tsx
import { prisma } from "@/lib/prisma"
import StockMovementForm from "@/components/StockMovementForm"
import InventoryImporter from "@/components/InventoryImporter"
import SearchInput from "@/components/SearchInput"
import Link from "next/link"

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function InventoryPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  const products = await prisma.product.findMany({
    where: { 
        isActive: true,
        OR: query ? [
            { name: { contains: query, mode: 'insensitive' } },
            { variants: { some: { name: { contains: query, mode: 'insensitive' } } } }
        ] : undefined
    },
    include: { variants: true, owner: true },
    orderBy: { name: 'asc' },
    take: query ? 100 : 20 
  })

  const productOptions = products.flatMap(p => 
    p.variants.map(v => ({
        variantId: v.id,
        productName: v.name === 'Est√°ndar' ? p.name : `${p.name} - ${v.name}`,
        ownerName: p.owner.name,
        stock: v.stock
    }))
  )
  productOptions.sort((a, b) => a.productName.localeCompare(b.productName))

  return (
    <div className="p-4 md:p-8 max-w-4xl mx-auto space-y-8">
      
      {/* HEADER */}
      <div className="flex justify-between items-center">
        <div>
            <h1 className="text-3xl font-black text-foreground font-nunito tracking-tight">Control de Stock</h1>
            <p className="text-muted-foreground text-sm font-medium">Entradas, salidas y ajustes de inventario.</p>
        </div>
        <Link href="/products" className="text-primary hover:underline text-sm font-bold bg-primary/10 px-4 py-2 rounded-lg transition">
            ‚Üê Volver a Lista
        </Link>
      </div>

      {/* SECCI√ìN 1: IMPORTADOR MASIVO */}
      {/* (Nota: InventoryImporter deber√≠a refactorizarse en el futuro, pero por ahora lo envolvemos bien) */}
      <div className="bg-card p-6 rounded-3xl shadow-sm border border-border">
          <InventoryImporter />
      </div>

      {/* SECCI√ìN 2: MOVIMIENTO MANUAL */}
      <div className="bg-card p-6 md:p-8 rounded-3xl shadow-lg border border-border">
        <h2 className="text-xl font-bold text-foreground mb-6 flex items-center gap-2">
            üì¶ Movimiento Individual
        </h2>
        
        {/* BUSCADOR */}
        <div className="mb-8 bg-muted/30 p-4 rounded-xl border border-border">
            <label className="block text-xs font-bold text-muted-foreground uppercase mb-2">
                1. Busc√° el producto para habilitarlo en la lista:
            </label>
            <SearchInput placeholder="Escrib√≠ para buscar (Ej: Buzo, Collar)..." />
        </div>

        {productOptions.length > 0 ? (
            <StockMovementForm products={productOptions} />
        ) : (
            <div className="text-center p-8 bg-muted/50 rounded-2xl border border-dashed border-border text-muted-foreground text-sm">
                {query ? "No se encontraron productos." : "Us√° el buscador de arriba para encontrar el producto a ajustar."}
            </div>
        )}
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\login) ---

'use client'

import { login } from "@/actions/auth-actions"
import { useState } from "react"
import { cn } from "@/lib/utils"

export default function LoginPage() {
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState("")

  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    setError("")
    
    const res = await login(formData)
    if (res?.error) {
        setError(res.error)
        setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-background p-4 animate-in fade-in duration-500">
      <div className="bg-card border border-border p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-sm relative overflow-hidden">
        
        {/* Decoraci√≥n de fondo sutil */}
        <div className="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-bl-full -mr-10 -mt-10 blur-2xl"></div>

        <div className="text-center mb-8 relative z-10">
            <h1 className="text-3xl font-black text-foreground font-nunito tracking-tighter">GUAPECANES</h1>
            <p className="text-sm font-bold text-muted-foreground uppercase tracking-widest mt-1">Sistema de Gesti√≥n</p>
        </div>

        {error && (
            <div className="bg-destructive/10 text-destructive text-sm p-3 rounded-xl mb-6 font-bold text-center border border-destructive/20 animate-in shake">
                {error}
            </div>
        )}

        <form action={handleSubmit} className="space-y-5 relative z-10">
            <div className="space-y-1.5">
                <label className="block text-xs font-black text-muted-foreground uppercase pl-1">Email</label>
                <input 
                    name="email" 
                    type="email" 
                    required 
                    autoFocus
                    placeholder="admin@guapecanes.com"
                    className="w-full border border-input p-3.5 rounded-xl bg-background text-foreground placeholder:text-muted-foreground focus:ring-2 focus:ring-primary focus:border-primary outline-none transition font-medium"
                />
            </div>

            <div className="space-y-1.5">
                <label className="block text-xs font-black text-muted-foreground uppercase pl-1">Contrase√±a</label>
                <input 
                    name="password" 
                    type="password" 
                    required 
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    className="w-full border border-input p-3.5 rounded-xl bg-background text-foreground placeholder:text-muted-foreground focus:ring-2 focus:ring-primary focus:border-primary outline-none transition font-medium"
                />
            </div>

            <button 
                type="submit" 
                disabled={loading}
                className={cn(
                    "w-full py-4 rounded-xl font-black text-primary-foreground transition-all shadow-lg mt-2",
                    loading 
                        ? 'bg-muted text-muted-foreground cursor-not-allowed shadow-none' 
                        : 'bg-primary hover:bg-primary/90 hover:shadow-primary/25 active:scale-95'
                )}
            >
                {loading ? (
                    <span className="flex items-center justify-center gap-2">
                        <span className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></span>
                        Validando...
                    </span>
                ) : (
                    "Iniciar Sesi√≥n"
                )}
            </button>
        </form>
        
        <div className="mt-8 pt-6 border-t border-border text-center">
             <p className="text-[10px] text-muted-foreground font-medium">
                v3.0 ‚Ä¢ Secure Access
            </p>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners) ---

import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm" 
import SearchInput from "@/components/SearchInput" 
import Link from "next/link"
import { cn } from "@/lib/utils"
import { PageHeader } from "@/components/ui/shared/PageHeader"
import { AppCard } from "@/components/ui/shared/AppCard"

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function OwnersPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  const owners = await prisma.owner.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { email: { contains: query, mode: 'insensitive' } },
            { phone: { contains: query, mode: 'insensitive' } }
        ]
    } : undefined,
    orderBy: { createdAt: 'desc' }
  })

  return (
    <div className="p-6 md:p-8 max-w-[1600px] mx-auto space-y-8">
      
      {/* HEADER REUTILIZABLE */}
      <PageHeader 
        title="Gesti√≥n de Due√±os"
        description="Base de datos de clientes y proveedores."
      />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO ALTA */}
        <div className="lg:col-span-1">
            {/* Asumo que OwnerForm tiene su propia tarjeta interna. 
                Si se ve "desnudo", lo envolveremos en un AppCard en el futuro. */}
            <OwnerForm /> 
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="lg:col-span-2 space-y-6">
            <SearchInput placeholder="Buscar por nombre, mail o tel√©fono..." />

            <div className="grid gap-3">
                {owners.map((owner) => (
                    // Usamos AppCard como √≠tem de lista (interactive)
                    <Link key={owner.id} href={`/owners/${owner.id}`}>
                        <AppCard 
                            hoverEffect 
                            noPadding 
                            className="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 rounded-2xl"
                        >
                            {/* INFO */}
                            <div className="flex items-center gap-3 flex-1 min-w-0">
                                <div className="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-sm shrink-0">
                                    {owner.name.slice(0,2).toUpperCase()}
                                </div>
                                <div className="min-w-0">
                                    <div className="flex items-center gap-2">
                                        <p className="font-bold text-lg text-foreground truncate">
                                            {owner.name}
                                        </p>
                                        <span className={cn(
                                            "w-2 h-2 rounded-full shrink-0",
                                            owner.isActive ? "bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]" : "bg-destructive"
                                        )} title={owner.isActive ? "Activo" : "Inactivo"}></span>
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-1 sm:gap-4 text-xs text-muted-foreground mt-0.5 truncate">
                                        {owner.email && <span>üìß {owner.email}</span>}
                                        {owner.phone && <span>üìû {owner.phone}</span>}
                                    </div>
                                </div>
                            </div>
                            
                            {/* BADGE "VER PERFIL" (Visual only, whole card is link) */}
                            <div className="hidden sm:block">
                                <span className="bg-secondary text-foreground px-3 py-1.5 rounded-lg text-xs font-bold border border-border">
                                    Ver Perfil
                                </span>
                            </div>
                        </AppCard>
                    </Link>
                ))}
                
                {owners.length === 0 && (
                    <div className="p-12 text-center text-muted-foreground border-2 border-dashed border-border rounded-3xl bg-muted/10 animate-in fade-in">
                        <span className="text-4xl block mb-2 opacity-50">üë•</span>
                        <p className="font-medium">
                            {query ? "No se encontraron due√±os con ese criterio." : "No hay due√±os registrados a√∫n."}
                        </p>
                    </div>
                )}
            </div>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\balance) ---

// src/app/owners/balance/page.tsx
import { prisma } from "@/lib/prisma";
import Link from "next/link";
import { cn } from "@/lib/utils";

export default async function OwnersBalancePage() {
  const ownersData = await prisma.owner.findMany({
    where: { isActive: true },
    include: {
      products: {
        include: {
          variants: {
            include: {
              saleItems: { 
                where: { 
                    sale: { 
                        status: 'COMPLETED',
                        paymentStatus: 'PAID' // üëà FILTRO
                    } 
                }
              },
            },
          },
        },
      },
      balanceAdjustments: { where: { isApplied: false } }
    },
  });

  const report = ownersData.map((owner) => {
    let debtFromSales = 0;
    let debtFromAdjustments = 0;
    let itemsCount = 0;

    owner.products.forEach((product) => {
      product.variants.forEach((variant) => {
        variant.saleItems.forEach((item) => {
          const remainingQty = item.quantity - item.settledQuantity;
          if (remainingQty > 0) {
            debtFromSales += Number(item.costAtSale) * remainingQty;
            itemsCount += remainingQty;
          }
        });
      });
    });

    owner.balanceAdjustments.forEach(adjustment => {
      debtFromAdjustments += Number(adjustment.amount);
    });

    const totalDebt = debtFromSales + debtFromAdjustments;

    return {
      ownerId: owner.id,
      name: owner.name,
      phone: owner.phone,
      totalDebt,
      itemsCount,
      hasAdjustments: owner.balanceAdjustments.length > 0
    };
  });

  const ownersWithActivity = report
    .filter((r) => r.totalDebt !== 0)
    .sort((a, b) => b.totalDebt - a.totalDebt);

  const ownersClean = report.filter((r) => r.totalDebt === 0);
  const totalGlobal = report.reduce((sum, r) => sum + r.totalDebt, 0);

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8 animate-in fade-in">
      
      {/* HEADER + KPI */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 className="text-3xl font-black text-foreground font-nunito tracking-tight">Estado de Cuenta</h1>
            <p className="text-sm text-muted-foreground mt-1">Saldos pendientes a due√±os y proveedores.</p>
        </div>
        
        <div className="bg-foreground text-background px-6 py-4 rounded-2xl shadow-xl border border-border">
            <p className="text-[10px] uppercase font-bold tracking-widest opacity-80 mb-1">Deuda Total Local</p>
            <p className="text-3xl font-black font-nunito tracking-tight">${totalGlobal.toLocaleString()}</p>
        </div>
      </div>

      {/* TABLA DE DEUDAS */}
      <div className="bg-card rounded-3xl shadow-sm overflow-hidden border border-border">
        <div className="overflow-x-auto">
            <table className="w-full text-left">
            <thead className="bg-muted/50 text-muted-foreground uppercase text-xs font-bold">
                <tr>
                    <th className="p-5 pl-6">Due√±o</th>
                    <th className="p-5 text-center">Items Pend.</th>
                    <th className="p-5 text-right">Saldo Neto</th>
                    <th className="p-5 text-center">Acci√≥n</th>
                </tr>
            </thead>
            <tbody className="divide-y divide-border">
                {ownersWithActivity.map((row) => (
                <tr key={row.ownerId} className="hover:bg-muted/30 transition duration-200">
                    <td className="p-5 pl-6">
                        <p className="font-bold text-lg text-foreground">{row.name}</p>
                        <p className="text-xs text-muted-foreground font-medium">
                            {row.phone || "Sin tel√©fono"}
                        </p>
                        {row.hasAdjustments && (
                            <span className="text-[10px] bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 px-2 py-0.5 rounded border border-yellow-500/20 inline-block mt-2 font-bold">
                            ‚ö†Ô∏è Incluye ajustes manuales
                            </span>
                        )}
                    </td>
                    
                    <td className="p-5 text-center">
                        <span className="bg-secondary text-secondary-foreground px-3 py-1 rounded-lg text-sm font-bold">
                            {row.itemsCount} u.
                        </span>
                    </td>
                    
                    <td className="p-5 text-right">
                        <span className={cn(
                            "text-xl font-black font-mono",
                            row.totalDebt >= 0 
                                ? 'text-destructive dark:text-red-400' 
                                : 'text-green-600 dark:text-green-400'
                        )}>
                            ${row.totalDebt.toLocaleString()}
                        </span>
                        {row.totalDebt < 0 && (
                            <p className="text-[10px] text-green-600 dark:text-green-400 font-bold uppercase mt-1">Saldo a favor Local</p>
                        )}
                    </td>
                    
                    <td className="p-5 text-center">
                        <Link
                            href={`/owners/settlement/${row.ownerId}`}
                            className="bg-primary/10 text-primary hover:bg-primary/20 px-4 py-2 rounded-xl text-sm font-bold border border-primary/10 transition shadow-sm"
                        >
                            Ver Detalle
                        </Link>
                    </td>
                </tr>
                ))}
            </tbody>
            </table>
        </div>

        {ownersWithActivity.length === 0 && (
          <div className="p-12 text-center text-muted-foreground bg-muted/20">
            <span className="text-4xl block mb-2 opacity-50">üéâ</span>
            ¬°Todo al d√≠a! No hay saldos pendientes.
          </div>
        )}
      </div>

      {/* DUE√ëOS AL D√çA */}
      {ownersClean.length > 0 && (
        <div className="bg-card/50 p-6 rounded-3xl border border-border border-dashed">
            <details className="group">
                <summary className="cursor-pointer text-muted-foreground font-bold hover:text-foreground select-none flex items-center gap-2">
                    <span>Ver due√±os sin saldo pendiente ({ownersClean.length})</span>
                    <span className="transition-transform group-open:rotate-180">‚ñº</span>
                </summary>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    {ownersClean.map((o) => (
                    <div
                        key={o.ownerId}
                        className="p-3 rounded-xl bg-background border border-border text-sm flex justify-between items-center opacity-70 hover:opacity-100 transition"
                    >
                        <span className="font-medium">{o.name}</span>
                        <span className="text-green-500 font-bold">‚úì</span>
                    </div>
                    ))}
                </div>
            </details>
        </div>
      )}
    </div>
  );
}

--- File: page.tsx (in subfolder: app\owners\settlement\[id]) ---

// src/app/owners/settlement/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import SettlementForm from "@/components/SettlementForm"

interface Props {
  params: Promise<{ id: string }>
}

export default async function SettlementPage({ params }: Props) {
  const { id } = await params
  
  const owner = await prisma.owner.findUnique({
    where: { id },
    include: {
      products: {
        include: {
          variants: {
            include: {
              // Solo ventas completadas Y PAGADAS
              saleItems: { 
                where: { 
                    sale: { 
                        status: 'COMPLETED',
                        paymentStatus: 'PAID' // üëà FILTRO
                    } 
                },
                include: { sale: true } 
              }
            }
          }
        }
      },
      balanceAdjustments: { where: { isApplied: false } }
    }
  })

  if (!owner) {
      return <div className="p-10 text-center">Due√±o no encontrado</div>
  }

  const items: any[] = []

  owner.products.forEach(p => {
    p.variants.forEach(v => {
      v.saleItems.forEach(item => {
        const pendingQty = item.quantity - item.settledQuantity
        
        if (pendingQty > 0) {
            items.push({
              id: item.id,
              type: 'SALE',
              date: item.sale.createdAt,
              description: item.description,
              pendingQuantity: pendingQty,
              cost: Number(item.costAtSale),
              isAdjustment: false
            })
        }
      })
    })
  })

  owner.balanceAdjustments.forEach(adj => {
    items.push({
      id: adj.id,
      type: 'ADJUSTMENT',
      date: adj.createdAt,
      description: `AJUSTE: ${adj.description}`, 
      pendingQuantity: 1, 
      cost: Number(adj.amount),
      isAdjustment: true
    })
  })

  items.sort((a, b) => a.date.getTime() - b.date.getTime())

  return (
    <div className="p-6 md:p-8 max-w-5xl mx-auto space-y-8 animate-in fade-in">
      
      {/* CABECERA */}
      <div>
        <Link href="/owners/balance" className="text-sm font-bold text-primary hover:underline mb-2 block">
          ‚Üê Volver al Balance General
        </Link>
        <h1 className="text-3xl font-black text-foreground font-nunito tracking-tight">
          Liquidaci√≥n: {owner.name}
        </h1>
        <p className="text-muted-foreground text-sm mt-1">
            Seleccion√° los √≠tems que quer√©s pagar.
        </p>
      </div>

      {items.length > 0 ? (
          <SettlementForm ownerId={owner.id} items={items} />
      ) : (
          <div className="bg-green-500/10 text-green-600 dark:text-green-400 p-8 rounded-3xl font-bold border border-green-500/20 text-center text-lg">
             üéâ ¬°Excelente! Este due√±o no tiene saldos pendientes.
          </div>
      )}
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\[id]) ---

// src/app/owners/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import Link from "next/link"
import { notFound } from "next/navigation"
import { cn } from "@/lib/utils"

interface Props {
  params: Promise<{ id: string }>
}

export default async function OwnerProfilePage({ params }: Props) {
  const { id } = await params

  const owner = await prisma.owner.findUnique({
    where: { id },
    include: {
      products: {
        where: { isActive: true },
        include: { 
            variants: {
                include: {
                    saleItems: {
                        where: { 
                            sale: { 
                                status: 'COMPLETED',
                                paymentStatus: 'PAID' // üëà FILTRO
                            } 
                        }
                    }
                }
            } 
        }
      },
      settlements: {
        orderBy: { createdAt: 'desc' },
        take: 20 
      },
      balanceAdjustments: { where: { isApplied: false } }
    }
  })

  if (!owner) return notFound()

  const activeInventory = owner.products.flatMap(p => 
    p.variants.filter(v => v.stock > 0).map(v => ({
      name: v.name === 'Est√°ndar' ? p.name : `${p.name} - ${v.name}`,
      price: Number(v.salePrice),
      cost: Number(v.costPrice),
      stock: v.stock,
      image: v.imageUrl
    }))
  )

  let debtFromSales = 0
  
  owner.products.forEach(p => {
      p.variants.forEach(v => {
          v.saleItems.forEach(item => {
              const pendingQty = item.quantity - item.settledQuantity
              if (pendingQty > 0) {
                  debtFromSales += (Number(item.costAtSale) * pendingQty)
              }
          })
      })
  })

  const debtFromAdj = owner.balanceAdjustments.reduce((sum, adj) => sum + Number(adj.amount), 0)
  const totalDebt = debtFromSales + debtFromAdj

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8 animate-in fade-in">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-start gap-6">
        <div>
            <Link href="/owners" className="text-xs font-bold text-primary hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-black text-foreground flex items-center gap-3 font-nunito">
                {owner.name}
                {!owner.isActive && <span className="text-xs bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20">INACTIVO</span>}
            </h1>
            <div className="mt-2 text-muted-foreground flex flex-col gap-1 text-sm">
                <p>üìß {owner.email || "Sin email"}</p>
                <p>üìû {owner.phone || "Sin tel√©fono"}</p>
            </div>
            <div className="mt-4">
                <Link 
                    href={`/owners/${owner.id}/edit`}
                    className="text-xs font-bold bg-card text-foreground px-3 py-1.5 rounded-lg border border-border hover:bg-accent transition"
                >
                    ‚úèÔ∏è EDITAR DATOS
                </Link>
            </div>
        </div>

        {/* CAJA DE ESTADO DE CUENTA (KPI) */}
        <div className={cn(
            "p-6 rounded-3xl shadow-lg border min-w-[300px] flex flex-col justify-between",
            totalDebt > 0 
                ? 'bg-slate-900 dark:bg-card text-white dark:text-foreground border-slate-800 dark:border-border' 
                : 'bg-green-600 dark:bg-green-900/20 text-white dark:text-green-400 border-green-500 dark:border-green-900/50'
        )}>
            <div>
                <p className="text-xs font-bold uppercase opacity-70 mb-1">Saldo Pendiente</p>
                <p className="text-4xl font-black mb-4 tracking-tight">${totalDebt.toLocaleString()}</p>
            </div>
            
            {totalDebt !== 0 ? (
                <Link 
                    href={`/owners/settlement/${owner.id}`}
                    className="block text-center bg-white text-slate-900 dark:bg-primary dark:text-primary-foreground font-bold py-3 rounded-xl shadow hover:scale-[1.02] transition active:scale-95 text-sm"
                >
                    {totalDebt > 0 ? "üí∏ LIQUIDAR (PAGAR)" : "‚öñÔ∏è AJUSTAR SALDO"}
                </Link>
            ) : (
                <div className="flex items-center gap-2 text-sm font-bold bg-white/20 p-2 rounded-lg">
                    <span>‚úÖ</span> Todo al d√≠a
                </div>
            )}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* COLUMNA IZQUIERDA: INVENTARIO ACTUAL */}
        <div className="bg-card rounded-3xl shadow-sm border border-border overflow-hidden">
            <div className="p-5 border-b border-border bg-muted/30 flex justify-between items-center">
                <h2 className="font-bold text-foreground">üì¶ En Stock ({activeInventory.length})</h2>
                <span className="text-xs text-muted-foreground">Mercader√≠a en el local</span>
            </div>
            
            <div className="max-h-[400px] overflow-y-auto divide-y divide-border custom-scrollbar">
                {activeInventory.length === 0 ? (
                    <div className="p-10 text-center text-muted-foreground opacity-60">Este due√±o no tiene productos activos.</div>
                ) : (
                    activeInventory.map((item, idx) => (
                        <div key={idx} className="p-4 flex justify-between items-center hover:bg-muted/30 transition">
                            <div className="flex items-center gap-3">
                                {item.image ? (
                                    <img src={item.image} className="w-10 h-10 rounded-lg object-cover border border-border" alt={item.name} />
                                ) : (
                                    <div className="w-10 h-10 bg-secondary rounded-lg flex items-center justify-center text-[8px] font-bold text-muted-foreground border border-border">FOTO</div>
                                )}
                                <div>
                                    <p className="font-bold text-sm text-foreground">{item.name}</p>
                                    <p className="text-xs text-muted-foreground">Stock: {item.stock} u.</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="font-bold text-foreground text-sm">${item.price}</p>
                                <p className="text-[10px] text-green-600 dark:text-green-400 font-bold">Costo: ${item.cost}</p>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE PAGOS */}
        <div className="bg-card rounded-3xl shadow-sm border border-border overflow-hidden">
            <div className="p-5 border-b border-border bg-muted/30">
                <h2 className="font-bold text-foreground">üìú Historial de Pagos</h2>
            </div>
            
            <div className="max-h-[400px] overflow-y-auto divide-y divide-border custom-scrollbar">
                {owner.settlements.length === 0 ? (
                    <div className="p-10 text-center text-muted-foreground opacity-60">Nunca se le ha pagado.</div>
                ) : (
                    owner.settlements.map(settlement => (
                        <div key={settlement.id} className="p-4 flex justify-between items-center hover:bg-muted/30 transition group">
                            <div>
                                <p className="font-bold text-foreground text-sm">
                                    {settlement.createdAt.toLocaleDateString()}
                                </p>
                                <p className="text-[10px] text-muted-foreground font-mono uppercase">
                                    REF: {settlement.id.slice(0, 8)}
                                </p>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-base font-black text-green-600 dark:text-green-400">
                                    ${Number(settlement.totalAmount).toLocaleString()}
                                </span>
                                <Link 
                                    href={`/settlements/${settlement.id}`}
                                    className="px-3 py-1.5 bg-background text-foreground rounded-lg text-xs font-bold border border-border hover:bg-accent transition"
                                >
                                    Ver Recibo
                                </Link>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\owners\[id]\edit) ---

// src/app/owners/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import OwnerForm from "@/components/OwnerForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditOwnerPage({ params }: Props) {
  const { id } = await params

  const owner = await prisma.owner.findUnique({
    where: { id }
  })

  if (!owner) return <div>Due√±o no encontrado</div>

  return (
    <div className="p-10 max-w-lg mx-auto">
      <Link href="/owners" className="text-blue-500 mb-4 block hover:underline">‚Üê Volver al listado</Link>
      
      {/* Reutilizamos el formulario pas√°ndole los datos */}
      <OwnerForm initialData={owner} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets) ---

// src/app/pets/page.tsx
import { prisma } from "@/lib/prisma"
import { createPet, deletePet } from "@/actions/pet-actions"
import Link from "next/link"
import SearchInput from "@/components/SearchInput"
import { cn } from "@/lib/utils"

interface Props {
  searchParams?: Promise<{ query?: string }>
}

export default async function PetsPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  const pets = await prisma.pet.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { ownerName: { contains: query, mode: 'insensitive' } },
            { breed: { contains: query, mode: 'insensitive' } }
        ]
    } : undefined,
    orderBy: { name: 'asc' }
  })

  // Action inline wrapper
  async function handleDelete(formData: FormData) {
    'use server'
    const id = formData.get("id") as string
    await deletePet(id)
  }

  const inputClass = "w-full p-3 rounded-xl border border-input bg-background text-foreground text-sm focus:ring-2 focus:ring-primary outline-none transition"
  const labelClass = "block text-xs font-bold text-muted-foreground uppercase mb-1.5"

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8 animate-in fade-in">
      
      {/* HEADER */}
      <div>
        <h1 className="text-3xl font-black text-foreground font-nunito tracking-tight">Mascotas</h1>
        <p className="text-sm text-muted-foreground mt-1">Base de clientes caninos y felinos.</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO */}
        <div className="lg:col-span-1">
          <div className="bg-card p-6 rounded-3xl shadow-sm border border-border sticky top-6">
            <h2 className="text-xl font-black text-foreground mb-6 font-nunito">üêï Nueva Ficha</h2>
            <form action={createPet} className="space-y-4">
              <div>
                <label className={labelClass}>Nombre Mascota *</label>
                <input name="name" type="text" required placeholder="Ej: Bobby" className={inputClass}/>
              </div>
              <div>
                <label className={labelClass}>Raza</label>
                <input name="breed" type="text" placeholder="Ej: Caniche" className={inputClass}/>
              </div>
              <div className="pt-4 border-t border-border mt-4">
                <p className="text-xs text-primary font-bold mb-4 uppercase">Datos del Due√±o</p>
                <div className="mb-4">
                    <label className={labelClass}>Nombre Humano *</label>
                    <input name="ownerName" type="text" required placeholder="Ej: Maria Perez" className={inputClass}/>
                </div>
                <div>
                    <label className={labelClass}>Tel√©fono / WhatsApp *</label>
                    <input name="ownerPhone" type="text" required placeholder="Ej: 11 1234 5678" className={inputClass}/>
                </div>
              </div>
              <div className="pt-2">
                <label className={labelClass}>Notas Generales</label>
                <textarea name="notes" rows={2} className={inputClass} placeholder="Ej: Al√©rgico al pollo"></textarea>
              </div>
              <button type="submit" className="w-full bg-primary hover:bg-primary/90 text-primary-foreground py-3 rounded-xl font-bold shadow-lg transition active:scale-95 mt-2">
                Guardar Ficha
              </button>
            </form>
          </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="lg:col-span-2 space-y-6">
          <SearchInput placeholder="Buscar por mascota, due√±o o raza..." />

          <div className="grid gap-4">
            {pets.map((pet) => (
              <div key={pet.id} className="bg-card p-4 rounded-2xl shadow-sm border border-border flex justify-between items-start hover:border-primary/50 transition duration-200">
                <div>
                  <div className="flex items-center gap-2 mb-1">
                    <h3 className="text-lg font-black text-foreground">{pet.name}</h3>
                    <span className="text-[10px] font-bold bg-secondary text-secondary-foreground px-2 py-0.5 rounded-lg uppercase">{pet.breed}</span>
                  </div>
                  <div className="text-sm text-muted-foreground">
                    <span className="font-bold">Due√±o:</span> {pet.ownerName} 
                    <span className="mx-2 text-border">|</span>
                    <span className="text-green-600 dark:text-green-400 font-mono text-xs">üìû {pet.ownerPhone}</span>
                  </div>
                  {pet.notes && (
                    <p className="mt-3 text-xs text-yellow-700 dark:text-yellow-400 bg-yellow-500/10 p-2 rounded-lg border border-yellow-500/20 inline-block font-medium">
                      ‚ö†Ô∏è {pet.notes}
                    </p>
                  )}
                </div>
                <div className="flex flex-col gap-2 items-end">
                    <Link href={`/pets/${pet.id}`} className="bg-primary/10 text-primary text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-primary/20 border border-primary/10 transition">
                        VER FICHA
                    </Link>
                    <form action={handleDelete}>
                        <input type="hidden" name="id" value={pet.id} />
                        <button type="submit" className="text-muted-foreground hover:text-destructive text-[10px] font-bold px-2 py-1 transition">
                            ELIMINAR
                        </button>
                    </form>
                </div>
              </div>
            ))}

            {pets.length === 0 && (
              <div className="text-center py-20 text-muted-foreground bg-card rounded-3xl border border-dashed border-border opacity-70">
                <span className="text-4xl block mb-2 opacity-50">üêï</span>
                {query ? "No encontr√© mascotas con ese nombre." : "No hay mascotas registradas."}
              </div>
            )}
          </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pets\[id]) ---

// src/app/pets/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import { createNote, deleteNote } from "@/actions/note-actions"
import Link from "next/link"
import { cn } from "@/lib/utils"

interface Props {
  params: Promise<{ id: string }>
}

export default async function PetDetailPage({ params }: Props) {
  const { id } = await params

  const pet = await prisma.pet.findUnique({
    where: { id },
    include: {
      appointments: {
        orderBy: { startTime: 'desc' }
      },
      groomingNotes: {
        orderBy: { createdAt: 'desc' }
      }
    }
  })

  if (!pet) return <div className="p-10 text-foreground">Mascota no encontrada</div>

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8 animate-in fade-in">
      
      {/* CABECERA DE PERFIL */}
      <div className="flex flex-col md:flex-row items-start justify-between gap-6">
        <div>
            <Link href="/pets" className="text-xs font-bold text-primary hover:underline mb-2 block">‚Üê Volver al listado</Link>
            <h1 className="text-4xl font-black text-foreground flex items-center gap-3 font-nunito">
                {pet.name}
                <span className="text-lg font-bold bg-secondary text-secondary-foreground px-3 py-1 rounded-xl border border-border">
                    {pet.breed || "Mestizo"}
                </span>
            </h1>
            <div className="mt-2 text-muted-foreground flex flex-col gap-1 text-sm font-medium">
                <p>üë§ Due√±o: <strong className="text-foreground">{pet.ownerName}</strong></p>
                <p>üìû Tel: <strong className="text-foreground">{pet.ownerPhone}</strong></p>
            </div>
            {pet.notes && (
                <p className="mt-4 text-destructive bg-destructive/10 p-3 rounded-xl border border-destructive/20 inline-block text-xs font-bold">
                    ‚ö†Ô∏è Alerta: {pet.notes}
                </p>
            )}
        </div>
        
        <div className="bg-card text-card-foreground p-6 rounded-3xl border border-border shadow-sm min-w-[200px] text-center">
            <p className="text-xs uppercase font-bold text-muted-foreground mb-1">Visitas Totales</p>
            <p className="text-4xl font-black font-nunito">{pet.appointments.length}</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: NUEVA NOTA + HISTORIAL T√âCNICO */}
        <div className="lg:col-span-2 space-y-8">
            
            {/* Formulario Agregar Nota */}
            <div className="bg-yellow-500/5 p-6 rounded-3xl border border-yellow-500/20">
                <h2 className="font-bold text-yellow-700 dark:text-yellow-400 mb-4 flex items-center gap-2">
                    üìù Nueva Nota T√©cnica
                </h2>
                <form action={createNote}>
                    <input type="hidden" name="petId" value={pet.id} />
                    <textarea 
                        name="content" 
                        required
                        rows={3} 
                        className="w-full p-4 border border-yellow-500/20 rounded-xl bg-background text-foreground focus:ring-2 focus:ring-yellow-500 outline-none placeholder:text-muted-foreground"
                        placeholder="Ej: Corte con alza 4, se port√≥ bien..."
                    ></textarea>
                    <div className="mt-3 text-right">
                        <button className="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-xl font-bold transition shadow-sm text-sm">
                            Guardar Nota
                        </button>
                    </div>
                </form>
            </div>

            {/* Listado de Notas */}
            <div>
                <h3 className="text-xl font-black mb-4 text-foreground font-nunito">Historial T√©cnico</h3>
                {pet.groomingNotes.length === 0 ? (
                    <p className="text-muted-foreground italic text-sm">No hay notas guardadas.</p>
                ) : (
                    <div className="space-y-4">
                        {pet.groomingNotes.map(note => (
                            <div key={note.id} className="bg-card p-5 rounded-2xl shadow-sm border border-border group relative">
                                <div className="flex justify-between items-start">
                                    <p className="text-foreground whitespace-pre-wrap text-sm leading-relaxed">{note.content}</p>
                                </div>
                                <div className="mt-3 pt-3 border-t border-border flex justify-between items-center">
                                    <p className="text-xs text-muted-foreground font-bold">
                                        {note.createdAt.toLocaleDateString()}
                                    </p>
                                    <form action={deleteNote}>
                                        <input type="hidden" name="id" value={note.id} />
                                        <input type="hidden" name="petId" value={pet.id} />
                                        <button className="text-destructive hover:underline text-[10px] font-bold opacity-0 group-hover:opacity-100 transition">
                                            BORRAR
                                        </button>
                                    </form>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL DE TURNOS */}
        <div className="lg:col-span-1">
            <h3 className="text-xl font-black mb-4 text-foreground font-nunito">Historial de Visitas</h3>
            <div className="bg-card rounded-3xl shadow-sm border border-border overflow-hidden">
                {pet.appointments.length === 0 ? (
                    <div className="p-8 text-center text-muted-foreground text-sm">Sin visitas a√∫n.</div>
                ) : (
                    <div className="divide-y divide-border">
                        {pet.appointments.map(appt => (
                            <div key={appt.id} className="p-4 hover:bg-muted/30 transition">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold text-foreground text-sm">
                                        {appt.startTime.toLocaleDateString()}
                                    </span>
                                    <span className={cn(
                                        "text-[9px] px-2 py-0.5 rounded font-black border uppercase",
                                        appt.status === 'COMPLETED' || appt.status === 'BILLED' 
                                            ? 'bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20' 
                                            : appt.status === 'CANCELLED' 
                                                ? 'bg-destructive/10 text-destructive border-destructive/20'
                                                : 'bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/20'
                                    )}>
                                        {appt.status === 'BILLED' ? 'COBRADO' : appt.status}
                                    </span>
                                </div>
                                <p className="text-xs text-muted-foreground font-mono">
                                    {appt.startTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </p>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\pos) ---

// src/app/pos/page.tsx
import { prisma } from "@/lib/prisma"
import PosSystem from "@/components/PosSystem"

export default async function PosPage() {
  // 1. CARGAR PRODUCTOS
  const products = await prisma.product.findMany({
    where: { isActive: true },
    include: { 
        variants: true, 
        owner: true,
        category: true 
    },
    orderBy: { name: 'asc' }
  })

  // 2. CARGAR CLIENTES (CORREGIDO)
  const customers = await prisma.customer.findMany({
    orderBy: { name: 'asc' },
    select: { 
        id: true, 
        name: true 
        // Eliminamos currentDebt de aqu√≠ porque no existe en la tabla
    }
  })

  // Mapeo de Productos (L√≥gica de servidor existente)
  const groupedProducts = products.map(p => {
    const totalStock = p.variants.reduce((sum, v) => sum + v.stock, 0)
    const mainImage = p.variants.find(v => v.imageUrl)?.imageUrl || null

    return {
      id: p.id,
      name: p.name,
      categoryName: p.category.name,
      ownerName: p.owner.name,
      imageUrl: mainImage,
      totalStock: totalStock,
      variants: p.variants.map(v => ({
        id: v.id,
        name: v.name,
        price: Number(v.salePrice),
        stock: v.stock
      }))
    }
  })

  return (
    <div className="h-screen flex flex-col p-4 bg-background">
      <header className="mb-4 flex justify-between items-center">
        <h1 className="text-2xl font-bold text-foreground flex items-center gap-2">
            üõí Punto de Venta
        </h1>
        <div className="text-sm font-bold bg-card text-muted-foreground px-3 py-1 rounded border border-border shadow-sm">
            Caja Principal
        </div>
      </header>
      
      {/* Pasamos products Y customers */}
      <PosSystem products={groupedProducts} customers={customers} />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products) ---

import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import ProductActions from "@/components/ProductActions"
import SearchInput from "@/components/SearchInput" 
import Link from "next/link"
import { PageHeader } from "@/components/ui/shared/PageHeader"
import { AppCard } from "@/components/ui/shared/AppCard"
import { cn } from "@/lib/utils"

interface Props {
  searchParams?: Promise<{
    query?: string
  }>
}

export default async function ProductsPage({ searchParams }: Props) {
  const params = await searchParams
  const query = params?.query || ""

  // R-02: Feature Flag
  const showImages = process.env.NEXT_PUBLIC_ENABLE_IMAGES === 'true'

  const owners = await prisma.owner.findMany({ select: { id: true, name: true } })
  const categories = await prisma.category.findMany({ select: { id: true, name: true } })

  const products = await prisma.product.findMany({
    where: query ? {
        OR: [
            { name: { contains: query, mode: 'insensitive' } },
            { owner: { name: { contains: query, mode: 'insensitive' } } }
        ]
    } : undefined,
    include: {
      variants: true,
      category: true,
      owner: true
    },
    orderBy: { name: 'asc' }
  })

  return (
    <div className="p-4 md:p-8 max-w-[1920px] mx-auto space-y-6 md:space-y-8 animate-in fade-in">
      
      {/* 1. HEADER ESTANDARIZADO */}
      <PageHeader 
        title="Inventario"
        description="Gesti√≥n maestra de productos, precios y stock."
      >
         <div className="flex gap-2 w-full md:w-auto">
            <Link 
              href="/inventory" 
              className="flex-1 md:flex-none justify-center bg-card hover:bg-accent text-foreground border border-border px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition shadow-sm"
            >
              üì¶ <span className="hidden sm:inline">Control Stock</span>
            </Link>
            <Link 
              href="/products/import" 
              className="flex-1 md:flex-none justify-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition shadow-lg shadow-green-900/20"
            >
              üìÑ <span className="hidden sm:inline">Importar Excel</span>
            </Link>
         </div>
      </PageHeader>

      <div className="grid grid-cols-1 xl:grid-cols-4 gap-6 md:gap-8">
        
        {/* COLUMNA IZQUIERDA: FORMULARIO */}
        <div className="xl:col-span-1 order-2 xl:order-1">
          <div className="xl:sticky xl:top-6 space-y-6">
             {/* Search en m√≥vil aparece arriba del form para acceso r√°pido */}
             <div className="xl:hidden">
                <SearchInput placeholder="üîç Buscar producto..." />
             </div>
             
             {/* Contenedor del Formulario (Asumimos que ProductForm es interno, 
                 pero le damos un wrapper si fuera necesario) */}
             <div className="bg-card border border-border rounded-3xl p-1 md:p-0 shadow-sm">
                 <ProductForm owners={owners} categories={categories} />
             </div>
          </div>
        </div>

        {/* COLUMNA DERECHA: LISTADO */}
        <div className="xl:col-span-3 flex flex-col gap-4 order-1 xl:order-2">
            
            {/* Search Desktop */}
            <div className="hidden xl:block max-w-md">
                <SearchInput placeholder="üîç Buscar por nombre, due√±o, categor√≠a..." />
            </div>

            <AppCard noPadding className="min-h-[500px] flex flex-col">
                {/* 
                    === VISTA DESKTOP (TABLA) === 
                    Hidden en pantallas chicas (< md)
                */}
                <div className="hidden md:block overflow-x-auto">
                    <table className="w-full text-sm text-left">
                    <thead className="bg-muted/50 text-muted-foreground uppercase font-bold text-xs">
                        <tr>
                        <th className="px-6 py-4">Producto</th>
                        <th className="px-6 py-4">Categor√≠a</th>
                        <th className="px-6 py-4">Precio Venta</th>
                        <th className="px-6 py-4 text-center">Stock</th>
                        <th className="px-6 py-4 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-border">
                        {products.map(p => {
                        const isArchived = !p.isActive
                        const totalStock = p.variants.reduce((sum, v) => sum + v.stock, 0)
                        const variantCount = p.variants.length
                        const prices = p.variants.map(v => Number(v.salePrice))
                        const minPrice = Math.min(...prices)
                        const maxPrice = Math.max(...prices)
                        const mainImage = p.variants[0]?.imageUrl

                        return (
                            <tr 
                            key={p.id} 
                            className={cn(
                                "group transition-colors duration-200",
                                isArchived ? 'bg-muted/30 opacity-60 grayscale' : 'hover:bg-muted/30 bg-card'
                            )}
                            >
                            <td className="px-6 py-4">
                                <Link href={`/products/${p.id}`} className="flex items-center gap-4 group-hover:translate-x-1 transition-transform">
                                    <div className="w-12 h-12 rounded-xl bg-muted border border-border overflow-hidden shrink-0 flex items-center justify-center">
                                        {showImages && mainImage ? (
                                            <img src={mainImage} className="w-full h-full object-cover" alt={p.name} />
                                        ) : (
                                            <span className="text-xl">üì¶</span>
                                        )}
                                    </div>
                                    <div>
                                        <div className="flex items-center gap-2">
                                            <p className="font-bold text-foreground text-base leading-tight group-hover:text-primary transition-colors">{p.name}</p>
                                            {isArchived && <span className="text-[9px] font-bold text-destructive border border-destructive/30 px-1 rounded uppercase">Archivado</span>}
                                        </div>
                                        
                                        <div className="text-xs text-muted-foreground flex gap-2 mt-0.5">
                                            <span className="bg-secondary px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">{p.owner.name}</span>
                                            {variantCount > 1 && (
                                                <span className="bg-primary/10 text-primary px-1.5 py-0.5 rounded text-[10px] font-bold">
                                                    +{variantCount} var
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </Link>
                            </td>
                            
                            <td className="px-6 py-4">
                                <span className="text-muted-foreground text-xs font-bold border border-border px-2 py-1 rounded-lg">
                                    {p.category.name}
                                </span>
                            </td>
                            
                            <td className="px-6 py-4 font-mono font-bold text-foreground">
                                {variantCount > 1 && minPrice !== maxPrice ? (
                                    <span className="text-sm">${minPrice} - ${maxPrice}</span>
                                ) : (
                                    <span className="text-base">${minPrice || 0}</span>
                                )}
                            </td>
                            
                            <td className="px-6 py-4 text-center">
                                {totalStock === 0 ? (
                                <span className="text-destructive bg-destructive/10 px-2 py-1 rounded text-[10px] font-black uppercase tracking-wide">AGOTADO</span>
                                ) : (
                                <span className={cn(
                                    "font-mono font-bold text-lg",
                                    totalStock <= 5 ? 'text-orange-500' : 'text-green-600 dark:text-green-400'
                                )}>
                                    {totalStock}
                                </span>
                                )}
                            </td>
                            
                            <td className="px-6 py-4">
                                <ProductActions id={p.id} isActive={p.isActive} stock={totalStock} />
                            </td>
                            </tr>
                        )
                        })}
                    </tbody>
                    </table>
                </div>

                {/* 
                    === VISTA M√ìVIL (CARDS) === 
                    Visible solo en pantallas chicas (< md)
                */}
                <div className="md:hidden divide-y divide-border">
                    {products.map(p => {
                        const isArchived = !p.isActive
                        const totalStock = p.variants.reduce((sum, v) => sum + v.stock, 0)
                        const prices = p.variants.map(v => Number(v.salePrice))
                        const minPrice = Math.min(...prices)
                        const mainImage = p.variants[0]?.imageUrl
                        
                        return (
                            <div key={p.id} className={cn("p-4 flex gap-4", isArchived && "opacity-60 grayscale bg-muted/20")}>
                                <Link href={`/products/${p.id}`} className="shrink-0">
                                    <div className="w-20 h-20 rounded-xl bg-muted border border-border overflow-hidden flex items-center justify-center">
                                        {showImages && mainImage ? (
                                            <img src={mainImage} className="w-full h-full object-cover" alt={p.name} />
                                        ) : (
                                            <span className="text-3xl">üì¶</span>
                                        )}
                                    </div>
                                </Link>
                                
                                <div className="flex-1 min-w-0 flex flex-col justify-between">
                                    <div className="flex justify-between items-start gap-2">
                                        <div>
                                            <Link href={`/products/${p.id}`}>
                                                <h3 className="font-bold text-foreground leading-tight line-clamp-2">{p.name}</h3>
                                            </Link>
                                            <p className="text-xs text-muted-foreground mt-1">{p.owner.name} ‚Ä¢ {p.category.name}</p>
                                        </div>
                                        <div className="text-right shrink-0">
                                            <div className="font-mono font-black text-lg">${minPrice}</div>
                                        </div>
                                    </div>

                                    <div className="flex justify-between items-end mt-2">
                                         {totalStock === 0 ? (
                                            <span className="text-xs font-black text-destructive bg-destructive/10 px-2 py-1 rounded">SIN STOCK</span>
                                         ) : (
                                            <span className={cn("text-xs font-bold px-2 py-1 rounded bg-secondary border border-border", totalStock <= 3 && "text-orange-500 border-orange-200")}>
                                                Stock: {totalStock}
                                            </span>
                                         )}
                                         
                                         <ProductActions id={p.id} isActive={p.isActive} stock={totalStock} />
                                    </div>
                                </div>
                            </div>
                        )
                    })}
                </div>

                {/* Empty State Universal */}
                {products.length === 0 && (
                    <div className="flex-1 flex flex-col items-center justify-center py-20 text-muted-foreground p-4 text-center">
                        <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center text-3xl mb-4">
                            üßê
                        </div>
                        <p className="font-medium text-lg">No encontramos productos</p>
                        <p className="text-sm opacity-60 max-w-xs">
                            {query ? `No hay resultados para "${query}".` : "Tu inventario est√° vac√≠o."}
                        </p>
                    </div>
                )}
            </AppCard>
        </div>
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\import) ---

import ExcelImporter from "@/components/ExcelImporter"
import ExportButtons from "@/components/ExportButtons"
import Link from "next/link"
import { PageHeader } from "@/components/ui/shared/PageHeader" // Usamos el header est√°ndar

export default function ImportPage() {
  return (
    <div className="p-6 md:p-8 max-w-5xl mx-auto space-y-8 animate-in fade-in">
      
      {/* Navegaci√≥n Breadcrumb simple */}
      <Link 
        href="/products" 
        className="text-primary hover:underline text-xs font-bold uppercase tracking-wide flex items-center gap-1"
      >
        <span>‚Üê</span> Volver a Productos
      </Link>
      
      <PageHeader 
        title="Centro de Carga Masiva"
        description="Administr√° tu inventario subiendo planillas Excel."
      />

      {/* SECCI√ìN 1: DESCARGAS */}
      <div className="space-y-4">
          <h3 className="text-sm font-black text-muted-foreground uppercase tracking-widest">
            1. Descargar Plantillas
          </h3>
          <ExportButtons />
      </div>

      <hr className="border-border border-dashed" />

      {/* SECCI√ìN 2: IMPORTADOR */}
      <div className="space-y-4 h-full">
         <h3 className="text-sm font-black text-muted-foreground uppercase tracking-widest">
            2. Subir Modificaciones
          </h3>
         <ExcelImporter />
      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\[id]) ---

// src/app/products/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import { translateMovementType } from "@/services/inventory-service"
import Link from "next/link"
import { notFound } from "next/navigation"
import StockMovementForm from "@/components/StockMovementForm"
import { cn } from "@/lib/utils"

interface Props {
  params: Promise<{ id: string }>
}

export default async function ProductDetailPage({ params }: Props) {
  const { id } = await params

  const product = await prisma.product.findUnique({
    where: { id },
    include: {
      category: true,
      owner: true,
      variants: {
        orderBy: { name: 'asc' }
      }
    }
  })

  if (!product) return notFound()

  const history = await prisma.stockMovement.findMany({
    where: { variant: { productId: id } },
    include: { variant: true },
    orderBy: { createdAt: 'desc' },
    take: 50
  })

  const formOptions = product.variants.map(v => ({
    variantId: v.id,
    productName: v.name === 'Est√°ndar' ? product.name : v.name, 
    ownerName: product.owner.name,
    stock: v.stock
  }))

  const totalStock = product.variants.reduce((sum, v) => sum + v.stock, 0)
  
  let totalCostValue = 0
  let totalSaleValue = 0

  product.variants.forEach(v => {
    totalCostValue += Number(v.costPrice) * v.stock
    totalSaleValue += Number(v.salePrice) * v.stock
  })

  const mainImage = product.variants.find(v => v.imageUrl)?.imageUrl || null

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8 animate-in fade-in">
      
      {/* HEADER DE NAVEGACI√ìN */}
      <div className="flex items-center justify-between">
        <Link href="/products" className="text-primary hover:underline font-bold text-sm flex items-center gap-1">
           ‚Üê Volver al Inventario
        </Link>
        <Link 
            href={`/products/${id}/edit`}
            className="bg-card hover:bg-accent text-foreground border border-border px-4 py-2 rounded-xl font-bold transition text-sm shadow-sm"
        >
            ‚úèÔ∏è Editar Datos
        </Link>
      </div>

      {/* TARJETA PRINCIPAL DEL PRODUCTO */}
      <div className="bg-card text-card-foreground rounded-3xl shadow-sm border border-border overflow-hidden">
        <div className="p-6 md:p-8 flex flex-col md:flex-row gap-8">
            {/* Imagen */}
            <div className="w-32 h-32 md:w-40 md:h-40 flex-shrink-0 bg-muted rounded-2xl border border-border flex items-center justify-center overflow-hidden">
                {mainImage ? (
                    <img src={mainImage} alt={product.name} className="w-full h-full object-cover" />
                ) : (
                    <span className="text-muted-foreground text-xs font-bold">Sin Foto</span>
                )}
            </div>

            {/* Info Texto */}
            <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                    <h1 className="text-3xl font-black text-foreground font-nunito">{product.name}</h1>
                    {!product.isActive && (
                        <span className="bg-destructive/10 text-destructive px-2 py-1 rounded text-xs font-bold border border-destructive/20 uppercase">
                            ARCHIVADO
                        </span>
                    )}
                </div>
                
                <div className="flex flex-wrap gap-4 text-sm text-muted-foreground mb-6">
                    <p className="flex items-center gap-1">
                        üìÇ <strong className="text-foreground">{product.category.name}</strong>
                    </p>
                    <p className="flex items-center gap-1">
                        üë§ <strong className="text-foreground">{product.owner.name}</strong>
                    </p>
                </div>

                <p className="text-muted-foreground italic text-sm border-l-4 border-primary/20 pl-4 py-1">
                    {product.description || "Sin descripci√≥n."}
                </p>
            </div>

            {/* KPI Boxes */}
            <div className="flex flex-col gap-3 min-w-[200px]">
                <div className="bg-blue-500/10 p-4 rounded-2xl border border-blue-500/20">
                    <p className="text-xs text-blue-600 dark:text-blue-400 font-bold uppercase tracking-wide">Stock Total</p>
                    <p className="text-3xl font-black text-blue-700 dark:text-blue-300">
                        {totalStock} <span className="text-sm font-bold text-blue-600/60 dark:text-blue-400/60">u.</span>
                    </p>
                </div>
                <div className="bg-green-500/10 p-4 rounded-2xl border border-green-500/20">
                    <p className="text-xs text-green-600 dark:text-green-400 font-bold uppercase tracking-wide">Valor Venta (Est.)</p>
                    <p className="text-2xl font-black text-green-700 dark:text-green-300">${totalSaleValue.toLocaleString()}</p>
                </div>
            </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {/* COLUMNA IZQUIERDA: VARIANTES + FORMULARIO */}
        <div className="lg:col-span-1 space-y-8">
            
            {/* Tabla Variantes */}
            <div className="bg-card rounded-3xl shadow-sm border border-border overflow-hidden">
                <div className="p-4 border-b border-border bg-muted/30">
                    <h2 className="font-bold text-foreground flex items-center gap-2">
                        üè∑Ô∏è Variantes
                    </h2>
                </div>
                <table className="w-full text-sm">
                    <thead className="bg-muted/50 text-muted-foreground font-bold text-xs uppercase">
                        <tr>
                            <th className="p-3 text-left">Nombre</th>
                            <th className="p-3 text-right">Precio</th>
                            <th className="p-3 text-center">Stock</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-border">
                        {product.variants.map(v => (
                            <tr key={v.id} className="hover:bg-muted/20 transition-colors">
                                <td className="p-3 font-medium text-foreground">{v.name}</td>
                                <td className="p-3 text-right text-muted-foreground font-mono">${Number(v.salePrice)}</td>
                                <td className="p-3 text-center">
                                    <span className={cn(
                                        "font-bold px-2 py-0.5 rounded text-xs border",
                                        v.stock === 0 
                                            ? 'bg-destructive/10 text-destructive border-destructive/20' 
                                            : 'bg-secondary text-secondary-foreground border-transparent'
                                    )}>
                                        {v.stock}
                                    </span>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* FORMULARIO INCRUSTADO */}
            <div className="bg-card p-6 rounded-3xl border border-border shadow-lg shadow-primary/5">
                <h3 className="font-bold text-foreground mb-6 border-b border-border pb-2">üì¶ Ajuste R√°pido de Stock</h3>
                <StockMovementForm 
                    products={formOptions} 
                    redirectPath={`/products/${id}`} 
                />
            </div>

            {/* Info Financiera */}
            <div className="bg-yellow-500/10 p-4 rounded-xl border border-yellow-500/20 text-xs text-yellow-700 dark:text-yellow-400">
                <p className="font-bold mb-1 uppercase tracking-wide">üí° Dato Financiero</p>
                <p>Costo inmovilizado en stock: <strong className="text-sm">${totalCostValue.toLocaleString()}</strong></p>
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL */}
        <div className="lg:col-span-2">
            <h2 className="text-xl font-bold text-foreground mb-4 flex items-center gap-2 px-2">
                üìú Auditor√≠a de Movimientos
            </h2>
            
            <div className="bg-card rounded-3xl shadow-sm border border-border overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-muted/50 text-muted-foreground font-bold text-xs uppercase">
                            <tr>
                                <th className="p-4">Fecha</th>
                                <th className="p-4">Variante</th>
                                <th className="p-4">Acci√≥n</th>
                                <th className="p-4 text-right">Cant.</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-border">
                            {history.length === 0 ? (
                                <tr>
                                    <td colSpan={4} className="p-12 text-center text-muted-foreground italic">
                                        No hay movimientos registrados a√∫n.
                                    </td>
                                </tr>
                            ) : (
                                history.map(mov => {
                                    const isPositive = mov.quantity > 0
                                    const typeLabel = translateMovementType(mov.type)

                                    return (
                                        <tr key={mov.id} className="hover:bg-muted/20 transition-colors group">
                                            <td className="p-4">
                                                <p className="font-bold text-foreground">
                                                    {mov.createdAt.toLocaleDateString()}
                                                </p>
                                                <p className="text-xs text-muted-foreground font-mono">
                                                    {mov.createdAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                </p>
                                            </td>
                                            <td className="p-4 text-muted-foreground">
                                                {mov.variant.name === 'Est√°ndar' ? '-' : mov.variant.name}
                                            </td>
                                            <td className="p-4">
                                                <p className="font-medium text-foreground">{typeLabel}</p>
                                                {mov.reason && (
                                                    <p className="text-xs text-muted-foreground italic mt-0.5">
                                                        "{mov.reason}"
                                                    </p>
                                                )}
                                            </td>
                                            <td className={cn(
                                                "p-4 text-right font-black text-base",
                                                isPositive ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400"
                                            )}>
                                                {isPositive ? '+' : ''}{mov.quantity}
                                            </td>
                                        </tr>
                                    )
                                })
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

      </div>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\products\[id]\edit) ---

// src/app/products/[id]/edit/page.tsx
import { prisma } from "@/lib/prisma"
import ProductForm from "@/components/ProductForm"
import Link from "next/link"

interface Props {
  params: Promise<{ id: string }>
}

export default async function EditProductPage({ params }: Props) {
  const { id } = await params

  // 1. Buscar datos maestros
  const owners = await prisma.owner.findMany()
  const categories = await prisma.category.findMany()

  // 2. Buscar el producto CON TODAS sus variantes
  const product = await prisma.product.findUnique({
    where: { id },
    include: { variants: { orderBy: { name: 'asc' } } } // Ordenamos por nombre
  })

  if (!product) return <div>Producto no encontrado</div>

  // 3. Estructura de datos para el form
  const initialData = {
    id: product.id,
    name: product.name,
    description: product.description,
    ownerId: product.ownerId,
    categoryId: product.categoryId,
    imageUrl: product.variants[0]?.imageUrl || "", // Tomamos la foto de la primera como referencia
    // Pasamos el array completo de variantes
    variants: product.variants.map(v => ({
      id: v.id,
      name: v.name,
      costPrice: Number(v.costPrice),
      salePrice: Number(v.salePrice),
      stock: v.stock
    }))
  }

  return (
    <div className="p-8 max-w-4xl mx-auto">
        <Link href="/products" className="text-blue-500 mb-4 block font-bold">‚Üê Cancelar y Volver</Link>
        <ProductForm 
            owners={owners} 
            categories={categories} 
            initialData={initialData} 
        />
    </div>
  )
}

--- File: page.tsx (in subfolder: app\sales) ---

import { prisma } from "@/lib/prisma"
import { getLocalDateISO, getArgentinaDayRange } from "@/lib/utils"
import Link from "next/link"
import SaleRow from "@/components/SaleRow"
import { PageHeader } from "@/components/ui/shared/PageHeader"
import { AppCard } from "@/components/ui/shared/AppCard"
import { cn } from "@/lib/utils"

interface Props {
  searchParams: Promise<{ 
    dateFrom?: string 
    dateTo?: string 
    method?: string
  }>
}

export default async function SalesHistoryPage({ searchParams }: Props) {
  const { dateFrom, dateTo, method } = await searchParams

  const today = getLocalDateISO()
  const fromStr = dateFrom || today
  const toStr = dateTo || today

  const fromDate = getArgentinaDayRange(fromStr).start
  const toDate = getArgentinaDayRange(toStr).end

  const sales = await prisma.sale.findMany({
    where: {
      createdAt: { gte: fromDate, lte: toDate },
      paymentMethod: method ? { equals: method } : undefined
    },
    include: { items: true },
    orderBy: { createdAt: 'desc' }
  })

  const totalPeriodo = sales
    .filter(s => s.status === 'COMPLETED')
    .reduce((sum, s) => sum + Number(s.total), 0)

  const cantVentas = sales.filter(s => s.status === 'COMPLETED').length

  const inputClass = "bg-background border border-input text-foreground rounded-xl px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-primary outline-none transition shadow-sm [color-scheme:light] dark:[color-scheme:dark] w-full md:w-auto"

  return (
    <div className="p-4 md:p-8 max-w-6xl mx-auto space-y-6 md:space-y-8 animate-in fade-in">
      
      {/* HEADER + KPI */}
      <PageHeader 
        title="Historial de Ventas"
        description="Auditor√≠a de caja y transacciones diarias."
      >
         <div className="bg-primary text-primary-foreground px-6 py-3 rounded-2xl shadow-lg shadow-primary/20 text-right border border-primary/20 min-w-[200px]">
            <p className="text-[10px] uppercase font-bold tracking-widest mb-0.5 opacity-80">Total Periodo</p>
            <p className="text-3xl font-black font-nunito tracking-tight">${totalPeriodo.toLocaleString()}</p>
            <p className="text-[10px] font-bold opacity-60">{cantVentas} operaciones</p>
        </div>
      </PageHeader>

      {/* BARRA DE FILTROS */}
      <AppCard className="p-4 md:p-5">
        <form className="flex flex-col md:flex-row items-end gap-4">
            <div className="grid grid-cols-2 md:flex md:flex-row gap-4 w-full md:w-auto">
                {/* Desde */}
                <div className="flex flex-col gap-1.5 w-full">
                    <label className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider">Desde</label>
                    <input 
                        name="dateFrom" 
                        type="date" 
                        defaultValue={fromStr}
                        className={inputClass}
                    />
                </div>

                {/* Hasta */}
                <div className="flex flex-col gap-1.5 w-full">
                    <label className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider">Hasta</label>
                    <input 
                        name="dateTo" 
                        type="date" 
                        defaultValue={toStr}
                        className={inputClass}
                    />
                </div>
            </div>

            {/* M√©todo */}
            <div className="flex flex-col gap-1.5 w-full md:w-auto">
                <label className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider">Medio Pago</label>
                <select 
                    name="method" 
                    defaultValue={method || ""}
                    className={cn(inputClass, "md:min-w-[140px]")}
                >
                    <option value="">Todos</option>
                    <option value="CASH">Efectivo</option>
                    <option value="TRANSFER">Transferencia</option>
                </select>
            </div>

            <button className="w-full md:w-auto bg-foreground hover:bg-foreground/80 text-background px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg transition active:scale-95 h-[42px]">
                Filtrar
            </button>
            
            {(dateFrom || dateTo || method) && (
                <Link href="/sales" className="w-full md:w-auto text-center text-xs font-bold text-destructive hover:underline py-3 px-2">
                    Borrar Filtros
                </Link>
            )}
        </form>
      </AppCard>

      {/* TABLA DE RESULTADOS */}
      <AppCard noPadding>
        <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
            <thead className="hidden md:table-header-group bg-muted/50 text-muted-foreground uppercase text-xs font-bold border-b border-border">
                <tr>
                    <th className="p-4 pl-6">Fecha</th>
                    <th className="p-4">M√©todo</th>
                    <th className="p-4">Total</th>
                    <th className="p-4 text-center">Detalle</th>
                </tr>
            </thead>
            <tbody className="divide-y divide-border block md:table-row-group">
                {sales.length === 0 ? (
                    <tr>
                        <td colSpan={4} className="p-12 text-center text-muted-foreground block md:table-cell">
                            <span className="text-4xl block mb-2 opacity-50">üìÖ</span>
                            No se encontraron ventas para este filtro.
                        </td>
                    </tr>
                ) : (
                    sales.map(sale => {
                        // FIX: Conversi√≥n expl√≠cita de TODOS los campos Decimal
                        const saleForClient = {
                            ...sale,
                            total: Number(sale.total),
                            items: sale.items.map(i => ({
                                ...i,
                                priceAtSale: Number(i.priceAtSale),
                                costAtSale: i.costAtSale ? Number(i.costAtSale) : 0 // üëà FIX AQU√ç
                            }))
                        }
                        return <SaleRow key={sale.id} sale={saleForClient} />
                    })
                )}
            </tbody>
            </table>
        </div>
      </AppCard>
    </div>
  )
}

--- File: page.tsx (in subfolder: app\settlements\[id]) ---

// src/app/settlements/[id]/page.tsx
import { prisma } from "@/lib/prisma"
import SettlementTicket from "@/components/SettlementTicket"
import { notFound } from "next/navigation"

interface Props {
  params: Promise<{ id: string }>
}

export default async function SettlementDetailPage({ params }: Props) {
  const { id } = await params

  // Buscamos la liquidaci√≥n con la nueva estructura de tablas intermedias
  const settlement = await prisma.settlement.findUnique({
    where: { id },
    include: {
      owner: true,
      items: {
        // CORRECCI√ìN: Ordenamos navegando la relaci√≥n (Line -> Item -> Sale)
        orderBy: {
            saleItem: {
                sale: { createdAt: 'desc' }
            }
        },
        // En el nuevo esquema, 'items' son l√≠neas de liquidaci√≥n (SettlementLine)
        include: {
          saleItem: {
            include: {
              sale: true // Necesitamos la fecha de la venta original
            }
          }
        }
      },
      adjustments: {
        orderBy: { createdAt: 'desc' }
      }
    }
  })

  if (!settlement) return notFound()

  // Mapeamos los datos al formato que espera el componente visual (SettlementTicket)
  const formattedData = {
    id: settlement.id,
    createdAt: settlement.createdAt,
    totalAmount: Number(settlement.totalAmount),
    owner: settlement.owner,
    
    // Transformamos las l√≠neas de liquidaci√≥n
    items: settlement.items.map(line => ({
        id: line.id,
        // La descripci√≥n vive en el item de venta original
        description: line.saleItem.description,
        // La cantidad es la de ESTA liquidaci√≥n (puede ser parcial)
        quantity: line.quantity,
        // El costo unitario hist√≥rico
        costAtSale: Number(line.saleItem.costAtSale),
        // La fecha de la venta original
        createdAt: line.saleItem.sale.createdAt 
    })), // El sort ya lo hicimos en DB, pero no est√° de m√°s mantener el orden del array

    adjustments: settlement.adjustments.map(a => ({
        ...a,
        amount: Number(a.amount)
    }))
  }

  return (
    <SettlementTicket data={formattedData} />
  )
}

--- File: AppointmentCard.tsx (in subfolder: components) ---

// src/components/AppointmentCard.tsx
'use client'

import { cancelAppointment, updateAppointmentStatus } from "@/actions/appointment-actions"
import Link from "next/link"
import { useState } from "react"
import { cn } from "@/lib/utils"

type AppointmentData = {
  id: string
  startTime: Date
  endTime: Date
  status: string 
  pet: {
    name: string
    breed: string | null
    ownerName: string
  }
}

export default function AppointmentCard({ appt }: { appt: AppointmentData }) {
  const [loading, setLoading] = useState(false)

  const start = appt.startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  const end = appt.endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })

  const handleStatusChange = async (newStatus: 'CONFIRMED' | 'COMPLETED') => {
    setLoading(true)
    await updateAppointmentStatus(appt.id, newStatus)
    setLoading(false)
  }

  // DEFINICI√ìN DE ESTILOS POR ESTADO
  // Usamos border-l-4 para mantener la identidad visual, pero con colores compatibles
  const statusStyles: Record<string, string> = {
    PENDING: "bg-yellow-500/10 border-yellow-500 dark:border-yellow-400/50",
    CONFIRMED: "bg-blue-500/10 border-blue-500 dark:border-blue-400/50",
    COMPLETED: "bg-green-500/10 border-green-500 dark:border-green-400/50",
    BILLED: "bg-secondary border-border opacity-70 grayscale",
    CANCELLED: "bg-destructive/10 border-destructive opacity-80",
  }

  const badgeStyles: Record<string, string> = {
    PENDING: "text-yellow-700 dark:text-yellow-400 bg-yellow-500/10",
    CONFIRMED: "text-blue-700 dark:text-blue-400 bg-blue-500/10",
    COMPLETED: "text-green-700 dark:text-green-400 bg-green-500/10",
    BILLED: "text-muted-foreground bg-secondary",
    CANCELLED: "text-destructive bg-destructive/10",
  }

  const currentStyle = statusStyles[appt.status] || "bg-card border-border"

  return (
    <div className={cn(
        "p-4 rounded-xl shadow-sm border border-transparent border-l-4 transition-all duration-200 hover:scale-[1.01]",
        currentStyle
    )}>
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        
        {/* INFO PRINCIPAL */}
        <div className="flex items-center gap-4">
            {/* Hora */}
            <div className="flex flex-col items-center justify-center min-w-[60px] bg-background/50 rounded-lg p-2 backdrop-blur-sm">
                <span className="text-xl font-black text-foreground">{start}</span>
                <span className="text-[10px] font-bold text-muted-foreground">{end}</span>
            </div>

            {/* Datos Mascota */}
            <div>
                <h3 className="font-black text-lg text-foreground leading-none mb-1">
                    {appt.pet.name}
                </h3>
                <p className="text-xs font-medium text-muted-foreground">
                    {appt.pet.breed} ‚Ä¢ {appt.pet.ownerName}
                </p>
                
                {/* Badge de Estado */}
                <span className={cn(
                    "inline-block mt-2 px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wider",
                    badgeStyles[appt.status]
                )}>
                    {appt.status === 'CONFIRMED' ? 'EN PROCESO' : appt.status}
                </span>
            </div>
        </div>

        {/* BOTONERA DE ACCIONES (WORKFLOW) */}
        <div className="flex flex-wrap gap-2 items-center justify-end w-full sm:w-auto">
            
            {/* 1. CONFIRMAR (LLEG√ì) */}
            {appt.status === 'PENDING' && (
                <button 
                    disabled={loading}
                    onClick={() => handleStatusChange('CONFIRMED')}
                    className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-4 py-2 rounded-lg transition shadow-sm"
                >
                    üêï LLEG√ì
                </button>
            )}

            {/* 2. TERMINAR (LISTO) */}
            {appt.status === 'CONFIRMED' && (
                <button 
                    disabled={loading}
                    onClick={() => handleStatusChange('COMPLETED')}
                    className="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-4 py-2 rounded-lg transition shadow-sm animate-pulse"
                >
                    ‚ú® LISTO
                </button>
            )}

            {/* 3. COBRAR */}
            {appt.status !== 'BILLED' && appt.status !== 'CANCELLED' && (
                <Link
                    href={`/pos?apptId=${appt.id}&petName=${encodeURIComponent(appt.pet.name)}`}
                    className="bg-foreground text-background hover:bg-foreground/90 text-xs font-bold px-4 py-2 rounded-lg transition flex items-center gap-1 shadow-sm"
                >
                    üí∞ COBRAR
                </Link>
            )}

            {/* 4. CANCELAR */}
            {(appt.status === 'PENDING' || appt.status === 'CONFIRMED') && (
                <form action={cancelAppointment}>
                    <input type="hidden" name="id" value={appt.id} />
                    <button className="text-muted-foreground hover:text-destructive hover:bg-destructive/10 p-2 rounded-lg transition">
                        ‚úñ
                    </button>
                </form>
            )}
        </div>
      </div>
    </div>
  )
}

--- File: AppointmentForm.tsx (in subfolder: components) ---

// src/components/AppointmentForm.tsx
'use client'

import { useState } from "react"
import { createAppointment } from "@/actions/appointment-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"
import { cn } from "@/lib/utils"
// R-08: Importar hook de notificaciones
import { useToast } from "@/components/ui/Toast"

type Props = {
  pets: { id: string, name: string, breed: string | null }[]
  selectedDate: string 
}

export default function AppointmentForm({ pets, selectedDate }: Props) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()
  // R-08: Inicializar toast
  const { addToast } = useToast()

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault() 
    setLoading(true)

    const form = e.currentTarget
    const formData = new FormData(form)
    
    const result = await createAppointment(formData)

    setLoading(false)

    // R-08: Reemplazo de alerts
    if (result.error) {
      addToast(result.error, "error")
    } else {
      addToast("Turno agendado correctamente.", "success")
      form.reset() 
      router.refresh()
    }
  }

  const labelClass = "block text-xs font-bold text-muted-foreground uppercase mb-1.5"
  const inputClass = "w-full p-2.5 rounded-xl border border-input bg-background text-foreground text-sm font-medium focus:ring-2 focus:ring-primary outline-none transition [color-scheme:light] dark:[color-scheme:dark]"

  return (
    <div className="bg-card p-6 rounded-3xl border border-border shadow-sm sticky top-6">
      <h2 className="text-xl font-black mb-6 text-foreground font-nunito flex items-center gap-2">
        üìÖ Agendar Turno
      </h2>
      
      <form onSubmit={handleSubmit} className="space-y-5">
        <div>
          <div className="flex justify-between items-center mb-1.5">
            <label className={labelClass}>Mascota</label>
            <Link href="/pets" className="text-[10px] font-bold text-primary hover:underline uppercase">
                + Nueva
            </Link>
          </div>
          <select name="petId" required className={inputClass}>
            <option value="">Seleccionar...</option>
            {pets.map(p => (
              <option key={p.id} value={p.id}>{p.name} ({p.breed || 'Sin raza'})</option>
            ))}
          </select>
        </div>
        <div>
            <label className={labelClass}>Fecha</label>
            <input type="date" name="date" defaultValue={selectedDate} required className={inputClass} />
        </div>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className={labelClass}>Hora Inicio</label>
            <input name="time" type="time" required className={inputClass} />
          </div>
          <div>
            <label className={labelClass}>Duraci√≥n</label>
            <select name="duration" className={inputClass}>
              <option value="30">30 min</option>
              <option value="60">1 h</option>
              <option value="90">1 h 30m</option>
              <option value="120">2 hs</option>
              <option value="180">3 hs</option>
            </select>
          </div>
        </div>
        <button type="submit" disabled={loading} className={cn("w-full py-3 rounded-xl font-bold transition text-primary-foreground shadow-lg active:scale-95 mt-2", loading ? 'bg-muted text-muted-foreground cursor-wait' : 'bg-primary hover:bg-primary/90 shadow-primary/25')}>
          {loading ? "Verificando..." : "Confirmar Reserva"}
        </button>
      </form>
    </div>
  )
}

--- File: CancelSaleButton.tsx (in subfolder: components) ---

// src/components/CancelSaleButton.tsx
'use client'

import { cancelSale } from "@/actions/sale-actions"
import { useState } from "react"

export default function CancelSaleButton({ saleId }: { saleId: string }) {
  const [loading, setLoading] = useState(false)

  const handleCancel = async () => {
    // 1. Log en el NAVEGADOR (Mirar F12 > Console)
    console.log(`üîµ [CLIENTE] Click en anular venta ID: ${saleId}`)

    const confirmed = confirm("¬øEst√°s SEGURO de anular esta venta?\n\nSi ya fue liquidada, se generar√° una deuda al due√±o.")
    if (!confirmed) return

    setLoading(true)

    try {
      // 2. Llamada al Servidor
      console.log("‚è≥ [CLIENTE] Llamando al servidor...")
      const result = await cancelSale(saleId)

      // 3. Respuesta del Servidor
      console.log("üü¢ [CLIENTE] Respuesta recibida:", result)

      if (result.success) {
        alert("‚úÖ ¬°Venta Anulada con √âxito!")
        // La p√°gina se refrescar√° sola gracias al revalidatePath del servidor
      } else {
        alert(`‚ùå Error: ${result.error}`)
      }
    } catch (err) {
      console.error("üî¥ [CLIENTE] Error de red o c√≥digo:", err)
      alert("Error inesperado al intentar anular.")
    } finally {
      setLoading(false)
    }
  }

  return (
    <button
      onClick={handleCancel}
      disabled={loading}
      className={`text-sm font-semibold border px-3 py-1 rounded transition
        ${loading 
          ? 'bg-gray-200 text-gray-500 cursor-wait' 
          : 'text-red-600 border-red-200 hover:bg-red-50 hover:text-red-800'
        }
      `}
    >
      {loading ? "Procesando..." : "Anular"}
    </button>
  )
}

--- File: CustomerForm.tsx (in subfolder: components) ---

// src/components/CustomerForm.tsx
'use client'

import { createCustomer, updateCustomer } from "@/actions/customer-actions"
import { useRouter } from "next/navigation"
import { useState } from "react"
import { cn } from "@/lib/utils"

type CustomerData = {
  id?: string
  name: string
  email: string | null
  phone: string | null
  address: string | null
}

export default function CustomerForm({ initialData }: { initialData?: CustomerData }) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    
    let result;
    
    if (initialData?.id) {
        // MODO EDICI√ìN
        formData.append("id", initialData.id)
        result = await updateCustomer(formData)
        if (result.success) {
            router.refresh()
            // Opcional: Podr√≠amos redirigir, pero si estamos en el perfil, el refresh basta
        }
    } else {
        // MODO CREACI√ìN
        result = await createCustomer(formData)
        if (result?.success) {
            const form = document.getElementById("customer-form") as HTMLFormElement
            form?.reset()
            router.refresh()
        }
    }

    setLoading(false)
    if (result?.error) alert(result.error)
  }

  // Estilos compartidos
  const inputClass = "w-full p-3 rounded-xl border border-input bg-background text-foreground text-sm focus:ring-2 focus:ring-primary outline-none transition"
  const labelClass = "block text-xs font-bold text-muted-foreground uppercase mb-1.5"

  return (
    <div className="bg-card p-6 rounded-3xl shadow-sm border border-border sticky top-6">
      <h2 className="text-xl font-black text-foreground mb-6 font-nunito flex items-center gap-2">
        {initialData ? "‚úèÔ∏è Editar Cliente" : "üë§ Nuevo Cliente"}
      </h2>
      
      <form id="customer-form" action={handleSubmit} className="flex flex-col gap-5">
        
        {/* NOMBRE */}
        <div>
          <label className={labelClass}>Nombre y Apellido *</label>
          <input 
            name="name" 
            defaultValue={initialData?.name}
            type="text" 
            required 
            className={inputClass} 
            placeholder="Ej: Laura G√≥mez"
          />
        </div>

        {/* TEL√âFONO */}
        <div>
          <label className={labelClass}>Tel√©fono / WhatsApp</label>
          <input 
            name="phone" 
            defaultValue={initialData?.phone || ""}
            type="text" 
            className={inputClass} 
            placeholder="11 1234 5678"
          />
        </div>

        {/* EMAIL */}
        <div>
          <label className={labelClass}>Email (Opcional)</label>
          <input 
            name="email" 
            defaultValue={initialData?.email || ""}
            type="email" 
            className={inputClass} 
            placeholder="cliente@mail.com"
          />
        </div>

        {/* DIRECCI√ìN */}
        <div>
          <label className={labelClass}>Direcci√≥n (Opcional)</label>
          <input 
            name="address" 
            defaultValue={initialData?.address || ""}
            type="text" 
            className={inputClass} 
            placeholder="Av. Principal 123"
          />
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={cn(
            "w-full py-3 rounded-xl font-bold text-primary-foreground shadow-lg transition active:scale-95 mt-2",
            loading 
                ? 'bg-muted text-muted-foreground cursor-wait' 
                : 'bg-primary hover:bg-primary/90 shadow-primary/25'
          )}
        >
          {loading ? "Guardando..." : "Guardar Ficha"}
        </button>
      </form>
    </div>
  )
}

--- File: CustomerSaleRow.tsx (in subfolder: components) ---

// src/components/CustomerSaleRow.tsx
'use client'

import { useState } from "react"
import { markSaleAsPaid } from "@/actions/customer-actions"
import { cn } from "@/lib/utils"

type SaleType = {
    id: string
    createdAt: Date
    total: any // Decimal
    paymentStatus: string // 'PAID' | 'PENDING'
    items: { description: string, quantity: number }[]
}

export default function CustomerSaleRow({ sale }: { sale: SaleType }) {
    const [loading, setLoading] = useState(false)
    const isPending = sale.paymentStatus === 'PENDING'

    const handlePay = async () => {
        if (!confirm("¬øConfirm√°s que el cliente pag√≥ esta deuda?")) return
        setLoading(true)
        await markSaleAsPaid(sale.id)
        setLoading(false)
    }

    return (
        <tr className={cn("transition", isPending ? "bg-red-500/5" : "hover:bg-muted/30")}>
            <td className="p-4 pl-6">
                <p className="font-bold text-foreground">{sale.createdAt.toLocaleDateString()}</p>
                <p className="text-xs text-muted-foreground font-mono">
                    {sale.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </p>
            </td>
            
            <td className="p-4">
                <div className="text-xs text-foreground/80 max-w-[200px] truncate">
                    {sale.items.map(i => `${i.quantity} ${i.description}`).join(", ")}
                </div>
                <p className="text-[10px] text-muted-foreground mt-0.5">ID: {sale.id.slice(0,6)}</p>
            </td>

            <td className="p-4 text-right font-mono font-bold text-base">
                ${Number(sale.total).toLocaleString()}
            </td>

            <td className="p-4 text-center">
                <span className={cn(
                    "px-2 py-1 rounded text-[10px] font-black uppercase border",
                    isPending 
                        ? "bg-destructive/10 text-destructive border-destructive/20" 
                        : "bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20"
                )}>
                    {isPending ? "PENDIENTE" : "PAGADO"}
                </span>
            </td>

            <td className="p-4 pr-6 text-right">
                {isPending && (
                    <button 
                        onClick={handlePay}
                        disabled={loading}
                        className="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition active:scale-95 disabled:opacity-50"
                    >
                        {loading ? "..." : "üí∏ COBRAR"}
                    </button>
                )}
            </td>
        </tr>
    )
}

--- File: ExcelImporter.tsx (in subfolder: components) ---

'use client'

import { useState } from "react"
import readXlsxFile from "read-excel-file"
import { importProductBatch } from "@/actions/bulk-actions"
import { cn } from "@/lib/utils"

function chunkArray<T>(array: T[], size: number): T[][] {
  const chunks: T[][] = []
  for (let i = 0; i < array.length; i += size) {
    chunks.push(array.slice(i, i + size))
  }
  return chunks
}

export default function ExcelImporter() {
  const [rows, setRows] = useState<any[]>([])
  const [processing, setProcessing] = useState(false)
  const [progress, setProgress] = useState({ current: 0, total: 0, errors: 0 })
  const [logs, setLogs] = useState<string[]>([])

  const handleFile = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    if (file.size > 5 * 1024 * 1024) {
        alert("‚ö†Ô∏è El archivo es demasiado grande. M√°ximo 5MB.")
        e.target.value = "" 
        return
    }

    try {
      const data = await readXlsxFile(file)
      const cleanData = data.slice(1).map(row => ({
        name: row[0] as string,
        variantName: row[1] as string,
        categoryName: row[2] as string,
        ownerName: row[3] as string,
        cost: Number(row[4]),
        price: Number(row[5])
      }))

      setRows(cleanData)
      setLogs(prev => [...prev, `üìÇ Archivo cargado: ${cleanData.length} filas detectadas. Listo para importar.`])
      setProgress({ current: 0, total: cleanData.length, errors: 0 })
    } catch (error) {
      console.error(error)
      alert("Error leyendo Excel. Verific√° el formato.")
    }
  }

  const startImport = async () => {
    setProcessing(true)
    setLogs([]) 
    
    const BATCH_SIZE = 20
    const batches = chunkArray(rows, BATCH_SIZE)
    
    let processedCount = 0
    let errorCount = 0
    let batchIndex = 1

    for (const batch of batches) {
        try {
            const result = await importProductBatch(batch)

            if (result.success) {
                processedCount += batch.length
                setLogs(prev => [...prev, `‚úÖ Lote ${batchIndex}/${batches.length}: ${batch.length} items procesados.`])
            } else {
                errorCount += batch.length
                setLogs(prev => [...prev, `‚ùå Error en Lote ${batchIndex}: ${result.error}`])
            }
        } catch (err) {
            errorCount += batch.length
            setLogs(prev => [...prev, `‚ùå Error cr√≠tico en Lote ${batchIndex}.`])
        }

        processedCount = Math.min(processedCount, rows.length) 
        setProgress(p => ({ 
            current: processedCount + errorCount,
            total: rows.length, 
            errors: errorCount 
        }))

        batchIndex++
    }

    setProcessing(false)
    setLogs(prev => [...prev, `üèÅ FIN DEL PROCESO. √âxitos: ${processedCount} | Fallos: ${errorCount}`])
    
    if (errorCount === 0) {
        setTimeout(() => {
            alert("Importaci√≥n completada exitosamente.")
            setRows([])
        }, 500)
    }
  }

  return (
    <div className="bg-card p-6 md:p-8 rounded-3xl shadow-sm border border-border h-full flex flex-col">
      <h2 className="text-xl font-black text-foreground mb-4 font-nunito flex items-center gap-2">
         <span>üìä</span> Importaci√≥n Masiva (Excel)
      </h2>
      
      <div className="mb-6 p-5 bg-primary/5 text-foreground text-sm rounded-2xl border border-primary/10">
        <strong className="block mb-3 font-bold uppercase text-xs text-primary tracking-wide">Columnas Requeridas</strong>
        <div className="grid grid-cols-2 gap-2 text-xs font-mono text-muted-foreground">
            <div>1. Nombre Producto</div>
            <div>2. Variante (Talle/Color)</div>
            <div>3. Categor√≠a</div>
            <div>4. Due√±o</div>
            <div>5. Costo</div>
            <div>6. Precio Venta</div>
        </div>
      </div>

      {!processing && rows.length === 0 && (
        <label className="flex flex-col items-center justify-center w-full flex-1 min-h-[200px] border-2 border-dashed border-border rounded-2xl cursor-pointer hover:bg-muted/30 transition group">
            <div className="flex flex-col items-center justify-center pt-5 pb-6">
                <span className="text-4xl mb-3 grayscale opacity-50 group-hover:scale-110 transition-transform">üìÑ</span>
                <p className="mb-1 text-sm font-bold text-foreground">Subir archivo Excel</p>
                <p className="text-xs text-muted-foreground">Click o arrastrar aqu√≠ (.xlsx)</p>
            </div>
            <input 
                type="file" 
                accept=".xlsx" 
                onChange={handleFile}
                className="hidden" 
            />
        </label>
      )}

      {rows.length > 0 && !processing && progress.current === 0 && (
        <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
          <div className="flex justify-between items-center bg-muted/30 p-4 rounded-2xl border border-border">
             <div className="flex items-center gap-3">
                 <span className="text-2xl">üìë</span>
                 <div>
                    <p className="font-bold text-sm text-foreground">{rows.length} filas listas</p>
                    <p className="text-xs text-muted-foreground">Preparado para importar</p>
                 </div>
             </div>
             <button 
               onClick={() => { setRows([]); setLogs([]); }} 
               className="text-muted-foreground hover:text-destructive text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-destructive/10 transition"
             >
               Cancelar
             </button>
          </div>
          <button 
            onClick={startImport}
            className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-black shadow-lg shadow-green-900/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm uppercase tracking-wide"
          >
            <span>üöÄ</span> Comenzar Importaci√≥n
          </button>
        </div>
      )}

      {/* BARRA DE PROGRESO */}
      {(processing || progress.current > 0) && (
        <div className="mt-6 space-y-3 animate-in fade-in">
          <div className="flex justify-between text-[10px] font-black uppercase text-muted-foreground tracking-widest">
            <span>Progreso del lote</span>
            <span>{Math.round((progress.current / progress.total) * 100)}%</span>
          </div>
          <div className="w-full bg-secondary rounded-full h-2 overflow-hidden">
            <div 
              className={cn(
                  "h-full rounded-full transition-all duration-300 ease-out",
                  progress.errors > 0 ? 'bg-orange-500' : 'bg-primary'
              )}
              style={{ width: `${(progress.current / progress.total) * 100}%` }}
            ></div>
          </div>
          <div className="flex justify-between text-xs font-bold">
            <span className="text-muted-foreground">Procesando {progress.current} de {progress.total}...</span>
            {progress.errors > 0 && <span className="text-destructive bg-destructive/10 px-2 py-0.5 rounded">{progress.errors} errores</span>}
          </div>
        </div>
      )}

      {/* CONSOLA DE LOGS */}
      <div className="mt-6 bg-slate-950 dark:bg-black text-slate-300 p-4 rounded-2xl font-mono text-[10px] h-48 overflow-y-auto border border-border shadow-inner custom-scrollbar">
        {logs.length === 0 ? (
            <div className="h-full flex items-center justify-center opacity-30 italic">
                Esperando inicio del proceso...
            </div>
        ) : (
            logs.map((log, i) => (
                <div key={i} className={cn(
                    "mb-1.5 border-b border-white/5 pb-1 last:border-0",
                    log.includes('‚ùå') ? 'text-red-400 font-bold' : 'text-green-400'
                )}>
                    <span className="opacity-50 mr-2">[{new Date().toLocaleTimeString()}]</span>
                    {log}
                </div>
            ))
        )}
      </div>
    </div>
  )
}

--- File: ExportButtons.tsx (in subfolder: components) ---

'use client'

import { useState } from "react"
import { exportProducts } from "@/actions/export-actions"
import { useToast } from "@/components/ui/Toast" // Usamos el sistema de notificaciones
import { cn } from "@/lib/utils"

export default function ExportButtons() {
  const [loading, setLoading] = useState<'TEMPLATE' | 'FULL' | null>(null)
  const { addToast } = useToast()

  const handleExport = async (mode: 'TEMPLATE' | 'FULL') => {
    setLoading(mode)
    
    try {
      const result = await exportProducts(mode)

      if (result.success && result.base64 && result.filename) {
        // Truco para descargar archivo desde Base64
        const link = document.createElement("a")
        link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${result.base64}`
        link.download = result.filename
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        
        addToast(
            mode === 'TEMPLATE' ? "üìÑ Plantilla descargada" : "üì• Exportaci√≥n completa", 
            "success"
        )
      } else {
        addToast(`‚ùå ${result.error}`, "error")
      }
    } catch (error) {
      console.error(error)
      addToast("üö´ Error de conexi√≥n al exportar", "error")
    } finally {
      setLoading(null)
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
      
      {/* OPCI√ìN 1: PLANTILLA VAC√çA */}
      <div className="bg-card hover:bg-muted/30 p-6 rounded-2xl border border-dashed border-border flex flex-col items-center justify-center text-center gap-2 transition-colors duration-200 group">
        <div className="w-12 h-12 rounded-full bg-muted flex items-center justify-center text-2xl group-hover:scale-110 transition-transform mb-1">
            üìÑ
        </div>
        <h3 className="font-black text-foreground text-sm uppercase tracking-wide">¬øCarga Nueva?</h3>
        <p className="text-xs text-muted-foreground max-w-xs font-medium">Descarg√° el formato oficial vac√≠o para completar y subir.</p>
        <button 
          onClick={() => handleExport('TEMPLATE')}
          disabled={!!loading}
          className="mt-3 w-full md:w-auto bg-background hover:bg-accent text-foreground border border-input px-6 py-2.5 rounded-xl text-xs font-bold transition shadow-sm"
        >
          {loading === 'TEMPLATE' ? "Generando..." : "Descargar Plantilla"}
        </button>
      </div>

      {/* OPCI√ìN 2: EXPORTAR DATOS REALES */}
      <div className="bg-blue-500/5 hover:bg-blue-500/10 p-6 rounded-2xl border border-blue-500/20 flex flex-col items-center justify-center text-center gap-2 transition-colors duration-200 group">
        <div className="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform mb-1">
            üì•
        </div>
        <h3 className="font-black text-blue-700 dark:text-blue-400 text-sm uppercase tracking-wide">Edici√≥n Masiva</h3>
        <p className="text-xs text-blue-600/80 dark:text-blue-300/80 max-w-xs font-medium">Baj√° tu inventario actual, edit√° precios r√°pido y volv√© a subirlo.</p>
        <button 
           onClick={() => handleExport('FULL')}
           disabled={!!loading}
           className="mt-3 w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl text-xs font-bold transition shadow-lg shadow-blue-500/20"
        >
          {loading === 'FULL' ? "Procesando..." : "Exportar Inventario"}
        </button>
      </div>

    </div>
  )
}

--- File: ImageUpload.tsx (in subfolder: components) ---

// src/components/ImageUpload.tsx
'use client' // Necesario para interactuar con el usuario

import { useState } from "react"

export default function ImageUpload({ onImageUpload }: { onImageUpload: (url: string) => void }) {
  const [uploading, setUploading] = useState(false)
  const [preview, setPreview] = useState<string | null>(null)

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setUploading(true)

    // 1. Preparar los datos para Cloudinary
    const formData = new FormData()
    formData.append("file", file)
    formData.append("upload_preset", process.env.NEXT_PUBLIC_CLOUDINARY_PRESET!)

    try {
      // 2. Enviar a Cloudinary (Petici√≥n directa desde el navegador)
      const cloudName = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData,
      })

      const data = await response.json()

      if (data.secure_url) {
        // 3. √âxito: Guardamos la URL y avisamos al componente padre
        setPreview(data.secure_url)
        onImageUpload(data.secure_url) // üëà Esta funci√≥n viene de afuera
      } else {
        alert("Error al subir imagen")
      }
    } catch (error) {
      console.error(error)
      alert("Error de conexi√≥n al subir imagen")
    } finally {
      setUploading(false)
    }
  }

  return (
    <div className="flex flex-col gap-2">
      <label className="text-sm font-medium text-gray-700">Imagen del Producto</label>
      
      <div className="flex items-center gap-4">
        {/* Input de archivo */}
        <input 
          type="file" 
          accept="image/*"
          onChange={handleFileChange}
          disabled={uploading}
          className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
        
        {/* Indicador de carga */}
        {uploading && <span className="text-sm text-blue-600">Subiendo...</span>}
      </div>

      {/* Previsualizaci√≥n */}
      {preview && (
        <div className="mt-2">
          <img src={preview} alt="Vista previa" className="h-32 w-32 object-cover rounded-md border" />
        </div>
      )}
    </div>
  )
}

--- File: InventoryImporter.tsx (in subfolder: components) ---

// src/components/InventoryImporter.tsx
'use client'

import { useState } from "react"
import { exportInventorySheet } from "@/actions/inventory-export-actions"
import { bulkUpdateStock } from "@/actions/inventory-bulk-actions"
import readXlsxFile from "read-excel-file"
import { cn } from "@/lib/utils"

export default function InventoryImporter() {
  const [downloading, setDownloading] = useState(false)
  const [uploading, setUploading] = useState(false)
  const [logs, setLogs] = useState<string[]>([])

  // 1. DESCARGAR PLANILLA
  const handleDownload = async () => {
    setDownloading(true)
    const res = await exportInventorySheet()
    if (res.success && res.base64) {
        const link = document.createElement("a")
        link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${res.base64}`
        link.download = res.filename!
        link.click()
    } else {
        alert("Error descargando planilla")
    }
    setDownloading(false)
  }

  // 2. IMPORTAR PLANILLA
  const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro de procesar este archivo?\n\nLas cantidades ingresadas se SUMAR√ÅN al stock actual.")) {
        e.target.value = "" // Reset
        return
    }

    setUploading(true)
    setLogs([])

    try {
        const rows = await readXlsxFile(file)
        const dataRows = rows.slice(1) // Omitir cabecera
        
        const payload = dataRows.map(r => ({
            variantId: r[0] as string,
            quantity: Number(r[5]), 
            reason: r[6] as string  
        })).filter(item => item.variantId && item.quantity !== 0 && !isNaN(item.quantity))

        if (payload.length === 0) {
            alert("No se detectaron cantidades v√°lidas para procesar.")
            setUploading(false)
            return
        }

        setLogs(prev => [...prev, `‚è≥ Procesando ${payload.length} movimientos...`])

        const res = await bulkUpdateStock(payload)

        if (res.success) {
            setLogs(prev => [...prev, `‚úÖ √âxito: ${res.count} items actualizados.`])
            if (res.errors && res.errors.length > 0) {
                res.errors.forEach(err => setLogs(p => [...p, `‚ùå ${err}`]))
            }
        } else {
            setLogs(prev => [...prev, `‚õî Error General: ${res.error}`])
        }

    } catch (error) {
        console.error(error)
        alert("Error leyendo el archivo.")
    } finally {
        setUploading(false)
        e.target.value = "" 
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-1">
          <h2 className="text-xl font-bold text-foreground">Gesti√≥n Masiva (Excel)</h2>
          <p className="text-sm text-muted-foreground">Actualiz√° stock r√°pidamente descargando la planilla y volvi√©ndola a subir.</p>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
        
        {/* PASO 1: BAJAR */}
        <div className="bg-primary/5 p-4 rounded-2xl border border-primary/10">
            <div className="flex items-center gap-2 mb-3">
                <span className="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-primary-foreground">1</span>
                <p className="text-sm font-bold text-foreground">Descargar Planilla</p>
            </div>
            <button 
                onClick={handleDownload}
                disabled={downloading}
                className={cn(
                    "w-full bg-background hover:bg-accent text-foreground px-4 py-3 rounded-xl font-bold border border-border shadow-sm transition flex items-center justify-center gap-2 group",
                    downloading && "opacity-50 cursor-wait"
                )}
            >
                <span className="text-xl group-hover:scale-110 transition">üì•</span>
                {downloading ? "Generando..." : "Bajar Excel de Stock"}
            </button>
        </div>

        {/* PASO 2: SUBIR */}
        <div className="bg-green-500/5 p-4 rounded-2xl border border-green-500/10">
            <div className="flex items-center gap-2 mb-3">
                <span className="flex h-6 w-6 items-center justify-center rounded-full bg-green-600 text-[10px] font-bold text-white">2</span>
                <p className="text-sm font-bold text-foreground">Subir Cambios</p>
            </div>
            
            <div className="relative group">
                {uploading ? (
                    <div className="w-full py-3 text-center text-sm font-bold text-green-600 animate-pulse bg-green-500/10 rounded-xl">
                        Procesando movimientos...
                    </div>
                ) : (
                    <input 
                        type="file" 
                        accept=".xlsx"
                        onChange={handleUpload}
                        className="
                          block w-full text-sm text-muted-foreground
                          file:mr-4 file:py-3 file:px-4
                          file:rounded-xl file:border-0
                          file:text-sm file:font-bold
                          file:bg-green-600 file:text-white
                          hover:file:bg-green-700
                          cursor-pointer
                          file:cursor-pointer
                          file:transition
                        "
                    />
                )}
            </div>
        </div>
      </div>

      {/* LOGS TERMINAL */}
      {logs.length > 0 && (
        <div className="mt-4 bg-zinc-950 p-4 rounded-xl border border-zinc-800 shadow-inner">
            <p className="text-[10px] uppercase font-bold text-zinc-500 mb-2 tracking-widest">Consola de Resultados</p>
            <div className="font-mono text-xs space-y-1 max-h-32 overflow-y-auto custom-scrollbar">
                {logs.map((l, i) => (
                    <div key={i} className={cn(
                        "break-all",
                        l.includes('‚ùå') ? "text-red-400" : 
                        l.includes('‚úÖ') ? "text-green-400" : 
                        "text-zinc-300"
                    )}>
                        {l}
                    </div>
                ))}
            </div>
        </div>
      )}
    </div>
  )
}

--- File: MainNav.tsx (in subfolder: components) ---

'use client'

import { useState, useEffect } from "react"
import Link from "next/link"
import { usePathname } from "next/navigation"
import { cn } from "@/lib/utils"
import { ThemeToggle } from "./ThemeToggle"
import { logout } from "@/actions/auth-actions"

export default function MainNav() {
  const pathname = usePathname()
  
  // üõë FIX: Si estamos en el login, no renderizamos nada (return null)
  // Esto permite que el formulario de login ocupe toda la pantalla y se centre.
  if (pathname === "/login") return null

  // Estado local para colapso
  const [isCollapsed, setIsCollapsed] = useState(false)
  const [isMounted, setIsMounted] = useState(false)

  useEffect(() => {
    setIsMounted(true)
    const savedState = localStorage.getItem("sidebar-collapsed")
    if (savedState === "true") {
      setIsCollapsed(true)
    }
  }, [])

  const toggleSidebar = () => {
    const newState = !isCollapsed
    setIsCollapsed(newState)
    localStorage.setItem("sidebar-collapsed", String(newState))
  }

  const routes = [
    { href: "/dashboard", label: "Inicio", icon: "üè†", exact: true },
    { href: "/pos", label: "Caja", icon: "üõçÔ∏è", exact: true, highlight: true },
    { href: "/agenda", label: "Agenda", icon: "üìÖ", exact: false },
    { href: "/sales", label: "Ventas", icon: "üßæ", exact: false },
    { href: "/customers", label: "Clientes", icon: "üë§", exact: false }, 
    { href: "/products", label: "Stock", icon: "üì¶", exact: false },
    { href: "/pets", label: "Mascotas", icon: "üê∂", exact: false },
    { href: "/owners", label: "Due√±os", icon: "üë•", exact: false },
    { href: "/owners/balance", label: "Finanzas", icon: "üíé", exact: true },
    { href: "/admin/users", label: "Equipo", icon: "üõ°Ô∏è", exact: false },
  ]

  // Si no est√° montado, renderizamos placeholder para evitar layout shift
  if (!isMounted) return <div className="hidden md:flex w-72 h-screen bg-card" />

  return (
    <>
      {/* === DESKTOP SIDEBAR === */}
      <aside 
        className={cn(
            "hidden md:flex flex-col bg-card border-r border-border h-screen sticky top-0 z-50 transition-all duration-300 ease-in-out",
            isCollapsed ? "w-20" : "w-72"
        )}
      >
        
        {/* LOGO */}
        <div className={cn(
            "flex items-center transition-all duration-300",
            isCollapsed ? "p-4 justify-center" : "p-8 pb-6"
        )}>
          {isCollapsed ? (
             <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center text-xl shadow-lg cursor-pointer" onClick={toggleSidebar}>
                üê∂
             </div>
          ) : (
             <div className="overflow-hidden whitespace-nowrap">
                <h1 className="text-3xl font-black font-nunito tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-primary to-foreground animate-in fade-in">
                    GUAPECANES
                </h1>
                <p className="text-[10px] font-bold text-muted-foreground mt-0.5 uppercase tracking-widest truncate">
                    Sistema Profesional v3
                </p>
             </div>
          )}
        </div>

        {/* NAV */}
        <nav className="flex-1 px-3 space-y-2 py-4 overflow-y-auto overflow-x-hidden custom-scrollbar">
          {routes.map((route) => {
            const isActive = route.exact 
                ? pathname === route.href
                : pathname.startsWith(route.href)

            return (
              <Link
                key={route.href}
                href={route.href}
                title={isCollapsed ? route.label : undefined}
                className={cn(
                  "flex items-center transition-all duration-200 group relative",
                  isCollapsed ? "justify-center p-3 rounded-xl" : "gap-4 px-4 py-3 rounded-2xl",
                  "text-sm font-bold",
                  route.highlight 
                    ? cn(
                        "bg-gradient-to-r from-primary to-accent text-primary-foreground shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:scale-[1.02] mb-6",
                        isCollapsed ? "rounded-2xl aspect-square" : "justify-center text-base"
                      )
                    : isActive 
                        ? "bg-primary/10 text-primary" 
                        : "text-muted-foreground hover:bg-secondary/20 hover:text-foreground"
                )}
              >
                <span className={cn(
                    "transition-transform group-hover:scale-110 shrink-0", 
                    route.highlight && "animate-pulse",
                    isCollapsed ? "text-2xl" : "text-xl"
                )}>
                    {route.icon}
                </span>
                
                <span className={cn(
                    "whitespace-nowrap overflow-hidden transition-all duration-300",
                    isCollapsed ? "w-0 opacity-0" : "w-auto opacity-100"
                )}>
                    {route.label}
                </span>
                
                {!isCollapsed && !route.highlight && isActive && (
                    <div className="ml-auto w-1.5 h-1.5 rounded-full bg-primary shrink-0" />
                )}

                {isCollapsed && isActive && (
                    <div className="absolute top-2 right-2 w-2 h-2 rounded-full bg-primary border-2 border-card" />
                )}
              </Link>
            )
          })}
        </nav>

        {/* FOOTER */}
        <div className="p-3 border-t border-border space-y-3 shrink-0">
            <div className={cn(
                "flex items-center bg-background/50 rounded-2xl border border-border transition-all duration-300",
                isCollapsed ? "flex-col gap-2 p-2 bg-transparent border-none" : "justify-between p-3"
            )}>
                {!isCollapsed ? (
                    <div className="flex items-center gap-3 overflow-hidden">
                        <div className="w-8 h-8 rounded-full bg-secondary flex items-center justify-center text-secondary-foreground text-xs font-bold shrink-0">
                            ST
                        </div>
                        <div className="min-w-0">
                            <p className="text-xs font-bold text-foreground truncate">Staff</p>
                            <p className="text-[10px] text-green-500 font-bold uppercase truncate">‚óè Online</p>
                        </div>
                    </div>
                ) : (
                     <div className="w-8 h-8 rounded-full bg-secondary flex items-center justify-center text-secondary-foreground text-xs font-bold shrink-0" title="Staff Online">
                        ST
                    </div>
                )}
                
                <ThemeToggle />
            </div>

            <form action={logout}>
                <button 
                    type="submit"
                    className={cn(
                        "flex items-center justify-center gap-2 text-muted-foreground hover:bg-destructive/10 hover:text-destructive transition text-xs font-bold",
                        isCollapsed ? "w-full p-2 rounded-xl" : "w-full py-2 rounded-xl"
                    )}
                    title="Cerrar Sesi√≥n"
                >
                    <span className="text-lg">üö™</span> 
                    {!isCollapsed && <span>Cerrar Sesi√≥n</span>}
                </button>
            </form>

            <button 
                onClick={toggleSidebar}
                className="w-full h-8 flex items-center justify-center text-muted-foreground hover:text-foreground hover:bg-secondary rounded-lg transition-colors text-lg font-black"
            >
                {isCollapsed ? "¬ª" : "¬´"}
            </button>
        </div>
      </aside>

      {/* === MOBILE NAV === */}
      <nav className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-card/95 backdrop-blur-md border-t border-border pb-safe pt-2 px-4 shadow-[0_-5px_20px_rgba(0,0,0,0.2)]">
        <div className="flex justify-between items-center">
            {routes.slice(0, 5).map((route) => {
                const isActive = route.exact ? pathname === route.href : pathname.startsWith(route.href)
                
                if (route.highlight) {
                    return (
                        <Link key={route.href} href={route.href} className="relative -top-6">
                            <div className="w-14 h-14 rounded-full bg-gradient-to-r from-primary to-accent flex items-center justify-center text-2xl shadow-lg shadow-primary/40 border-4 border-background text-primary-foreground">
                                {route.icon}
                            </div>
                        </Link>
                    )
                }

                return (
                <Link
                    key={route.href}
                    href={route.href}
                    className={cn(
                    "flex flex-col items-center justify-center p-2 rounded-xl transition-all",
                    isActive ? "text-primary font-bold" : "text-muted-foreground"
                    )}
                >
                    <span className="text-xl mb-0.5">{route.icon}</span>
                    <span className="text-[9px]">{route.label}</span>
                </Link>
                )
            })}

             <div className="flex flex-col gap-2 items-center opacity-80">
                <ThemeToggle />
                <form action={logout}>
                    <button type="submit" className="text-destructive text-lg" title="Salir">
                        üö™
                    </button>
                </form>
             </div>
        </div>
      </nav>
    </>
  )
}

--- File: OwnerForm.tsx (in subfolder: components) ---

// src/components/OwnerForm.tsx
'use client'

import { createOwner, updateOwner } from "@/actions/owner-actions"
import { useRouter } from "next/navigation"
import { useState } from "react"
import { cn } from "@/lib/utils"

type OwnerData = {
  id?: string
  name: string
  email: string | null
  phone: string | null
}

export default function OwnerForm({ initialData }: { initialData?: OwnerData }) {
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    
    let result;
    
    if (initialData?.id) {
        formData.append("id", initialData.id)
        result = await updateOwner(formData)
        if (result.success) {
            router.push("/owners") 
            router.refresh()
        }
    } else {
        result = await createOwner(formData)
        if (result?.success) {
            const form = document.getElementById("owner-form") as HTMLFormElement
            form?.reset()
            router.refresh()
        }
    }

    setLoading(false)
    if (result?.error) alert(result.error)
  }

  const inputClass = "w-full p-3 rounded-xl border border-input bg-background text-foreground text-sm focus:ring-2 focus:ring-primary outline-none transition"
  const labelClass = "block text-xs font-bold text-muted-foreground uppercase mb-1.5"

  return (
    <div className="bg-card p-6 rounded-3xl shadow-sm border border-border sticky top-6">
      <h2 className="text-xl font-black text-foreground mb-6 font-nunito flex items-center gap-2">
        {initialData ? "‚úèÔ∏è Editar Due√±o" : "üë§ Nuevo Due√±o"}
      </h2>
      
      <form id="owner-form" action={handleSubmit} className="flex flex-col gap-5">
        
        <div>
          <label className={labelClass}>Nombre Completo *</label>
          <input 
            name="name" 
            defaultValue={initialData?.name}
            type="text" 
            required 
            className={inputClass} 
            placeholder="Ej: Juan P√©rez"
          />
        </div>

        <div>
          <label className={labelClass}>Email</label>
          <input 
            name="email" 
            defaultValue={initialData?.email || ""}
            type="email" 
            className={inputClass} 
            placeholder="juan@mail.com"
          />
        </div>

        <div>
          <label className={labelClass}>Tel√©fono / WhatsApp</label>
          <input 
            name="phone" 
            defaultValue={initialData?.phone || ""}
            type="text" 
            className={inputClass} 
            placeholder="11 1234 5678"
          />
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className={cn(
            "w-full py-3 rounded-xl font-bold text-primary-foreground shadow-lg transition active:scale-95 mt-2",
            loading 
                ? 'bg-muted text-muted-foreground cursor-wait' 
                : 'bg-primary hover:bg-primary/90 shadow-primary/25'
          )}
        >
          {loading ? "Guardando..." : "Guardar Ficha"}
        </button>
      </form>
    </div>
  )
}

--- File: PosSystem.tsx (in subfolder: components) ---

'use client'

import Image from "next/image"
import { useState } from "react"
import TicketView from "./TicketView"
import { usePos, ProductGroupType, CustomerOption } from "@/hooks/usePos"
import { cn } from "@/lib/utils"
import { createCustomer } from "@/actions/customer-actions"
import { useToast } from "@/components/ui/Toast"

export default function PosSystem({ products, customers }: { products: ProductGroupType[], customers: CustomerOption[] }) {
  const {
    cart, total, loading, paymentMethod, lastSale,
    search, selectedCategory, categories, filteredProducts, selectedProductForModal, selectedCustomerId,
    setPaymentMethod, setSearch, setSelectedCategory, setSelectedProductForModal, clearLastSale, setSelectedCustomerId,
    handleProductClick, addVariantToCart, removeFromCart, updateServicePrice, checkout
  } = usePos(products, customers)

  const { addToast } = useToast()
  
  const [isCustomerModalOpen, setIsCustomerModalOpen] = useState(false)
  const [creatingCustomer, setCreatingCustomer] = useState(false)

  const showImages = process.env.NEXT_PUBLIC_ENABLE_IMAGES === 'true'

  // --- HANDLER ALTA R√ÅPIDA (MODIFICADO) ---
  const handleQuickCustomerCreate = async (formData: FormData) => {
    setCreatingCustomer(true)
    
    // Llamamos a la acci√≥n
    const result = await createCustomer(formData) 
    
    setCreatingCustomer(false)

    if (result?.success) {
        addToast("‚úÖ Cliente creado y seleccionado.", "success")
        setIsCustomerModalOpen(false)
        
        // ‚ú® MAGIA: Si viene el cliente nuevo, lo seleccionamos inmediatamente
        // Next.js refrescar√° las props 'customers' en segundo plano, 
        // pero el ID ya ser√° v√°lido para el estado local.
        if (result.customer) {
            setSelectedCustomerId(result.customer.id)
        }
    } else {
        addToast(result?.error || "Error al crear cliente", "error")
    }
  }

  // ... (El resto del componente sigue id√©ntico, solo cambi√≥ handleQuickCustomerCreate)
  // ... RENDERIZADO DEL TICKET ...
  if (lastSale) {
    if (lastSale.method === 'CHECKING_ACCOUNT') {
        return (
            <div className="flex flex-col items-center justify-center h-full p-4 animate-in zoom-in-95 duration-300">
                <div className="bg-card p-10 rounded-3xl shadow-xl border border-border text-center max-w-md w-full">
                    <span className="text-6xl mb-4 block">üìì</span>
                    <h2 className="text-3xl font-black text-foreground mb-2">Cuenta Corriente Actualizada</h2>
                    <p className="text-muted-foreground font-medium mb-6">
                        Se registraron los √≠tems en la cuenta del cliente correctamente.
                    </p>
                    <button 
                        onClick={clearLastSale}
                        className="w-full bg-primary hover:bg-primary/90 text-primary-foreground font-bold py-4 rounded-xl shadow-lg transition active:scale-95"
                    >
                        ‚ú® Nueva Venta
                    </button>
                </div>
            </div>
        )
    }

    return (
        <TicketView 
            mode="POS"
            saleId={lastSale.id}
            date={lastSale.date}
            items={lastSale.items}
            total={lastSale.total}
            paymentMethod={lastSale.method}
            onClose={clearLastSale}
        />
    )
  }

  return (
    <>
    <div className="flex flex-col md:flex-row h-[calc(100vh-80px)] md:h-[calc(100vh-20px)] gap-6 pb-4 md:pb-0">
      
      {/* === COLUMNA 1: CAT√ÅLOGO === */}
      <div className="flex-1 flex flex-col gap-6 overflow-hidden h-full">
        {/* Header Filtros */}
        <div className="bg-card p-4 rounded-3xl shadow-sm border border-border space-y-3 shrink-0">
            <div className="relative">
                <input 
                    type="text" 
                    placeholder="üîç Buscar producto..." 
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full p-3 pl-10 border border-input rounded-2xl bg-background text-foreground focus:ring-2 focus:ring-ring outline-none transition font-medium placeholder:text-muted-foreground"
                    autoFocus
                />
                {search && (
                    <button 
                        onClick={() => setSearch("")} 
                        className="absolute right-3 top-3 text-muted-foreground hover:text-primary transition"
                    >
                        ‚úï
                    </button>
                )}
            </div>
            
            <div className="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
                {categories.map(cat => (
                    <button
                        key={cat}
                        onClick={() => setSelectedCategory(cat === selectedCategory ? "ALL" : cat)}
                        className={cn(
                            "px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition",
                            selectedCategory === cat 
                                ? 'bg-primary text-primary-foreground border-primary shadow-md' 
                                : 'bg-card text-muted-foreground border-border hover:bg-secondary hover:text-foreground'
                        )}
                    >
                        {cat === "ALL" ? "Todo" : cat}
                    </button>
                ))}
            </div>
        </div>

        {/* Grid de Productos */}
        <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
            {filteredProducts.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-64 text-muted-foreground opacity-60">
                    <span className="text-5xl mb-3">üßê</span>
                    <p className="font-medium">Sin resultados para "{search}"</p>
                    <button 
                        onClick={() => {setSearch(""); setSelectedCategory("ALL")}} 
                        className="text-primary underline text-sm mt-2 font-bold"
                    >
                        Limpiar b√∫squeda
                    </button>
                </div>
            ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 pb-20">
                    {filteredProducts.map(p => {
                        const isOOS = p.totalStock === 0
                        const stockColor = isOOS 
                            ? 'bg-zinc-500' 
                            : p.totalStock <= 3 ? 'bg-orange-500' : 'bg-green-500'

                        return (
                        <button 
                            key={p.id}
                            onClick={() => handleProductClick(p)}
                            disabled={isOOS}
                            className={cn(
                                "group relative flex flex-col p-3 rounded-2xl border transition-all duration-200 text-left overflow-hidden",
                                isOOS 
                                    ? "bg-muted border-border opacity-50 grayscale cursor-not-allowed" 
                                    : "bg-card border-border hover:border-primary hover:shadow-lg hover:shadow-primary/10 hover:-translate-y-1"
                            )}
                        >
                            {showImages && (
                                <div className="w-full aspect-square bg-muted rounded-xl overflow-hidden relative mb-3">
                                    {p.imageUrl ? (
                                        <Image 
                                            src={p.imageUrl} 
                                            alt={p.name} 
                                            fill
                                            className="object-cover transition-transform duration-500 group-hover:scale-110"
                                            sizes="(max-width: 768px) 50vw, 20vw"
                                        />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-xs text-muted-foreground font-bold bg-secondary">
                                            Sin Foto
                                        </div>
                                    )}
                                    <div className={cn(
                                        "absolute top-2 right-2 px-2 py-0.5 rounded-md text-[10px] font-black text-white shadow-sm z-10",
                                        stockColor
                                    )}>
                                        {p.totalStock}
                                    </div>
                                </div>
                            )}
                            
                            <div className="flex-1 min-w-0">
                                <h3 className="font-bold text-foreground text-sm leading-tight line-clamp-2 mb-1 group-hover:text-primary transition-colors">
                                    {p.name}
                                </h3>
                                <p className="text-[10px] font-bold text-muted-foreground uppercase truncate">
                                    {p.ownerName}
                                </p>
                            </div>
                            
                            <div className="mt-3 pt-2 border-t border-dashed border-border flex justify-between items-center w-full">
                                {p.variants.length > 1 ? (
                                    <span className="text-[10px] font-bold bg-secondary text-secondary-foreground px-2 py-1 rounded-full">
                                        Opciones
                                    </span>
                                ) : (
                                    <span className="text-primary font-black text-lg">
                                        ${p.variants[0]?.price || 0}
                                    </span>
                                )}
                                
                                {!showImages && !isOOS && (
                                    <span className={cn("text-[9px] font-bold px-1.5 py-0.5 rounded text-white", stockColor)}>
                                        {p.totalStock}u
                                    </span>
                                )}
                            </div>
                        </button>
                    )})}
                </div>
            )}
        </div>
      </div>

      {/* === COLUMNA 2: TICKET / CARRITO === */}
      <div className="w-full md:w-[380px] shrink-0 h-full flex flex-col">
        <div className="bg-card border border-border rounded-3xl shadow-xl flex flex-col h-full overflow-hidden relative">
          
          <div className="p-5 border-b border-border bg-muted/30 backdrop-blur-sm space-y-3">
            <div className="flex justify-between items-center">
                <h2 className="font-black text-lg text-foreground font-nunito flex items-center gap-2">
                    üõçÔ∏è Ticket
                </h2>
                <span className="text-xs font-bold bg-background text-muted-foreground border border-border px-2 py-1 rounded-lg">
                    {cart.length} items
                </span>
            </div>
            
            <div className="flex gap-2">
                <select 
                    value={selectedCustomerId}
                    onChange={(e) => setSelectedCustomerId(e.target.value)}
                    className={cn(
                        "flex-1 p-2.5 rounded-xl text-sm font-bold border transition outline-none cursor-pointer appearance-none",
                        selectedCustomerId 
                            ? "bg-primary/10 border-primary text-primary" 
                            : "bg-background border-input text-muted-foreground"
                    )}
                >
                    <option value="">üë§ Cliente Final (An√≥nimo)</option>
                    {customers.map(c => (
                        <option key={c.id} value={c.id}>üë§ {c.name}</option>
                    ))}
                </select>
                
                <button 
                    onClick={() => setIsCustomerModalOpen(true)}
                    className="w-10 h-10 flex items-center justify-center rounded-xl bg-secondary hover:bg-primary hover:text-primary-foreground border border-border transition text-lg font-black"
                    title="Nuevo Cliente"
                >
                    +
                </button>
            </div>
          </div>
          
          <div className="p-4 space-y-3 flex-1 overflow-y-auto custom-scrollbar">
            {cart.length === 0 && (
              <div className="h-full flex flex-col items-center justify-center text-center opacity-40 p-8">
                <span className="text-6xl mb-4 grayscale">üõí</span>
                <p className="text-sm font-bold text-foreground">Carrito vac√≠o</p>
                <p className="text-xs text-muted-foreground mt-1">Seleccion√° productos para cobrar.</p>
              </div>
            )}
            
            {cart.map((item, index) => (
              <div key={index} className="flex justify-between items-start p-3 bg-background rounded-2xl border border-transparent hover:border-border transition animate-in slide-in-from-right-4">
                <div className="flex-1 min-w-0 pr-3">
                  <p className="font-bold text-foreground text-sm truncate">
                    {item.type === 'SERVICE' && <span className="mr-1">‚úÇÔ∏è</span>}
                    {item.name}
                  </p>
                  
                  {item.type === 'SERVICE' ? (
                     <div className="mt-1 flex items-center gap-2">
                        <span className="text-xs text-muted-foreground font-bold">$</span>
                        <input 
                            type="number" 
                            value={item.price} 
                            onChange={(e) => updateServicePrice(index, e.target.value)}
                            className="w-20 border border-input rounded px-1 py-0.5 text-sm font-bold bg-card text-foreground focus:ring-1 focus:ring-ring outline-none"
                        />
                     </div>
                  ) : (
                     <div className="flex items-center gap-2 mt-1">
                        <span className="text-xs font-medium text-muted-foreground bg-card px-1.5 py-0.5 rounded border border-border">
                            {item.quantity} un.
                        </span>
                        <span className="text-xs text-muted-foreground">x ${item.price}</span>
                     </div>
                  )}
                </div>

                <div className="flex flex-col items-end gap-1">
                    <span className="font-black text-foreground">
                        ${(item.quantity * item.price).toLocaleString()}
                    </span>
                    <button 
                        onClick={() => removeFromCart(index)} 
                        className="text-[10px] font-bold text-destructive hover:text-destructive-foreground hover:bg-destructive px-2 py-1 rounded transition"
                    >
                        ELIMINAR
                    </button>
                </div>
              </div>
            ))}
          </div>

          <div className="p-5 bg-card border-t border-border z-10">
             
             <div className="grid grid-cols-3 gap-2 mb-5">
                <button 
                    onClick={() => setPaymentMethod("CASH")}
                    className={cn(
                        "p-2 rounded-xl text-[10px] font-black border transition flex flex-col items-center justify-center gap-1 h-14",
                        paymentMethod === "CASH" 
                            ? "bg-green-500/20 text-green-700 dark:text-green-400 border-green-500/50" 
                            : "bg-background border-border text-muted-foreground hover:bg-secondary"
                    )}
                >
                    <span>üíµ</span> EFECTIVO
                </button>
                <button 
                    onClick={() => setPaymentMethod("TRANSFER")}
                    className={cn(
                        "p-2 rounded-xl text-[10px] font-black border transition flex flex-col items-center justify-center gap-1 h-14",
                        paymentMethod === "TRANSFER" 
                            ? "bg-blue-500/20 text-blue-700 dark:text-blue-400 border-blue-500/50" 
                            : "bg-background border-border text-muted-foreground hover:bg-secondary"
                    )}
                >
                    <span>üè¶</span> TRANSFER
                </button>
                <button 
                    onClick={() => setPaymentMethod("CHECKING_ACCOUNT")}
                    className={cn(
                        "p-2 rounded-xl text-[10px] font-black border transition flex flex-col items-center justify-center gap-1 h-14",
                        paymentMethod === "CHECKING_ACCOUNT" 
                            ? "bg-purple-500/20 text-purple-700 dark:text-purple-400 border-purple-500/50" 
                            : "bg-background border-border text-muted-foreground hover:bg-secondary"
                    )}
                >
                    <span>üìì</span> FIADO
                </button>
             </div>

             <div className="flex justify-between items-end mb-5">
                <span className="text-muted-foreground text-sm font-bold uppercase">Total a Pagar</span>
                <span className="text-4xl font-black text-foreground tracking-tight">
                    ${total.toLocaleString()}
                </span>
             </div>
             
             <button 
              onClick={checkout}
              disabled={cart.length === 0 || loading}
              className={cn(
                  "w-full py-4 rounded-xl font-black text-lg transition active:scale-95 text-primary-foreground shadow-xl flex items-center justify-center gap-2",
                  cart.length === 0 
                    ? 'bg-muted text-muted-foreground cursor-not-allowed shadow-none' 
                    : 'bg-primary hover:bg-primary/90 hover:shadow-primary/25'
              )}
            >
              {loading ? (
                  <span className="animate-pulse">Procesando...</span>
              ) : (
                  <>
                    <span>COBRAR</span>
                    <span>‚Üí</span>
                  </>
              )}
            </button>
          </div>
        </div>
      </div>
    </div>

    {selectedProductForModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-card rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-border">
                <div className="p-5 border-b border-border flex justify-between items-center bg-muted/30">
                    <div>
                        <h3 className="font-black text-lg text-foreground font-nunito">{selectedProductForModal.name}</h3>
                        <p className="text-xs text-muted-foreground font-bold uppercase">Seleccion√° variante</p>
                    </div>
                    <button 
                        onClick={() => setSelectedProductForModal(null)} 
                        className="w-8 h-8 rounded-full bg-border flex items-center justify-center text-muted-foreground hover:bg-input transition"
                    >
                        ‚úï
                    </button>
                </div>
                
                <div className="p-4 max-h-[60vh] overflow-y-auto custom-scrollbar grid grid-cols-2 gap-3">
                    {selectedProductForModal.variants.map(variant => {
                        const hasStock = variant.stock > 0
                        return (
                            <button
                                key={variant.id}
                                disabled={!hasStock}
                                onClick={() => {
                                    addVariantToCart(selectedProductForModal.name, variant)
                                    setSelectedProductForModal(null)
                                }}
                                className={cn(
                                    "p-4 border rounded-2xl text-left transition flex flex-col justify-between h-24 relative overflow-hidden",
                                    hasStock 
                                        ? 'bg-background border-border hover:border-primary hover:ring-1 hover:ring-primary/50' 
                                        : 'bg-muted border-transparent opacity-50 cursor-not-allowed'
                                )}
                            >
                                <div className="z-10 relative">
                                    <span className="font-bold text-foreground block text-sm mb-1">{variant.name}</span>
                                    {hasStock ? (
                                        <span className="text-primary font-black text-lg">${variant.price}</span>
                                    ) : (
                                        <span className="text-xs font-bold text-destructive uppercase bg-destructive/10 px-2 py-0.5 rounded">Agotado</span>
                                    )}
                                </div>

                                {hasStock && (
                                    <div className="absolute bottom-2 right-2 text-[10px] font-bold bg-green-500/20 text-green-700 dark:text-green-400 px-2 py-1 rounded-full">
                                        {variant.stock} u.
                                    </div>
                                )}
                            </button>
                        )
                    })}
                </div>
            </div>
        </div>
    )}

    {isCustomerModalOpen && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
             <div className="bg-card rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden border border-border animate-in zoom-in-95">
                <div className="p-5 border-b border-border flex justify-between items-center bg-muted/30">
                    <h3 className="font-black text-lg text-foreground font-nunito">üë§ Nuevo Cliente</h3>
                    <button 
                        onClick={() => setIsCustomerModalOpen(false)} 
                        className="w-8 h-8 rounded-full bg-border flex items-center justify-center text-muted-foreground hover:bg-input transition"
                    >
                        ‚úï
                    </button>
                </div>
                
                <form action={handleQuickCustomerCreate} className="p-6 flex flex-col gap-4">
                    <div className="space-y-1">
                        <label className="text-xs font-bold text-muted-foreground uppercase">Nombre Completo *</label>
                        <input 
                            name="name" 
                            type="text" 
                            required 
                            autoFocus
                            placeholder="Ej: Juan Perez"
                            className="w-full bg-background border border-input p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary"
                        />
                    </div>
                    <div className="space-y-1">
                        <label className="text-xs font-bold text-muted-foreground uppercase">Tel√©fono</label>
                        <input 
                            name="phone" 
                            type="text" 
                            placeholder="Opcional"
                            className="w-full bg-background border border-input p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-primary"
                        />
                    </div>

                    <button 
                        type="submit" 
                        disabled={creatingCustomer}
                        className={cn(
                            "w-full py-3 rounded-xl font-bold text-primary-foreground transition mt-2",
                            creatingCustomer ? 'bg-muted text-muted-foreground' : 'bg-primary hover:bg-primary/90'
                        )}
                    >
                        {creatingCustomer ? "Guardando..." : "Crear Cliente"}
                    </button>
                </form>
             </div>
        </div>
    )}
    </>
  )
}

--- File: ProductActions.tsx (in subfolder: components) ---

'use client'

import { useState } from "react"
import { toggleProductStatus } from "@/actions/product-actions"
import Link from "next/link"
import { useRouter } from "next/navigation"
import { cn } from "@/lib/utils"
import { useToast } from "@/components/ui/Toast"
import ConfirmModal from "@/components/ui/ConfirmModal"

export default function ProductActions({ id, isActive, stock }: { id: string, isActive: boolean, stock: number }) {
  const router = useRouter()
  const { addToast } = useToast()
  
  // Estado local para controlar el modal
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [loading, setLoading] = useState(false)

  // 1. Manejador inicial del clic
  const initiateToggle = (e: React.MouseEvent) => {
    e.preventDefault()
    e.stopPropagation()

    // Validaci√≥n de negocio: No archivar con stock
    if (isActive && stock > 0) {
        addToast("‚ö†Ô∏è No pod√©s archivar un producto con stock. Hac√© un retiro o ajuste a 0 primero.", "error")
        return
    }

    // Si pasa validaci√≥n, abrimos el modal
    setIsModalOpen(true)
  }

  // 2. Acci√≥n confirmada
  const handleConfirm = async () => {
    setLoading(true)
    try {
        const res = await toggleProductStatus(id, isActive)
        
        if (res.error) {
            addToast(`üö´ ${res.error}`, "error")
        } else {
            addToast(
                isActive ? "üì¶ Producto archivado correctamente" : "‚úÖ Producto reactivado", 
                "success"
            )
            router.refresh()
            setIsModalOpen(false)
        }
    } catch (error) {
        addToast("üö´ Error de conexi√≥n", "error")
    } finally {
        setLoading(false)
    }
  }

  return (
    <>
        <div className="flex gap-2 justify-center">
        {/* Bot√≥n EDITAR */}
        <Link 
            href={`/products/${id}/edit`} 
            className="px-3 py-1.5 rounded-lg text-xs font-bold transition border border-border hover:bg-accent hover:text-accent-foreground text-muted-foreground"
            onClick={(e) => e.stopPropagation()}
        >
            EDITAR
        </Link>

        {/* Bot√≥n ARCHIVAR/ACTIVAR */}
        <button
            onClick={initiateToggle}
            disabled={loading}
            className={cn(
                "px-3 py-1.5 rounded-lg text-xs font-bold border transition",
                isActive 
                    ? 'border-destructive/30 text-destructive hover:bg-destructive/10' 
                    : 'border-green-500/30 text-green-600 dark:text-green-400 hover:bg-green-500/10'
            )}
        >
            {isActive ? "ARCHIVAR" : "ACTIVAR"}
        </button>
        </div>

        {/* Modal Declarativo */}
        <ConfirmModal 
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            onConfirm={handleConfirm}
            loading={loading}
            title={isActive ? "¬øArchivar producto?" : "¬øReactivar producto?"}
            description={isActive 
                ? "El producto dejar√° de estar visible en el POS y listados de venta, pero mantendr√° su historial." 
                : "El producto volver√° a estar disponible para la venta inmediatamente."
            }
            confirmText={isActive ? "S√≠, archivar" : "S√≠, reactivar"}
            variant={isActive ? "danger" : "info"}
        />
    </>
  )
}


--- File: ProductForm.tsx (in subfolder: components) ---

// src/components/ProductForm.tsx
'use client'

import { useState } from "react"
import { createProduct, updateProduct } from "@/actions/product-actions"
import dynamic from 'next/dynamic'
import { useRouter } from "next/navigation"
import { cn } from "@/lib/utils"
import { useToast } from "@/components/ui/Toast"

const ImageUpload = dynamic(() => import('./ImageUpload'), {
  loading: () => <p className="text-xs text-muted-foreground animate-pulse">Cargando m√≥dulo de im√°genes...</p>,
  ssr: false
})

type VariantItem = {
  id?: string 
  name: string
  costPrice: number
  salePrice: number
  stock?: number 
}

type Props = {
  owners: { id: string; name: string }[]
  categories: { id: string; name: string }[]
  initialData?: {
    id: string
    name: string
    description: string | null
    ownerId: string
    categoryId: string
    imageUrl: string | null
    variants: VariantItem[]
  }
}

export default function ProductForm({ owners, categories, initialData }: Props) {
  const router = useRouter()
  const { addToast } = useToast()
  const [imageUrl, setImageUrl] = useState(initialData?.imageUrl || "")
  const [loading, setLoading] = useState(false)
  const [isNewCategory, setIsNewCategory] = useState(false)
  const [variants, setVariants] = useState<VariantItem[]>(
    initialData?.variants || [{ name: "Est√°ndar", costPrice: 0, salePrice: 0 }]
  )

  const showImages = process.env.NEXT_PUBLIC_ENABLE_IMAGES === 'true'

  const addVariant = () => {
    setVariants([...variants, { name: "", costPrice: 0, salePrice: 0 }])
  }

  const removeVariant = (index: number) => {
    if (variants.length <= 1) {
        addToast("Debe haber al menos una variante.", "error")
        return
    }
    if (variants[index].id) {
        addToast("Las variantes guardadas no se borran desde aqu√≠ para proteger el historial.", "info")
        return
    }
    const newList = [...variants]
    newList.splice(index, 1)
    setVariants(newList)
  }

  const updateVariant = (index: number, field: keyof VariantItem, value: string | number) => {
    const newList = [...variants]
    newList[index] = { ...newList[index], [field]: value }
    setVariants(newList)
  }

  const handleSubmit = async (formData: FormData) => {
    if (variants.some(v => !v.name.trim())) {
        addToast("Todas las variantes deben tener un nombre.", "error")
        return
    }
    if (variants.some(v => v.salePrice < v.costPrice)) {
        addToast("Revis√° los precios: Hay rentabilidad negativa.", "error")
        return
    }

    setLoading(true)
    if (imageUrl) formData.append("imageUrl", imageUrl)
    if (isNewCategory) formData.append("isNewCategory", "true")
    formData.append("variantsJson", JSON.stringify(variants))

    if (initialData) {
        formData.append("id", initialData.id)
        const result = await updateProduct(formData)
        
        if (result && 'error' in result) {
            // Correcci√≥n Final: A√±adir fallback por si result.error es undefined o null
            addToast(result.error || "Error al actualizar el producto.", "error")
        } else {
            addToast("Producto actualizado con √©xito.", "success")
            router.push("/products")
            router.refresh()
        }
    } else {
        const result = await createProduct(formData)

        if (result && 'error' in result) {
            // Correcci√≥n Final: A√±adir fallback por si result.error es undefined o null
            addToast(result.error || "Error al crear el producto.", "error")
        } else {
            addToast("Producto creado con √©xito.", "success")
            router.refresh()
        }
    }
    setLoading(false)
  }

  const inputClass = "w-full border border-input bg-background p-2 rounded-lg text-sm focus:ring-2 focus:ring-ring outline-none transition"
  const labelClass = "block text-xs font-bold text-muted-foreground uppercase mb-1.5"

  return (
    <div className="bg-card p-6 rounded-3xl shadow-sm border border-border">
      <h2 className="text-xl font-black text-foreground mb-6 font-nunito">
        {initialData ? "Editar Producto" : "Nuevo Producto"}
      </h2>
      
      <form action={handleSubmit} className="space-y-8">
        
        <div className="grid grid-cols-1 gap-6">
            <div className="space-y-4">
                <div><label className={labelClass}>Nombre del Producto *</label><input name="name" defaultValue={initialData?.name} type="text" required placeholder="Ej: Collar de Cuero" className={inputClass} /></div>
                <div><label className={labelClass}>Descripci√≥n</label><textarea name="description" defaultValue={initialData?.description || ""} className={inputClass} rows={2} /></div>
            </div>
            <div className="grid grid-cols-2 gap-4">
                 <div>
                    <label className={labelClass}>Due√±o *</label>
                    <select name="ownerId" defaultValue={initialData?.ownerId || ""} required className={inputClass}>
                        <option value="">Seleccionar...</option>
                        {owners.map(o => (<option key={o.id} value={o.id}>{o.name}</option>))}
                    </select>
                </div>
                <div>
                    <div className="flex justify-between items-center mb-1"><label className={labelClass}>Categor√≠a *</label><button type="button" onClick={() => setIsNewCategory(!isNewCategory)} className="text-[10px] text-primary font-bold hover:underline uppercase">{isNewCategory ? "Cancelar" : "+ Nueva"}</button></div>
                    {isNewCategory ? (<input name="categoryName" type="text" placeholder="Nombre nueva categor√≠a..." className={cn(inputClass, "bg-primary/5 border-primary/20")} autoFocus />) : (<select name="categoryId" defaultValue={initialData?.categoryId || ""} required className={inputClass}><option value="">Seleccionar...</option>{categories.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}</select>)}
                </div>
            </div>
        </div>

        <div className="bg-muted/30 p-4 rounded-xl border border-border">
            <div className="flex justify-between items-center mb-4"><label className="text-sm font-bold text-foreground">Variantes y Precios</label><button type="button" onClick={addVariant} className="text-xs bg-foreground text-background px-3 py-1.5 rounded-lg hover:opacity-90 font-bold transition">+ Agregar Variante</button></div>
            <div className="space-y-2">
                <div className="hidden md:grid grid-cols-12 gap-2 text-[10px] uppercase font-bold text-muted-foreground px-2">
                    <div className="col-span-4">Nombre</div>
                    <div className="col-span-3">Costo</div>
                    <div className="col-span-3">Venta</div>
                    <div className="col-span-1 text-center">Stock</div>
                    <div className="col-span-1"></div>
                </div>
                {variants.map((variant, idx) => (
                    <div key={idx} className="grid grid-cols-1 md:grid-cols-12 gap-2 items-center bg-card p-2 md:p-0 rounded-lg md:bg-transparent border md:border-0 border-border mb-2 md:mb-0">
                        <div className="col-span-4"><input type="text" value={variant.name} onChange={(e) => updateVariant(idx, 'name', e.target.value)} placeholder="Ej: XL, Rojo..." className={inputClass} /></div>
                        <div className="col-span-3 flex items-center gap-1"><span className="text-xs text-muted-foreground md:hidden">Costo:</span><input type="number" step="0.01" value={variant.costPrice} onChange={(e) => updateVariant(idx, 'costPrice', parseFloat(e.target.value) || 0)} className={inputClass} /></div>
                        <div className="col-span-3 flex items-center gap-1"><span className="text-xs text-muted-foreground md:hidden">Venta:</span><input type="number" step="0.01" value={variant.salePrice} onChange={(e) => updateVariant(idx, 'salePrice', parseFloat(e.target.value) || 0)} className={cn(inputClass, "font-bold text-green-600 dark:text-green-400")} /></div>
                        <div className="col-span-1 text-center text-xs font-mono text-muted-foreground hidden md:block">{variant.id ? variant.stock : '-'}</div>
                        <div className="col-span-1 text-right md:text-center"><button type="button" onClick={() => removeVariant(idx)} className="text-muted-foreground hover:text-destructive transition p-2">‚úï</button></div>
                    </div>
                ))}
            </div>
        </div>

        <div className="flex flex-col md:flex-row items-center gap-6 pt-4 border-t border-border">
            {showImages && (<div className="w-full md:w-1/2"><ImageUpload onImageUpload={(url) => setImageUrl(url)} /></div>)}
            <button type="submit" disabled={loading} className={cn("w-full md:w-auto md:ml-auto px-8 py-3 rounded-xl font-bold text-white shadow-lg transition active:scale-95", loading ? 'bg-muted text-muted-foreground cursor-wait' : 'bg-green-600 hover:bg-green-700')}>
                {loading ? "Guardando..." : "GUARDAR PRODUCTO"}
            </button>
        </div>
      </form>
    </div>
  )
}

--- File: ReceiptModal.tsx (in subfolder: components) ---

// src/components/ReceiptModal.tsx
'use client'

import { useState } from "react"
import TicketView from "./TicketView"

type SaleData = {
  id: string
  total: number
  paymentMethod: string
  createdAt: Date
  items: { description: string; quantity: number; priceAtSale: number }[]
}

export default function ReceiptModal({ sale }: { sale: SaleData }) {
  const [isOpen, setIsOpen] = useState(false)

  // Mapeamos los datos de DB a lo que espera el Ticket
  const ticketItems = sale.items.map(i => ({
    description: i.description,
    quantity: i.quantity,
    price: i.priceAtSale // El ticket espera 'price', la DB tiene 'priceAtSale'
  }))

  return (
    <>
      {/* EL BOT√ìN ACTIVADOR */}
      <button 
        onClick={(e) => {
            e.stopPropagation() // Evita que se cierre/abra el acorde√≥n de la fila
            setIsOpen(true)
        }}
        className="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold px-3 py-1 rounded border border-gray-300 flex items-center gap-1 transition"
      >
        üìÑ Ver Ticket
      </button>

      {/* EL MODAL (Solo visible si isOpen === true) */}
      {isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            
            {/* Contenedor del Ticket (Con scroll si es muy alto) */}
            <div className="bg-transparent w-full max-w-lg max-h-screen overflow-y-auto">
                <TicketView 
                    mode="HISTORY"
                    saleId={sale.id}
                    date={sale.createdAt}
                    items={ticketItems}
                    total={sale.total}
                    paymentMethod={sale.paymentMethod}
                    onClose={() => setIsOpen(false)} // Cierra el modal
                />
            </div>

        </div>
      )}
    </>
  )
}

--- File: SaleRow.tsx (in subfolder: components) ---

'use client'

import { useState } from "react"
import CancelSaleButton from "./CancelSaleButton"
import ReceiptModal from "./ReceiptModal"
import { cn } from "@/lib/utils"

type SaleItem = {
  description: string
  quantity: number
  priceAtSale: number 
}

type SaleData = {
  id: string
  total: number
  paymentMethod: string
  status: string
  createdAt: Date
  items: SaleItem[]
}

export default function SaleRow({ sale }: { sale: SaleData }) {
  const [isOpen, setIsOpen] = useState(false)

  const dateStr = sale.createdAt.toLocaleDateString()
  const timeStr = sale.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  const isCancelled = sale.status === 'CANCELLED'

  return (
    <>
      <tr 
        onClick={() => setIsOpen(!isOpen)}
        className={cn(
            "cursor-pointer transition-colors duration-200 border-b border-border last:border-0",
            // Transformaci√≥n Mobile: Block Display para que ocupe todo el ancho
            "flex flex-col md:table-row w-full",
            isCancelled 
                ? "bg-destructive/5 text-muted-foreground hover:bg-destructive/10" 
                : "bg-card hover:bg-muted/30"
        )}
      >
        {/* Celda Fecha */}
        <td className="p-4 md:pl-6 flex justify-between md:table-cell items-center w-full md:w-auto">
            <div className="flex flex-col">
                <span className={cn("font-bold text-sm", isCancelled ? "text-muted-foreground" : "text-foreground")}>
                    {dateStr}
                </span>
                <span className="text-xs text-muted-foreground font-mono">{timeStr}</span>
            </div>
            {/* Mobile: Mostrar Total aqu√≠ para verlo r√°pido */}
            <div className="md:hidden font-mono font-black text-lg">
                ${sale.total.toLocaleString()}
            </div>
        </td>
        
        {/* Celda M√©todo */}
        <td className="px-4 pb-2 md:py-4 md:table-cell w-full md:w-auto">
            <span className={cn(
                "text-[10px] font-black px-2 py-1 rounded-lg border uppercase tracking-wider inline-block",
                sale.paymentMethod === 'CASH' 
                    ? 'bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20' 
                    : sale.paymentMethod === 'TRANSFER'
                        ? 'bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/20'
                        : 'bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-500/20'
            )}>
                {sale.paymentMethod === 'CASH' ? 'Efectivo' : sale.paymentMethod === 'TRANSFER' ? 'Transferencia' : 'Cta. Corriente'}
            </span>
            {isCancelled && (
                <span className="ml-2 text-[10px] text-destructive font-black bg-destructive/10 px-1.5 py-0.5 rounded border border-destructive/20 uppercase">
                    Anulada
                </span>
            )}
        </td>

        {/* Celda Total (Oculta en mobile porque ya se mostr√≥ arriba) */}
        <td className="hidden md:table-cell p-4">
             <span className={cn(
                "font-mono font-bold text-lg",
                isCancelled ? 'line-through decoration-destructive opacity-50' : 'text-foreground'
            )}>
                ${sale.total.toLocaleString()}
            </span>
        </td>

        {/* Flecha */}
        <td className="hidden md:table-cell p-4 text-center">
            <span className={cn(
                "inline-block transition-transform duration-300 text-muted-foreground",
                isOpen ? 'rotate-180 text-primary' : ''
            )}>
                ‚ñº
            </span>
        </td>
      </tr>

      {/* DETALLE EXPANDIBLE */}
      {isOpen && (
        <tr className="bg-muted/30 border-b border-border shadow-inner flex flex-col md:table-row w-full">
            <td colSpan={4} className="p-0 block md:table-cell w-full">
                <div className="p-4 md:p-6 flex flex-col md:flex-row justify-between items-start gap-6 animate-in slide-in-from-top-2 duration-200">
                    
                    {/* Lista de Items */}
                    <div className="flex-1 space-y-3 w-full">
                        <p className="text-xs font-bold text-muted-foreground uppercase tracking-widest border-b border-border pb-1">
                            Detalle de la venta
                        </p>
                        <ul className="text-sm space-y-2">
                            {sale.items.map((item, idx) => (
                                <li key={idx} className="flex justify-between items-center group">
                                    <div className="flex items-center gap-2">
                                        <span className="font-bold text-foreground bg-background px-1.5 rounded border border-border text-xs">
                                            {item.quantity}
                                        </span>
                                        <span className="text-foreground/80 line-clamp-1">{item.description}</span>
                                    </div>
                                    <span className="text-muted-foreground font-mono text-xs whitespace-nowrap">
                                        ${Number(item.priceAtSale).toLocaleString()}
                                    </span>
                                </li>
                            ))}
                        </ul>
                        <p className="text-[10px] text-muted-foreground font-mono mt-4 pt-2 border-t border-border">
                            REF ID: {sale.id}
                        </p>
                    </div>

                    {/* Acciones */}
                    <div className="flex flex-row md:flex-col gap-3 items-center md:items-end w-full md:w-auto justify-end border-t md:border-0 border-border pt-4 md:pt-0">
                        
                        <ReceiptModal sale={sale} />

                        {!isCancelled && (
                            <div className="flex flex-col items-end gap-1">
                                <CancelSaleButton saleId={sale.id} />
                            </div>
                        )}
                    </div>
                </div>
            </td>
        </tr>
      )}
    </>
  )
}

--- File: SearchInput.tsx (in subfolder: components) ---

// src/components/SearchInput.tsx
'use client'

import { useSearchParams, usePathname, useRouter } from 'next/navigation'
import { useState, useEffect } from 'react'
import { cn } from "@/lib/utils"

export default function SearchInput({ placeholder, className }: { placeholder: string, className?: string }) {
  const searchParams = useSearchParams()
  const pathname = usePathname()
  const { replace } = useRouter()
  
  const [term, setTerm] = useState(searchParams.get('query')?.toString() || '')

  useEffect(() => {
    const timeoutId = setTimeout(() => {
      const params = new URLSearchParams(searchParams)
      const currentQueryInUrl = params.get('query') || ''
      
      if (currentQueryInUrl === term) return

      if (term) {
        params.set('query', term)
      } else {
        params.delete('query')
      }
      
      replace(`${pathname}?${params.toString()}`)
    }, 300)

    return () => clearTimeout(timeoutId)
  }, [term, searchParams, pathname, replace])

  return (
    <div className={cn("relative flex flex-1 flex-shrink-0", className)}>
      <label htmlFor="search" className="sr-only">Buscar</label>
      <input
        className="peer block w-full rounded-2xl border border-input bg-background py-3 pl-10 text-sm outline-none text-foreground placeholder:text-muted-foreground focus:ring-2 focus:ring-primary focus:border-primary transition shadow-sm"
        placeholder={placeholder}
        value={term}
        onChange={(e) => setTerm(e.target.value)}
      />
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={2}
        stroke="currentColor"
        className="absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-muted-foreground peer-focus:text-primary transition-colors"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
        />
      </svg>
    </div>
  )
}

--- File: SettlementButton.tsx (in subfolder: components) ---

// src/components/SettlementButton.tsx
'use client' 

import { useFormStatus } from "react-dom"
import { cn } from "@/lib/utils"

export default function SettlementButton() {
  const { pending } = useFormStatus()

  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    const confirmed = confirm("¬øEst√°s seguro de que vas a entregar el dinero?\n\nEsta acci√≥n marcar√° los items como PAGADOS y no se puede deshacer f√°cilmente.")
    if (!confirmed) e.preventDefault()
  }

  return (
    <button
      type="submit"
      onClick={handleClick}
      disabled={pending}
      className={cn(
        "px-8 py-4 rounded-xl font-bold text-lg shadow-lg transition active:scale-95 text-white w-full md:w-auto",
        pending 
          ? 'bg-muted text-muted-foreground cursor-not-allowed' 
          : 'bg-green-600 hover:bg-green-700 hover:shadow-green-900/20'
      )}
    >
      {pending ? "Procesando..." : "‚úÖ Confirmar Pago"}
    </button>
  )
}

--- File: SettlementForm.tsx (in subfolder: components) ---

// src/components/SettlementForm.tsx
'use client'

import { useState, useMemo } from "react"
import { createSettlement } from "@/actions/settlement-actions"
import { useRouter } from "next/navigation"
import { cn } from "@/lib/utils"
// R-08: Importar hook de notificaciones
import { useToast } from "@/components/ui/Toast"

type PendingItem = {
    id: string
    type: 'SALE' | 'ADJUSTMENT'
    date: Date
    description: string
    pendingQuantity: number
    cost: number
    isAdjustment: boolean
}

interface Props {
    ownerId: string
    items: PendingItem[]
}

export default function SettlementForm({ ownerId, items }: Props) {
    const router = useRouter()
    // R-08: Inicializar toast
    const { addToast } = useToast()
    const [loading, setLoading] = useState(false)
    
    const [selections, setSelections] = useState<Record<string, { selected: boolean, quantity: number }>>(() => {
        const initial: any = {}
        items.forEach(i => {
            initial[i.id] = { selected: true, quantity: i.pendingQuantity }
        })
        return initial
    })

    const totalToPay = useMemo(() => {
        let sum = 0
        items.forEach(item => {
            const sel = selections[item.id]
            if (sel && sel.selected) {
                sum += (sel.quantity * item.cost)
            }
        })
        return Math.round(sum * 100) / 100 // Redondeo visual
    }, [items, selections])

    const handleQuantityChange = (id: string, valStr: string, max: number) => {
        let val = parseInt(valStr)
        if (isNaN(val) || val < 1) val = 1
        if (val > max) val = max
        
        setSelections(prev => ({ ...prev, [id]: { ...prev[id], quantity: val, selected: true } }))
    }

    const toggleSelection = (id: string) => {
        setSelections(prev => ({ ...prev, [id]: { ...prev[id], selected: !prev[id].selected } }))
    }

    const toggleAll = () => {
        const allSelected = items.every(i => selections[i.id]?.selected)
        const newState: any = {}
        items.forEach(i => { newState[i.id] = { selected: !allSelected, quantity: selections[i.id]?.quantity || i.pendingQuantity } })
        setSelections(newState)
    }

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        
        if (totalToPay <= 0) {
            addToast("El total a pagar debe ser mayor a cero.", "error")
            return
        }

        // R-08: Reemplazar confirm por un modal (si existiera) o mantenerlo como acci√≥n cr√≠tica
        if (!confirm(`¬øConfirm√°s el pago por $${totalToPay.toLocaleString()}?`)) return

        setLoading(true)

        const payload = items
            .filter(i => selections[i.id]?.selected)
            .map(i => ({
                id: i.id,
                type: i.type,
                quantity: i.isAdjustment ? undefined : selections[i.id].quantity
            }))

        const formData = new FormData()
        formData.append("ownerId", ownerId)
        formData.append("selection", JSON.stringify(payload))

        const res = await createSettlement(formData)

        setLoading(false)
        if (res?.error) {
            addToast(res.error, "error")
        } else {
            addToast("Liquidaci√≥n registrada con √©xito.", "success")
            router.push(`/owners/balance`)
            router.refresh()
        }
    }

    return (
        <form onSubmit={handleSubmit} className="animate-in fade-in space-y-6">
            <div className="bg-card p-6 md:p-8 rounded-3xl border border-border shadow-lg flex flex-col md:flex-row justify-between items-center gap-6 sticky top-4 z-10 backdrop-blur-md bg-opacity-95">
                <div>
                    <p className="text-xs text-muted-foreground uppercase font-bold tracking-widest mb-2">Total a Pagar</p>
                    <p className={cn("text-5xl font-black font-nunito transition-all", totalToPay > 0 ? "text-foreground" : "text-muted-foreground")}>
                        ${totalToPay.toLocaleString()}
                    </p>
                    <p className="text-xs text-muted-foreground font-medium mt-1">{items.filter(i => selections[i.id]?.selected).length} items seleccionados</p>
                </div>
                <button type="submit" disabled={loading || totalToPay <= 0} className={cn("px-8 py-4 rounded-xl font-bold text-lg shadow-lg transition active:scale-95 text-white w-full md:w-auto", loading || totalToPay <= 0 ? 'bg-muted text-muted-foreground cursor-not-allowed shadow-none' : 'bg-green-600 hover:bg-green-700 hover:shadow-green-900/20')}>
                    {loading ? "Procesando..." : "‚úÖ Confirmar Pago"}
                </button>
            </div>
            <div className="bg-card rounded-3xl shadow-sm overflow-hidden border border-border">
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-muted/50 text-muted-foreground uppercase font-bold text-xs">
                            <tr>
                                <th className="p-4 w-10 text-center"><input type="checkbox" onChange={toggleAll} checked={items.every(i => selections[i.id]?.selected)} className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer"/></th>
                                <th className="p-4">Fecha / Producto</th>
                                <th className="p-4 text-center">Pendiente</th>
                                <th className="p-4 text-center">A Pagar (Cant.)</th>
                                <th className="p-4 text-right pr-6">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-border">
                            {items.map(row => {
                                const isSelected = selections[row.id]?.selected
                                const currentQty = selections[row.id]?.quantity
                                const subtotal = currentQty * row.cost
                                const isAdj = row.isAdjustment
                                return (
                                    <tr key={row.id} className={cn("transition", isSelected ? "bg-primary/5" : "hover:bg-muted/30 opacity-60 hover:opacity-100")}>
                                        <td className="p-4 text-center"><input type="checkbox" checked={isSelected} onChange={() => toggleSelection(row.id)} className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer"/></td>
                                        <td className="p-4"><p className="font-bold text-foreground flex items-center gap-2">{row.type === 'SALE' ? 'üõí' : '‚Ü©Ô∏è'} {row.description}</p><p className="text-xs text-muted-foreground">{row.date.toLocaleDateString()}</p></td>
                                        <td className="p-4 text-center font-mono text-muted-foreground">{isAdj ? '-' : row.pendingQuantity}</td>
                                        <td className="p-4 text-center">{isAdj ? (<span className="text-xs font-bold text-muted-foreground">-</span>) : (<input type="number" min={1} max={row.pendingQuantity} value={currentQty} onChange={(e) => handleQuantityChange(row.id, e.target.value, row.pendingQuantity)} disabled={!isSelected} className={cn("w-16 text-center p-1 rounded border font-bold outline-none focus:ring-2 focus:ring-primary", isSelected ? "bg-background border-input text-foreground" : "bg-transparent border-transparent text-muted-foreground")}/>)}</td>
                                        <td className={cn("p-4 pr-6 text-right font-mono font-bold text-base", row.cost < 0 ? "text-green-600" : "text-foreground")}>${subtotal.toLocaleString()}</td>
                                    </tr>
                                )
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </form>
    )
}

--- File: SettlementTicket.tsx (in subfolder: components) ---

// src/components/SettlementTicket.tsx
'use client'

import { useRef, useState } from "react"
import html2canvas from "html2canvas"
import jsPDF from "jspdf"
import Link from "next/link"
import { cn } from "@/lib/utils"

type SettlementData = {
  id: string
  createdAt: Date
  totalAmount: number
  owner: { name: string; email: string | null }
  items: { 
    id: string
    description: string
    quantity: number
    costAtSale: number
    createdAt: Date 
  }[]
  adjustments: {
    id: string
    description: string
    amount: number
    createdAt: Date
  }[]
}

export default function SettlementTicket({ data }: { data: SettlementData }) {
  const [downloading, setDownloading] = useState(false)
  const ticketRef = useRef<HTMLDivElement>(null)

  const handleDownloadPDF = async () => {
    const element = ticketRef.current
    if (!element) return
    setDownloading(true)

    try {
      const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#ffffff" })
      const imgData = canvas.toDataURL('image/png')
      const pdf = new jsPDF('p', 'mm', 'a4')
      const pdfWidth = pdf.internal.pageSize.getWidth()
      const imgProps = pdf.getImageProperties(imgData)
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight)
      pdf.save(`Liquidacion_${data.owner.name}_${data.createdAt.toISOString().split('T')[0]}.pdf`)
    } catch (e) {
      console.error(e)
      alert("Error generando PDF")
    } finally {
      setDownloading(false)
    }
  }

  return (
    <div className="flex flex-col items-center gap-8 p-8 min-h-screen bg-background animate-in fade-in">
      
      {/* BOTONERA SUPERIOR */}
      <div className="flex gap-4 w-full max-w-2xl">
        <Link href={`/owners/balance`} className="px-5 py-3 bg-secondary hover:bg-accent text-foreground rounded-xl font-bold text-sm border border-border transition">
            ‚Üê Volver
        </Link>
        <button 
            onClick={handleDownloadPDF}
            disabled={downloading}
            className={cn(
                "flex-1 bg-primary hover:bg-primary/90 text-primary-foreground py-3 rounded-xl font-bold shadow-lg transition active:scale-95",
                downloading && "opacity-50 cursor-wait"
            )}
        >
            {downloading ? "Generando..." : "üì• Descargar PDF"}
        </button>
      </div>

      {/* DOCUMENTO "PAPEL" (Siempre Blanco) */}
      <div 
        ref={ticketRef} 
        className="bg-white text-slate-900 p-12 shadow-2xl max-w-2xl w-full text-sm relative"
        style={{ minHeight: '800px', backgroundColor: '#ffffff', color: '#0f172a' }} 
      >
        {/* CABECERA */}
        <div className="border-b-2 border-slate-900 pb-6 mb-8 flex justify-between items-start">
            <div>
                <h1 className="text-3xl font-black tracking-tighter text-slate-900">GUAPECANES</h1>
                <p className="text-xs uppercase tracking-widest text-slate-500 mt-1">Liquidaci√≥n de Cuenta</p>
            </div>
            <div className="text-right">
                <p className="font-mono text-slate-500 text-xs">REF: {data.id.slice(0,8)}</p>
                <p className="font-bold text-lg text-slate-900">{data.createdAt.toLocaleDateString()}</p>
            </div>
        </div>

        {/* INFO DUE√ëO */}
        <div className="mb-8 p-4 bg-slate-50 rounded border border-slate-100">
            <p className="text-xs uppercase font-bold text-slate-400 mb-1">Beneficiario</p>
            <h2 className="text-xl font-bold text-slate-800">{data.owner.name}</h2>
            <p className="text-slate-600">{data.owner.email || "Sin email registrado"}</p>
        </div>

        {/* TABLA DE VENTAS LIQUIDADAS */}
        <div className="mb-8">
            <h3 className="font-bold text-slate-700 border-b pb-2 mb-2 uppercase text-xs">Productos Vendidos</h3>
            <table className="w-full text-left">
                <thead className="text-slate-400 text-xs uppercase">
                    <tr>
                        <th className="py-2">Fecha Venta</th>
                        <th className="py-2">Descripci√≥n</th>
                        <th className="py-2 text-right">Subtotal</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100 font-medium text-slate-700">
                    {data.items.length === 0 ? (
                        <tr><td colSpan={3} className="py-4 text-center text-slate-400 italic">Sin items de venta</td></tr>
                    ) : (
                        data.items.map(item => (
                            <tr key={item.id}>
                                <td className="py-2 text-slate-500">{item.createdAt.toLocaleDateString()}</td>
                                <td className="py-2">
                                    <span className="font-bold mr-1 text-slate-900">{item.quantity}x</span>
                                    {item.description}
                                </td>
                                <td className="py-2 text-right">
                                    ${(Number(item.costAtSale) * item.quantity).toLocaleString()}
                                </td>
                            </tr>
                        ))
                    )}
                </tbody>
            </table>
        </div>

        {/* TABLA DE AJUSTES */}
        {data.adjustments.length > 0 && (
            <div className="mb-8">
                <h3 className="font-bold text-slate-700 border-b pb-2 mb-2 uppercase text-xs">Otros Movimientos / Ajustes</h3>
                <table className="w-full text-left">
                    <tbody className="divide-y divide-slate-100 font-medium text-slate-700">
                        {data.adjustments.map(adj => (
                            <tr key={adj.id}>
                                <td className="py-2 text-slate-500">{adj.createdAt.toLocaleDateString()}</td>
                                <td className="py-2">{adj.description}</td>
                                <td className={`py-2 text-right font-bold ${Number(adj.amount) < 0 ? 'text-red-600' : 'text-slate-800'}`}>
                                    ${Number(adj.amount).toLocaleString()}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        )}

        {/* TOTAL FINAL */}
        <div className="flex justify-end mt-10">
            <div className="text-right bg-slate-900 text-white p-6 rounded-lg min-w-[250px]">
                <p className="text-xs uppercase font-bold opacity-70 mb-1">Total Liquidado</p>
                <p className="text-4xl font-black">${Number(data.totalAmount).toLocaleString()}</p>
            </div>
        </div>
        
        <div className="mt-12 pt-8 border-t border-slate-200 text-center text-xs text-slate-400">
            <p>Comprobante generado electr√≥nicamente por Sistema Guapecanes.</p>
        </div>

      </div>
    </div>
  )
}

--- File: StockMovementForm.tsx (in subfolder: components) ---

// src/components/StockMovementForm.tsx
'use client'

import { useState } from "react"
import { registerStockMovement } from "@/actions/inventory-actions"
import { useRouter } from "next/navigation"
import { cn } from "@/lib/utils"

type ProductOption = {
  variantId: string
  productName: string
  ownerName: string
  stock: number
}

export default function StockMovementForm({ 
  products, 
  redirectPath 
}: { 
  products: ProductOption[], 
  redirectPath?: string 
}) {
  const [loading, setLoading] = useState(false)
  const [selectedType, setSelectedType] = useState<"ENTRY" | "OWNER_WITHDRAWAL" | "ADJUSTMENT">("ENTRY")
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setLoading(true)

    const form = e.currentTarget
    const formData = new FormData(form)

    const result = await registerStockMovement(formData)

    if (result.success) {
      alert("‚úÖ Movimiento registrado correctamente")
      form.reset() 
      // Reseteamos al default visual
      setSelectedType("ENTRY")
      router.refresh()

      if (redirectPath) {
          router.push(redirectPath)
      } else {
          router.push("/products")
      }
    } else {
      alert("‚ùå ERROR: " + result.error)
    }

    setLoading(false)
  }

  // Definir colores din√°micos seg√∫n el tipo seleccionado
  const themeColor = {
      ENTRY: "border-green-500 bg-green-500/10 text-green-700 dark:text-green-400",
      OWNER_WITHDRAWAL: "border-orange-500 bg-orange-500/10 text-orange-700 dark:text-orange-400",
      ADJUSTMENT: "border-destructive bg-destructive/10 text-destructive dark:text-red-400"
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-8 animate-in fade-in duration-300">
          
      {/* SELECCI√ìN DE TIPO (TARJETAS) */}
      <div className="space-y-3">
        <label className="block text-sm font-bold text-muted-foreground uppercase tracking-wide">1. Tipo de Acci√≥n</label>
        
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            {/* Opci√≥n 1: Ingreso */}
            <label className={cn(
                "cursor-pointer p-4 rounded-xl border-2 transition-all duration-200 flex flex-col gap-2 hover:scale-[1.02]",
                selectedType === "ENTRY" 
                    ? "border-green-500 bg-green-500/5 shadow-md shadow-green-500/10" 
                    : "border-border bg-card hover:border-green-500/50"
            )}>
                <input 
                    type="radio" 
                    name="type" 
                    value="ENTRY" 
                    checked={selectedType === "ENTRY"}
                    onChange={() => setSelectedType("ENTRY")}
                    className="sr-only" // Ocultamos el radio nativo
                />
                <span className="text-2xl">üü¢</span>
                <div>
                    <span className={cn("block font-black text-sm", selectedType === "ENTRY" ? "text-green-600 dark:text-green-400" : "text-foreground")}>
                        INGRESO
                    </span>
                    <span className="text-xs text-muted-foreground font-medium">Nueva mercader√≠a</span>
                </div>
            </label>

            {/* Opci√≥n 2: Retiro Due√±o */}
            <label className={cn(
                "cursor-pointer p-4 rounded-xl border-2 transition-all duration-200 flex flex-col gap-2 hover:scale-[1.02]",
                selectedType === "OWNER_WITHDRAWAL" 
                    ? "border-orange-500 bg-orange-500/5 shadow-md shadow-orange-500/10" 
                    : "border-border bg-card hover:border-orange-500/50"
            )}>
                <input 
                    type="radio" 
                    name="type" 
                    value="OWNER_WITHDRAWAL" 
                    checked={selectedType === "OWNER_WITHDRAWAL"}
                    onChange={() => setSelectedType("OWNER_WITHDRAWAL")}
                    className="sr-only"
                />
                <span className="text-2xl">üü†</span>
                <div>
                    <span className={cn("block font-black text-sm", selectedType === "OWNER_WITHDRAWAL" ? "text-orange-600 dark:text-orange-400" : "text-foreground")}>
                        RETIRO
                    </span>
                    <span className="text-xs text-muted-foreground font-medium">Devoluci√≥n a due√±o</span>
                </div>
            </label>

            {/* Opci√≥n 3: Ajuste/Rotura */}
            <label className={cn(
                "cursor-pointer p-4 rounded-xl border-2 transition-all duration-200 flex flex-col gap-2 hover:scale-[1.02]",
                selectedType === "ADJUSTMENT" 
                    ? "border-destructive bg-destructive/5 shadow-md shadow-destructive/10" 
                    : "border-border bg-card hover:border-destructive/50"
            )}>
                <input 
                    type="radio" 
                    name="type" 
                    value="ADJUSTMENT" 
                    checked={selectedType === "ADJUSTMENT"}
                    onChange={() => setSelectedType("ADJUSTMENT")}
                    className="sr-only"
                />
                <span className="text-2xl">üî¥</span>
                <div>
                    <span className={cn("block font-black text-sm", selectedType === "ADJUSTMENT" ? "text-destructive dark:text-red-400" : "text-foreground")}>
                        BAJA / ROTURA
                    </span>
                    <span className="text-xs text-muted-foreground font-medium">P√©rdida de stock</span>
                </div>
            </label>
        </div>
      </div>

      {/* CONTENEDOR DE DATOS */}
      <div className={cn(
          "p-6 rounded-2xl border transition-colors duration-300",
          themeColor[selectedType]
      )}>
          <div className="grid gap-6">
            {/* SELECCI√ìN DE PRODUCTO */}
            <div>
                <label className="block text-sm font-bold mb-2 uppercase opacity-80">2. Variante a Ajustar</label>
                <select 
                    name="variantId" 
                    required 
                    className="w-full p-4 rounded-xl bg-background/80 border-0 shadow-sm text-foreground font-medium focus:ring-2 focus:ring-current outline-none"
                >
                {products.length > 1 && <option value="">Seleccionar variante...</option>}
                {products.map(p => (
                    <option key={p.variantId} value={p.variantId}>
                    {p.productName} (Stock actual: {p.stock})
                    </option>
                ))}
                </select>
            </div>

            {/* CANTIDAD Y MOTIVO */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label className="block text-sm font-bold mb-2 uppercase opacity-80">3. Cantidad</label>
                    <input 
                    name="quantity" 
                    type="number" 
                    min="1" 
                    required 
                    className="w-full p-4 rounded-xl bg-background/80 border-0 shadow-sm text-foreground font-bold text-xl focus:ring-2 focus:ring-current outline-none" 
                    placeholder="0"
                    />
                </div>
                <div>
                    <label className="block text-sm font-bold mb-2 uppercase opacity-80">Nota (Opcional)</label>
                    <input 
                    name="reason" 
                    type="text" 
                    className="w-full p-4 rounded-xl bg-background/80 border-0 shadow-sm text-foreground focus:ring-2 focus:ring-current outline-none placeholder:text-muted-foreground/50" 
                    placeholder="Ej: Remito #1234"
                    />
                </div>
            </div>
          </div>
      </div>

      <button 
        type="submit" 
        disabled={loading}
        className={cn(
            "w-full py-4 rounded-xl font-black text-lg shadow-lg transform transition active:scale-95 text-white",
            selectedType === 'ENTRY' && "bg-green-600 hover:bg-green-700",
            selectedType === 'OWNER_WITHDRAWAL' && "bg-orange-600 hover:bg-orange-700",
            selectedType === 'ADJUSTMENT' && "bg-red-600 hover:bg-red-700",
            loading && "opacity-50 cursor-wait bg-muted text-muted-foreground"
        )}
      >
        {loading ? "Procesando..." : "CONFIRMAR MOVIMIENTO"}
      </button>

    </form>
  )
}

--- File: ThemeProvider.tsx (in subfolder: components) ---

"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

--- File: ThemeToggle.tsx (in subfolder: components) ---

"use client"

import { useTheme } from "next-themes"
import { useEffect, useState } from "react"

export function ThemeToggle() {
  const { theme, setTheme } = useTheme()
  const [mounted, setMounted] = useState(false)

  // Esperar a que el cliente monte para evitar error de hidrataci√≥n
  useEffect(() => setMounted(true), [])

  if (!mounted) return null

  return (
    <button
      onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
      className="
        p-2 rounded-full transition-all duration-300
        bg-secondary hover:bg-primary text-secondary-foreground hover:scale-110 shadow-lg
      "
      aria-label="Cambiar tema"
    >
      {theme === "dark" ? "üåô" : "‚òÄÔ∏è"}
    </button>
  )
}

--- File: TicketView.tsx (in subfolder: components) ---

'use client'

import { useState, useRef } from "react"
import jsPDF from "jspdf"
import html2canvas from "html2canvas"
import { cn } from "@/lib/utils"

type TicketProps = {
  saleId: string
  date: Date
  items: { description: string; quantity: number; price: number }[]
  total: number
  paymentMethod: string
  onClose: () => void
  mode?: 'POS' | 'HISTORY'
}

export default function TicketView({ saleId, date, items, total, paymentMethod, onClose, mode = 'POS' }: TicketProps) {
  const [downloading, setDownloading] = useState(false)
  const ticketRef = useRef<HTMLDivElement>(null)

  const handleDownloadPDF = async () => {
    const element = ticketRef.current
    if (!element) return

    setDownloading(true)

    try {
      // 1. Captura del Canvas
      const canvas = await html2canvas(element, {
        scale: 2, // Mayor calidad
        backgroundColor: "#ffffff", // Fondo blanco forzado
        logging: false,
        useCORS: true,
      })

      const imgData = canvas.toDataURL('image/png')
      
      // 2. Generaci√≥n PDF (A4)
      const pdf = new jsPDF('p', 'mm', 'a4')
      const pdfWidth = pdf.internal.pageSize.getWidth()
      const pdfHeight = pdf.internal.pageSize.getHeight()
      
      const imgWidth = canvas.width
      const imgHeight = canvas.height
      
      // Ajuste de m√°rgenes para centrar o expandir
      const margin = 20 
      const finalWidth = pdfWidth - (margin * 2)
      const finalHeight = (imgHeight * finalWidth) / imgWidth

      pdf.addImage(imgData, 'PNG', margin, 20, finalWidth, finalHeight)
      pdf.save(`Ticket_${saleId.slice(0, 8)}.pdf`)

    } catch (error) {
      console.error("Error al generar PDF:", error)
      alert("Hubo un error al generar el comprobante. Intenta nuevamente.")
    } finally {
      setDownloading(false)
    }
  }

  return (
    <div className="flex flex-col items-center justify-center min-h-[500px] h-full p-4 animate-in zoom-in-95 duration-300 w-full">
        
        {/* 
            === TICKET VISUAL & PRINT SOURCE === 
            Usamos colores 'Slate' fijos (900, 500, 200) en lugar de variables sem√°nticas.
            Esto garantiza que se vea igual en Dark y Light mode.
            bg-white text-slate-900 siempre es negro sobre blanco.
        */}
        <div 
            ref={ticketRef} 
            className="p-8 md:p-10 bg-white text-slate-900 w-full max-w-[400px] shadow-2xl relative overflow-hidden flex flex-col gap-6"
            // Estilos inline de respaldo para html2canvas si falla tailwind
            style={{ backgroundColor: '#ffffff', color: '#0f172a' }} 
        >
            {/* Header */}
            <div className="text-center border-b-2 border-slate-900 pb-4">
                <h2 className="text-3xl font-black tracking-tighter font-nunito text-slate-900">
                    GUAPECANES
                </h2>
                <p className="text-[10px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-1">
                    {mode === 'POS' ? 'Comprobante Oficial' : 'Copia de Archivo'}
                </p>
            </div>

            {/* Metadatos */}
            <div className="grid grid-cols-2 gap-y-2 gap-x-4 text-sm text-slate-600">
                <div>
                    <p className="font-bold text-[10px] uppercase text-slate-400">Fecha</p>
                    <p className="font-mono font-bold text-slate-900">{new Date(date).toLocaleDateString()}</p>
                </div>
                <div className="text-right">
                    <p className="font-bold text-[10px] uppercase text-slate-400">Hora</p>
                    <p className="font-mono font-bold text-slate-900">{new Date(date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                </div>
                <div>
                    <p className="font-bold text-[10px] uppercase text-slate-400">ID Operaci√≥n</p>
                    <p className="font-mono text-xs text-slate-900">#{saleId.slice(0,8).toUpperCase()}</p>
                </div>
                <div className="text-right">
                    <p className="font-bold text-[10px] uppercase text-slate-400">M√©todo</p>
                    <p className="font-bold text-slate-900 uppercase">{paymentMethod === 'CASH' ? 'Efectivo' : paymentMethod === 'TRANSFER' ? 'Transferencia' : 'Cta. Corriente'}</p>
                </div>
            </div>

            {/* Tabla de Items */}
            <div className="border-t border-slate-200 pt-4">
                <table className="w-full text-sm">
                    <thead>
                        <tr className="text-[10px] uppercase text-slate-400 border-b border-slate-100">
                            <th className="text-left py-1 font-bold">Cant. / Detalle</th>
                            <th className="text-right py-1 font-bold">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody className="font-medium text-slate-800">
                        {items.map((item, i) => (
                            <tr key={i} className="border-b border-slate-50">
                                <td className="py-2 pr-2 align-top">
                                    <span className="font-bold text-slate-900 mr-1">{item.quantity}</span>
                                    <span className="text-xs text-slate-600">x</span>
                                    <span className="ml-2">{item.description}</span>
                                </td>
                                <td className="py-2 text-right align-top font-mono font-bold">
                                    ${(item.price * item.quantity).toLocaleString()}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Totales */}
            <div className="bg-slate-50 p-4 rounded-xl flex justify-between items-center border border-slate-100 mt-2">
                <span className="text-xs font-black uppercase text-slate-500 tracking-wider">Total</span>
                <span className="text-3xl font-black text-slate-900 tracking-tight">
                    ${total.toLocaleString()}
                </span>
            </div>
            
            {/* Footer Legal */}
            <div className="text-center space-y-1 mt-2">
               <p className="text-[10px] text-slate-400 font-medium">Gracias por confiar en nosotros üê∂</p>
               <p className="text-[8px] text-slate-300 uppercase">Documento no v√°lido como factura fiscal</p>
            </div>

            {/* Decoraci√≥n CSS (Solo visual, borde dentado abajo) */}
            <div className="absolute bottom-0 left-0 right-0 h-1 bg-[linear-gradient(45deg,transparent_75%,#cbd5e1_75%),linear-gradient(-45deg,transparent_75%,#cbd5e1_75%)] bg-[length:10px_10px] opacity-30"></div>
        </div>

        {/* BOTONERA (Fuera del √°rea de impresi√≥n) */}
        <div className="mt-8 flex flex-col gap-3 w-full max-w-[400px]">
            <button 
                onClick={handleDownloadPDF}
                disabled={downloading}
                className={cn(
                    "w-full py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-xl transition-all active:scale-95 text-white",
                    downloading 
                        ? 'bg-slate-400 cursor-not-allowed' 
                        : 'bg-gradient-to-r from-red-600 to-red-500 hover:to-red-600 hover:shadow-red-500/30'
                )}
            >
                {downloading ? (
                    <>
                        <span className="animate-spin h-4 w-4 border-2 border-white/50 border-t-white rounded-full"/>
                        <span>Procesando PDF...</span>
                    </>
                ) : (
                    <>
                        <span>üì•</span> 
                        <span>Descargar PDF</span>
                    </>
                )}
            </button>

            <button 
                onClick={onClose}
                disabled={downloading}
                className="w-full bg-card hover:bg-accent text-foreground border border-border font-bold py-4 rounded-xl shadow-sm transition active:scale-95 text-sm"
            >
                {mode === 'POS' ? '‚ú® Nueva Venta' : 'Cerrar'}
            </button>
        </div>
    </div>
  )
}

--- File: UserForm.tsx (in subfolder: components) ---

'use client'

import { createUser } from "@/actions/user-actions"
import { useState, useRef } from "react"
import { useRouter } from "next/navigation"
import { useToast } from "@/components/ui/Toast" // Integraci√≥n FE-01
import { cn } from "@/lib/utils"

export default function UserForm() {
  const [loading, setLoading] = useState(false)
  const formRef = useRef<HTMLFormElement>(null)
  const router = useRouter()
  const { addToast } = useToast()

  const handleSubmit = async (formData: FormData) => {
    setLoading(true)
    
    try {
        const result = await createUser(formData)
        
        if (result?.error) {
            addToast(`‚ùå ${result.error}`, "error")
        } else {
            addToast("‚úÖ Usuario creado correctamente", "success")
            formRef.current?.reset()
            router.refresh()
        }
    } catch (error) {
        addToast("üö´ Error de conexi√≥n", "error")
    } finally {
        setLoading(false)
    }
  }

  return (
    <div className="bg-card p-6 rounded-3xl shadow-sm border border-border h-full">
      <h2 className="text-lg font-black text-foreground mb-6 flex items-center gap-2 font-nunito">
        üë§ Nuevo Usuario
      </h2>
      
      <form ref={formRef} action={handleSubmit} className="space-y-4">
        
        <div className="space-y-1">
            <label className="block text-xs font-black text-muted-foreground uppercase pl-1">Nombre</label>
            <input 
                name="name" 
                type="text" 
                required 
                placeholder="Ej: Juan Admin" 
                className="w-full bg-background border border-input p-2.5 rounded-xl text-sm text-foreground focus:ring-2 focus:ring-primary focus:border-primary outline-none transition font-medium placeholder:text-muted-foreground"
            />
        </div>

        <div className="space-y-1">
            <label className="block text-xs font-black text-muted-foreground uppercase pl-1">Email (Login)</label>
            <input 
                name="email" 
                type="email" 
                required 
                placeholder="juan@guapecanes.com" 
                className="w-full bg-background border border-input p-2.5 rounded-xl text-sm text-foreground focus:ring-2 focus:ring-primary focus:border-primary outline-none transition font-medium placeholder:text-muted-foreground"
            />
        </div>

        <div className="space-y-1">
            <label className="block text-xs font-black text-muted-foreground uppercase pl-1">Contrase√±a</label>
            <input 
                name="password" 
                type="password" 
                required 
                placeholder="******" 
                className="w-full bg-background border border-input p-2.5 rounded-xl text-sm text-foreground focus:ring-2 focus:ring-primary focus:border-primary outline-none transition font-medium placeholder:text-muted-foreground"
            />
        </div>

        <div className="space-y-1">
            <label className="block text-xs font-black text-muted-foreground uppercase pl-1">Rol</label>
            <div className="relative">
                <select 
                    name="role" 
                    className="w-full bg-background border border-input p-2.5 rounded-xl text-sm text-foreground focus:ring-2 focus:ring-primary focus:border-primary outline-none transition font-bold appearance-none cursor-pointer"
                >
                    <option value="STAFF">Staff (Vendedor/Peluquero)</option>
                    <option value="ADMIN">Administrador (Total)</option>
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none text-xs">
                    ‚ñº
                </div>
            </div>
        </div>

        <button 
            type="submit" 
            disabled={loading}
            className={cn(
                "w-full py-3 rounded-xl font-bold text-sm transition mt-4 shadow-lg",
                loading 
                    ? 'bg-muted text-muted-foreground cursor-wait shadow-none' 
                    : 'bg-foreground text-background hover:bg-foreground/90 hover:scale-[1.02] active:scale-95'
            )}
        >
            {loading ? "Creando..." : "Registrar Usuario"}
        </button>

      </form>
    </div>
  )
}

--- File: ConfirmModal.tsx (in subfolder: components\ui) ---

'use client'

import { useEffect, useState } from "react"
import { createPortal } from "react-dom"
import { cn } from "@/lib/utils"

interface ConfirmModalProps {
  isOpen: boolean
  onClose: () => void
  onConfirm: () => void
  title: string
  description: string
  confirmText?: string
  cancelText?: string
  variant?: 'danger' | 'info' | 'default'
  loading?: boolean
}

export default function ConfirmModal({
  isOpen,
  onClose,
  onConfirm,
  title,
  description,
  confirmText = "Confirmar",
  cancelText = "Cancelar",
  variant = 'danger',
  loading = false
}: ConfirmModalProps) {
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    setMounted(true)
    // Bloquear scroll cuando el modal est√° abierto
    if (isOpen) {
      document.body.style.overflow = 'hidden'
    } else {
      document.body.style.overflow = 'unset'
    }
    return () => { document.body.style.overflow = 'unset' }
  }, [isOpen])

  if (!mounted || !isOpen) return null

  // Portal para asegurar que el modal est√© siempre encima de todo (z-index)
  return createPortal(
    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div 
        className="bg-card border border-border w-full max-w-md rounded-3xl shadow-2xl overflow-hidden scale-100 animate-in zoom-in-95 duration-200"
        role="dialog"
        aria-modal="true"
      >
        <div className="p-6 text-center">
          <div className={cn(
            "w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl",
            variant === 'danger' ? "bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400" :
            variant === 'info' ? "bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400" :
            "bg-gray-100 text-gray-600 dark:bg-gray-800"
          )}>
            {variant === 'danger' ? '‚ö†Ô∏è' : variant === 'info' ? '‚ÑπÔ∏è' : '‚ùì'}
          </div>

          <h3 className="text-xl font-black text-foreground font-nunito mb-2">
            {title}
          </h3>
          <p className="text-sm text-muted-foreground font-medium leading-relaxed">
            {description}
          </p>
        </div>

        <div className="flex divide-x divide-border border-t border-border bg-muted/30">
          <button
            onClick={onClose}
            disabled={loading}
            className="flex-1 py-4 text-sm font-bold text-muted-foreground hover:bg-muted transition hover:text-foreground disabled:opacity-50"
          >
            {cancelText}
          </button>
          <button
            onClick={onConfirm}
            disabled={loading}
            className={cn(
              "flex-1 py-4 text-sm font-black transition disabled:opacity-50 flex items-center justify-center gap-2",
              variant === 'danger' 
                ? "text-destructive hover:bg-destructive/10" 
                : "text-primary hover:bg-primary/10"
            )}
          >
            {loading ? (
                <span className="animate-spin h-4 w-4 border-2 border-current border-t-transparent rounded-full" />
            ) : null}
            {confirmText}
          </button>
        </div>
      </div>
    </div>,
    document.body
  )
}

--- File: Toast.tsx (in subfolder: components\ui) ---

// src/components/ui/Toast.tsx
'use client'

import { useState, useEffect } from 'react'
import { create } from 'zustand' // Recomiendo instalar zustand: npm install zustand

// 1. Store simple para manejar estado global de notificaciones
type ToastType = { id: string; message: string; type: 'success' | 'error' | 'info' }

interface ToastStore {
  toasts: ToastType[]
  addToast: (message: string, type: 'success' | 'error' | 'info') => void
  removeToast: (id: string) => void
}

export const useToast = create<ToastStore>((set) => ({
  toasts: [],
  addToast: (msg, type) => {
    const id = Math.random().toString(36).substring(2, 9)
    set((state) => ({ toasts: [...state.toasts, { id, message: msg, type }] }))
    setTimeout(() => {
      set((state) => ({ toasts: state.toasts.filter((t) => t.id !== id) }))
    }, 4000) // Auto-cierre
  },
  removeToast: (id) => set((state) => ({ toasts: state.toasts.filter((t) => t.id !== id) })),
}))

// 2. Componente Visual
export function Toaster() {
  const { toasts, removeToast } = useToast()

  return (
    <div className="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2">
      {toasts.map((toast) => (
        <div
          key={toast.id}
          onClick={() => removeToast(toast.id)}
          className={`
            px-4 py-3 rounded-xl shadow-lg border cursor-pointer transition-all animate-in slide-in-from-right-10 fade-in
            ${toast.type === 'success' ? 'bg-white border-green-200 text-green-700 border-l-4 border-l-green-500' : ''}
            ${toast.type === 'error' ? 'bg-white border-red-200 text-red-700 border-l-4 border-l-red-500' : ''}
            ${toast.type === 'info' ? 'bg-slate-800 text-white border-slate-700' : ''}
          `}
        >
          <div className="flex items-center gap-3">
            <span className="text-xl">
              {toast.type === 'success' && '‚ú®'}
              {toast.type === 'error' && 'üö´'}
              {toast.type === 'info' && '‚ÑπÔ∏è'}
            </span>
            <p className="font-bold text-sm">{toast.message}</p>
          </div>
        </div>
      ))}
    </div>
  )
}

--- File: AppCard.tsx (in subfolder: components\ui\shared) ---

'use client'

import { cn } from "@/lib/utils"

interface AppCardProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode
  noPadding?: boolean // Para tablas que necesitan llegar al borde
  hoverEffect?: boolean // Para items clickeables
}

export function AppCard({ 
  children, 
  className, 
  noPadding = false,
  hoverEffect = false,
  ...props 
}: AppCardProps) {
  return (
    <div 
      className={cn(
        // Estilos Base (Seg√∫n Auditor√≠a: rounded-3xl para contenedores)
        "bg-card border border-border rounded-3xl shadow-sm transition-all duration-200 overflow-hidden",
        
        // Padding condicional
        !noPadding && "p-6",
        
        // Efecto Hover (√∫til para listas de tarjetas)
        hoverEffect && "hover:border-primary/50 hover:shadow-md hover:-translate-y-0.5 cursor-pointer",
        
        className
      )} 
      {...props}
    >
      {children}
    </div>
  )
}

--- File: PageHeader.tsx (in subfolder: components\ui\shared) ---

'use client'

import { cn } from "@/lib/utils"

interface PageHeaderProps {
  title: string
  description?: string
  children?: React.ReactNode // Para botones de acci√≥n (Nuevo, Exportar, etc)
  className?: string
}

export function PageHeader({ title, description, children, className }: PageHeaderProps) {
  return (
    <div className={cn("flex flex-col md:flex-row justify-between items-start md:items-end gap-4 animate-in slide-in-from-left-2 duration-300", className)}>
      <div className="space-y-1">
        <h1 className="text-3xl font-black text-foreground font-nunito tracking-tight">
          {title}
        </h1>
        {description && (
          <p className="text-sm text-muted-foreground font-medium">
            {description}
          </p>
        )}
      </div>
      
      {children && (
        <div className="flex items-center gap-3 w-full md:w-auto">
          {children}
        </div>
      )}
    </div>
  )
}

--- File: usePos.ts (in subfolder: hooks) ---

'use client'

import { useState, useMemo, useEffect, useCallback, useRef } from "react"
import { useRouter, useSearchParams } from "next/navigation"
import { processSale } from "@/actions/sale-actions"
import { useToast } from "@/components/ui/Toast"

export type VariantType = {
  id: string
  name: string
  price: number
  stock: number
}

export type ProductGroupType = {
  id: string
  name: string
  categoryName: string
  ownerName: string
  imageUrl: string | null
  totalStock: number
  variants: VariantType[]
}

export type CustomerOption = {
  id: string
  name: string
}

export type CartItem = {
  type: 'PRODUCT' | 'SERVICE'
  id: string
  name: string
  price: number
  quantity: number
  stockMax?: number
}

type PaymentMethod = "CASH" | "TRANSFER" | "CHECKING_ACCOUNT"

type SaleResult = {
    id: string
    date: Date
    items: { description: string; quantity: number; price: number }[]
    total: number
    method: PaymentMethod
}

export function usePos(products: ProductGroupType[], customers: CustomerOption[]) {
  const { addToast } = useToast()
  const router = useRouter()
  const searchParams = useSearchParams()

  const [cart, setCart] = useState<CartItem[]>([])
  const [loading, setLoading] = useState(false)
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>("CASH")
  const [lastSale, setLastSale] = useState<SaleResult | null>(null)
  const [selectedCustomerId, setSelectedCustomerId] = useState<string>("")

  const [search, setSearch] = useState("")
  const [selectedCategory, setSelectedCategory] = useState<string | "ALL">("ALL")
  const [selectedProductForModal, setSelectedProductForModal] = useState<ProductGroupType | null>(null)

  // FIX: Usamos un ref para evitar loop infinito de useEffect si agregamos dependencias
  const processedParamsRef = useRef(false)

  // --- EFECTO: Carga de Servicios desde URL ---
  useEffect(() => {
    const apptId = searchParams.get("apptId")
    const petName = searchParams.get("petName")
    
    // Solo ejecutar si no se ha procesado ya para evitar re-renders y loops
    if (apptId && petName && !processedParamsRef.current) {
       processedParamsRef.current = true
       
       setCart(current => {
         // Verificaci√≥n defensiva
         if (current.some(i => i.id === apptId && i.type === 'SERVICE')) return current
         
         // Retornar nuevo estado
         return [{
            type: 'SERVICE',
            id: apptId,
            name: `Servicio: ${petName}`,
            price: 0, 
            quantity: 1
         }, ...current]
       })

       // FIX: Sacamos el Toast del flujo de renderizado usando setTimeout
       setTimeout(() => {
           addToast(`Servicio para ${petName} cargado`, 'info')
       }, 100)
    }
  }, [searchParams, addToast])

  const categories = useMemo(() => {
    const cats = products.map(p => p.categoryName)
    return ["ALL", ...Array.from(new Set(cats))].sort()
  }, [products])

  const filteredProducts = useMemo(() => {
    const term = search.toLowerCase()
    return products.filter(p => {
        const matchesCategory = selectedCategory === "ALL" || p.categoryName === selectedCategory
        const matchesText = 
            p.name.toLowerCase().includes(term) || 
            p.ownerName.toLowerCase().includes(term) ||
            p.categoryName.toLowerCase().includes(term)
        return matchesCategory && matchesText
    })
  }, [products, search, selectedCategory])

  const addVariantToCart = useCallback((productName: string, variant: VariantType) => {
    if (variant.stock <= 0) {
        addToast(`Sin stock para ${variant.name}`, 'error')
        return
    }

    setCart(current => {
        const existingIndex = current.findIndex(item => item.id === variant.id && item.type === 'PRODUCT')
        
        if (existingIndex >= 0) {
            const existingItem = current[existingIndex]
            if (existingItem.quantity >= variant.stock) {
                // FIX: Toast as√≠ncrono
                setTimeout(() => addToast("Stock m√°ximo alcanzado", 'error'), 0)
                return current
            }
            const newCart = [...current]
            newCart[existingIndex] = { ...existingItem, quantity: existingItem.quantity + 1 }
            return newCart
        }
        
        const displayName = variant.name === "Est√°ndar" ? productName : `${productName} - ${variant.name}`
        
        return [...current, { 
            type: 'PRODUCT', 
            id: variant.id, 
            name: displayName, 
            price: variant.price, 
            quantity: 1, 
            stockMax: variant.stock 
        }]
    })
  }, [addToast])

  const handleProductClick = useCallback((product: ProductGroupType) => {
    const activeVariants = product.variants.filter(v => v.stock > 0)
    if (activeVariants.length === 0) {
        addToast("Producto agotado", 'error')
        return
    }
    if (activeVariants.length === 1) {
        addVariantToCart(product.name, activeVariants[0])
    } else {
        setSelectedProductForModal(product)
    }
  }, [addVariantToCart, addToast])

  const removeFromCart = useCallback((index: number) => {
    setCart(current => current.filter((_, i) => i !== index))
  }, [])

  const updateServicePrice = useCallback((index: number, newPrice: string) => {
    const val = parseFloat(newPrice)
    setCart(current => current.map((item, i) => i === index ? { ...item, price: isNaN(val) ? 0 : val } : item))
  }, [])

  const total = useMemo(() => cart.reduce((sum, item) => sum + (item.price * item.quantity), 0), [cart])

  const checkout = async () => {
    if (total === 0 && !confirm("¬øConfirmar venta por $0?")) return
    
    if (paymentMethod === 'CHECKING_ACCOUNT' && !selectedCustomerId) {
        addToast("‚ö†Ô∏è Seleccion√° un cliente para fiar.", 'error')
        return
    }

    setLoading(true)
    
    const payload = cart.map(item => ({ 
        type: item.type, 
        id: item.id, 
        description: item.name, 
        price: item.price, 
        quantity: item.quantity 
    }))
    
    const result = await processSale(payload, total, paymentMethod, selectedCustomerId || undefined)
    
    setLoading(false)

    if (result.success && result.saleId && result.date) {
      addToast("‚úÖ Venta Exitosa", 'success')
      setLastSale({
        id: result.saleId,
        date: result.date,
        items: cart.map(i => ({ description: i.name, quantity: i.quantity, price: i.price })),
        total: total,
        method: paymentMethod
      })
      setCart([]) 
      setSelectedCustomerId("")
      setPaymentMethod("CASH")

      if (searchParams.get("apptId")) {
          router.replace("/pos") 
      } else {
          router.refresh()
      }
    } else {
      addToast(result.error || "Error al procesar", 'error')
    }
  }

  const clearLastSale = () => setLastSale(null)

  return {
    cart, total, loading, paymentMethod, lastSale,
    search, selectedCategory, categories, filteredProducts, selectedProductForModal,
    selectedCustomerId,
    setPaymentMethod, setSearch, setSelectedCategory, setSelectedProductForModal, clearLastSale,
    setSelectedCustomerId,
    handleProductClick, addVariantToCart, removeFromCart, updateServicePrice, checkout
  }
}

--- File: auth.ts (in subfolder: lib) ---

// src/lib/auth.ts
import { SignJWT, jwtVerify } from "jose";
import { cookies } from "next/headers";
import bcrypt from "bcryptjs";

// R-01: Validaci√≥n estricta de entorno. Sin clave, no hay sistema.
if (!process.env.JWT_SECRET) {
  throw new Error("FATAL: JWT_SECRET no est√° definida en variables de entorno.");
}

const SECRET_KEY = new TextEncoder().encode(process.env.JWT_SECRET);

// --- 1. HASHING (Protecci√≥n de Contrase√±as) ---

export async function hashPassword(plainText: string): Promise<string> {
  // Salt rounds: 10 es el est√°ndar actual de balance seguridad/velocidad
  return await bcrypt.hash(plainText, 10);
}

export async function verifyPassword(plainText: string, hash: string): Promise<boolean> {
  return await bcrypt.compare(plainText, hash);
}

// --- 2. SESI√ìN (Manejo de Cookies JWT) ---

export async function createSession(userId: string, role: string, name: string) {
  // Creamos el token
  const token = await new SignJWT({ userId, role, name })
    .setProtectedHeader({ alg: "HS256" })
    .setIssuedAt()
    .setExpirationTime("8h") // La sesi√≥n dura 8 horas laborables
    .sign(SECRET_KEY);

  // Guardamos en Cookie HTTP-Only (Inaccesible para JavaScript del navegador -> Anti XSS)
  const cookieStore = await cookies();
  
  cookieStore.set("session", token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    path: "/",
    maxAge: 8 * 60 * 60, // 8 horas en segundos
  });
}

export async function getSession() {
  const cookieStore = await cookies();
  const session = cookieStore.get("session")?.value;
  if (!session) return null;

  try {
    const { payload } = await jwtVerify(session, SECRET_KEY, {
      algorithms: ["HS256"],
    });
    return payload as { userId: string; role: string; name: string };
  } catch (error) {
    return null;
  }
}

export async function deleteSession() {
  const cookieStore = await cookies();
  cookieStore.delete("session");
}

--- File: prisma.ts (in subfolder: lib) ---

// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    // üëá QUITAMOS 'query' para reducir el ruido en consola
    log: ['error', 'warn'], 
  })

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

--- File: utils.ts (in subfolder: lib) ---

// src/lib/utils.ts
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

/**
 * Combina clases de Tailwind CSS de forma inteligente.
 * Resuelve conflictos (ej: si pasas 'bg-red-500' y luego 'bg-blue-500', gana el √∫ltimo).
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Devuelve la fecha actual en Argentina (GMT-3) en formato YYYY-MM-DD.
 * √ötil para establecer el valor por defecto en inputs type="date".
 */
export function getLocalDateISO(): string {
  // Obtenemos la fecha actual
  const now = new Date()
  
  // Forzamos el offset de Argentina (-3 horas)
  // Nota: Esto es una aproximaci√≥n manual r√°pida para evitar librer√≠as pesadas como date-fns-tz
  const offsetMs = -3 * 60 * 60 * 1000
  const argentinaTime = new Date(now.getTime() + offsetMs)
  
  return argentinaTime.toISOString().split('T')[0]
}

/**
 * Construye un objeto Date asegurando que sea interpretado como GMT-3 (Argentina).
 * Prisma guardar√° esto en UTC, pero la conversi√≥n ser√° correcta.
 * 
 * @param dateStr Formato "YYYY-MM-DD"
 * @param timeStr Formato "HH:MM" (opcional, default 00:00)
 */
export function buildArgentinaDate(dateStr: string, timeStr: string = "00:00:00"): Date {
  // Aseguramos formato de segundos
  const timeFull = timeStr.length === 5 ? `${timeStr}:00` : timeStr
  
  // Construimos string ISO con el offset expl√≠cito de Argentina
  const isoString = `${dateStr}T${timeFull}-03:00`
  
  return new Date(isoString)
}

/**
 * Devuelve el rango de inicio y fin de un d√≠a espec√≠fico en Argentina.
 * Se usa para buscar en la base de datos (ej: "Dames los turnos de hoy").
 */
export function getArgentinaDayRange(dateStr?: string) {
  const targetDate = dateStr || getLocalDateISO()
  
  // Inicio del d√≠a: 00:00:00.000 GMT-3
  const start = buildArgentinaDate(targetDate, "00:00:00")
  
  // Fin del d√≠a: 23:59:59.999 GMT-3
  // Sumamos casi 24hs (menos 1ms) al inicio
  const end = new Date(start.getTime() + (24 * 60 * 60 * 1000) - 1)
  
  return { start, end, dateStr: targetDate }
}

--- File: inventory-service.ts (in subfolder: services) ---

// src/services/inventory-service.ts
import { prisma } from "@/lib/prisma"

export type StockHistoryEntry = {
  id: string
  date: Date
  type: string      // Traducido o raw
  quantity: number  // + o -
  reason: string | null
  user: string
  balanceAfter: number | null // Futuro: Para c√°lculo de saldo parcial
}

/**
 * Obtiene el historial de movimientos de una variante.
 * Ordenado del m√°s reciente al m√°s antiguo.
 */
export async function getVariantStockHistory(variantId: string, limit = 50): Promise<StockHistoryEntry[]> {
  const movements = await prisma.stockMovement.findMany({
    where: { variantId },
    orderBy: { createdAt: 'desc' },
    take: limit
  })

  // Mapeamos a una estructura limpia para el frontend
  return movements.map(m => ({
    id: m.id,
    date: m.createdAt,
    type: m.type, // ENTRY, SALE, etc.
    quantity: m.quantity,
    reason: m.reason || "Sin detalle",
    user: m.userId,
    balanceAfter: null // Por ahora null, implementar si se requiere c√°lculo costoso
  }))
}

/**
 * Helper para traducir los c√≥digos t√©cnicos a humano
 */
export function translateMovementType(type: string): string {
  const dictionary: Record<string, string> = {
    ENTRY: "üü¢ Ingreso Mercader√≠a",
    SALE: "üõí Venta",
    ADJUSTMENT: "‚ö†Ô∏è Ajuste Manual",
    OWNER_WITHDRAWAL: "üì¶ Retiro de Due√±o",
    RETURN: "‚Ü©Ô∏è Devoluci√≥n",
    SALE_CANCELLED: "üö´ Venta Anulada"
  }
  return dictionary[type] || type
}

--- File: owner-service.ts (in subfolder: services) ---

// src/services/owner-service.ts
import { prisma } from "@/lib/prisma"

export type OwnerBalance = {
  debtFromSales: number
  debtFromAdjustments: number
  totalNetDebt: number
  pendingItemsCount: number
}

export async function getOwnerBalance(ownerId: string): Promise<OwnerBalance> {
  
  // 1. BUSCAR CANDIDATOS
  const allOwnerItems = await prisma.saleItem.findMany({
    where: {
      variant: { product: { ownerId: ownerId } },
      sale: { 
          status: 'COMPLETED',       // Venta v√°lida (no anulada)
          paymentStatus: 'PAID'      // üëà CR√çTICO: Solo pagamos si ya cobramos
      } 
    },
    select: {
      id: true,
      quantity: true,
      settledQuantity: true,
      costAtSale: true
    }
  })

  // 2. FILTRAR PENDIENTES
  const pendingItems = allOwnerItems.filter(item => item.settledQuantity < item.quantity)

  // 3. BUSCAR AJUSTES PENDIENTES
  const pendingAdjustments = await prisma.balanceAdjustment.findMany({
    where: {
      ownerId: ownerId,
      isApplied: false
    },
    select: {
      amount: true
    }
  })

  // 4. C√ÅLCULO
  const debtFromSales = pendingItems.reduce((sum, item) => {
    const remainingQuantity = item.quantity - item.settledQuantity
    const debtForThisItem = Number(item.costAtSale) * remainingQuantity
    return sum + debtForThisItem
  }, 0)

  const debtFromAdjustments = pendingAdjustments.reduce((sum, adj) => {
    return sum + Number(adj.amount)
  }, 0)

  const totalNetDebt = debtFromSales + debtFromAdjustments

  const pendingItemsCount = pendingItems.reduce((acc, item) => {
    return acc + (item.quantity - item.settledQuantity)
  }, 0)

  return {
    debtFromSales,
    debtFromAdjustments,
    totalNetDebt,
    pendingItemsCount
  }
}

--- File: prisma.config.ts (in subfolder: TEMP) ---

// This file was generated by Prisma, and assumes you have installed the following:
// npm install --save-dev prisma dotenv
import "dotenv/config";
import { defineConfig } from "prisma/config";

export default defineConfig({
  schema: "prisma/schema.prisma",
  migrations: {
    path: "prisma/migrations",
  },
  datasource: {
    url: process.env["DATABASE_URL"],
  },
});


--- File: tailwind.config.ts (in subfolder: TEMP) ---

import type { Config } from "tailwindcss";

const config: Config = {
  darkMode: ["class"], // Importante: Activaci√≥n manual por clase css
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      fontFamily: {
        sans: ["var(--font-inter)"],
        nunito: ["var(--font-nunito)"],
      },
    },
  },
  plugins: [],
};
export default config;

--- File: schema.prisma (in subfolder: TEMP\prisma) ---

// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Usamos PostgreSQL por defecto.
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// ENUMS (Listas de valores fijos)
// ==============================

enum Role {
  ADMIN
  STAFF
}

// Tipos de movimiento de stock para auditor√≠a estricta
enum StockMovementType {
  ENTRY // Ingreso de mercader√≠a (Suma)
  SALE // Venta por caja (Resta)
  ADJUSTMENT // Ajuste manual por rotura/p√©rdida (Resta o Suma)
  OWNER_WITHDRAWAL // Retiro del due√±o (Resta sin venta)
  RETURN // Devoluci√≥n de cliente (Suma)
  SALE_CANCELLED // Anulaci√≥n de venta (Suma autom√°tica)
}

// Estados del turno de peluquer√≠a
enum ApptStatus {
  PENDING // Reci√©n creado
  CONFIRMED // Cliente lleg√≥ / Confirmado
  COMPLETED // Servicio terminado
  BILLED // Ya se cobr√≥ en caja
  CANCELLED // Turno cancelado
}

// NUEVO: Estado de pago de la venta (Caja)
enum PaymentStatus {
  PAID // Pagado totalmente en el momento (Efectivo/Transferencia)
  PENDING // Cuenta Corriente / Fiado (Genera deuda al cliente)
  PARTIAL // (Reservado para futuro: pago parcial de cliente)
}

// ==============================
// MODELOS DE SISTEMA
// ==============================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // Hashed
  name      String
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
}

// ==============================
// MODELOS DEL NEGOCIO
// ==============================

// 1. Due√±os de Mercader√≠a (Consignaci√≥n)
model Owner {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  email     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relaciones
  products           Product[]
  settlements        Settlement[]
  balanceAdjustments BalanceAdjustment[]

  @@index([name])
}

// NUEVO: Clientes (Compradores / Cuentas Corrientes)
model Customer {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  email     String?
  address   String?
  createdAt DateTime @default(now())

  sales Sale[] // Historial de compras (pagas y impagas)

  @@index([name])
}

// 2. Categor√≠as de Productos
model Category {
  id       String    @id @default(uuid())
  name     String    @unique
  products Product[]
}

// 3. Productos (Cabecera)
model Product {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Relaciones
  ownerId    String
  owner      Owner    @relation(fields: [ownerId], references: [id])
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  variants ProductVariant[]

  isActive Boolean @default(true)

  @@index([name])
  @@index([ownerId])
}

// 4. Variantes (Talle/Color/Precio) - Es lo que realmente se vende
model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])
  name      String // Ej: "Rojo - XL" o "Est√°ndar"
  imageUrl  String? // URL externa (Cloudinary)

  // PRECIOS: Usamos Decimal para exactitud monetaria
  costPrice Decimal @db.Decimal(10, 2)
  salePrice Decimal @db.Decimal(10, 2)
  stock     Int     @default(0)

  // Relaciones
  stockMovements StockMovement[]
  saleItems      SaleItem[]

  // Evitar duplicados del mismo nombre dentro del mismo producto
  @@unique([productId, name])
}

// 5. Historial de Stock (Kardex)
model StockMovement {
  id        String            @id @default(uuid())
  variantId String
  variant   ProductVariant    @relation(fields: [variantId], references: [id])
  quantity  Int // Positivo (entrada) o Negativo (salida)
  type      StockMovementType
  reason    String?
  userId    String // ID del usuario que hizo la acci√≥n
  createdAt DateTime          @default(now())

  @@index([variantId])
  @@index([createdAt])
}

// 6. Ventas (Cabecera)
model Sale {
  id            String  @id @default(uuid())
  total         Decimal @db.Decimal(10, 2)
  paymentMethod String // "CASH", "TRANSFER", "CHECKING_ACCOUNT" (si es fiado)
  status        String  @default("COMPLETED") // "COMPLETED" (stock descontado) o "CANCELLED"

  // NUEVO: Control de deuda cliente
  paymentStatus PaymentStatus @default(PAID)
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id])

  // R-02: Fecha real de ingreso del dinero (Caja)
  paidAt        DateTime?

  createdAt DateTime @default(now())

  items SaleItem[]

  @@index([createdAt])
  @@index([paymentStatus])
  @@index([customerId])
  @@index([paidAt]) // Indexado para reportes de caja r√°pidos
}

// 7. Items de Venta (Detalle)
model SaleItem {
  id     String @id @default(uuid())
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id])

  // Puede ser null si vendemos un "Servicio" que no tiene stock
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  description String // Guardamos el nombre tal cual se vendi√≥ (snapshot)
  quantity    Int

  // SNAPSHOT DE PRECIOS
  costAtSale  Decimal @db.Decimal(10, 2)
  priceAtSale Decimal @db.Decimal(10, 2)

  // NUEVO: CONTROL DE LIQUIDACI√ìN PARCIAL
  // Eliminamos 'isSettled' (bool) y usamos un contador.
  // Si settledQuantity < quantity, significa que falta liquidar al due√±o.
  settledQuantity Int @default(0)

  // Relaci√≥n con las l√≠neas de liquidaci√≥n (donde se paga al due√±o)
  settlementLines SettlementLine[]

  @@index([saleId])
}

// NUEVO: L√≠nea de Liquidaci√≥n (Tabla intermedia para pagos parciales)
model SettlementLine {
  id String @id @default(uuid())

  settlementId String
  settlement   Settlement @relation(fields: [settlementId], references: [id])

  saleItemId String
  saleItem   SaleItem @relation(fields: [saleItemId], references: [id])

  quantity Int // Cu√°ntas unidades de ese item se est√°n pagando AHORA
  amount   Decimal @db.Decimal(10, 2) // Cu√°nta plata representa (quantity * costAtSale)

  @@index([settlementId])
  @@index([saleItemId])
}

// 8. Liquidaciones (Pagos a Due√±os)
model Settlement {
  id          String   @id @default(uuid())
  ownerId     String
  owner       Owner    @relation(fields: [ownerId], references: [id])
  totalAmount Decimal  @db.Decimal(10, 2) // Total pagado en este recibo
  createdAt   DateTime @default(now())

  // Antes items SaleItem[], ahora usamos la tabla intermedia
  items       SettlementLine[]
  adjustments BalanceAdjustment[]
}

// 9. Ajustes de Saldo (Cr√©ditos/D√©bitos manuales a Due√±os)
model BalanceAdjustment {
  id          String  @id @default(uuid())
  ownerId     String
  owner       Owner   @relation(fields: [ownerId], references: [id])
  amount      Decimal @db.Decimal(10, 2)
  description String

  isApplied    Boolean     @default(false)
  settlementId String?
  settlement   Settlement? @relation(fields: [settlementId], references: [id])
  createdAt    DateTime    @default(now())
}

// ==============================
// MODELOS DE PELUQUER√çA
// ==============================

// 10. Clientes (Mascotas) - Nota: Se mantiene separado de Customer por ahora
model Pet {
  id         String  @id @default(uuid())
  name       String
  ownerName  String
  ownerPhone String?
  breed      String?
  notes      String?

  appointments  Appointment[]
  groomingNotes GroomingNote[]

  @@index([name])
  @@index([ownerName])
}

// 11. Turnos
model Appointment {
  id        String     @id @default(uuid())
  petId     String
  pet       Pet        @relation(fields: [petId], references: [id])
  startTime DateTime
  endTime   DateTime
  status    ApptStatus @default(PENDING)

  @@index([startTime])
  @@index([status])
}

// 12. Notas T√©cnicas
model GroomingNote {
  id        String   @id @default(uuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id])
  content   String   @db.Text
  createdAt DateTime @default(now())
}

--- File: migration.sql (in subfolder: TEMP\prisma\migrations\20260109022200_init_db) ---

-- CreateEnum
CREATE TYPE "Role" AS ENUM ('ADMIN', 'STAFF');

-- CreateEnum
CREATE TYPE "StockMovementType" AS ENUM ('ENTRY', 'SALE', 'ADJUSTMENT', 'OWNER_WITHDRAWAL', 'RETURN', 'SALE_CANCELLED');

-- CreateEnum
CREATE TYPE "ApptStatus" AS ENUM ('PENDING', 'CONFIRMED', 'COMPLETED', 'BILLED', 'CANCELLED');

-- CreateTable
CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "role" "Role" NOT NULL DEFAULT 'STAFF',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Owner" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "phone" TEXT,
    "email" TEXT,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Owner_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Category" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,

    CONSTRAINT "Category_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Product" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "tags" TEXT[],
    "ownerId" TEXT NOT NULL,
    "categoryId" TEXT NOT NULL,
    "isActive" BOOLEAN NOT NULL DEFAULT true,

    CONSTRAINT "Product_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "ProductVariant" (
    "id" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "imageUrl" TEXT,
    "costPrice" DECIMAL(10,2) NOT NULL,
    "salePrice" DECIMAL(10,2) NOT NULL,
    "stock" INTEGER NOT NULL DEFAULT 0,

    CONSTRAINT "ProductVariant_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "StockMovement" (
    "id" TEXT NOT NULL,
    "variantId" TEXT NOT NULL,
    "quantity" INTEGER NOT NULL,
    "type" "StockMovementType" NOT NULL,
    "reason" TEXT,
    "userId" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "StockMovement_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Sale" (
    "id" TEXT NOT NULL,
    "total" DECIMAL(10,2) NOT NULL,
    "paymentMethod" TEXT NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'COMPLETED',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Sale_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "SaleItem" (
    "id" TEXT NOT NULL,
    "saleId" TEXT NOT NULL,
    "variantId" TEXT,
    "description" TEXT NOT NULL,
    "quantity" INTEGER NOT NULL,
    "costAtSale" DECIMAL(10,2) NOT NULL,
    "priceAtSale" DECIMAL(10,2) NOT NULL,
    "isSettled" BOOLEAN NOT NULL DEFAULT false,
    "settlementId" TEXT,

    CONSTRAINT "SaleItem_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Settlement" (
    "id" TEXT NOT NULL,
    "ownerId" TEXT NOT NULL,
    "totalAmount" DECIMAL(10,2) NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Settlement_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "BalanceAdjustment" (
    "id" TEXT NOT NULL,
    "ownerId" TEXT NOT NULL,
    "amount" DECIMAL(10,2) NOT NULL,
    "description" TEXT NOT NULL,
    "isApplied" BOOLEAN NOT NULL DEFAULT false,
    "settlementId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "BalanceAdjustment_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Pet" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "ownerName" TEXT NOT NULL,
    "ownerPhone" TEXT,
    "breed" TEXT,
    "notes" TEXT,

    CONSTRAINT "Pet_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Appointment" (
    "id" TEXT NOT NULL,
    "petId" TEXT NOT NULL,
    "startTime" TIMESTAMP(3) NOT NULL,
    "endTime" TIMESTAMP(3) NOT NULL,
    "status" "ApptStatus" NOT NULL DEFAULT 'PENDING',
    "price" DECIMAL(10,2),

    CONSTRAINT "Appointment_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "GroomingNote" (
    "id" TEXT NOT NULL,
    "petId" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "appointmentId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "GroomingNote_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

-- CreateIndex
CREATE UNIQUE INDEX "Category_name_key" ON "Category"("name");

-- CreateIndex
CREATE UNIQUE INDEX "ProductVariant_productId_name_key" ON "ProductVariant"("productId", "name");

-- AddForeignKey
ALTER TABLE "Product" ADD CONSTRAINT "Product_ownerId_fkey" FOREIGN KEY ("ownerId") REFERENCES "Owner"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Product" ADD CONSTRAINT "Product_categoryId_fkey" FOREIGN KEY ("categoryId") REFERENCES "Category"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ProductVariant" ADD CONSTRAINT "ProductVariant_productId_fkey" FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "StockMovement" ADD CONSTRAINT "StockMovement_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "ProductVariant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SaleItem" ADD CONSTRAINT "SaleItem_saleId_fkey" FOREIGN KEY ("saleId") REFERENCES "Sale"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SaleItem" ADD CONSTRAINT "SaleItem_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "ProductVariant"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SaleItem" ADD CONSTRAINT "SaleItem_settlementId_fkey" FOREIGN KEY ("settlementId") REFERENCES "Settlement"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Settlement" ADD CONSTRAINT "Settlement_ownerId_fkey" FOREIGN KEY ("ownerId") REFERENCES "Owner"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "BalanceAdjustment" ADD CONSTRAINT "BalanceAdjustment_ownerId_fkey" FOREIGN KEY ("ownerId") REFERENCES "Owner"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "BalanceAdjustment" ADD CONSTRAINT "BalanceAdjustment_settlementId_fkey" FOREIGN KEY ("settlementId") REFERENCES "Settlement"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Appointment" ADD CONSTRAINT "Appointment_petId_fkey" FOREIGN KEY ("petId") REFERENCES "Pet"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "GroomingNote" ADD CONSTRAINT "GroomingNote_petId_fkey" FOREIGN KEY ("petId") REFERENCES "Pet"("id") ON DELETE RESTRICT ON UPDATE CASCADE;


--- File: migration.sql (in subfolder: TEMP\prisma\migrations\20260112034842_init_db) ---

/*
  Warnings:

  - You are about to drop the column `price` on the `Appointment` table. All the data in the column will be lost.
  - You are about to drop the column `appointmentId` on the `GroomingNote` table. All the data in the column will be lost.
  - You are about to drop the column `tags` on the `Product` table. All the data in the column will be lost.
  - You are about to drop the `User` table. If the table is not empty, all the data it contains will be lost.

*/
-- AlterTable
ALTER TABLE "Appointment" DROP COLUMN "price";

-- AlterTable
ALTER TABLE "GroomingNote" DROP COLUMN "appointmentId";

-- AlterTable
ALTER TABLE "Product" DROP COLUMN "tags";

-- DropTable
DROP TABLE "User";

-- CreateIndex
CREATE INDEX "Appointment_startTime_idx" ON "Appointment"("startTime");

-- CreateIndex
CREATE INDEX "Appointment_status_idx" ON "Appointment"("status");

-- CreateIndex
CREATE INDEX "Owner_name_idx" ON "Owner"("name");

-- CreateIndex
CREATE INDEX "Pet_name_idx" ON "Pet"("name");

-- CreateIndex
CREATE INDEX "Pet_ownerName_idx" ON "Pet"("ownerName");

-- CreateIndex
CREATE INDEX "Product_name_idx" ON "Product"("name");

-- CreateIndex
CREATE INDEX "Product_ownerId_idx" ON "Product"("ownerId");

-- CreateIndex
CREATE INDEX "Sale_createdAt_idx" ON "Sale"("createdAt");

-- CreateIndex
CREATE INDEX "SaleItem_isSettled_idx" ON "SaleItem"("isSettled");

-- CreateIndex
CREATE INDEX "SaleItem_saleId_idx" ON "SaleItem"("saleId");

-- CreateIndex
CREATE INDEX "StockMovement_variantId_idx" ON "StockMovement"("variantId");

-- CreateIndex
CREATE INDEX "StockMovement_createdAt_idx" ON "StockMovement"("createdAt");


--- File: migration.sql (in subfolder: TEMP\prisma\migrations\20260114214956_restore_users) ---

-- CreateTable
CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "role" "Role" NOT NULL DEFAULT 'STAFF',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");


--- File: migration.sql (in subfolder: TEMP\prisma\migrations\20260116025646_init_customers_and_partial_settlements) ---

/*
  Warnings:

  - You are about to drop the column `isSettled` on the `SaleItem` table. All the data in the column will be lost.
  - You are about to drop the column `settlementId` on the `SaleItem` table. All the data in the column will be lost.

*/
-- CreateEnum
CREATE TYPE "PaymentStatus" AS ENUM ('PAID', 'PENDING', 'PARTIAL');

-- DropForeignKey
ALTER TABLE "SaleItem" DROP CONSTRAINT "SaleItem_settlementId_fkey";

-- DropIndex
DROP INDEX "SaleItem_isSettled_idx";

-- AlterTable
ALTER TABLE "Sale" ADD COLUMN     "customerId" TEXT,
ADD COLUMN     "paymentStatus" "PaymentStatus" NOT NULL DEFAULT 'PAID';

-- AlterTable
ALTER TABLE "SaleItem" DROP COLUMN "isSettled",
DROP COLUMN "settlementId",
ADD COLUMN     "settledQuantity" INTEGER NOT NULL DEFAULT 0;

-- CreateTable
CREATE TABLE "Customer" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "phone" TEXT,
    "email" TEXT,
    "address" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Customer_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "SettlementLine" (
    "id" TEXT NOT NULL,
    "settlementId" TEXT NOT NULL,
    "saleItemId" TEXT NOT NULL,
    "quantity" INTEGER NOT NULL,
    "amount" DECIMAL(10,2) NOT NULL,

    CONSTRAINT "SettlementLine_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE INDEX "Customer_name_idx" ON "Customer"("name");

-- CreateIndex
CREATE INDEX "SettlementLine_settlementId_idx" ON "SettlementLine"("settlementId");

-- CreateIndex
CREATE INDEX "SettlementLine_saleItemId_idx" ON "SettlementLine"("saleItemId");

-- CreateIndex
CREATE INDEX "Sale_paymentStatus_idx" ON "Sale"("paymentStatus");

-- CreateIndex
CREATE INDEX "Sale_customerId_idx" ON "Sale"("customerId");

-- AddForeignKey
ALTER TABLE "Sale" ADD CONSTRAINT "Sale_customerId_fkey" FOREIGN KEY ("customerId") REFERENCES "Customer"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SettlementLine" ADD CONSTRAINT "SettlementLine_settlementId_fkey" FOREIGN KEY ("settlementId") REFERENCES "Settlement"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "SettlementLine" ADD CONSTRAINT "SettlementLine_saleItemId_fkey" FOREIGN KEY ("saleItemId") REFERENCES "SaleItem"("id") ON DELETE RESTRICT ON UPDATE CASCADE;


--- File: migration.sql (in subfolder: TEMP\prisma\migrations\20260117020457_after_auth) ---

-- AlterTable
ALTER TABLE "Sale" ADD COLUMN     "paidAt" TIMESTAMP(3);

-- CreateIndex
CREATE INDEX "Sale_paidAt_idx" ON "Sale"("paidAt");


